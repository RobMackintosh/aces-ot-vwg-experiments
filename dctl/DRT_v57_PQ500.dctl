DEFINE_UI_PARAMS(toneCurve, Tone Curve, DCTLUI_CHECK_BOX, 1)
DEFINE_UI_PARAMS(compressChroma, Compress Chroma, DCTLUI_CHECK_BOX, 1)
DEFINE_UI_PARAMS(gamutCompress, Gamut Compress, DCTLUI_CHECK_BOX, 1)
DEFINE_UI_PARAMS(d60Sim, D60 Sim, DCTLUI_CHECK_BOX, 0)
DEFINE_UI_PARAMS(asPQ, Encode as BT.2100 PQ, DCTLUI_CHECK_BOX, 1)
DEFINE_UI_PARAMS(ap1Clip, AP1 Clamp, DCTLUI_CHECK_BOX, 1)
DEFINE_UI_PARAMS(softClip, Soft Clip, DCTLUI_CHECK_BOX, 0)
DEFINE_UI_PARAMS(hardClip, Clamp, DCTLUI_CHECK_BOX, 1)
DEFINE_UI_PARAMS(invert, Invert, DCTLUI_CHECK_BOX, 0)
DEFINE_UI_PARAMS(JMhOut, Diagnostic JMh Output, DCTLUI_CHECK_BOX, 0)


typedef struct
{
    float3 x;
    float3 y;
    float3 z;
} float3x3;

// Constant values generated in Python
// https://github.com/nick-shaw/aces-ot-vwg-experiments/blob/master/python/v57_init_plot.py

__CONSTANT__ float3x3 XYZ_to_RGB_limit =
{
// XYZ to P3-D65 matrix
    { 2.4934969119f, -0.9313836179f, -0.4027107845f },
    {-0.8294889696f,  1.7626640603f,  0.0236246858f },
    { 0.0358458302f, -0.0761723893f,  0.9568845240f }
};

__CONSTANT__ float3x3 RGB_to_XYZ_output =
{
// Rec.2020 to XYZ matrix
    { 0.6369580483f,  0.1446169036f,  0.1688809752f },
    { 0.2627002120f,  0.6779980715f,  0.0593017165f },
    { 0.0000000000f,  0.0280726930f,  1.0609850577f }
};

__CONSTANT__ float3x3 RGB_to_XYZ_P3D60 =
{
    { 0.5049495342f,  0.2646814889f,  0.1830150515f },
    { 0.2376233102f,  0.6891706692f,  0.0732060206f },
    {-0.0000000000f,  0.0449459132f,  0.9638792711f }
};

__CONSTANT__ float3x3 P3D65_to_BT2020 =
{
    { 0.7538330344f,  0.1985973691f,  0.0475695966f },
    { 0.0457438490f,  0.9417772198f,  0.0124789312f },
    {-0.0012103404f,  0.0176017173f,  0.9836086231f }
};

__CONSTANT__ float limitJmax = 208.257070f;
__CONSTANT__ float midJ = 38.9322092937f; // ~13 nits in Hellwig J
__CONSTANT__ float focusDist = 3.0013166352f;

__CONSTANT__ float daniele_n = 500.0f; // peak white  
__CONSTANT__ float daniele_m_2 = 5.0892350790f;
__CONSTANT__ float daniele_s_2 = 3.3869123661f;
__CONSTANT__ float daniele_u_2 = 0.9902637512f;

// Chroma compression scaling for HDR/SDR appearance match
__CONSTANT__ float sat = 0.6730239061f;
__CONSTANT__ float sat_thr = 0.0010f;
__CONSTANT__ float compr = 7.935842f;

__CONSTANT__ float3 gamutCuspTable[360] = 
{
    { 119.4955116182f,  157.0427193055f,  0.6996436714f },
    { 118.8878599445f,  157.6146205644f,  1.5900739174f },
    { 118.2743574960f,  158.2101000642f,  2.5163012887f },
    { 117.6546914751f,  158.8306731081f,  3.4826235096f },
    { 117.0285012608f,  159.4781625008f,  4.4942231664f },
    { 116.3953652604f,  160.1548093106f,  5.5574310806f },
    { 115.7547824831f,  160.8634365428f,  6.6800973314f },
    { 115.1061459681f,  161.6076978473f,  7.8721285065f },
    { 114.4487031623f,  162.3924680692f,  9.1462913619f },
    { 113.7814944214f,  163.2244812015f,  10.5194629006f },
    { 113.1032527764f,  164.1134239943f,  12.0146702072f },
    { 112.4122302693f,  165.0739279050f,  13.6646253173f },
    { 111.7058723207f,  166.1294947813f,  15.5183480167f },
    { 110.9801382723f,  167.3211078811f,  17.6549593369f },
    { 110.2278468930f,  168.7292979053f,  20.2171686379f },
    { 109.4335063188f,  170.5469305311f,  23.5154527152f },
    { 108.5461988160f,  173.4863966358f,  28.5706055537f },
    { 110.6285772802f,  166.6291105238f,  30.1505435798f },
    { 112.6492621502f,  160.3930641277f,  31.7642524509f },
    { 114.6141222128f,  154.7093517976f,  33.4095926313f },
    { 116.5280745281f,  149.5210093950f,  35.0844239947f },
    { 118.3952943504f,  144.7803260339f,  36.7865011196f },
    { 120.2193682287f,  140.4468600047f,  38.5134166681f },
    { 122.0034081619f,  136.4859475912f,  40.2625740865f },
    { 123.7501383600f,  132.8675645056f,  42.0311797519f },
    { 125.4619622967f,  129.5654446925f,  43.8162490283f },
    { 127.1410153044f,  126.5563904841f,  45.6146228583f },
    { 128.7892063777f,  123.8197274640f,  47.4229925896f },
    { 130.4082517955f,  121.3368704933f,  49.2379312377f },
    { 131.9997024555f,  119.0909763424f,  51.0559296084f },
    { 133.5649663135f,  117.0666646403f,  52.8734357753f },
    { 135.1053269695f,  115.2497932839f,  54.6868964417f },
    { 136.6219591879f,  113.6272776172f,  56.4927987415f },
    { 138.1159419551f,  112.1869449894f,  58.2877111002f },
    { 139.5882695418f,  110.9174179976f,  60.0683218823f },
    { 141.0398609341f,  109.8080209858f,  61.8314747071f },
    { 142.4715679238f,  108.8487053486f,  63.5741995169f },
    { 143.8841820844f,  108.0299899511f,  65.2937387066f },
    { 145.2784408198f,  107.3429135958f,  66.9875678734f },
    { 146.6550326330f,  106.7789969746f,  68.6534109889f },
    { 148.0146017359f,  106.3302119787f,  70.2892500267f },
    { 149.3577521011f,  105.9889566098f,  71.8933292839f },
    { 150.6850510360f,  105.7480340586f,  73.4641548006f },
    { 151.9970323479f,  105.6006347958f,  75.0004894112f },
    { 153.2941991575f,  105.5403207667f,  76.5013440423f },
    { 154.5770264069f,  105.5610109857f,  77.9659659195f },
    { 155.8459631034f,  105.6569680078f,  79.3938243495f },
    { 157.1014343327f,  105.8227848989f,  80.7845947273f },
    { 158.3438430699f,  106.0533724488f,  82.1381413679f },
    { 159.5735718136f,  106.3439464665f,  83.4544997030f },
    { 160.7909840639f,  106.6900150714f,  84.7338583129f },
    { 161.9964256622f,  107.0873659514f,  85.9765411858f },
    { 163.1902260090f,  107.5320535961f,  87.1829905223f },
    { 164.3726991732f,  108.0203865432f,  88.3537503314f },
    { 165.5441449041f,  108.5489146909f,  89.4894509988f },
    { 166.7048495578f,  109.1144167367f,  90.5907949479f },
    { 167.8550869450f,  109.7138878083f,  91.6585434672f },
    { 168.9951191101f,  110.3445273448f,  92.6935047339f },
    { 170.1251970476f,  111.0037272879f,  93.6965230307f },
    { 171.2455613617f,  111.6890606284f,  94.6684691259f },
    { 172.3564428755f,  112.3982703515f,  95.6102317695f },
    { 173.4580631934f,  113.1292588114f,  96.5227102410f },
    { 174.5506352220f,  113.8800775609f,  97.4068078773f },
    { 175.6343636528f,  114.6489176506f,  98.2634265046f },
    { 176.7094454103f,  115.4341004087f,  99.0934616941f },
    { 177.7760700687f,  116.2340687034f,  99.8977987626f },
    { 178.8344202390f,  117.0473786854f,  100.6773094419f },
    { 179.8846719304f,  117.8726920044f,  101.4328491442f },
    { 180.9269948873f,  118.7087684884f,  102.1652547530f },
    { 181.9615529038f,  119.5544592724f,  102.8753428773f },
    { 182.9885041181f,  120.4087003602f,  103.5639085092f },
    { 184.0080012878f,  121.2705066026f,  104.2317240317f },
    { 185.0201920479f,  122.1389660722f,  104.8795385288f },
    { 186.0252191533f,  123.0132348157f,  105.5080773529f },
    { 187.0232207055f,  123.8925319649f,  106.1180419127f },
    { 188.0143303669f,  124.7761351839f,  106.7101096465f },
    { 188.9986775611f,  125.6633764362f,  107.2849341496f },
    { 188.5604037142f,  125.7481995811f,  107.8513538871f },
    { 188.1206717127f,  125.8465081175f,  108.4202183061f },
    { 187.6794676545f,  125.9585038062f,  108.9914316248f },
    { 187.2367774114f,  126.0843882699f,  109.5648954541f },
    { 186.7925866246f,  126.2243629063f,  110.1405088784f },
    { 186.3468806988f,  126.3786288049f,  110.7181685440f },
    { 185.8996447973f,  126.5473866653f,  111.2977687534f },
    { 185.4508638354f,  126.7308367190f,  111.8792015669f },
    { 185.0005224757f,  126.9291786532f,  112.4623569103f },
    { 184.5486051209f,  127.1426115395f,  113.0471226887f },
    { 184.0950959086f,  127.3713337651f,  113.6333849067f },
    { 183.6399787042f,  127.6155429695f,  114.2210277938f },
    { 183.1832370945f,  127.8754359849f,  114.8099339355f },
    { 182.7248543809f,  128.1512087822f,  115.3999844091f },
    { 182.2648135725f,  128.4430564218f,  115.9910589248f },
    { 181.8030973784f,  128.7511730106f,  116.5830359701f },
    { 181.3396882008f,  129.0757516646f,  117.1757929590f },
    { 180.8745681267f,  129.4169844786f,  117.7692063843f },
    { 180.4077189202f,  129.7750625015f,  118.3631519727f },
    { 179.9391220144f,  130.1501757195f,  118.9575048422f },
    { 179.4687585023f,  130.5425130460f,  119.5521396627f },
    { 178.9966091286f,  130.9522623198f,  120.1469308161f },
    { 178.5226542802f,  131.3796103100f,  120.7417525595f },
    { 178.0468739770f,  131.8247427302f,  121.3364791872f },
    { 177.5692478620f,  132.2878442597f,  121.9309851940f },
    { 177.0897551913f,  132.7690985744f,  122.5251454366f },
    { 176.6083748236f,  133.2686883853f,  123.1188352953f },
    { 176.1250852094f,  133.7867954867f,  123.7119308329f },
    { 175.6398643801f,  134.3236008124f,  124.3043089525f },
    { 175.1526899361f,  134.8792845024f,  124.8958475520f },
    { 174.6635390347f,  135.4540259772f,  125.4864256762f },
    { 174.1723883783f,  136.0480040225f,  126.0759236647f },
    { 173.6792142009f,  136.6613968831f,  126.6642232967f },
    { 173.1839922550f,  137.2943823658f,  127.2512079306f },
    { 172.6866977979f,  137.9471379522f,  127.8367626396f },
    { 172.1873055771f,  138.6198409209f,  128.4207743422f },
    { 171.6857898155f,  139.3126684796f,  129.0031319264f },
    { 171.1821241961f,  140.0257979058f,  129.5837263695f },
    { 170.6762818458f,  140.7594066982f,  130.1624508508f },
    { 170.1682353188f,  141.5136727369f,  130.7392008591f },
    { 169.6579565792f,  142.2887744537f,  131.3138742928f },
    { 169.1454169831f,  143.0848910114f,  131.8863715541f },
    { 168.6305872601f,  143.9022024933f,  132.4565956363f },
    { 168.1134374934f,  144.7408901014f,  133.0244522041f },
    { 167.5939371000f,  145.6011363653f,  133.5898496673f },
    { 167.0720548094f,  146.4831253598f,  134.1526992473f },
    { 166.5477586418f,  147.3870429320f,  134.7129150367f },
    { 166.0210158855f,  148.3130769391f,  135.2704140519f },
    { 165.4917930725f,  149.2614174944f,  135.8251162792f },
    { 164.9600559546f,  150.2322572245f,  136.3769447134f },
    { 164.4257694769f,  151.2257915353f,  136.9258253904f },
    { 163.8888977512f,  152.2422188883f,  137.4716874126f },
    { 163.3494040278f,  153.2817410871f,  138.0144629683f },
    { 162.8072506663f,  154.3445635742f,  138.5540873445f },
    { 162.2623991049f,  155.4308957381f,  139.0904989339f },
    { 161.7148098285f,  156.5409512310f,  139.6236392360f },
    { 161.1644423352f,  157.6749482982f,  140.1534528520f },
    { 160.6112551014f,  158.8331101177f,  140.6798874752f },
    { 160.0552055453f,  160.0156651526f,  141.2028938756f },
    { 159.4962499888f,  161.2228475148f,  141.7224258796f },
    { 159.9705906096f,  155.7902062175f,  142.8478463553f },
    { 160.4328248413f,  150.9981703716f,  143.9188624983f },
    { 160.8855333493f,  146.6996372013f,  144.9498740503f },
    { 161.3304452014f,  142.7961931873f,  145.9504946315f },
    { 161.7687847674f,  139.2182794999f,  146.9274944672f },
    { 162.2014561365f,  135.9146474972f,  147.8858349145f },
    { 162.6291492447f,  132.8462904803f,  148.8292645149f },
    { 163.0524047931f,  129.9827313899f,  149.7606839089f },
    { 163.4716559405f,  127.2996384965f,  150.6823803045f },
    { 163.8872561630f,  124.7772319353f,  151.5961841952f },
    { 164.2994984971f,  122.3991829333f,  152.5035776076f },
    { 164.7086292088f,  120.1518317859f,  153.4057709852f },
    { 165.1148577381f,  118.0236187668f,  154.3037591168f },
    { 165.5183640870f,  116.0046612674f,  155.1983626834f },
    { 165.9193044097f,  114.0864337959f,  156.0902596939f },
    { 166.3178153096f,  112.2615218756f,  156.9800096679f },
    { 166.7140171920f,  110.5234300353f,  157.8680725190f },
    { 167.1080169120f,  108.8664300615f,  158.7548235039f },
    { 167.4999098919f,  107.2854396716f,  159.6405652100f },
    { 167.8897818306f,  105.7759244819f,  160.5255372837f },
    { 168.2777100983f,  104.3338180407f,  161.4099244189f },
    { 168.6637648835f,  102.9554560231f,  162.2938629883f },
    { 169.0480101441f,  101.6375216460f,  163.1774466115f },
    { 169.4305044021f,  100.3770000570f,  164.0607308781f },
    { 169.8113014123f,  99.1711399624f,  164.9437373994f },
    { 170.1904507282f,  98.0174211443f,  165.8264573204f },
    { 170.5679981835f,  96.9135268043f,  166.7088543959f },
    { 170.9439863048f,  95.8573198906f,  167.5908677130f },
    { 171.3184546669f,  94.8468227355f,  168.4724141248f },
    { 171.6914401998f,  93.8801994604f,  169.3533904478f },
    { 172.0629774550f,  92.9557407089f,  170.2336754629f },
    { 172.4330988387f,  92.0718503475f,  171.1131317546f },
    { 172.8018348157f,  91.2270338407f,  171.9916074136f },
    { 173.1692140879f,  90.4198880549f,  172.8689376250f },
    { 173.5352637534f,  89.6490922901f,  173.7449461583f },
    { 173.9000094457f,  88.9134003688f,  174.6194467725f },
    { 174.2634754586f,  88.2116336413f,  175.4922445472f },
    { 174.6256848565f,  87.5426747869f,  176.3631371478f },
    { 174.9866595741f,  86.9054623088f,  177.2319160302f },
    { 175.3464205045f,  86.2989856375f,  178.0983675918f },
    { 175.7049875792f,  85.7222807674f,  178.9622742693f },
    { 176.0623798399f,  85.1744263636f,  179.8234155881f },
    { 176.4186155032f,  84.6545402837f,  180.6815691644f },
    { 176.7737120194f,  84.1617764674f,  181.5365116596f },
    { 177.1276861258f,  83.6953221514f,  182.3880196893f },
    { 177.4805538949f,  83.2543953753f,  183.2358706862f },
    { 177.8323307783f,  82.8382427449f,  184.0798437165f },
    { 178.1830316475f,  82.4461374261f,  184.9197202503f },
    { 178.5326708299f,  82.0773773446f,  185.7552848844f },
    { 178.8812621433f,  81.7312835687f,  186.5863260189f },
    { 179.2288189260f,  81.4071988580f,  187.4126364860f },
    { 179.5753540659f,  81.1044863578f,  188.2340141303f },
    { 179.9208800261f,  80.8225284263f,  189.0502623427f },
    { 180.2654088695f,  80.5607255790f,  189.8611905456f },
    { 180.6089522808f,  80.3184955394f,  190.6666146306f },
    { 180.9515215870f,  80.0952723838f,  191.4663573500f },
    { 181.2931277770f,  79.8905057700f,  192.2602486608f },
    { 181.6337815186f,  79.7036602423f,  193.0481260239f },
    { 181.9734931755f,  79.5342146032f,  193.8298346581f },
    { 182.3122728226f,  79.3816613449f,  194.6052277516f },
    { 181.2755293710f,  78.7475754206f,  195.3877150750f },
    { 180.2310949539f,  78.1220960282f,  196.1901472372f },
    { 179.1788138905f,  77.5058606289f,  197.0130515323f },
    { 178.1185252399f,  76.8995415310f,  197.8569555262f },
    { 177.0500625500f,  76.3038474104f,  198.7223848553f },
    { 175.9732535908f,  75.7195248367f,  199.6098607403f },
    { 174.8879200706f,  75.1473597932f,  200.5198971962f },
    { 173.7938773349f,  74.5881791803f,  201.4529979212f },
    { 172.6909340447f,  74.0428522858f,  202.4096528479f },
    { 171.5788918345f,  73.5122922079f,  203.3903343451f },
    { 170.4575449471f,  72.9974572135f,  204.3954930608f },
    { 169.3266798441f,  72.4993520112f,  205.4255534025f },
    { 168.1860747888f,  72.0190289197f,  206.4809086558f },
    { 167.0354994010f,  71.5575889088f,  207.5619157515f },
    { 165.8747141797f,  71.1161824889f,  208.6688897000f },
    { 164.7034699914f,  70.6960104262f,  209.8020977185f },
    { 163.5215075212f,  70.2983242595f,  210.9617530946f },
    { 162.3285566833f,  69.9244265925f,  212.1480088367f },
    { 161.1243359862f,  69.5756711427f,  213.3609511798f },
    { 159.9085518499f,  69.2534625231f,  214.6005930292f },
    { 158.6808978694f,  68.9592557422f,  215.8668674413f },
    { 157.4410540193f,  68.6945554086f,  217.1596212554f },
    { 156.1886857947f,  68.4609146342f,  218.4786090087f },
    { 154.9234432804f,  68.2599336378f,  219.8234872792f },
    { 153.6449601425f,  68.0932580583f,  221.1938096147f },
    { 152.3528525337f,  67.9625769993f,  222.5890222155f },
    { 151.0467179027f,  67.8696208389f,  224.0084605467f },
    { 149.7261336978f,  67.8161588510f,  225.4513470522f },
    { 148.3906559533f,  67.8039967018f,  226.9167901444f },
    { 147.0398177446f,  67.8349738987f,  228.4037846262f },
    { 145.6731274969f,  67.9109612899f,  229.9112136898f },
    { 144.2900671317f,  68.0338587255f,  231.4378526076f },
    { 142.8900900290f,  68.2055930125f,  232.9823742009f },
    { 141.4726187853f,  68.4281163119f,  234.5433561332f },
    { 140.0370427392f,  68.7034051422f,  236.1192900325f },
    { 138.5827152365f,  69.0334601696f,  237.7085923996f },
    { 137.1089505991f,  69.4203069816f,  239.3096172127f },
    { 135.6150207586f,  69.8659980512f,  240.9206700902f },
    { 134.1001515073f,  70.3726161170f,  242.5400238317f },
    { 132.5635183125f,  70.9422792146f,  244.1659351199f },
    { 131.0042416307f,  71.5771476123f,  245.7966621359f },
    { 129.4213816458f,  72.2794329235f,  247.4304828261f },
    { 127.8139323433f,  73.0514096894f,  249.0657135508f },
    { 126.1808148145f,  73.8954297608f,  250.7007278552f },
    { 124.5208696649f,  74.8139398490f,  252.3339751274f },
    { 122.8328483768f,  75.8095026762f,  253.9639989442f },
    { 121.1154034430f,  76.8848222347f,  255.5894549617f },
    { 119.3670770516f,  78.0427737753f,  257.2091282701f },
    { 117.5862880542f,  79.2864392889f,  258.8219502158f },
    { 115.7713168859f,  80.6191494416f,  260.4270147860f },
    { 113.9202880305f,  82.0445331834f,  262.0235947598f },
    { 112.0311495254f,  83.5665766002f,  263.6111579559f },
    { 110.1016488676f,  85.1896930420f,  265.1893840514f },
    { 108.1293045208f,  86.9188071935f,  266.7581826265f },
    { 106.1113719962f,  88.7594566031f,  268.3177133026f },
    { 104.0448031889f,  90.7179153636f,  269.8684091246f },
    { 101.9261972522f,  92.8013462664f,  271.4110047025f },
    { 99.7517407494f,  95.0179900522f,  272.9465711340f },
    { 97.5171340723f,  97.3774036676f,  274.4765604323f },
    { 95.2175000577f,  99.8907642334f,  276.0028632017f },
    { 96.2809782082f,  99.4071670618f,  278.0452202502f },
    { 97.3279719077f,  99.0485703725f,  280.0495854080f },
    { 98.3592177587f,  98.8066951758f,  282.0135906745f },
    { 99.3753982871f,  98.6736475163f,  283.9352257653f },
    { 100.3771473661f,  98.6419107537f,  285.8128371662f },
    { 101.3650549595f,  98.7043394149f,  287.6451198296f },
    { 102.3396712871f,  98.8541535891f,  289.4311027275f },
    { 103.3015104939f,  99.0849331222f,  291.1701295341f },
    { 104.2510538951f,  99.3906111161f,  292.8618356867f },
    { 105.1887528550f,  99.7654664357f,  294.5061229974f },
    { 106.1150313481f,  100.2041150884f,  296.1031328724f },
    { 107.0302882458f,  100.7015004614f,  297.6532190477f },
    { 107.9348993620f,  101.2528824904f,  299.1569205996f },
    { 108.8292192897f,  101.8538258906f,  300.6149358315f },
    { 109.7135830529f,  102.5001876214f,  302.0280974908f },
    { 110.5883075964f,  103.1881037657f,  303.3973496401f },
    { 111.4536931326f,  103.9139760158f,  304.7237263880f },
    { 112.3100243619f,  104.6744579417f,  306.0083325904f },
    { 113.1575715804f,  105.4664412117f,  307.2523265536f },
    { 113.9965916874f,  106.2870419096f,  308.4569047094f },
    { 114.8273291050f,  107.1335870757f,  309.6232881884f },
    { 115.6500166162f,  108.0036015777f,  310.7527111821f },
    { 116.4648761329f,  108.8947953949f,  311.8464109671f },
    { 117.2721193995f,  109.8050513820f,  312.9056194516f },
    { 118.0719486387f,  110.7324135599f,  313.9315560971f },
    { 118.8645571452f,  111.6750759668f,  314.9254220736f },
    { 119.6501298327f,  112.6313720883f,  315.8883955067f },
    { 120.4288437384f,  113.5997648763f,  316.8216276851f },
    { 121.2008684888f,  114.5788373533f,  317.7262401052f },
    { 121.9663667303f,  115.5672837978f,  318.6033222389f },
    { 122.7254945290f,  116.5639014920f,  319.4539299225f },
    { 123.4784017400f,  117.5675830181f,  320.2790842742f },
    { 124.2252323517f,  118.5773090779f,  321.0797710571f },
    { 124.9661248049f,  119.5921418134f,  321.8569404175f },
    { 125.7012122900f,  120.6112186025f,  322.6115069310f },
    { 126.4306230246f,  121.6337463043f,  323.3443499051f },
    { 127.1544805115f,  122.6589959267f,  324.0563138869f },
    { 127.8729037804f,  123.6862976902f,  324.7482093361f },
    { 128.5860076131f,  124.7150364631f,  325.4208134281f },
    { 129.2939027553f,  125.7446475424f,  326.0748709560f },
    { 129.9966961136f,  126.7746127566f,  326.7110953065f },
    { 130.6944909415f,  127.8044568684f,  327.3301694884f },
    { 131.3873870131f,  128.8337442538f,  327.9327471952f },
    { 132.0754807868f,  129.8620758397f,  328.5194538879f },
    { 132.7588655586f,  130.8890862782f,  329.0908878838f },
    { 133.4376316070f,  131.9144413415f,  329.6476214434f },
    { 134.1118663288f,  132.9378355196f,  330.1902018456f },
    { 134.7816543678f,  133.9589898053f,  330.7191524458f },
    { 135.4470777354f,  134.9776496520f,  331.2349737109f },
    { 136.1082159251f,  135.9935830911f,  331.7381442277f },
    { 136.7651460203f,  137.0065789951f,  332.2291216820f },
    { 137.4179427963f,  138.0164454775f,  332.7083438056f },
    { 138.0666788165f,  139.0230084152f,  333.1762292898f },
    { 138.7114245244f,  140.0261100874f,  333.6331786656f },
    { 139.3522483292f,  141.0256079185f,  334.0795751481f },
    { 139.9892166886f,  142.0213733187f,  334.5157854472f },
    { 140.6223941860f,  143.0132906143f,  334.9421605432f },
    { 141.2518436048f,  144.0012560595f,  335.3590364290f },
    { 141.8776259978f,  144.9851769248f,  335.7667348184f },
    { 142.4998007547f,  145.9649706542f,  336.1655638222f },
    { 142.0354288232f,  146.0167425793f,  336.5603877834f },
    { 141.5689544605f,  146.0747136578f,  336.9599393727f },
    { 141.1003476474f,  146.1390417702f,  337.3643174287f },
    { 140.6295775409f,  146.2098891173f,  337.7736249873f },
    { 140.1566124372f,  146.2874223620f,  338.1879695829f },
    { 139.6814197332f,  146.3718127788f,  338.6074635772f },
    { 139.2039658848f,  146.4632364095f,  339.0322245189f },
    { 138.7242163628f,  146.5618742274f,  339.4623755382f },
    { 138.2421356055f,  146.6679123096f,  339.8980457791f },
    { 137.7576869682f,  146.7815420186f,  340.3393708744f },
    { 137.2708326688f,  146.9029601938f,  340.7864934694f },
    { 136.7815337295f,  147.0323693541f,  341.2395637976f },
    { 136.2897499141f,  147.1699779131f,  341.6987403174f },
    { 135.7954396605f,  147.3160004069f,  342.1641904153f },
    { 135.2985600076f,  147.4706577384f,  342.6360911862f },
    { 134.7990665161f,  147.6341774369f,  343.1146302973f },
    { 134.2969131834f,  147.8067939375f,  343.6000069511f },
    { 133.7920523501f,  147.9887488823f,  344.0924329564f },
    { 133.2844345989f,  148.1802914453f,  344.5921339254f },
    { 132.7740086443f,  148.3816786853f,  345.0993506125f },
    { 132.2607212109f,  148.5931759315f,  345.6143404167f },
    { 131.7445169011f,  148.8150572055f,  346.1373790701f },
    { 131.2253380491f,  149.0476056869f,  346.6687625418f },
    { 130.7031245588f,  149.2911142293f,  347.2088091902f },
    { 130.1778137263f,  149.5458859359f,  347.7578622019f },
    { 129.6493400403f,  149.8122348056f,  348.3162923658f },
    { 129.1176349617f,  150.0904864631f,  348.8845012365f },
    { 128.5826266753f,  150.3809789901f,  349.4629247554f },
    { 128.0442398119f,  150.6840638779f,  350.0520374099f },
    { 127.5023951341f,  151.0001071286f,  350.6523570287f },
    { 126.9570091798f,  151.3294905371f,  351.2644503335f },
    { 126.4079938572f,  151.6726131966f,  351.8889393940f },
    { 125.8552559794f,  152.0298932805f,  352.5265091678f },
    { 125.2986967302f,  152.4017701712f,  353.1779163513f },
    { 124.7382110434f,  152.7887070241f,  353.8439998244f },
    { 124.1736868811f,  153.1911938847f,  354.5256930469f },
    { 123.6050043852f,  153.6097515134f,  355.2240388614f },
    { 123.0320348740f,  154.0449361232f,  355.9402072868f },
    { 122.4546396476f,  154.4973453074f,  356.6755170620f },
    { 121.8726685496f,  154.9676255304f,  357.4314619328f },
    { 121.2859582230f,  155.4564816988f,  358.2097430020f },
    { 120.6943299711f,  155.9646895261f,  359.0123089127f },
    { 120.0975871057f,  156.4931117019f,  359.8414062752f }
};

__CONSTANT__ float gamutCuspTableReach[360] = 
{
    309.644f,
    312.787f,
    315.869f,
    318.878f,
    321.808f,
    324.640f,
    327.374f,
    330.011f,
    332.532f,
    334.949f,
    337.250f,
    339.441f,
    341.516f,
    343.488f,
    345.349f,
    347.107f,
    348.773f,
    350.354f,
    351.843f,
    353.265f,
    354.620f,
    355.914f,
    357.159f,
    358.362f,
    359.540f,
    360.687f,
    355.096f,
    342.340f,
    330.579f,
    319.696f,
    309.601f,
    300.220f,
    291.473f,
    283.313f,
    275.684f,
    268.530f,
    261.823f,
    255.511f,
    249.579f,
    243.988f,
    238.715f,
    233.734f,
    229.022f,
    224.573f,
    220.349f,
    216.351f,
    212.561f,
    208.966f,
    205.548f,
    202.301f,
    199.219f,
    196.283f,
    193.494f,
    190.845f,
    188.318f,
    185.913f,
    183.624f,
    181.451f,
    179.376f,
    177.405f,
    175.531f,
    173.749f,
    172.052f,
    170.441f,
    168.909f,
    167.456f,
    166.077f,
    164.771f,
    163.538f,
    162.372f,
    161.267f,
    160.229f,
    159.247f,
    158.331f,
    157.471f,
    156.671f,
    155.920f,
    155.231f,
    154.590f,
    153.998f,
    153.461f,
    152.979f,
    152.539f,
    152.148f,
    151.813f,
    151.520f,
    151.270f,
    151.074f,
    150.922f,
    150.812f,
    150.751f,
    150.739f,
    150.769f,
    150.848f,
    150.970f,
    151.141f,
    151.361f,
    151.624f,
    151.935f,
    152.295f,
    152.698f,
    153.156f,
    153.662f,
    154.218f,
    154.828f,
    155.487f,
    156.201f,
    156.970f,
    157.794f,
    158.673f,
    159.613f,
    160.614f,
    161.676f,
    162.805f,
    164.001f,
    165.259f,
    166.595f,
    167.999f,
    169.482f,
    171.039f,
    172.687f,
    174.414f,
    176.233f,
    178.143f,
    180.151f,
    182.257f,
    184.479f,
    186.804f,
    189.252f,
    191.827f,
    194.531f,
    197.369f,
    200.354f,
    203.497f,
    206.805f,
    210.284f,
    213.953f,
    217.816f,
    221.893f,
    226.190f,
    230.731f,
    235.535f,
    240.619f,
    245.996f,
    251.703f,
    257.764f,
    264.203f,
    268.195f,
    261.218f,
    254.633f,
    248.407f,
    242.511f,
    236.932f,
    231.641f,
    226.624f,
    221.857f,
    217.328f,
    213.025f,
    208.923f,
    205.023f,
    201.312f,
    197.766f,
    194.391f,
    191.168f,
    188.098f,
    185.162f,
    182.361f,
    179.681f,
    177.130f,
    174.683f,
    172.351f,
    170.117f,
    167.981f,
    165.942f,
    163.995f,
    162.134f,
    160.352f,
    158.649f,
    157.025f,
    155.475f,
    153.992f,
    152.576f,
    151.227f,
    149.945f,
    148.718f,
    147.552f,
    146.442f,
    145.392f,
    144.391f,
    143.445f,
    142.548f,
    141.705f,
    140.906f,
    140.155f,
    139.447f,
    138.788f,
    138.171f,
    137.598f,
    137.067f,
    136.572f,
    136.127f,
    135.718f,
    135.345f,
    135.016f,
    134.723f,
    134.473f,
    134.259f,
    134.082f,
    133.942f,
    133.838f,
    133.771f,
    133.740f,
    133.752f,
    133.795f,
    133.881f,
    133.997f,
    134.155f,
    134.351f,
    134.583f,
    134.851f,
    135.156f,
    135.504f,
    135.889f,
    136.316f,
    136.780f,
    137.286f,
    137.836f,
    138.428f,
    139.056f,
    139.734f,
    140.454f,
    141.223f,
    142.035f,
    142.896f,
    143.805f,
    144.763f,
    145.776f,
    146.838f,
    147.961f,
    149.133f,
    150.366f,
    151.660f,
    153.015f,
    154.431f,
    155.920f,
    157.471f,
    159.094f,
    160.791f,
    162.567f,
    164.423f,
    166.357f,
    168.384f,
    170.496f,
    172.699f,
    175.000f,
    177.405f,
    179.913f,
    182.538f,
    185.272f,
    188.135f,
    191.119f,
    194.238f,
    197.498f,
    200.903f,
    204.462f,
    208.185f,
    212.079f,
    216.144f,
    216.992f,
    215.265f,
    213.617f,
    212.054f,
    210.565f,
    209.155f,
    207.819f,
    206.555f,
    205.359f,
    204.230f,
    203.168f,
    202.173f,
    201.239f,
    200.366f,
    199.554f,
    198.798f,
    198.108f,
    197.467f,
    196.887f,
    196.362f,
    195.892f,
    195.477f,
    195.117f,
    194.806f,
    194.550f,
    194.342f,
    194.189f,
    194.086f,
    194.037f,
    194.037f,
    194.086f,
    194.189f,
    194.336f,
    194.537f,
    194.794f,
    195.099f,
    195.453f,
    195.856f,
    196.313f,
    196.826f,
    197.388f,
    197.998f,
    198.669f,
    199.390f,
    200.165f,
    200.995f,
    201.880f,
    202.820f,
    203.821f,
    204.877f,
    205.988f,
    207.166f,
    208.398f,
    209.692f,
    211.047f,
    212.469f,
    213.953f,
    215.503f,
    217.114f,
    218.799f,
    220.544f,
    222.363f,
    224.249f,
    226.208f,
    228.241f,
    230.341f,
    232.513f,
    234.760f,
    237.079f,
    239.471f,
    241.937f,
    244.476f,
    247.089f,
    249.774f,
    252.527f,
    255.347f,
    258.240f,
    261.188f,
    264.203f,
    267.279f,
    270.404f,
    273.578f,
    276.794f,
    280.048f,
    283.331f,
    286.633f,
    289.954f,
    293.280f,
    296.600f,
    299.908f,
    303.192f,
    306.439f
};

__CONSTANT__ float3 cGamutCuspTable[360] = 
{
    { 129.7597337234f,  207.5442915815f,  0.2995950820f },
    { 129.2825291375f,  208.2812848895f,  0.8963241565f },
    { 128.8014851239f,  209.0318875047f,  1.5111739725f },
    { 128.3164286017f,  209.7963191772f,  2.1459278171f },
    { 127.8271656411f,  210.5748182210f,  2.8026569415f },
    { 127.3334770984f,  211.3676499652f,  3.4837864424f },
    { 126.8351129438f,  212.1751192353f,  4.1921814116f },
    { 126.3317847656f,  212.9975889445f,  4.9312614412f },
    { 125.8231556731f,  213.8355081107f,  5.7051556631f },
    { 125.3088263967f,  214.6894547356f,  6.5189171615f },
    { 124.7883156678f,  215.5602027070f,  7.3788268408f },
    { 124.2610317079f,  216.4488287431f,  8.2928365636f },
    { 123.7262293436f,  217.3568885529f,  9.2712376733f },
    { 123.1829427801f,  218.2867181259f,  10.3277115920f },
    { 122.6298747261f,  219.2419741199f,  11.4810659677f },
    { 122.0652014536f,  220.2286644478f,  12.7582917212f },
    { 121.4862002329f,  221.2572808741f,  14.2004114606f },
    { 120.8884511655f,  222.3477420508f,  15.8750150128f },
    { 120.2638144427f,  223.5429603161f,  17.9080252117f },
    { 119.5936445223f,  224.9583783796f,  20.5901809105f },
    { 118.8053664267f,  227.1344466926f,  25.0569434115f },
    { 120.6356790073f,  218.7992382788f,  26.4066095178f },
    { 122.4134509840f,  211.1056144729f,  27.7808994593f },
    { 124.1437212292f,  203.9873241847f,  29.1802793103f },
    { 125.8307224882f,  197.3893071887f,  30.6049458724f },
    { 127.4780533999f,  191.2652639303f,  32.0548414729f },
    { 129.0888059587f,  185.5758493692f,  33.5296639232f },
    { 130.6656617481f,  180.2873049966f,  35.0288735369f },
    { 132.2109658112f,  175.3704052235f,  36.5516986756f },
    { 133.7267841958f,  170.7996337182f,  38.0971409766f },
    { 135.2149493777f,  166.5525309394f,  39.6639811816f },
    { 136.6770965457f,  162.6091712210f,  41.2507862977f },
    { 138.1146928989f,  158.9517394155f,  42.8559186570f },
    { 139.5290615365f,  155.5641851787f,  44.4775472920f },
    { 140.9214011140f,  152.4319386664f,  46.1136618966f },
    { 142.2928021480f,  149.5416754721f,  47.7620894969f },
    { 143.6442606463f,  146.8811215685f,  49.4205138127f },
    { 144.9766895804f,  144.4388911492f,  51.0864971461f },
    { 146.2909286063f,  142.2043518344f,  52.7575045057f },
    { 147.5877523500f,  140.1675128556f,  54.4309295505f },
    { 148.8678775100f,  138.3189326921f,  56.1041218406f },
    { 150.1319689783f,  136.6496432603f,  57.7744148039f },
    { 151.3806451409f,  135.1510882329f,  59.4391537855f },
    { 152.6144824890f,  133.8150734180f,  61.0957235266f },
    { 153.8340196494f,  132.6337274020f,  62.7415744404f },
    { 155.0397609197f,  131.5994708704f,  64.3742470985f },
    { 156.2321793831f,  130.7049931983f,  65.9913944135f },
    { 157.4117196613f,  129.9432350458f,  67.5908011000f },
    { 158.5788003571f,  129.3073758287f,  69.1704001013f },
    { 159.7338162284f,  128.7908250535f,  70.7282857886f },
    { 160.8771401287f,  128.3872166248f,  72.2627238515f },
    { 162.0091247452f,  128.0904053428f,  73.7721579106f },
    { 163.1301041596f,  127.8944649180f,  75.2552129783f },
    { 164.2403952529f,  127.7936869357f,  76.7106959791f },
    { 165.3402989741f,  127.7825803015f,  78.1375936036f },
    { 166.4301014879f,  127.8558707905f,  79.5350678153f },
    { 167.5100752158f,  128.0085004114f,  80.9024493618f },
    { 168.5804797826f,  128.2356263712f,  82.2392296460f },
    { 169.6415628784f,  128.5326194923f,  83.5450513168f },
    { 170.6935610458f,  128.8950619950f,  84.8196979160f },
    { 171.7367003995f,  129.3187446014f,  86.0630828993f },
    { 172.7711972861f,  129.7996629603f,  87.2752383128f },
    { 173.7972588898f,  130.3340134187f,  88.4563033744f },
    { 174.8150837890f,  130.9181881901f,  89.6065131712f },
    { 175.8248624693f,  131.5487699846f,  90.7261876464f },
    { 176.8267777972f,  132.2225261750f,  91.8157210148f },
    { 177.8210054569f,  132.9364025796f,  92.8755717120f },
    { 178.8077143554f,  133.6875169410f,  93.9062529548f },
    { 179.7870669977f,  134.4731521811f,  94.9083239610f },
    { 180.7592198346f,  135.2907495060f,  95.8823818571f },
    { 181.7243235863f,  136.1379014305f,  96.8290542839f },
    { 182.6825235437f,  137.0123447844f,  97.7489926918f },
    { 183.6339598485f,  137.9119537561f,  98.6428663107f },
    { 184.5787677551f,  138.8347330217f,  99.5113567650f },
    { 185.5170778748f,  139.7788110003f,  100.3551533012f },
    { 186.4490164040f,  140.7424332701f,  101.1749485906f },
    { 187.3747053385f,  141.7239561718f,  101.9714350650f },
    { 188.2942626733f,  142.7218406230f,  102.7453017452f },
    { 189.2078025908f,  143.7346461582f,  103.4972315176f },
    { 190.1154356369f,  144.7610252076f,  104.2278988208f },
    { 191.0172688870f,  145.7997176212f,  104.9379676995f },
    { 190.4824321764f,  145.9096206143f,  105.6376342366f },
    { 189.9453635459f,  146.0430590578f,  106.3409035539f },
    { 189.4060361492f,  146.2004503522f,  107.0475957968f },
    { 188.8644225909f,  146.3822108669f,  107.7575254038f },
    { 188.3204949114f,  146.5887556631f,  108.4705013496f },
    { 187.7742245701f,  146.8204982270f,  109.1863274129f },
    { 187.2255824282f,  147.0778502142f,  109.9048024657f },
    { 186.6745387315f,  147.3612212072f,  110.6257207836f },
    { 186.1210630912f,  147.6710184881f,  111.3488723770f },
    { 185.5651244655f,  148.0076468283f,  112.0740433414f },
    { 185.0066911392f,  148.3715082964f,  112.8010162254f },
    { 184.4457307033f,  148.7630020863f,  113.5295704151f },
    { 183.8822100335f,  149.1825243679f,  114.2594825343f },
    { 183.3160952679f,  149.6304681605f,  114.9905268563f },
    { 182.7473517834f,  150.1072232324f,  115.7224757287f },
    { 182.1759441720f,  150.6131760260f,  116.4551000063f },
    { 181.6018362153f,  151.1487096115f,  117.1881694925f },
    { 181.0249908583f,  151.7142036703f,  117.9214533850f },
    { 180.4453701822f,  152.3100345079f,  118.6547207260f },
    { 179.8629353755f,  152.9365750993f,  119.3877408522f },
    { 179.2776467049f,  153.5941951663f,  120.1202838446f },
    { 178.6894634837f,  154.2832612890f,  120.8521209752f },
    { 178.0983440398f,  155.0041370507f,  121.5830251475f },
    { 177.5042456817f,  155.7571832185f,  122.3127713305f },
    { 176.9071246635f,  156.5427579581f,  123.0411369832f },
    { 176.3069361476f,  157.3612170861f,  123.7679024675f },
    { 175.7036341667f,  158.2129143566f,  124.4928514480f },
    { 175.0971715831f,  159.0982017857f,  125.2157712776f },
    { 174.4875000466f,  160.0174300120f,  125.9364533660f },
    { 173.8745699506f,  160.9709486934f,  126.6546935309f },
    { 173.2583303854f,  161.9591069409f,  127.3702923297f },
    { 172.6387290904f,  162.9822537892f,  128.0830553718f },
    { 172.0157124029f,  164.0407387038f,  128.7927936085f },
    { 171.3892252051f,  165.1349121237f,  129.4993236021f },
    { 170.7592108679f,  166.2651260423f,  130.2024677717f },
    { 170.1256111928f,  167.4317346227f,  130.9020546161f },
    { 169.4883663501f,  168.6350948503f,  131.5979189133f },
    { 168.8474148138f,  169.8755672219f,  132.2899018968f },
    { 168.2026932942f,  171.1535164700f,  132.9778514076f },
    { 167.5541366659f,  172.4693123249f,  133.6616220240f },
    { 166.9016778927f,  173.8233303124f,  134.3410751672f },
    { 166.2452479477f,  175.2159525893f,  135.0160791851f },
    { 165.5847757305f,  176.6475688164f,  135.6865094140f },
    { 164.9201879783f,  178.1185770695f,  136.3522482183f },
    { 164.2514091730f,  179.6293847900f,  137.0131850106f },
    { 163.5783614431f,  181.1804097757f,  137.6692162514f },
    { 162.9009644598f,  182.7720812128f,  138.3202454303f },
    { 162.2191353267f,  184.4048407518f,  138.9661830293f },
    { 161.5327884647f,  186.0791436275f,  139.6069464697f },
    { 160.8418354878f,  187.7954598275f,  140.2424600431f },
    { 160.1461850736f,  189.5542753091f,  140.8726548288f },
    { 159.4457428250f,  191.3560932696f,  141.4974685963f },
    { 158.7404111234f,  193.2014354724f,  142.1168456981f },
    { 158.0300889728f,  195.0908436326f,  142.7307369494f },
    { 157.3146718348f,  197.0248808662f,  143.3390994998f },
    { 156.5940514525f,  199.0041332084f,  143.9418966956f },
    { 155.8681156625f,  201.0292112050f,  144.5390979354f },
    { 155.1367481960f,  203.1007515842f,  145.1306785191f },
    { 154.3998284652f,  205.2194190140f,  145.7166194919f },
    { 153.6572313366f,  207.3859079541f,  146.2969074851f },
    { 154.1282111915f,  199.9177661955f,  147.7539617107f },
    { 154.5724450387f,  193.8623443981f,  149.0393415548f },
    { 154.9991131792f,  188.7215555943f,  150.2139105557f },
    { 155.4130542643f,  184.2330591108f,  151.3098259606f },
    { 155.8171799736f,  180.2391047625f,  152.3464469071f },
    { 156.2133998041f,  176.6363224996f,  153.3364532717f },
    { 156.6030444664f,  173.3527413638f,  154.2886566843f },
    { 156.9870843735f,  170.3359330247f,  155.2094552550f },
    { 157.3662525950f,  167.5463406161f,  156.1036542174f },
    { 157.7411187701f,  164.9532689438f,  156.9749602940f },
    { 158.1121359133f,  162.5323454553f,  157.8262953467f },
    { 158.4796713330f,  160.2638431550f,  158.6600039148f },
    { 158.8440277813f,  158.1315334340f,  159.4779954041f },
    { 159.2054583541f,  156.1218779205f,  160.2818444046f },
    { 159.5641772551f,  154.2234446582f,  161.0728632649f },
    { 159.9203677431f,  152.4264770678f,  161.8521557491f },
    { 160.2741881126f,  150.7225696090f,  162.6206574677f },
    { 160.6257762691f,  149.1044196101f,  163.3791668573f },
    { 160.9752532834f,  147.5656345371f,  164.1283692764f },
    { 161.3227261881f,  146.1005803177f,  164.8688559981f },
    { 161.6682902055f,  144.7042605387f,  165.6011393627f },
    { 162.0120305409f,  143.3722191910f,  166.3256649988f },
    { 162.3540238416f,  142.1004615994f,  167.0428217796f },
    { 162.6943393929f,  140.8853895602f,  167.7529500077f },
    { 163.0330401080f,  139.7237476951f,  168.4563482005f },
    { 163.3701833533f,  138.6125787473f,  169.1532787586f },
    { 163.7058216406f,  137.5491860695f,  169.8439727355f },
    { 164.0400032121f,  136.5311019436f,  170.5286338776f },
    { 164.3727725377f,  135.5560606656f,  171.2074420660f },
    { 164.7041707401f,  134.6219755528f,  171.8805562675f },
    { 165.0342359594f,  133.7269191985f,  172.5481170760f },
    { 165.3630036691f,  132.8691064346f,  173.2102489133f },
    { 165.6905069488f,  132.0468795640f,  173.8670619429f },
    { 166.0167767228f,  131.2586955055f,  174.5186537419f },
    { 166.3418419683f,  130.5031145595f,  175.1651107664f },
    { 166.6657298984f,  129.7787905526f,  175.8065096416f },
    { 166.9884661232f,  129.0844621618f,  176.4429183002f },
    { 167.3100747924f,  128.4189452511f,  177.0743969906f },
    { 167.6305787217f,  127.7811260809f,  177.7009991731f },
    { 167.9499995055f,  127.1699552730f,  178.3227723163f },
    { 168.2683576172f,  126.5844424313f,  178.9397586086f },
    { 168.5856724991f,  126.0236513349f,  179.5519955940f },
    { 168.9019626431f,  125.4866956300f,  180.1595167419f },
    { 169.2172456634f,  124.9727349610f,  180.7623519571f },
    { 169.5315383618f,  124.4809714870f,  181.3605280390f },
    { 169.8448567870f,  124.0106467373f,  181.9540690939f },
    { 170.1572162880f,  123.5610387695f,  182.5429969054f },
    { 170.4686315632f,  123.1314595921f,  183.1273312688f },
    { 170.7791167043f,  122.7212528256f,  183.7070902914f },
    { 171.0886852370f,  122.3297915736f,  184.2822906632f },
    { 171.3973501575f,  121.9564764832f,  184.8529479004f },
    { 171.7051239667f,  121.6007339729f,  185.4190765648f },
    { 172.0120187009f,  121.2620146123f,  185.9806904607f },
    { 172.3180459602f,  120.9397916374f,  186.5378028115f },
    { 172.6232169347f,  120.6335595876f,  187.0904264190f },
    { 172.9275424285f,  120.3428330534f,  187.6385738050f },
    { 173.2310328821f,  120.0671455224f,  188.1822573380f },
    { 173.5336983927f,  119.8060483166f,  188.7214893465f },
    { 173.8355487330f,  119.5591096101f,  189.2562822192f },
    { 174.1365933695f,  119.3259135205f,  189.7866484936f },
    { 173.1208552045f,  118.3543903556f,  190.3217648819f },
    { 172.0974101945f,  117.3836460422f,  190.8706391223f },
    { 171.0660984010f,  116.4140009964f,  191.4337635958f },
    { 170.0267543421f,  115.4457993197f,  192.0116505352f },
    { 168.9792067202f,  114.4794105005f,  192.6048326855f },
    { 167.9232781332f,  113.5152312389f,  193.2138639477f },
    { 166.8587847673f,  112.5536874039f,  193.8393200008f },
    { 165.7855360683f,  111.5952361326f,  194.4817988919f },
    { 164.7033343927f,  110.6403680795f,  195.1419215814f },
    { 163.6119746336f,  109.6896098274f,  195.8203324345f },
    { 162.5112438224f,  108.7435264678f,  196.5176996400f },
    { 161.4009207016f,  107.8027243627f,  197.2347155425f },
    { 160.2807752679f,  106.8678540983f,  197.9720968670f },
    { 159.1505682827f,  105.9396136397f,  198.7305848143f },
    { 158.0100507460f,  105.0187516995f,  199.5109450015f },
    { 156.8589633323f,  104.1060713282f,  200.3139672199f },
    { 155.6970357832f,  103.2024337391f,  201.1404649776f },
    { 154.5239862536f,  102.3087623751f,  201.9912747915f },
    { 153.3395206065f,  101.4260472274f,  202.8672551896f },
    { 152.1433316529f,  100.5553494131f,  203.7692853798f },
    { 150.9350983284f,  99.6978060192f,  204.6982635379f },
    { 149.7144848039f,  98.8546352158f,  205.6551046639f },
    { 148.4811395201f,  98.0271416430f,  206.6407379524f },
    { 147.2346941408f,  97.2167220701f,  207.6561036190f },
    { 145.9747624139f,  96.4248713250f,  208.7021491232f },
    { 144.7009389320f,  95.6531884882f,  209.7798247293f },
    { 143.4127977803f,  94.9033833410f,  210.8900783423f },
    { 142.1098910596f,  94.1772830558f,  212.0338495662f },
    { 140.7917472698f,  93.4768391109f,  213.2120629298f },
    { 139.4578695378f,  92.8041344098f,  214.4256202404f },
    { 138.1077336703f,  92.1613905818f,  215.6753920353f },
    { 136.7407860109f,  91.5509754378f,  216.9622081188f },
    { 135.3564410761f,  90.9754105571f,  218.2868471980f },
    { 133.9540789428f,  90.4373789796f,  219.6500256572f },
    { 132.5330423524f,  89.9397329859f,  221.0523855502f },
    { 131.0926334961f,  89.4855019566f,  222.4944819305f },
    { 129.6321104345f,  89.0779003166f,  223.9767696924f },
    { 128.1506831016f,  88.7203355967f,  225.4995901539f },
    { 126.6475088309f,  88.4164166727f,  227.0631576751f },
    { 125.1216873337f,  88.1699622942f,  228.6675466768f },
    { 123.5722550431f,  87.9850100686f,  230.3126794946f },
    { 121.9981787257f,  87.8658261481f,  231.9983155766f },
    { 120.3983482382f,  87.8169159663f,  233.7240426002f },
    { 118.7715682887f,  87.8430364940f,  235.4892701453f },
    { 117.1165490264f,  87.9492106451f,  237.2932266102f },
    { 115.4318952525f,  88.1407446506f,  239.1349600916f },
    { 113.7160939943f,  88.4232494655f,  241.0133439646f },
    { 111.9675001303f,  88.8026675619f,  242.9270878987f },
    { 110.1843196775f,  89.2853068328f,  244.8747550234f },
    { 108.3645902591f,  89.8778837917f,  246.8547859246f },
    { 106.5061581469f,  90.5875788358f,  248.8655301202f },
    { 104.6066511145f,  91.4221071004f,  250.9052856425f },
    { 102.6634461250f,  92.3898094293f,  252.9723473723f },
    { 100.6736305966f,  93.4997693300f,  255.0650648629f },
    { 98.6339556108f,  94.7619636299f,  257.1819105966f },
    { 96.5407789082f,  96.1874571423f,  259.3215600065f },
    { 94.3899948027f,  97.7886553617f,  261.4829852555f },
    { 92.1769471307f,  99.5796346353f,  263.6655658175f },
    { 89.8963199126f,  101.5765773400f,  265.8692205558f },
    { 87.5419982927f,  103.7983519175f,  268.0945685468f },
    { 89.0221714274f,  102.5106192048f,  271.3661247650f },
    { 90.4661001671f,  101.5769209247f,  274.5779326338f },
    { 91.8763147968f,  100.9672711325f,  277.7165433443f },
    { 93.2550618441f,  100.6529772222f,  280.7703373815f },
    { 94.6043467333f,  100.6066824395f,  283.7297392923f },
    { 95.9259685457f,  100.8024447760f,  286.5873003384f },
    { 97.2215485998f,  101.2158230707f,  289.3376647849f },
    { 98.4925541402f,  101.8239502256f,  291.9774434731f },
    { 99.7403181207f,  102.6055815592f,  294.5050216131f },
    { 100.9660558396f,  103.5411129785f,  296.9203271045f },
    { 102.1708790168f,  104.6125686123f,  299.2245823419f },
    { 103.3558077796f,  105.8035608405f,  301.4200576693f },
    { 104.5217809208f,  107.0992275147f,  303.5098394777f },
    { 105.6696647275f,  108.4861518903f,  305.4976211649f },
    { 106.8002606137f,  109.9522707444f,  307.3875211952f },
    { 107.9143117500f,  111.4867756100f,  309.1839294742f },
    { 109.0125088468f,  113.0800112770f,  310.8913811497f },
    { 110.0954952189f,  114.7233748458f,  312.5144556283f },
    { 111.1638712382f,  116.4092177931f,  314.0576978992f },
    { 112.2181982622f,  118.1307527756f,  315.5255589968f },
    { 113.2590021112f,  119.8819662807f,  316.9223524721f },
    { 114.2867761570f,  121.6575377486f,  318.2522239701f },
    { 115.3019840743f,  123.4527654119f,  319.5191313221f },
    { 116.3050622986f,  125.2634988312f,  320.7268329196f },
    { 117.2964222282f,  127.0860779085f,  321.8788824865f },
    { 118.2764522023f,  128.9172780412f,  322.9786286959f },
    { 119.2455192820f,  130.7542609996f,  324.0292183682f },
    { 120.2039708580f,  132.5945310768f,  325.0336022425f },
    { 121.1521361049f,  134.4358960450f,  325.9945425242f },
    { 122.0903273004f,  136.2764324642f,  326.9146215904f },
    { 123.0188410226f,  138.1144549046f,  327.7962513767f },
    { 123.9379592418f,  139.9484886730f,  328.6416830871f },
    { 124.8479503148f,  141.7772456649f,  329.4530169599f },
    { 125.7490698945f,  143.5996029946f,  330.2322118936f },
    { 126.6415617621f,  145.4145840919f,  330.9810947983f },
    { 127.5256585910f,  147.2213419797f,  331.7013695760f },
    { 128.4015826471f,  149.0191444834f,  332.3946256712f },
    { 129.2695464349f,  150.8073611453f,  333.0623461560f },
    { 130.1297532911f,  152.5854516442f,  333.7059153340f },
    { 130.9823979336f,  154.3529555441f,  334.3266258610f },
    { 131.8276669683f,  156.1094832154f,  334.9256853893f },
    { 132.6657393581f,  157.8547077902f,  335.5042227506f },
    { 133.4967868573f,  159.5883580312f,  336.0632936980f },
    { 134.3209744152f,  161.3102120057f,  336.6038862271f },
    { 135.1384605505f,  163.0200914718f,  337.1269255023f },
    { 135.9493976994f,  164.7178568933f,  337.6332784111f },
    { 136.7539325405f,  166.4034030102f,  338.1237577728f },
    { 137.5522062967f,  168.0766549006f,  338.5991262242f },
    { 138.3443550176f,  169.7375644781f,  339.0600998067f },
    { 139.1305098433f,  171.3861073740f,  339.5073512761f },
    { 139.9107972501f,  173.0222801616f,  339.9415131573f },
    { 140.6853392824f,  174.6460978826f,  340.3631805627f },
    { 141.4542537679f,  176.2575918427f,  340.7729137937f },
    { 142.2176545210f,  177.8568076462f,  341.1712407416f },
    { 142.9756515328f,  179.4438034419f,  341.5586591050f },
    { 143.7283511502f,  181.0186483588f,  341.9356384373f },
    { 144.4758562438f,  182.5814211090f,  342.3026220391f },
    { 145.2182663663f,  184.1322087407f,  342.6600287075f },
    { 145.9556779019f,  185.6711055245f,  343.0082543538f },
    { 146.6881842063f,  187.1982119588f,  343.3476735001f },
    { 146.3034876066f,  187.5302507455f,  343.6828551521f },
    { 145.9172187325f,  187.8696138313f,  344.0208919732f },
    { 145.5293552527f,  188.2164190014f,  344.3618498986f },
    { 145.1398741941f,  188.5707860223f,  344.7057983530f },
    { 144.7487519113f,  188.9328366668f,  345.0528105049f },
    { 144.3559640542f,  189.3026947371f,  345.4029635418f },
    { 143.9614855336f,  189.6804860872f,  345.7563389717f },
    { 143.5652904838f,  190.0663386434f,  346.1130229507f },
    { 143.1673522232f,  190.4603824229f,  346.4731066429f },
    { 142.7676432111f,  190.8627495509f,  346.8366866125f },
    { 142.3661350021f,  191.2735742746f,  347.2038652557f },
    { 141.9627981957f,  191.6929929750f,  347.5747512740f },
    { 141.5576023833f,  192.1211441755f,  347.9494601951f },
    { 141.1505160896f,  192.5581685473f,  348.3281149475f },
    { 140.7415067096f,  193.0042089105f,  348.7108464956f },
    { 140.3305404403f,  193.4594102320f,  349.0977945408f },
    { 139.9175822054f,  193.9239196176f,  349.4891083013f },
    { 139.5025955742f,  194.3978862997f,  349.8849473769f },
    { 139.0855426719f,  194.8814616193f,  350.2854827130f },
    { 138.6663840819f,  195.3747990021f,  350.6908976770f },
    { 138.2450787378f,  195.8780539277f,  351.1013892625f },
    { 137.8215838043f,  196.3913838926f,  351.5171694407f },
    { 137.3958545454f,  196.9149483659f,  351.9384666815f },
    { 136.9678441784f,  197.4489087371f,  352.3655276690f },
    { 136.5375037111f,  197.9934282580f,  352.7986192436f },
    { 136.1047817595f,  198.5486719766f,  353.2380306068f },
    { 135.6696243438f,  199.1148066653f,  353.6840758327f },
    { 135.2319746584f,  199.6920007453f,  354.1370967399f },
    { 134.7917728123f,  200.2804242078f,  354.5974661857f },
    { 134.3489555338f,  200.8802485370f,  355.0655918623f },
    { 133.9034558336f,  201.4916466395f,  355.5419206884f },
    { 133.4552026190f,  202.1147927884f,  356.0269439123f },
    { 133.0041202494f,  202.7498625923f,  356.5212030717f },
    { 132.5501280203f,  203.3970330053f,  357.0252969877f },
    { 132.0931395629f,  204.0564823999f,  357.5398900193f },
    { 131.6330621394f,  204.7283907339f,  358.0657218620f },
    { 131.1697958099f,  205.4129398562f,  358.6036192536f },
    { 130.7032324423f,  206.1103140125f,  359.1545100540f },
    { 130.2332545237f,  206.8207006405f,  359.7194403071f }
};

// cGamutReachTable removed as it duplicates gamutCuspTableReach

__CONSTANT__ float gamutTopGamma[360] = 
{
    0.893084716796875f,
    0.892089843750000f,
    0.891119384765625f,
    0.890161132812500f,
    0.889221191406250f,
    0.888305664062500f,
    0.887408447265625f,
    0.886529541015625f,
    0.885681152343750f,
    0.884851074218750f,
    0.884039306640625f,
    0.883258056640625f,
    0.882507324218750f,
    0.881768798828125f,
    0.881066894531250f,
    0.880383300781250f,
    0.879724121093750f,
    0.879095458984375f,
    0.878491210937500f,
    0.877899169921875f,
    0.877355957031250f,
    0.876800537109375f,
    0.876275634765625f,
    0.875805664062500f,
    0.875323486328125f,
    0.874822998046875f,
    0.874371337890625f,
    0.873974609375000f,
    0.873632812500000f,
    0.874420166015625f,
    0.876739501953125f,
    0.878851318359375f,
    0.880938720703125f,
    0.882873535156250f,
    0.884729003906250f,
    0.886553955078125f,
    0.888208007812500f,
    0.889880371093750f,
    0.891430664062500f,
    0.892944335937500f,
    0.894421386718750f,
    0.895812988281250f,
    0.897216796875000f,
    0.898498535156250f,
    0.899804687500000f,
    0.901025390625000f,
    0.902246093750000f,
    0.903417968750000f,
    0.904553222656250f,
    0.905682373046875f,
    0.906756591796875f,
    0.907843017578125f,
    0.908850097656250f,
    0.909887695312500f,
    0.910858154296875f,
    0.911840820312500f,
    0.912786865234375f,
    0.913720703125000f,
    0.914642333984375f,
    0.915527343750000f,
    0.916436767578125f,
    0.917279052734375f,
    0.918145751953125f,
    0.918969726562500f,
    0.919793701171875f,
    0.920611572265625f,
    0.921398925781250f,
    0.922210693359375f,
    0.922955322265625f,
    0.923730468750000f,
    0.924481201171875f,
    0.925207519531250f,
    0.925958251953125f,
    0.926660156250000f,
    0.927362060546875f,
    0.928082275390625f,
    0.928741455078125f,
    0.929412841796875f,
    0.930090332031250f,
    0.930718994140625f,
    0.931353759765625f,
    0.931982421875000f,
    0.932592773437500f,
    0.933172607421875f,
    0.933746337890625f,
    0.934307861328125f,
    0.934863281250000f,
    0.935369873046875f,
    0.935852050781250f,
    0.936315917968750f,
    0.936749267578125f,
    0.937152099609375f,
    0.937518310546875f,
    0.937835693359375f,
    0.938110351562500f,
    0.938317871093750f,
    0.938464355468750f,
    0.938531494140625f,
    0.938507080078125f,
    0.938385009765625f,
    0.938116455078125f,
    0.937677001953125f,
    0.937066650390625f,
    0.936212158203125f,
    0.928656005859375f,
    0.909857177734375f,
    0.890490722656250f,
    0.870367431640625f,
    0.866851806640625f,
    0.869976806640625f,
    0.872912597656250f,
    0.875683593750000f,
    0.878302001953125f,
    0.880780029296875f,
    0.883123779296875f,
    0.885351562500000f,
    0.887463378906250f,
    0.889471435546875f,
    0.891387939453125f,
    0.893206787109375f,
    0.894940185546875f,
    0.896600341796875f,
    0.898181152343750f,
    0.899688720703125f,
    0.901129150390625f,
    0.902508544921875f,
    0.903826904296875f,
    0.905090332031250f,
    0.906298828125000f,
    0.907452392578125f,
    0.908551025390625f,
    0.909606933593750f,
    0.910614013671875f,
    0.911578369140625f,
    0.912493896484375f,
    0.913366699218750f,
    0.914202880859375f,
    0.914990234375000f,
    0.915740966796875f,
    0.916455078125000f,
    0.917126464843750f,
    0.917755126953125f,
    0.919042968750000f,
    0.922210693359375f,
    0.925177001953125f,
    0.927960205078125f,
    0.930584716796875f,
    0.933050537109375f,
    0.935375976562500f,
    0.937573242187500f,
    0.939654541015625f,
    0.941619873046875f,
    0.943481445312500f,
    0.945251464843750f,
    0.946929931640625f,
    0.948522949218750f,
    0.950036621093750f,
    0.951477050781250f,
    0.952825927734375f,
    0.954107666015625f,
    0.955334472656250f,
    0.956494140625000f,
    0.957598876953125f,
    0.958648681640625f,
    0.959649658203125f,
    0.960589599609375f,
    0.961474609375000f,
    0.962316894531250f,
    0.963116455078125f,
    0.963867187500000f,
    0.964581298828125f,
    0.965252685546875f,
    0.965887451171875f,
    0.966473388671875f,
    0.967016601562500f,
    0.967529296875000f,
    0.968005371093750f,
    0.968438720703125f,
    0.968841552734375f,
    0.969207763671875f,
    0.969531250000000f,
    0.969824218750000f,
    0.970074462890625f,
    0.970294189453125f,
    0.970477294921875f,
    0.970623779296875f,
    0.970721435546875f,
    0.970788574218750f,
    0.970819091796875f,
    0.970806884765625f,
    0.970745849609375f,
    0.970648193359375f,
    0.970501708984375f,
    0.970318603515625f,
    0.970074462890625f,
    0.976129150390625f,
    0.986193847656250f,
    0.986297607421875f,
    0.986352539062500f,
    0.986383056640625f,
    0.986407470703125f,
    0.986413574218750f,
    0.986407470703125f,
    0.986389160156250f,
    0.986364746093750f,
    0.986328125000000f,
    0.986285400390625f,
    0.986230468750000f,
    0.986175537109375f,
    0.986120605468750f,
    0.986059570312500f,
    0.985998535156250f,
    0.985919189453125f,
    0.985833740234375f,
    0.985754394531250f,
    0.985675048828125f,
    0.985595703125000f,
    0.985510253906250f,
    0.985412597656250f,
    0.985321044921875f,
    0.985235595703125f,
    0.985144042968750f,
    0.985034179687500f,
    0.984942626953125f,
    0.984857177734375f,
    0.984741210937500f,
    0.984631347656250f,
    0.984545898437500f,
    0.984423828125000f,
    0.984313964843750f,
    0.984222412109375f,
    0.984100341796875f,
    0.983984375000000f,
    0.983886718750000f,
    0.983758544921875f,
    0.983642578125000f,
    0.983538818359375f,
    0.983404541015625f,
    0.983288574218750f,
    0.983166503906250f,
    0.983038330078125f,
    0.982922363281250f,
    0.982781982421875f,
    0.982653808593750f,
    0.982531738281250f,
    0.982385253906250f,
    0.982257080078125f,
    0.982110595703125f,
    0.981964111328125f,
    0.981835937500000f,
    0.981677246093750f,
    0.981530761718750f,
    0.981378173828125f,
    0.981219482421875f,
    0.981072998046875f,
    0.980895996093750f,
    0.980731201171875f,
    0.980572509765625f,
    0.980389404296875f,
    0.980218505859375f,
    0.980035400390625f,
    0.979846191406250f,
    0.979669189453125f,
    0.979455566406250f,
    0.979260253906250f,
    0.979064941406250f,
    0.978839111328125f,
    0.978631591796875f,
    0.978405761718750f,
    0.978167724609375f,
    0.977947998046875f,
    0.977691650390625f,
    0.977435302734375f,
    0.977197265625000f,
    0.976910400390625f,
    0.976629638671875f,
    0.976367187500000f,
    0.976373291015625f,
    0.976446533203125f,
    0.976452636718750f,
    0.976519775390625f,
    0.976531982421875f,
    0.976599121093750f,
    0.976611328125000f,
    0.976672363281250f,
    0.976684570312500f,
    0.976739501953125f,
    0.976763916015625f,
    0.976812744140625f,
    0.976843261718750f,
    0.976879882812500f,
    0.976928710937500f,
    0.976953125000000f,
    0.977008056640625f,
    0.977032470703125f,
    0.977069091796875f,
    0.977117919921875f,
    0.977142333984375f,
    0.977185058593750f,
    0.977233886718750f,
    0.977258300781250f,
    0.977301025390625f,
    0.977355957031250f,
    0.977374267578125f,
    0.977410888671875f,
    0.977459716796875f,
    0.977514648437500f,
    0.977539062500000f,
    0.977575683593750f,
    0.977612304687500f,
    0.977661132812500f,
    0.977703857421875f,
    0.977746582031250f,
    0.977795410156250f,
    0.977838134765625f,
    0.977880859375000f,
    0.977923583984375f,
    0.977966308593750f,
    0.978002929687500f,
    0.978045654296875f,
    0.978094482421875f,
    0.978149414062500f,
    0.978192138671875f,
    0.978234863281250f,
    0.978289794921875f,
    0.978326416015625f,
    0.978381347656250f,
    0.978424072265625f,
    0.978479003906250f,
    0.978521728515625f,
    0.978564453125000f,
    0.978613281250000f,
    0.968389892578125f,
    0.956066894531250f,
    0.943927001953125f,
    0.931945800781250f,
    0.920074462890625f,
    0.917303466796875f,
    0.916302490234375f,
    0.915283203125000f,
    0.914257812500000f,
    0.913214111328125f,
    0.912164306640625f,
    0.911108398437500f,
    0.910046386718750f,
    0.908972167968750f,
    0.907897949218750f,
    0.906817626953125f,
    0.905743408203125f,
    0.904663085937500f,
    0.903582763671875f,
    0.902502441406250f,
    0.901428222656250f,
    0.900354003906250f,
    0.899285888671875f,
    0.898229980468750f,
    0.897180175781250f,
    0.896136474609375f,
    0.895104980468750f,
    0.894091796875000f
};

#include "hellwig_lib_v057.h"

__DEVICE__ float3 transform(int p_Width, int p_Height, int p_X, int p_Y, float p_R, float p_G, float p_B)
{
    float3 in = make_float3(p_R, p_G, p_B);
    float3 out = in;

    float3 XYZ;

    if (!invert)
    {
        XYZ = vector_dot(AP0_ACES_to_XYZ_matrix, in);
        if (ap1Clip)
        {
            float3 AP1 = vector_dot(XYZ_to_AP1_ACES_matrix, XYZ);
            AP1.x = _fmaxf(AP1.x, 0.0f);
            AP1.y = _fmaxf(AP1.y, 0.0f);
            AP1.z = _fmaxf(AP1.z, 0.0f);
            XYZ = vector_dot(AP1_ACES_to_XYZ_matrix, AP1);
        }
    }
    else
    {
        in.x = ST2084_to_linear(in.x) / referenceLuminance;
        in.y = ST2084_to_linear(in.y) / referenceLuminance;
        in.z = ST2084_to_linear(in.z) / referenceLuminance;
        XYZ = vector_dot(RGB_to_XYZ_output, in);
    }
    XYZ *= referenceLuminance;
    float3 JMh;
    if (!invert)
    {
        JMh = XYZ_to_Hellwig2022_JMh(XYZ, inWhite);
        if (toneCurve)
        {
            JMh = forwardTonescale(JMh, compressChroma);
        }
        if (gamutCompress)
        {
            JMh = compressGamut(JMh, 0);
        }
    }
    else
    {
        JMh = XYZ_to_Hellwig2022_JMh(XYZ, d65White);
        if (gamutCompress)
        {
            JMh = compressGamut(JMh, 1);
        }
        if (toneCurve)
        {
            JMh = inverseTonescale(JMh, compressChroma);
        }
    }
    if (JMhOut)
    {
        out.x = JMh.x / referenceLuminance;
        out.y = JMh.y / referenceLuminance;
        out.z = JMh.z / 360.0f;
    }
    else
    {
        if (!invert)
        {
            if (!d60Sim)
            {
                XYZ = Hellwig2022_JMh_to_XYZ(JMh , d65White) / referenceLuminance;
            }
            else
            {
                XYZ = Hellwig2022_JMh_to_XYZ(JMh , inWhite) / referenceLuminance;
                float3 creativeWhiteXYZ = vector_dot(RGB_to_XYZ_P3D60, make_float3(1.0f, 1.0f, 1.0f));
                float3 creativeWhiteRGB = vector_dot(XYZ_to_RGB_limit, creativeWhiteXYZ);
                XYZ *= 1.0f / max(creativeWhiteRGB.x, max(creativeWhiteRGB.y, creativeWhiteRGB.z));
            }
            out = vector_dot(XYZ_to_RGB_limit, XYZ);

            // Soft clamp by compressing negative display linear values
            if (softClip)
            {
                float3 compr = make_float3(clamp_thr, clamp_dist, 1.2f);
                out = compress_aces(out, compr, compr, compr, 0);
            }

            // hard clip 0-peak
            if (hardClip)
            {
                out = clamp3(referenceLuminance * out, 0.0f, daniele_n);
            }
            else
            {
                out *= referenceLuminance;
            }
            
            if (asPQ)
            {
                out = vector_dot(P3D65_to_BT2020, out);
                out.x = linear_to_ST2084(out.x);
                out.y = linear_to_ST2084(out.y);
                out.z = linear_to_ST2084(out.z);
            }
            else
            {
                out = float3spow(out / referenceLuminance, 1.0f / 2.4f);
            }
        }
        else
        {
            XYZ = Hellwig2022_JMh_to_XYZ(JMh , inWhite) / referenceLuminance;
            out = vector_dot(XYZ_to_AP0_ACES_matrix, XYZ);
        }
    }

    return out;
}