DEFINE_ACES_PARAM(IS_PARAMETRIC_ACES_TRANSFORM: 0,
                  OUTPUT_COLORSPACE_TAG: P3D65_48nits)

DEFINE_UI_PARAMS(toneCurve, Tone Curve, DCTLUI_CHECK_BOX, 1)
DEFINE_UI_PARAMS(compressChroma, Compress Chroma, DCTLUI_CHECK_BOX, 1)
DEFINE_UI_PARAMS(gamutCompress, Gamut Compress, DCTLUI_CHECK_BOX, 1)
DEFINE_UI_PARAMS(d60Sim, D60 Sim, DCTLUI_CHECK_BOX, 0)
DEFINE_UI_PARAMS(asPQ, Encode as PQ P3-D65 48nits, DCTLUI_CHECK_BOX, 0)
DEFINE_UI_PARAMS(ap1Clip, AP1 Clamp, DCTLUI_CHECK_BOX, 1)
DEFINE_UI_PARAMS(softClip, Soft Clip, DCTLUI_CHECK_BOX, 0)
DEFINE_UI_PARAMS(hardClip, Clamp, DCTLUI_CHECK_BOX, 1)
DEFINE_UI_PARAMS(invert, Invert, DCTLUI_CHECK_BOX, 0)
DEFINE_UI_PARAMS(JMhOut, Diagnostic JMh Output, DCTLUI_CHECK_BOX, 0)


typedef struct
{
    float3 x;
    float3 y;
    float3 z;
} float3x3;

// Constant values generated in Python
// https://github.com/nick-shaw/aces-ot-vwg-experiments/blob/master/python/v58_init_plot.py

__CONSTANT__ float3x3 XYZ_to_RGB_limit =
{
// XYZ to P3-D65 matrix
    { 2.4934969119f, -0.9313836179f, -0.4027107845f },
    {-0.8294889696f,  1.7626640603f,  0.0236246858f },
    { 0.0358458302f, -0.0761723893f,  0.9568845240f }
};

__CONSTANT__ float3x3 RGB_to_XYZ_output =
{
// P3-D65 to XYZ matrix
    { 0.4865709486f,  0.2656676932f,  0.1982172852f },
    { 0.2289745641f,  0.6917385218f,  0.0792869141f },
    {-0.0000000000f,  0.0451133819f,  1.0439443689f }
};

__CONSTANT__ float3x3 RGB_to_XYZ_P3D60 =
{
    { 0.5049495342f,  0.2646814889f,  0.1830150515f },
    { 0.2376233102f,  0.6891706692f,  0.0732060206f },
    {-0.0000000000f,  0.0449459132f,  0.9638792711f }
};

__CONSTANT__ float limitJmax = 100.0f;
__CONSTANT__ float midJ = 34.0965348204f; // ~10 nits in Hellwig J
__CONSTANT__ float focusDist = 1.35f;

__CONSTANT__ float daniele_n = 100.0f; // peak white
__CONSTANT__ float daniele_m_2 = 1.0471037624f;
__CONSTANT__ float daniele_s_2 = 0.9198582542f;
__CONSTANT__ float daniele_u_2 = 0.9917990155f;  

// Chroma compression scaling for HDR/SDR appearance match
__CONSTANT__ float sat = 1.3f;
__CONSTANT__ float sat_thr = 0.005f;
__CONSTANT__ float compr = 2.4f;

__CONSTANT__ float3 gamutCuspTable[360] = 
{
    { 56.6186185097f,  82.7991705957f,  0.7144441816f },
    { 56.3257539736f,  83.0869759912f,  1.6043698209f },
    { 56.0301471166f,  83.3873537826f,  2.5293648066f },
    { 55.7316515798f,  83.7010920892f,  3.4936139576f },
    { 55.4300986440f,  84.0291345807f,  4.5021633543f },
    { 55.1252910861f,  84.3726358550f,  5.5611765832f },
    { 54.8169945709f,  84.7330431271f,  6.6782956942f },
    { 54.5049252401f,  85.1122201527f,  7.8631638493f },
    { 54.1887312081f,  85.5126415289f,  9.1282071122f },
    { 53.8679638478f,  85.9377096100f,  10.4898504831f },
    { 53.5420309999f,  86.3922970277f,  11.9705021835f },
    { 53.2101159219f,  86.8837335588f,  13.6019923411f },
    { 52.8710253494f,  87.4237485761f,  15.4320158901f },
    { 52.5228725486f,  88.0327267080f,  17.5375524150f },
    { 52.1623057815f,  88.7506004193f,  20.0574496456f },
    { 51.7820982579f,  89.6727391146f,  23.2938063738f },
    { 51.3585147523f,  91.1504716205f,  28.2400666861f },
    { 52.3587025581f,  87.5878992360f,  29.7993105677f },
    { 53.3300227981f,  84.3445766179f,  31.3923527408f },
    { 54.2752157191f,  81.3852915274f,  33.0172000061f },
    { 55.1965774859f,  78.6809415254f,  34.6718596614f },
    { 56.0960580951f,  76.2071602188f,  36.3542356750f },
    { 56.9753327918f,  73.9433029168f,  38.0620715197f },
    { 57.8358553265f,  71.8716838836f,  39.7929214009f },
    { 58.6788984336f,  69.9769935899f,  41.5441403069f },
    { 59.5055851194f,  68.2458473376f,  43.3128875581f },
    { 60.3169132044f,  66.6664315580f,  45.0961406629f },
    { 61.1137748317f,  65.2282239777f,  46.8907173396f },
    { 61.8969721591f,  63.9217705412f,  48.6933040608f },
    { 62.6672301169f,  62.7385065738f,  50.5004896846f },
    { 63.4252068814f,  61.6706128752f,  52.3088027998f },
    { 64.1715025513f,  60.7108996991f,  54.1147514180f },
    { 64.9066663926f,  59.8527131906f,  55.9148636515f },
    { 65.6312029345f,  59.0898600306f,  57.7057280452f },
    { 66.3455771339f,  58.4165468903f,  59.4840323027f },
    { 67.0502187788f,  57.8273319498f,  61.2465992717f },
    { 67.7455262661f,  57.3170862170f,  62.9904192196f },
    { 68.4318698584f,  56.8809627715f,  64.7126776347f },
    { 69.1095945090f,  56.5143723613f,  66.4107780141f },
    { 69.7790223219f,  56.2129640356f,  68.0823593364f },
    { 70.4404547051f,  55.9726097091f,  69.7253081433f },
    { 71.0941742623f,  55.7893917396f,  71.3377653624f },
    { 71.7404464624f,  55.6595927602f,  72.9181281824f },
    { 72.3795211181f,  55.5796871491f,  74.4650474330f },
    { 73.0116336995f,  55.5463336445f,  75.9774210210f },
    { 73.6370065060f,  55.5563687200f,  77.4543840401f },
    { 74.2558497143f,  55.6068004251f,  78.8952961935f },
    { 74.8683623186f,  55.6948024804f,  80.2997271635f },
    { 75.4747329772f,  55.8177084747f,  81.6674405332f },
    { 76.0751407754f,  55.9730060678f,  82.9983768091f },
    { 76.6697559160f,  56.1583311462f,  84.2926360369f },
    { 77.2587403459f,  56.3714619048f,  85.5504604259f },
    { 77.8422483241f,  56.6103128574f,  86.7722173308f },
    { 78.4204269410f,  56.8729287917f,  87.9583828643f },
    { 78.9934165906f,  57.1574786950f,  89.1095263502f },
    { 79.5613514036f,  57.4622496850f,  90.2262957667f },
    { 80.1243596439f,  57.7856409802f,  91.3094042768f },
    { 80.6825640720f,  58.1261579453f,  92.3596178966f },
    { 81.2360822804f,  58.4824062444f,  93.3777443209f },
    { 81.7850270017f,  58.8530861324f,  94.3646228894f },
    { 82.3295063931f,  59.2369869099f,  95.3211156594f },
    { 82.8696242995f,  59.6329815628f,  96.2480995334f },
    { 83.4054804970f,  60.0400216043f,  97.1464593760f },
    { 83.9371709184f,  60.4571321315f,  98.0170820507f },
    { 84.4647878626f,  60.8834071049f,  98.8608513010f },
    { 84.9884201894f,  61.3180048572f,  99.6786433994f },
    { 85.5081535008f,  61.7601438332f,  100.4713234912f },
    { 86.0240703094f,  62.2090985589f,  101.2397425575f },
    { 86.5362501965f,  62.6641958389f,  101.9847349321f },
    { 87.0447699586f,  63.1248111761f,  102.7071163045f },
    { 87.5497037456f,  63.5903654078f,  103.4076821520f },
    { 88.0511231888f,  64.0603215506f,  104.0872065440f },
    { 88.5490975225f,  64.5341818471f,  104.7464412698f },
    { 89.0436936965f,  65.0114850033f,  105.3861152450f },
    { 89.5349764824f,  65.4918036100f,  106.0069341551f },
    { 90.0230085741f,  65.9747417368f,  106.6095803025f },
    { 90.5078506812f,  66.4599326907f,  107.1947126220f },
    { 90.2918826650f,  66.5035438717f,  107.7718564318f },
    { 90.0752262668f,  66.5545183214f,  108.3513883086f },
    { 89.8578749584f,  66.6129621853f,  108.9332055058f },
    { 89.6398221056f,  66.6789813468f,  109.5172026380f },
    { 89.4210609660f,  66.7526813786f,  110.1032717771f },
    { 89.2015846866f,  66.8341674949f,  110.6913025537f },
    { 88.9813863010f,  66.9235445052f,  111.2811822674f },
    { 88.7604587269f,  67.0209167700f,  111.8727960033f },
    { 88.5387947631f,  67.1263881584f,  112.4660267541f },
    { 88.3163870872f,  67.2400620084f,  113.0607555508f },
    { 88.0932282520f,  67.3620410889f,  113.6568615968f },
    { 87.8693106832f,  67.4924275650f,  114.2542224102f },
    { 87.6446266756f,  67.6313229654f,  114.8527139692f },
    { 87.4191683906f,  67.7788281541f,  115.4522108640f },
    { 87.1929278523f,  67.9350433035f,  116.0525864524f },
    { 86.9658969444f,  68.1000678730f,  116.6537130197f },
    { 86.7380674070f,  68.2740005895f,  117.2554619417f },
    { 86.5094308320f,  68.4569394323f,  117.8577038512f },
    { 86.2799786607f,  68.6489816225f,  118.4603088069f },
    { 86.0497021786f,  68.8502236157f,  119.0631464638f },
    { 85.8185925124f,  69.0607610988f,  119.6660862457f },
    { 85.5866406255f,  69.2806889924f,  120.2689975177f },
    { 85.3538373134f,  69.5101014561f,  120.8717497598f },
    { 85.1201732001f,  69.7490918994f,  121.4742127399f },
    { 84.8856387327f,  69.9977529972f,  122.0762566852f },
    { 84.6502241772f,  70.2561767098f,  122.6777524537f },
    { 84.4139196135f,  70.5244543079f,  123.2785717023f },
    { 84.1767149302f,  70.8026764025f,  123.8785870531f },
    { 83.9385998196f,  71.0909329798f,  124.4776722565f },
    { 83.6995637721f,  71.3893134412f,  125.0757023509f },
    { 83.4595960707f,  71.6979066479f,  125.6725538182f },
    { 83.2186857851f,  72.0168009716f,  126.2681047350f },
    { 82.9768217659f,  72.3460843490f,  126.8622349184f },
    { 82.7339926379f,  72.6858443422f,  127.4548260674f },
    { 82.4901867942f,  73.0361682042f,  128.0457618978f },
    { 82.2453923890f,  73.3971429490f,  128.6349282714f },
    { 81.9995973309f,  73.7688554271f,  129.2222133186f },
    { 81.7527892758f,  74.1513924059f,  129.8075075553f },
    { 81.5049556189f,  74.5448406553f,  130.3907039913f },
    { 81.2560834873f,  74.9492870381f,  130.9716982336f },
    { 81.0061597320f,  75.3648186052f,  131.5503885806f },
    { 80.7551709190f,  75.7915226961f,  132.1266761106f },
    { 80.5031033212f,  76.2294870440f,  132.7004647619f },
    { 80.2499429086f,  76.6787998860f,  133.2716614054f },
    { 79.9956753394f,  77.1395500776f,  133.8401759103f },
    { 79.7402859501f,  77.6118272129f,  134.4059212018f },
    { 79.4837597447f,  78.0957217486f,  134.9688133114f },
    { 79.2260813848f,  78.5913251340f,  135.5287714201f },
    { 78.9672351780f,  79.0987299442f,  136.0857178939f },
    { 78.7072050664f,  79.6180300200f,  136.6395783124f },
    { 78.4459746146f,  80.1493206110f,  137.1902814906f },
    { 78.1835269972f,  80.6926985246f,  137.7377594933f },
    { 77.9198449854f,  81.2482622799f,  138.2819476434f },
    { 77.6549109333f,  81.8161122659f,  138.8227845238f },
    { 77.3887067641f,  82.3963509056f,  139.3602119728f },
    { 77.1212139545f,  82.9890828253f,  139.8941750738f },
    { 76.8524135193f,  83.5944150285f,  140.4246221394f },
    { 76.5822859953f,  84.2124570766f,  140.9515046901f },
    { 76.3108114238f,  84.8433212738f,  141.4747774283f },
    { 76.0379693331f,  85.4871228597f,  141.9943982064f },
    { 76.2683033902f,  82.6786238548f,  143.1060240885f },
    { 76.4929655271f,  80.1977486945f,  144.1640530868f },
    { 76.7131623440f,  77.9694675074f,  145.1827096486f },
    { 76.9297025630f,  75.9435659259f,  146.1714927979f },
    { 77.1431590358f,  74.0845407103f,  147.1370943062f },
    { 77.3539548919f,  72.3662265810f,  148.0844201282f },
    { 77.5624131244f,  70.7687032424f,  149.0171788999f },
    { 77.7687869300f,  69.2764027817f,  149.9382422185f },
    { 77.9732791967f,  67.8768938312f,  150.8498761239f },
    { 78.1760555292f,  66.5600688352f,  151.7538958099f },
    { 78.3772532470f,  65.3175824947f,  152.6517724789f },
    { 78.5769877771f,  64.1424527416f,  153.5447092252f },
    { 78.7753573057f,  63.0287703051f,  154.4336962291f },
    { 78.9724462350f,  61.9714828646f,  155.3195517478f },
    { 79.1683277983f,  60.9662316760f,  156.2029531230f },
    { 79.3630660714f,  60.0092259023f,  157.0844606254f },
    { 79.5567175415f,  59.0971445474f,  157.9645360663f },
    { 79.7493323468f,  58.2270589383f,  158.8435575226f },
    { 79.9409552679f,  57.3963707342f,  159.7218311375f },
    { 80.1316265282f,  56.6027618279f,  160.5996006902f },
    { 80.3213824470f,  55.8441534711f,  161.4770554462f },
    { 80.5102559766f,  55.1186726294f,  162.3543366687f },
    { 80.6982771478f,  54.4246240692f,  163.2315430786f },
    { 80.8854734426f,  53.7604670260f,  164.1087354821f },
    { 81.0718701071f,  53.1247955718f,  164.9859407353f },
    { 81.2574904165f,  52.5163219902f,  165.8631551759f },
    { 81.4423559011f,  51.9338626181f,  166.7403476272f },
    { 81.6264865400f,  51.3763257222f,  167.6174620532f },
    { 81.8099009269f,  50.8427010680f,  168.4944199315f },
    { 81.9926164143f,  50.3320509032f,  169.3711223932f },
    { 82.1746492388f,  49.8435021307f,  170.2474521731f },
    { 82.3560146298f,  49.3762394889f,  171.1232754020f },
    { 82.5367269054f,  48.9294995874f,  171.9984432663f },
    { 82.7167995564f,  48.5025656744f,  172.8727935591f },
    { 82.8962453201f,  48.0947630317f,  173.7461521369f },
    { 83.0750762466f,  47.7054549119f,  174.6183342954f },
    { 83.2533037565f,  47.3340389444f,  175.4891460778f },
    { 83.4309386935f,  46.9799439492f,  176.3583855191f },
    { 83.6079913703f,  46.6426271068f,  177.2258438375f },
    { 83.7844716105f,  46.3215714401f,  178.0913065736f },
    { 83.9603887861f,  46.0162835702f,  178.9545546834f },
    { 84.1357518510f,  45.7262917137f,  179.8153655859f },
    { 84.3105693716f,  45.4511438937f,  180.6735141679f },
    { 84.4848495541f,  45.1904063395f,  181.5287737461f },
    { 84.6586002696f,  44.9436620552f,  182.3809169867f },
    { 84.8318290771f,  44.7105095372f,  183.2297167833f },
    { 85.0045432437f,  44.4905616252f,  184.0749470919f },
    { 85.1767497638f,  44.2834444727f,  184.9163837226f },
    { 85.3484553762f,  44.0887966237f,  185.7538050880f },
    { 85.5196665800f,  43.9062681847f,  186.5869929068f },
    { 85.6903896492f,  43.7355200824f,  187.4157328625f },
    { 85.8606306457f,  43.5762233973f,  188.2398152166f },
    { 86.0303954322f,  43.4280587671f,  189.0590353755f },
    { 86.1996896828f,  43.2907158502f,  189.8731944114f },
    { 86.3685188941f,  43.1638928451f,  190.6820995368f },
    { 86.5368883943f,  43.0472960591f,  191.4855645326f },
    { 86.7048033529f,  42.9406395211f,  192.2834101306f },
    { 86.8722687883f,  42.8436446333f,  193.0754643497f },
    { 87.0392895758f,  42.7560398591f,  193.8615627886f },
    { 87.2058704549f,  42.6775604415f,  194.6415488735f },
    { 86.6963039523f,  42.3244713275f,  195.4286427246f },
    { 86.1831122385f,  41.9761908305f,  196.2359788899f },
    { 85.6662223326f,  41.6330680061f,  197.0640938990f },
    { 85.1455587931f,  41.2954708438f,  197.9135241422f },
    { 84.6210436006f,  40.9637870751f,  198.7848035433f },
    { 84.0925960330f,  40.6384249799f,  199.6784609310f },
    { 83.5601325332f,  40.3198141862f,  200.5950170916f },
    { 83.0235665684f,  40.0084064549f,  201.5349814822f },
    { 82.4828084794f,  39.7046764422f,  202.4988485909f },
    { 81.9377653215f,  39.4091224286f,  203.4870939296f },
    { 81.3883406935f,  39.1222670074f,  204.5001696510f },
    { 80.8344345557f,  38.8446577180f,  205.5384997877f },
    { 80.2759430356f,  38.5768676142f,  206.6024751153f },
    { 79.7127582192f,  38.3194957544f,  207.6924476520f },
    { 79.1447679290f,  38.0731675989f,  208.8087248157f },
    { 78.5718554841f,  37.8385353025f,  209.9515632702f },
    { 77.9938994448f,  37.6162778873f,  211.1211625064f },
    { 77.4107733365f,  37.4071012821f,  212.3176582167f },
    { 76.8223453539f,  37.2117382171f,  213.5411155372f },
    { 76.2284780422f,  37.0309479612f,  214.7915222491f },
    { 75.6290279525f,  36.8655158934f,  216.0687820460f },
    { 75.0238452717f,  36.7162529022f,  217.3727079935f },
    { 74.4127734202f,  36.5839946088f,  218.7030163200f },
    { 73.7956486183f,  36.4696004177f,  220.0593206978f },
    { 73.1722994152f,  36.3739523997f,  221.4411271803f },
    { 72.5425461778f,  36.2979540216f,  222.8478299755f },
    { 71.9062005355f,  36.2425287416f,  224.2787082375f },
    { 71.2630647749f,  36.2086185005f,  225.7329240587f },
    { 70.6129311801f,  36.1971821422f,  227.2095218377f },
    { 69.9555813116f,  36.2091938122f,  228.7074291846f },
    { 69.2907852179f,  36.2456413861f,  230.2254595035f },
    { 68.6183005694f,  36.3075249943f,  231.7623163635f },
    { 67.9378717088f,  36.3958557154f,  233.3165997326f },
    { 67.2492286045f,  36.5116545206f,  234.8868141082f },
    { 66.5520856962f,  36.6559515602f,  236.4713785279f },
    { 65.8461406196f,  36.8297858894f,  238.0686383979f },
    { 65.1310727918f,  37.0342057397f,  239.6768790216f },
    { 64.4065418418f,  37.2702694459f,  241.2943406648f },
    { 63.6721858613f,  37.5390471463f,  242.9192349494f },
    { 62.9276194531f,  37.8416233791f,  244.5497623285f },
    { 62.1724315457f,  38.1791007042f,  246.1841303738f },
    { 61.4061829393f,  38.5526044878f,  247.8205725854f },
    { 60.6284035431f,  38.9632889986f,  249.4573674403f },
    { 59.8385892529f,  39.4123449790f,  251.0928574022f },
    { 59.0361984121f,  39.9010088747f,  252.7254676522f },
    { 58.2206477843f,  40.4305739383f,  254.3537243359f },
    { 57.3913079542f,  41.0024034597f,  255.9762721864f },
    { 56.5474980533f,  41.6179464327f,  257.5918914507f },
    { 55.6884796851f,  42.2787560422f,  259.1995141328f },
    { 54.8134498971f,  42.9865114552f,  260.7982396605f },
    { 53.9215330083f,  43.7430435314f,  262.3873501976f },
    { 53.0117710584f,  44.5503652503f,  263.9663259413f },
    { 52.0831125802f,  45.4107078866f,  265.5348608961f },
    { 51.1343993233f,  46.3265642893f,  267.0928797833f },
    { 50.1643504507f,  47.3007410575f,  268.6405569587f },
    { 49.1715435941f,  48.3364220013f,  270.1783384841f },
    { 48.1543919691f,  49.4372461130f,  271.7069688523f },
    { 47.1111164965f,  50.6074044413f,  273.2275243588f },
    { 46.0397115306f,  51.8517619405f,  274.7414558003f },
    { 44.9379022974f,  53.1760128066f,  276.2506441708f },
    { 45.4471446073f,  52.9297939840f,  278.2596592216f },
    { 45.9486777175f,  52.7478010287f,  280.2316106466f },
    { 46.4428453771f,  52.6258434037f,  282.1642990570f },
    { 46.9299661186f,  52.5599266969f,  284.0558553443f },
    { 47.4103357861f,  52.5462478250f,  285.9047397303f },
    { 47.8842297460f,  52.5811911570f,  287.7097342425f },
    { 48.3519048293f,  52.6613250461f,  289.4699296895f },
    { 48.8136010415f,  52.7833983967f,  291.1847082551f },
    { 49.2695430758f,  52.9443370129f,  292.8537228123f },
    { 49.7199416550f,  53.1412395672f,  294.4768739931f },
    { 50.1649947258f,  53.3713731104f,  296.0542859459f },
    { 50.6048885248f,  53.6321680980f,  297.5862815925f },
    { 51.0397985322f,  53.9212129550f,  299.0733580619f },
    { 51.4698903285f,  54.2362482291f,  300.5161628439f },
    { 51.8953203644f,  54.5751604040f,  301.9154710784f },
    { 52.3162366555f,  54.9359754497f,  303.2721642799f },
    { 52.7327794108f,  55.3168521944f,  304.5872106944f },
    { 53.1450816014f,  55.7160755989f,  305.8616474006f },
    { 53.5532694771f,  56.1320500073f,  307.0965641954f },
    { 53.9574630366f,  56.5632924438f,  308.2930892488f },
    { 54.3577764558f,  57.0084260130f,  309.4523764712f },
    { 54.7543184794f,  57.4661734532f,  310.5755945057f },
    { 55.1471927785f,  57.9353508849f,  311.6639172365f },
    { 55.5364982794f,  58.4148617838f,  312.7185156940f },
    { 55.9223294639f,  58.9036912033f,  313.7405512296f },
    { 56.3047766474f,  59.4009002637f,  314.7311698337f },
    { 56.6839262330f,  59.9056209160f,  315.6914974726f },
    { 57.0598609477f,  60.4170509883f,  316.6226363259f },
    { 57.4326600589f,  60.9344495134f,  317.5256618127f },
    { 57.8023995760f,  61.4571323353f,  318.4016203043f },
    { 58.1691524365f,  61.9844679889f,  319.2515274294f },
    { 58.5329886785f,  62.5158738446f,  320.0763668863f },
    { 58.8939756009f,  63.0508125080f,  320.8770896871f },
    { 59.2521779131f,  63.5887884643f,  321.6546137648f },
    { 59.6076578728f,  64.1293449552f,  322.4098238854f },
    { 59.9604754161f,  64.6720610754f,  323.1435718118f },
    { 60.3106882778f,  65.2165490786f,  323.8566766735f },
    { 60.6583521038f,  65.7624518778f,  324.5499255045f },
    { 61.0035205566f,  66.3094407298f,  325.2240739133f },
    { 61.3462454141f,  66.8572130911f,  325.8798468573f },
    { 61.6865766613f,  67.4054906340f,  326.5179394968f },
    { 62.0245625774f,  67.9540174112f,  327.1390181070f },
    { 62.3602498166f,  68.5025581601f,  327.7437210303f },
    { 62.6936834845f,  69.0508967351f,  328.3326596553f },
    { 63.0249072100f,  69.5988346590f,  328.9064194080f },
    { 63.3539632124f,  70.1461897856f,  329.4655607481f },
    { 63.6808923653f,  70.6927950639f,  330.0106201586f },
    { 64.0057342563f,  71.2384973976f,  330.5421111246f },
    { 64.3285272435f,  71.7831565907f,  331.0605250952f },
    { 64.6493085087f,  72.3266443753f,  331.5663324236f },
    { 64.9681141082f,  72.8688435128f,  332.0599832828f },
    { 65.2849790197f,  73.4096469637f,  332.5419085543f },
    { 65.5999371879f,  73.9489571218f,  333.0125206881f },
    { 65.9130215671f,  74.4866851058f,  333.4722145327f },
    { 66.2242641613f,  75.0227501050f,  333.9213681340f },
    { 66.5336960624f,  75.5570787754f,  334.3603435035f },
    { 66.8413474871f,  76.0896046802f,  334.7894873555f },
    { 67.1472478108f,  76.6202677743f,  335.2091318133f },
    { 67.4514256004f,  77.1490139262f,  335.6195950846f },
    { 67.7539086457f,  77.6757944764f,  336.0211821076f },
    { 67.5282729789f,  77.6851881583f,  336.4197140081f },
    { 67.3016496454f,  77.6978944429f,  336.8230287193f },
    { 67.0740245873f,  77.7139981753f,  337.2312239304f },
    { 66.8453833608f,  77.7335865208f,  337.6444013915f },
    { 66.6157111194f,  77.7567490400f,  338.0626672051f },
    { 66.3849925956f,  77.7835777696f,  338.4861321443f },
    { 66.1532120815f,  77.8141673057f,  338.9149120025f },
    { 65.9203534081f,  77.8486148915f,  339.3491279753f },
    { 65.6863999231f,  77.8870205102f,  339.7889070802f },
    { 65.4513344672f,  77.9294869822f,  340.2343826183f },
    { 65.2151393489f,  77.9761200677f,  340.6856946820f },
    { 64.9777963170f,  78.0270285754f,  341.1429907152f },
    { 64.7392865310f,  78.0823244781f,  341.6064261315f },
    { 64.4995905302f,  78.1421230347f,  342.0761649986f },
    { 64.2586881987f,  78.2065429212f,  342.5523807961f },
    { 64.0165587290f,  78.2757063696f,  343.0352572571f },
    { 63.7731805816f,  78.3497393186f,  343.5249893044f },
    { 63.5285314415f,  78.4287715738f,  344.0217840932f },
    { 63.2825881711f,  78.5129369820f,  344.5258621765f },
    { 63.0353267581f,  78.6023736206f,  345.0374588086f },
    { 62.7867222588f,  78.6972240028f,  345.5568254082f },
    { 62.5367487362f,  78.7976353037f,  346.0842312029f },
    { 62.2853791915f,  78.9037596079f,  346.6199650841f },
    { 62.0325854884f,  79.0157541850f,  347.1643377030f },
    { 61.7783382699f,  79.1337817952f,  347.7176838478f },
    { 61.5226068650f,  79.2580110323f,  348.2803651458f },
    { 61.2653591851f,  79.3886167103f,  348.8527731463f },
    { 61.0065616087f,  79.5257803030f,  349.4353328488f },
    { 60.7461788502f,  79.6696904456f,  350.0285067560f },
    { 60.4841738138f,  79.8205435143f,  350.6327995461f },
    { 60.2205074262f,  79.9785442984f,  351.2487634832f },
    { 59.9551384470f,  80.1439067873f,  351.8770047058f },
    { 59.6880232513f,  80.3168550999f,  352.5181905743f },
    { 59.4191155791f,  80.4976245906f,  353.1730582933f },
    { 59.1483662459f,  80.6864631788f,  353.8424250878f },
    { 58.8757228037f,  80.8836329584f,  354.5272002782f },
    { 58.6011291452f,  81.0894121682f,  355.2283996999f },
    { 58.3245250338f,  81.3040976247f,  355.9471630330f },
    { 58.0458455447f,  81.5280077568f,  356.6847747837f },
    { 57.7650203927f,  81.7614864300f,  357.4426898816f },
    { 57.4819731158f,  82.0049078189f,  358.2225651787f },
    { 57.1966200756f,  82.2586826856f,  359.0262985700f },
    { 56.9088692165f,  82.5232665673f,  359.8560780839f }
};

__CONSTANT__ float gamutCuspTableReach[360] = 
{
    166.785f,
    168.475f,
    170.129f,
    171.753f,
    173.340f,
    174.878f,
    176.367f,
    177.802f,
    179.181f,
    180.505f,
    181.763f,
    182.965f,
    184.106f,
    185.187f,
    186.212f,
    187.177f,
    188.086f,
    188.947f,
    189.758f,
    190.527f,
    191.254f,
    191.949f,
    192.615f,
    193.250f,
    193.872f,
    194.360f,
    187.091f,
    180.402f,
    174.237f,
    168.524f,
    163.226f,
    158.301f,
    153.711f,
    149.426f,
    145.416f,
    141.663f,
    138.135f,
    134.821f,
    131.702f,
    128.766f,
    125.995f,
    123.376f,
    120.898f,
    118.555f,
    116.339f,
    114.233f,
    112.244f,
    110.345f,
    108.551f,
    106.842f,
    105.219f,
    103.680f,
    102.209f,
    100.818f,
    99.487f,
    98.224f,
    97.021f,
    95.874f,
    94.781f,
    93.744f,
    92.761f,
    91.821f,
    90.930f,
    90.082f,
    89.276f,
    88.513f,
    87.787f,
    87.103f,
    86.450f,
    85.840f,
    85.260f,
    84.711f,
    84.198f,
    83.716f,
    83.264f,
    82.843f,
    82.452f,
    82.086f,
    81.750f,
    81.445f,
    81.165f,
    80.908f,
    80.682f,
    80.481f,
    80.304f,
    80.151f,
    80.023f,
    79.919f,
    79.840f,
    79.791f,
    79.761f,
    79.755f,
    79.773f,
    79.816f,
    79.889f,
    79.980f,
    80.096f,
    80.243f,
    80.408f,
    80.603f,
    80.817f,
    81.061f,
    81.335f,
    81.635f,
    81.958f,
    82.312f,
    82.690f,
    83.099f,
    83.539f,
    84.009f,
    84.509f,
    85.046f,
    85.614f,
    86.212f,
    86.847f,
    87.518f,
    88.226f,
    88.977f,
    89.764f,
    90.601f,
    91.473f,
    92.395f,
    93.359f,
    94.379f,
    95.447f,
    96.570f,
    97.748f,
    98.993f,
    100.293f,
    101.660f,
    103.101f,
    104.614f,
    106.201f,
    107.880f,
    109.637f,
    111.493f,
    113.446f,
    115.503f,
    117.670f,
    119.965f,
    122.382f,
    124.939f,
    127.649f,
    130.518f,
    133.563f,
    136.792f,
    140.222f,
    143.878f,
    141.687f,
    138.110f,
    134.729f,
    131.525f,
    128.491f,
    125.616f,
    122.888f,
    120.300f,
    117.841f,
    115.497f,
    113.269f,
    111.151f,
    109.131f,
    107.202f,
    105.371f,
    103.619f,
    101.947f,
    100.354f,
    98.828f,
    97.375f,
    95.984f,
    94.659f,
    93.390f,
    92.175f,
    91.016f,
    89.911f,
    88.849f,
    87.836f,
    86.871f,
    85.950f,
    85.065f,
    84.222f,
    83.417f,
    82.654f,
    81.921f,
    81.226f,
    80.560f,
    79.926f,
    79.327f,
    78.754f,
    78.217f,
    77.698f,
    77.216f,
    76.758f,
    76.324f,
    75.916f,
    75.537f,
    75.177f,
    74.847f,
    74.536f,
    74.249f,
    73.987f,
    73.743f,
    73.523f,
    73.328f,
    73.151f,
    72.992f,
    72.858f,
    72.742f,
    72.650f,
    72.577f,
    72.522f,
    72.491f,
    72.479f,
    72.485f,
    72.516f,
    72.565f,
    72.632f,
    72.717f,
    72.827f,
    72.961f,
    73.108f,
    73.279f,
    73.474f,
    73.688f,
    73.926f,
    74.182f,
    74.463f,
    74.768f,
    75.092f,
    75.446f,
    75.818f,
    76.215f,
    76.642f,
    77.094f,
    77.570f,
    78.070f,
    78.601f,
    79.163f,
    79.749f,
    80.371f,
    81.024f,
    81.708f,
    82.422f,
    83.173f,
    83.960f,
    84.784f,
    85.645f,
    86.548f,
    87.488f,
    88.477f,
    89.508f,
    90.588f,
    91.711f,
    92.889f,
    94.122f,
    95.404f,
    96.747f,
    98.157f,
    99.622f,
    101.154f,
    102.759f,
    104.437f,
    106.195f,
    108.032f,
    109.949f,
    111.963f,
    114.069f,
    116.272f,
    118.585f,
    121.002f,
    120.929f,
    119.934f,
    118.988f,
    118.085f,
    117.230f,
    116.418f,
    115.643f,
    114.911f,
    114.221f,
    113.568f,
    112.952f,
    112.372f,
    111.823f,
    111.316f,
    110.840f,
    110.394f,
    109.985f,
    109.607f,
    109.265f,
    108.948f,
    108.661f,
    108.411f,
    108.185f,
    107.990f,
    107.825f,
    107.684f,
    107.581f,
    107.501f,
    107.446f,
    107.422f,
    107.428f,
    107.458f,
    107.520f,
    107.611f,
    107.727f,
    107.874f,
    108.044f,
    108.246f,
    108.472f,
    108.728f,
    109.015f,
    109.332f,
    109.674f,
    110.046f,
    110.449f,
    110.883f,
    111.346f,
    111.841f,
    112.366f,
    112.921f,
    113.507f,
    114.124f,
    114.777f,
    115.460f,
    116.180f,
    116.931f,
    117.719f,
    118.536f,
    119.397f,
    120.288f,
    121.216f,
    122.186f,
    123.187f,
    124.225f,
    125.305f,
    126.422f,
    127.582f,
    128.772f,
    130.005f,
    131.281f,
    132.593f,
    133.942f,
    135.327f,
    136.755f,
    138.220f,
    139.722f,
    141.254f,
    142.822f,
    144.421f,
    146.057f,
    147.711f,
    149.396f,
    151.099f,
    152.826f,
    154.565f,
    156.317f,
    158.075f,
    159.833f,
    161.584f,
    163.336f,
    165.070f
};

__CONSTANT__ float3 cGamutCuspTable[360] = 
{
    { 61.5938248798f,  109.6780346366f,  0.3192278701f },
    { 61.3633410763f,  110.0528646103f,  0.9158853007f },
    { 61.1310558386f,  110.4349848830f,  1.5302522745f },
    { 60.8968881058f,  110.8245141528f,  2.1640631768f },
    { 60.6607470606f,  111.2215801672f,  2.8193322408f },
    { 60.4225300883f,  111.6263237464f,  3.4984175124f },
    { 60.1821201255f,  112.0389047296f,  4.2041044811f },
    { 59.9393821551f,  112.4595108387f,  4.9397172210f },
    { 59.6941584878f,  112.8883710465f,  5.7092688529f },
    { 59.4462622657f,  113.3257760482f,  6.5176695985f },
    { 59.1954682956f,  113.7721102238f,  7.3710215956f },
    { 58.9414997291f,  114.2279027570f,  8.2770487773f },
    { 58.6840080325f,  114.6939118837f,  9.2457453083f },
    { 58.4225415933f,  115.1712690476f,  10.2903944912f },
    { 58.1564939536f,  115.6617375616f,  11.4292523436f },
    { 57.8850128169f,  116.1682060839f,  12.6885117445f },
    { 57.6068261850f,  116.6957101034f,  14.1079725248f },
    { 57.3198699850f,  117.2538002908f,  15.7531935586f },
    { 57.0203446851f,  117.8630445960f,  17.7462839346f },
    { 56.6995516784f,  118.5787766775f,  20.3691087820f },
    { 56.3236603672f,  119.6601512528f,  24.7221846115f },
    { 57.2041962736f,  115.3201255654f,  26.0487208398f },
    { 58.0601289695f,  111.3096585971f,  27.3997823286f },
    { 58.8938131248f,  107.5948708003f,  28.7759046137f },
    { 59.7072269670f,  104.1476114840f,  30.1773649082f },
    { 60.5020525776f,  100.9442166403f,  31.6041962772f },
    { 61.2797353950f,  97.9645855890f,  33.0561968503f },
    { 62.0415291442f,  95.1914814866f,  34.5329359267f },
    { 62.7885303280f,  92.6099924341f,  36.0337584040f },
    { 63.5217050989f,  90.2071100381f,  37.5577886655f },
    { 64.2419104715f,  87.9713953891f,  39.1039348367f },
    { 64.9499112692f,  85.8927111662f,  40.6708941446f },
    { 65.6463938084f,  83.9620045325f,  42.2571599707f },
    { 66.3319770578f,  82.1711296148f,  43.8610310458f },
    { 67.0072218204f,  80.5127012745f,  45.4806231083f },
    { 67.6726383511f,  78.9799739531f,  47.1138832108f },
    { 68.3286927244f,  77.5667408828f,  48.7586067276f },
    { 68.9758121955f,  76.2672500474f,  50.4124569800f },
    { 69.6143897418f,  75.0761340840f,  52.0729872669f },
    { 70.2447879351f,  73.9883519112f,  53.7376649649f },
    { 70.8673422608f,  72.9991403081f,  55.4038972554f },
    { 71.4823639783f,  72.1039739933f,  57.0690579498f },
    { 72.0901425987f,  71.2985329962f,  58.7305148188f },
    { 72.6909480397f,  70.5786762908f,  60.3856568011f },
    { 73.2850325099f,  69.9404208006f,  62.0319204616f },
    { 73.8726321609f,  69.3799249864f,  63.6668150950f },
    { 74.4539685438f,  68.8934763114f,  65.2879459290f },
    { 75.0292498959f,  68.4774819496f,  66.8930349528f },
    { 75.5986722829f,  68.1284621615f,  68.4799390002f },
    { 76.1624206150f,  67.8430458199f,  70.0466648166f },
    { 76.7206695544f,  67.6179676186f,  71.5913809580f },
    { 77.2735843281f,  67.4500665526f,  73.1124264744f },
    { 77.8213214576f,  67.3362853080f,  74.6083164370f },
    { 78.3640294157f,  67.2736702493f,  76.0777444564f },
    { 78.9018492200f,  67.2593717443f,  77.5195824139f },
    { 79.4349149696f,  67.2906446106f,  78.9328776868f },
    { 79.9633543319f,  67.3648485124f,  80.3168481846f },
    { 80.4872889853f,  67.4794481789f,  81.6708755410f },
    { 81.0068350225f,  67.6320133490f,  82.9944968051f },
    { 81.5221033184f,  67.8202183799f,  84.2873949773f },
    { 82.0331998671f,  68.0418414858f,  85.5493887094f },
    { 82.5402260901f,  68.2947635924f,  86.7804214692f },
    { 83.0432791200f,  68.5769668134f,  87.9805504340f },
    { 83.5424520606f,  68.8865325676f,  89.1499353447f },
    { 84.0378342271f,  69.2216393678f,  90.2888275167f },
    { 84.5295113677f,  69.5805603141f,  91.3975591661f },
    { 85.0175658676f,  69.9616603368f,  92.4765331801f },
    { 85.5020769392f,  70.3633932272f,  93.5262134246f },
    { 85.9831207968f,  70.7842985015f,  94.5471156586f },
    { 86.4607708202f,  71.2229981375f,  95.5397990971f },
    { 86.9350977054f,  71.6781932239f,  96.5048586472f },
    { 87.4061696061f,  72.1486605571f,  97.4429178204f },
    { 87.8740522645f,  72.6332492191f,  98.3546223158f },
    { 88.3388091338f,  73.1308771638f,  99.2406342515f },
    { 88.8005014927f,  73.6405278376f,  100.1016270191f },
    { 89.2591885522f,  74.1612468557f,  100.9382807276f },
    { 89.7149275555f,  74.6921387505f,  101.7512781982f },
    { 90.1677738720f,  75.2323638081f,  102.5413014704f },
    { 90.6177810852f,  75.7811350041f,  103.3090287807f },
    { 91.0650010748f,  76.3377150467f,  104.0551319701f },
    { 91.5094840951f,  76.9014135343f,  104.7802742830f },
    { 91.2457255635f,  76.9569697441f,  105.4958127196f },
    { 90.9809128348f,  77.0254360602f,  106.2148940096f },
    { 90.7150332965f,  77.1070331373f,  106.9373229645f },
    { 90.4480740787f,  77.2019805380f,  107.6628985412f },
    { 90.1800220467f,  77.3104965726f,  108.3914141336f },
    { 89.9108637938f,  77.4327981437f,  109.1226578861f },
    { 89.6405856325f,  77.5691006004f,  109.8564130332f },
    { 89.3691735868f,  77.7196175995f,  110.5924582596f },
    { 89.0966133834f,  77.8845609773f,  111.3305680827f },
    { 88.8228904427f,  78.0641406315f,  112.0705132542f },
    { 88.5479898695f,  78.2585644150f,  112.8120611805f },
    { 88.2718964432f,  78.4680380424f,  113.5549763582f },
    { 87.9945946082f,  78.6927650097f,  114.2990208250f },
    { 87.7160684629f,  78.9329465284f,  115.0439546228f },
    { 87.4363017490f,  79.1887814752f,  115.7895362698f },
    { 87.1552778403f,  79.4604663572f,  116.5355232420f },
    { 86.8729797306f,  79.7481952943f,  117.2816724590f },
    { 86.5893900220f,  80.0521600179f,  118.0277407733f },
    { 86.3044909112f,  80.3725498890f,  118.7734854605f },
    { 86.0182641772f,  80.7095519329f,  119.5186647073f },
    { 85.7306911663f,  81.0633508946f,  120.2630380956f },
    { 85.4417527785f,  81.4341293117f,  121.0063670803f },
    { 85.1514294519f,  81.8220676077f,  121.7484154577f },
    { 84.8597011468f,  82.2273442047f,  122.4889498235f },
    { 84.5665473296f,  82.6501356559f,  123.2277400170f },
    { 84.2719469552f,  83.0906167982f,  123.9645595509f },
    { 83.9758784488f,  83.5489609241f,  124.6991860231f },
    { 83.6783196877f,  84.0253399743f,  125.4314015108f },
    { 83.3792479808f,  84.5199247498f,  126.1609929433f },
    { 83.0786400485f,  85.0328851432f,  126.8877524541f },
    { 82.7764720008f,  85.5643903902f,  127.6114777090f },
    { 82.4727193146f,  86.1146093402f,  128.3319722115f },
    { 82.1673568102f,  86.6837107460f,  129.0490455828f },
    { 81.8603586261f,  87.2718635726f,  129.7625138163f },
    { 81.5516981930f,  87.8792373243f,  130.4721995071f },
    { 81.2413482065f,  88.5060023910f,  131.1779320544f },
    { 80.9292805979f,  89.1523304127f,  131.8795478390f },
    { 80.6154665044f,  89.8183946617f,  132.5768903741f },
    { 80.2998762369f,  90.5043704434f,  133.2698104300f },
    { 79.9824792464f,  91.2104355156f,  133.9581661348f },
    { 79.6632440894f,  91.9367705250f,  134.6418230489f },
    { 79.3421383899f,  92.6835594625f,  135.3206542167f },
    { 79.0191288010f,  93.4509901370f,  135.9945401944f },
    { 78.6941809630f,  94.2392546671f,  136.6633690556f },
    { 78.3672594605f,  95.0485499932f,  137.3270363763f },
    { 78.0383277757f,  95.8790784073f,  137.9854451991f },
    { 77.7073482404f,  96.7310481050f,  138.6385059785f },
    { 77.3742819845f,  97.6046737567f,  139.2861365094f },
    { 77.0390888814f,  98.5001771018f,  139.9282618378f },
    { 76.7017274908f,  99.4177875653f,  140.5648141578f },
    { 76.3621549975f,  100.3577428989f,  141.1957326936f },
    { 76.0203271469f,  101.3202898479f,  141.8209635701f },
    { 75.6761981763f,  102.3056848449f,  142.4404596714f },
    { 75.3297207423f,  103.3141947336f,  143.0541804905f },
    { 74.9808458431f,  104.3460975239f,  143.6620919693f },
    { 74.6295227363f,  105.4016831804f,  144.2641663329f },
    { 74.2756988513f,  106.4812544482f,  144.8603819163f },
    { 73.9193196961f,  107.5851277179f,  145.4507229876f },
    { 73.5603287570f,  108.7136339345f,  146.0351795669f },
    { 73.1986673933f,  109.8671195523f,  146.6137472427f },
    { 73.4261408090f,  106.0282623093f,  148.0463084504f },
    { 73.6411059005f,  102.9095471383f,  149.3105550520f },
    { 73.8478500680f,  100.2575377765f,  150.4662383547f },
    { 74.0486341271f,  97.9386787329f,  151.5449277134f },
    { 74.2448190874f,  95.8726232432f,  152.5656284874f },
    { 74.4372978324f,  94.0066999624f,  153.5407890925f },
    { 74.6266928111f,  92.3042227689f,  154.4790605811f },
    { 74.8134580805f,  90.7384577752f,  155.3867247111f },
    { 74.9979367427f,  89.2892278984f,  156.2684995295f },
    { 75.1803954805f,  87.9408714805f,  157.1280246507f },
    { 75.3610464312f,  86.6809493677f,  157.9681691335f },
    { 75.5400616393f,  85.4993907150f,  158.7912351924f },
    { 75.7175829438f,  84.3879085686f,  159.5990977608f },
    { 75.8937289457f,  83.3395880744f,  160.3933029532f },
    { 76.0686000418f,  82.3485889332f,  161.1751392948f },
    { 76.2422821422f,  81.4099256787f,  161.9456903830f },
    { 76.4148494679f,  80.5193023151f,  162.7058745670f },
    { 76.5863666917f,  79.6729857652f,  163.4564753523f },
    { 76.7568906013f,  78.8677075717f,  164.1981650470f },
    { 76.9264714081f,  78.1005865239f,  164.9315234021f },
    { 77.0951537904f,  77.3690670230f,  165.6570524816f },
    { 77.2629777323f,  76.6708694536f,  166.3751886577f },
    { 77.4299792074f,  76.0039498278f,  167.0863123825f },
    { 77.5961907383f,  75.3664666752f,  167.7907562221f },
    { 77.7616418608f,  74.7567536546f,  168.4888115178f },
    { 77.9263595098f,  74.1732967271f,  169.1807339519f },
    { 78.0903683441f,  73.6147149985f,  169.8667482321f },
    { 78.2536910201f,  73.0797445384f,  170.5470520593f },
    { 78.4163484249f,  72.5672246304f,  171.2218195108f },
    { 78.5783598756f,  72.0760860246f,  171.8912039404f },
    { 78.7397432901f,  71.6053408486f,  172.5553404781f },
    { 78.9005153350f,  71.1540739008f,  173.2143481961f },
    { 79.0606915538f,  70.7214351019f,  173.8683319927f },
    { 79.2202864786f,  70.3066329248f,  174.5173842403f },
    { 79.3793137275f,  69.9089286512f,  175.1615862301f },
    { 79.5377860906f,  69.5276313335f,  175.8010094461f },
    { 79.6957156057f,  69.1620933585f,  176.4357166894f },
    { 79.8531136247f,  68.8117065294f,  177.0657630768f },
    { 80.0099908734f,  68.4758985938f,  177.6911969268f },
    { 80.1663575041f,  68.1541301572f,  178.3120605514f },
    { 80.3222231427f,  67.8458919330f,  178.9283909619f },
    { 80.4775969306f,  67.5507022837f,  179.5402205020f },
    { 80.6324875633f,  67.2681050192f,  180.1475774156f },
    { 80.7869033235f,  66.9976674176f,  180.7504863567f },
    { 80.9408521127f,  66.7389784447f,  181.3489688487f },
    { 81.0943414783f,  66.4916471470f,  181.9430436975f },
    { 81.2473786393f,  66.2553011979f,  182.5327273652f },
    { 81.3999705086f,  66.0295855819f,  183.1180343058f },
    { 81.5521237144f,  65.8141613984f,  183.6989772695f },
    { 81.7038446187f,  65.6087047748f,  184.2755675767f },
    { 81.8551393347f,  65.4129058752f,  184.8478153655f },
    { 82.0060137428f,  65.2264679962f,  185.4157298155f },
    { 82.1564735050f,  65.0491067397f,  185.9793193490f },
    { 82.3065240785f,  64.8805492547f,  186.5385918127f },
    { 82.4561707276f,  64.7205335427f,  187.0935546410f },
    { 82.6054185350f,  64.5688078185f,  187.6442150032f },
    { 82.7542724126f,  64.4251299226f,  188.1905799347f },
    { 82.9027371109f,  64.2892667791f,  188.7326564552f },
    { 83.0508172280f,  64.1609938958f,  189.2704516736f },
    { 83.1985172177f,  64.0400949018f,  189.8039728815f },
    { 82.7003586663f,  63.5000000612f,  190.3423165932f },
    { 82.1985701011f,  62.9605134581f,  190.8946406839f },
    { 81.6930765803f,  62.4218142216f,  191.4614474885f },
    { 81.1838005696f,  61.8840945341f,  192.0432595257f },
    { 80.6706618154f,  61.3475605609f,  192.6406201462f },
    { 80.1535772099f,  60.8124334458f,  193.2540941616f },
    { 79.6324606474f,  60.2789503794f,  193.8842684444f },
    { 79.1072228711f,  59.7473657421f,  194.5317524894f },
    { 78.5777713098f,  59.2179523282f,  195.1971789235f },
    { 78.0440099035f,  58.6910026563f,  195.8812039511f },
    { 77.5058389172f,  58.1668303697f,  196.5845077179f },
    { 76.9631547415f,  57.6457717334f,  197.3077945748f },
    { 76.4158496795f,  57.1281872319f,  198.0517932214f },
    { 75.8638117177f,  56.6144632734f,  198.8172567039f },
    { 75.3069242811f,  56.1050140057f,  199.6049622409f },
    { 74.7450659691f,  55.6002832479f,  200.4157108459f },
    { 74.1781102724f,  55.1007465429f,  201.2503267125f },
    { 73.6059252677f,  54.6069133347f,  202.1096563238f },
    { 73.0283732888f,  54.1193292738f,  202.9945672444f },
    { 72.4453105711f,  53.6385786538f,  203.9059465476f },
    { 71.8565868679f,  53.1652869800f,  204.8446988292f },
    { 71.2620450353f,  52.7001236715f,  205.8117437535f },
    { 70.6615205814f,  52.2438048950f,  206.8080130735f },
    { 70.0548411777f,  51.7970965291f,  207.8344470678f },
    { 69.4418261281f,  51.3608172532f,  208.8919903311f },
    { 68.8222857902f,  50.9358417556f,  209.9815868583f },
    { 68.1960209444f,  50.5231040520f,  211.1041743625f },
    { 67.5628221049f,  50.1236009032f,  212.2606777716f },
    { 66.9224687654f,  49.7383953192f,  213.4520018554f },
    { 66.2747285726f,  49.3686201340f,  214.6790229479f },
    { 65.6193564175f,  49.0154816334f,  215.9425797404f },
    { 64.9560934361f,  48.6802632185f,  217.2434631485f },
    { 64.2846659066f,  48.3643290851f,  218.5824052763f },
    { 63.6047840308f,  48.0691279019f,  219.9600675384f },
    { 62.9161405835f,  47.7961964726f,  221.3770280396f },
    { 62.2184094132f,  47.5471633742f,  222.8337683590f },
    { 61.5112437726f,  47.3237525702f,  224.3306599427f },
    { 60.7942744550f,  47.1277870134f,  225.8679503660f },
    { 60.0671077083f,  46.9611922711f,  227.4457497993f },
    { 59.3293228934f,  46.8260002296f,  229.0640180756f },
    { 58.5804698472f,  46.7243529708f,  230.7225528337f },
    { 57.8200659044f,  46.6585069542f,  232.4209792776f },
    { 57.0475925209f,  46.6308376943f,  234.1587421548f },
    { 56.2624914328f,  46.6438451890f,  235.9351006098f },
    { 55.4641602709f,  46.7001604400f,  237.7491266044f },
    { 54.6519475310f,  46.8025535067f,  239.5997076157f },
    { 53.8251467833f,  46.9539436606f,  241.4855543203f },
    { 52.9829899729f,  47.1574123603f,  243.4052139494f },
    { 52.1246396319f,  47.4162199538f,  245.3570899576f },
    { 51.2491797774f,  47.7338272505f,  247.3394685953f },
    { 50.3556052150f,  48.1139233996f,  249.3505529192f },
    { 49.4428088907f,  48.5604618955f,  251.3885047427f },
    { 48.5095668370f,  49.0777070331f,  253.4514950343f },
    { 47.5545201290f,  49.6702938143f,  255.5377633587f },
    { 46.5761530879f,  50.3433052399f,  257.6456871665f },
    { 45.5727667298f,  51.1023722337f,  259.7738621297f },
    { 44.5424461228f,  51.9538033275f,  261.9211953928f },
    { 43.4830198473f,  52.9047539891f,  264.0870146695f },
    { 42.3920090790f,  53.9634495839f,  266.2711977673f },
    { 41.2665628365f,  55.1394822234f,  268.4743296610f },
    { 41.9735394029f,  54.4850638563f,  271.6931295580f },
    { 42.6635753777f,  54.0120303146f,  274.8523689914f },
    { 43.3378512060f,  53.7051524895f,  277.9394867389f },
    { 43.9974150424f,  53.5498819459f,  280.9436377004f },
    { 44.6432026299f,  53.5323637789f,  283.8558828485f },
    { 45.2760534998f,  53.6394682306f,  286.6692604305f },
    { 45.8967242921f,  53.8588269989f,  289.3787529088f },
    { 46.5058997980f,  54.1788645107f,  291.9811708000f },
    { 47.1042021805f,  54.5888182755f,  294.4749773161f },
    { 47.6921987299f,  55.0787455835f,  296.8600771286f },
    { 48.2704084258f,  55.6395161685f,  299.1375896655f },
    { 48.8393075252f,  56.2627920334f,  301.3096231916f },
    { 49.3993343452f,  56.9409965578f,  303.3790614234f },
    { 49.9508933791f,  57.6672753876f,  305.3493702342f },
    { 50.4943588558f,  58.4354516321f,  307.2244284814f },
    { 51.0300778307f,  59.2399776681f,  309.0083842781f },
    { 51.5583728828f,  60.0758855144f,  310.7055361127f },
    { 52.0795444767f,  60.9387373473f,  312.3202369934f },
    { 52.5938730387f,  61.8245773510f,  313.8568191140f },
    { 53.1016207894f,  62.7298857522f,  315.3195362583f },
    { 53.6030333652f,  63.6515355993f,  316.7125211564f },
    { 54.0983412592f,  64.5867526137f,  318.0397551747f },
    { 54.5877611042f,  65.5330782566f,  319.3050479823f },
    { 55.0714968196f,  66.4883360232f,  320.5120251438f },
    { 55.5497406385f,  67.4506008797f,  321.6641218916f },
    { 56.0226740301f,  68.4181716930f,  322.7645816281f },
    { 56.4904685313f,  69.3895464661f,  323.8164579679f },
    { 56.9532864960f,  70.3634001675f,  324.8226193625f },
    { 57.4112817742f,  71.3385649369f,  325.7857555446f },
    { 57.8646003269f,  72.3140124502f,  326.7083851949f },
    { 58.3133807855f,  73.2888382331f,  327.5928643663f },
    { 58.7577549608f,  74.2622477264f,  328.4413953124f },
    { 59.1978483067f,  75.2335439175f,  329.2560354544f },
    { 59.6337803452f,  76.2021163701f,  330.0387062885f },
    { 60.0656650547f,  77.1674314963f,  330.7912020931f },
    { 60.4936112261f,  78.1290239334f,  331.5151983361f },
    { 60.9177227898f,  79.0864888995f,  332.2122597174f },
    { 61.3380991175f,  80.0394754158f,  332.8838478037f },
    { 61.7548352990f,  80.9876802965f,  333.5313282355f },
    { 62.1680223985f,  81.9308428178f,  334.1559774978f },
    { 62.5777476911f,  82.8687399863f,  334.7589892568f },
    { 62.9840948817f,  83.8011823392f,  335.3414802724f },
    { 63.3871443081f,  84.7280102136f,  335.9044959023f },
    { 63.7869731290f,  85.6490904303f,  336.4490152153f },
    { 64.1836554988f,  86.5643133465f,  336.9759557343f },
    { 64.5772627306f,  87.4735902322f,  337.4861778307f },
    { 64.9678634471f,  88.3768509355f,  337.9804887925f },
    { 65.3555237223f,  89.2740418028f,  338.4596465865f },
    { 65.7403072129f,  90.1651238252f,  338.9243633375f },
    { 66.1222752815f,  91.0500709858f,  339.3753085436f },
    { 66.5014871116f,  91.9288687852f,  339.8131120474f },
    { 66.8779998155f,  92.8015129246f,  340.2383667818f },
    { 67.2518685352f,  93.6680081310f,  340.6516313075f },
    { 67.6231465370f,  94.5283671064f,  341.0534321573f },
    { 67.9918853004f,  95.3826095889f,  341.4442660050f },
    { 68.3581346017f,  96.2307615132f,  341.8246016688f },
    { 68.7219425927f,  97.0728542591f,  342.1948819666f },
    { 69.0833558741f,  97.9089239801f,  342.5555254310f },
    { 69.4424195656f,  98.7390110011f,  342.9069278983f },
    { 69.7991773715f,  99.5631592802f,  343.2494639791f },
    { 69.6121373648f,  99.7218862043f,  343.5883660129f },
    { 69.4243582888f,  99.8845132740f,  343.9301316821f },
    { 69.2358296750f,  100.0511033627f,  344.2748249832f },
    { 69.0465407539f,  100.2217204070f,  344.6225132981f },
    { 68.8564804413f,  100.3964294219f,  344.9732676407f },
    { 68.6656373225f,  100.5752965143f,  345.3271629265f },
    { 68.4739996365f,  100.7583888965f,  345.6842782654f },
    { 68.2815552586f,  100.9457748992f,  346.0446972819f },
    { 68.0882916815f,  101.1375239830f,  346.4085084657f },
    { 67.8941959956f,  101.3337067498f,  346.7758055540f },
    { 67.6992548671f,  101.5343949527f,  347.1466879525f },
    { 67.5034545148f,  101.7396615050f,  347.5212611968f },
    { 67.3067806852f,  101.9495804871f,  347.8996374602f },
    { 67.1092186247f,  102.1642271532f,  348.2819361143f },
    { 66.9107530506f,  102.3836779349f,  348.6682843469f },
    { 66.7113681187f,  102.6080104438f,  349.0588178464f },
    { 66.5110473880f,  102.8373034717f,  349.4536815613f },
    { 66.3097737833f,  103.0716369881f,  349.8530305428f },
    { 66.1075295523f,  103.3110921356f,  350.2570308847f },
    { 65.9042962206f,  103.5557512224f,  350.6658607711f },
    { 65.7000545406f,  103.8056977113f,  351.0797116506f },
    { 65.4947844359f,  104.0610162064f,  351.4987895522f },
    { 65.2884649396f,  104.3217924355f,  351.9233165665f },
    { 65.0810741260f,  104.5881132296f,  352.3535325170f },
    { 64.8725890338f,  104.8600664988f,  352.7896968504f },
    { 64.6629855817f,  105.1377412052f,  353.2320907842f },
    { 64.4522384718f,  105.4212273319f,  353.6810197508f },
    { 64.2403210827f,  105.7106158516f,  354.1368161931f },
    { 64.0272053475f,  106.0059986916f,  354.5998427708f },
    { 63.8128616155f,  106.3074687016f,  355.0704960540f },
    { 63.5972584948f,  106.6151196227f,  355.5492107961f },
    { 63.3803626715f,  106.9290460640f,  356.0364648988f },
    { 63.1621387012f,  107.2493434900f,  356.5327852077f },
    { 62.9425487682f,  107.5761082281f,  357.0387543155f },
    { 62.7215524038f,  107.9094375045f,  357.5550185878f },
    { 62.4991061569f,  108.2494295251f,  358.0822976896f },
    { 62.2751632038f,  108.5961836215f,  358.6213959646f },
    { 62.0496728849f,  108.9498004914f,  359.1732161200f },
    { 61.8225801489f,  109.3103825763f,  359.7387758068f }
};

__CONSTANT__ float gamutTopGamma[360] = 
{
    0.894836425781250f,
    0.893804931640625f,
    0.892785644531250f,
    0.891784667968750f,
    0.890802001953125f,
    0.889843750000000f,
    0.888903808593750f,
    0.887988281250000f,
    0.887091064453125f,
    0.886224365234375f,
    0.885369873046875f,
    0.884552001953125f,
    0.883764648437500f,
    0.882983398437500f,
    0.882244873046875f,
    0.881524658203125f,
    0.880828857421875f,
    0.880169677734375f,
    0.879528808593750f,
    0.878906250000000f,
    0.878338623046875f,
    0.877746582031250f,
    0.877197265625000f,
    0.876708984375000f,
    0.876177978515625f,
    0.875659179687500f,
    0.875195312500000f,
    0.874786376953125f,
    0.874432373046875f,
    0.876202392578125f,
    0.878668212890625f,
    0.880926513671875f,
    0.883074951171875f,
    0.885192871093750f,
    0.887084960937500f,
    0.888977050781250f,
    0.890759277343750f,
    0.892462158203125f,
    0.894146728515625f,
    0.895684814453125f,
    0.897241210937500f,
    0.898687744140625f,
    0.900115966796875f,
    0.901495361328125f,
    0.902813720703125f,
    0.904138183593750f,
    0.905358886718750f,
    0.906610107421875f,
    0.907763671875000f,
    0.908935546875000f,
    0.910052490234375f,
    0.911151123046875f,
    0.912231445312500f,
    0.913269042968750f,
    0.914318847656250f,
    0.915295410156250f,
    0.916308593750000f,
    0.917248535156250f,
    0.918206787109375f,
    0.919128417968750f,
    0.920037841796875f,
    0.920941162109375f,
    0.921813964843750f,
    0.922705078125000f,
    0.923529052734375f,
    0.924383544921875f,
    0.925207519531250f,
    0.926019287109375f,
    0.926837158203125f,
    0.927612304687500f,
    0.928405761718750f,
    0.929168701171875f,
    0.929925537109375f,
    0.930694580078125f,
    0.931414794921875f,
    0.932147216796875f,
    0.932885742187500f,
    0.933575439453125f,
    0.934271240234375f,
    0.934979248046875f,
    0.935644531250000f,
    0.936303710937500f,
    0.936962890625000f,
    0.937622070312500f,
    0.938232421875000f,
    0.938836669921875f,
    0.939434814453125f,
    0.940020751953125f,
    0.940594482421875f,
    0.941125488281250f,
    0.941632080078125f,
    0.942114257812500f,
    0.942565917968750f,
    0.942987060546875f,
    0.943365478515625f,
    0.943701171875000f,
    0.943988037109375f,
    0.944207763671875f,
    0.944360351562500f,
    0.944396972656250f,
    0.944329833984375f,
    0.944152832031250f,
    0.943835449218750f,
    0.943273925781250f,
    0.936029052734375f,
    0.917431640625000f,
    0.898394775390625f,
    0.878649902343750f,
    0.877087402343750f,
    0.879840087890625f,
    0.882427978515625f,
    0.884881591796875f,
    0.887194824218750f,
    0.889392089843750f,
    0.891467285156250f,
    0.893444824218750f,
    0.895318603515625f,
    0.897100830078125f,
    0.898797607421875f,
    0.900415039062500f,
    0.901959228515625f,
    0.903430175781250f,
    0.904833984375000f,
    0.906170654296875f,
    0.907452392578125f,
    0.908673095703125f,
    0.909838867187500f,
    0.910955810546875f,
    0.912017822265625f,
    0.913037109375000f,
    0.914007568359375f,
    0.914929199218750f,
    0.915814208984375f,
    0.916650390625000f,
    0.917449951171875f,
    0.918206787109375f,
    0.918920898437500f,
    0.919598388671875f,
    0.920239257812500f,
    0.920837402343750f,
    0.921398925781250f,
    0.921923828125000f,
    0.922418212890625f,
    0.925640869140625f,
    0.928674316406250f,
    0.931536865234375f,
    0.934234619140625f,
    0.936779785156250f,
    0.939178466796875f,
    0.941442871093750f,
    0.943572998046875f,
    0.945587158203125f,
    0.947497558593750f,
    0.949304199218750f,
    0.951019287109375f,
    0.952655029296875f,
    0.954205322265625f,
    0.955682373046875f,
    0.957080078125000f,
    0.958398437500000f,
    0.959655761718750f,
    0.960852050781250f,
    0.961987304687500f,
    0.963073730468750f,
    0.964111328125000f,
    0.965093994140625f,
    0.966015625000000f,
    0.966894531250000f,
    0.967730712890625f,
    0.968524169921875f,
    0.969281005859375f,
    0.969995117187500f,
    0.970666503906250f,
    0.971295166015625f,
    0.971893310546875f,
    0.972448730468750f,
    0.972973632812500f,
    0.973461914062500f,
    0.973919677734375f,
    0.974340820312500f,
    0.974719238281250f,
    0.975067138671875f,
    0.975384521484375f,
    0.975671386718750f,
    0.975921630859375f,
    0.976135253906250f,
    0.976312255859375f,
    0.976452636718750f,
    0.976562500000000f,
    0.976641845703125f,
    0.976672363281250f,
    0.976666259765625f,
    0.976617431640625f,
    0.976538085937500f,
    0.976409912109375f,
    0.981878662109375f,
    0.991729736328125f,
    0.991571044921875f,
    0.991400146484375f,
    0.991217041015625f,
    0.991046142578125f,
    0.990875244140625f,
    0.990710449218750f,
    0.990545654296875f,
    0.990380859375000f,
    0.990222167968750f,
    0.990063476562500f,
    0.989904785156250f,
    0.989746093750000f,
    0.989599609375000f,
    0.989453125000000f,
    0.989294433593750f,
    0.989129638671875f,
    0.988977050781250f,
    0.988824462890625f,
    0.988684082031250f,
    0.988543701171875f,
    0.988378906250000f,
    0.988226318359375f,
    0.988085937500000f,
    0.987951660156250f,
    0.987786865234375f,
    0.987640380859375f,
    0.987506103515625f,
    0.987353515625000f,
    0.987200927734375f,
    0.987066650390625f,
    0.986920166015625f,
    0.986761474609375f,
    0.986627197265625f,
    0.986480712890625f,
    0.986322021484375f,
    0.986187744140625f,
    0.986035156250000f,
    0.985876464843750f,
    0.985742187500000f,
    0.985583496093750f,
    0.985430908203125f,
    0.985290527343750f,
    0.985119628906250f,
    0.984973144531250f,
    0.984814453125000f,
    0.984649658203125f,
    0.984509277343750f,
    0.984332275390625f,
    0.984173583984375f,
    0.984014892578125f,
    0.983837890625000f,
    0.983679199218750f,
    0.983502197265625f,
    0.983325195312500f,
    0.983160400390625f,
    0.982971191406250f,
    0.982794189453125f,
    0.982611083984375f,
    0.982415771484375f,
    0.982244873046875f,
    0.982031250000000f,
    0.981835937500000f,
    0.981640625000000f,
    0.981420898437500f,
    0.981219482421875f,
    0.980999755859375f,
    0.980773925781250f,
    0.980566406250000f,
    0.980316162109375f,
    0.980078125000000f,
    0.979852294921875f,
    0.979583740234375f,
    0.979333496093750f,
    0.979077148437500f,
    0.978790283203125f,
    0.978521728515625f,
    0.978234863281250f,
    0.977923583984375f,
    0.977630615234375f,
    0.977319335937500f,
    0.977258300781250f,
    0.977325439453125f,
    0.977355957031250f,
    0.977423095703125f,
    0.977453613281250f,
    0.977520751953125f,
    0.977551269531250f,
    0.977624511718750f,
    0.977648925781250f,
    0.977722167968750f,
    0.977746582031250f,
    0.977807617187500f,
    0.977850341796875f,
    0.977893066406250f,
    0.977954101562500f,
    0.977990722656250f,
    0.978051757812500f,
    0.978088378906250f,
    0.978137207031250f,
    0.978204345703125f,
    0.978234863281250f,
    0.978289794921875f,
    0.978356933593750f,
    0.978387451171875f,
    0.978442382812500f,
    0.978509521484375f,
    0.978552246093750f,
    0.978594970703125f,
    0.978656005859375f,
    0.978717041015625f,
    0.978771972656250f,
    0.978820800781250f,
    0.978875732421875f,
    0.978930664062500f,
    0.978991699218750f,
    0.979052734375000f,
    0.979113769531250f,
    0.979174804687500f,
    0.979235839843750f,
    0.979296875000000f,
    0.979357910156250f,
    0.979425048828125f,
    0.979498291015625f,
    0.979571533203125f,
    0.979638671875000f,
    0.979705810546875f,
    0.979785156250000f,
    0.979858398437500f,
    0.979931640625000f,
    0.980017089843750f,
    0.980096435546875f,
    0.980175781250000f,
    0.980267333984375f,
    0.980358886718750f,
    0.980444335937500f,
    0.970123291015625f,
    0.957659912109375f,
    0.945385742187500f,
    0.933282470703125f,
    0.921319580078125f,
    0.920050048828125f,
    0.919000244140625f,
    0.917932128906250f,
    0.916851806640625f,
    0.915771484375000f,
    0.914672851562500f,
    0.913574218750000f,
    0.912469482421875f,
    0.911352539062500f,
    0.910235595703125f,
    0.909118652343750f,
    0.907995605468750f,
    0.906872558593750f,
    0.905755615234375f,
    0.904632568359375f,
    0.903515625000000f,
    0.902404785156250f,
    0.901293945312500f,
    0.900195312500000f,
    0.899102783203125f,
    0.898016357421875f,
    0.896948242187500f,
    0.895886230468750f
};

#include "hellwig_lib_v058.h"

__DEVICE__ float3 transform(int p_Width, int p_Height, int p_X, int p_Y, float p_R, float p_G, float p_B)
{
    float3 in = make_float3(p_R, p_G, p_B);
    float3 out = in;

    float3 XYZ;

    if (!invert)
    {
        XYZ = vector_dot(AP0_ACES_to_XYZ_matrix, in);
        if (ap1Clip)
        {
            float3 AP1 = vector_dot(XYZ_to_AP1_ACES_matrix, XYZ);
            AP1.x = _fmaxf(AP1.x, 0.0f);
            AP1.y = _fmaxf(AP1.y, 0.0f);
            AP1.z = _fmaxf(AP1.z, 0.0f);
            XYZ = vector_dot(AP1_ACES_to_XYZ_matrix, AP1);
        }
    }
    else
    {
        in = float3spow(in, 2.6f);
        XYZ = vector_dot(RGB_to_XYZ_output, in);
    }
    XYZ *= referenceLuminance;
    float3 JMh;
    if (!invert)
    {
        JMh = XYZ_to_Hellwig2022_JMh(XYZ, inWhite);
        if (toneCurve)
        {
            JMh = forwardTonescale(JMh, compressChroma);
        }
        if (gamutCompress)
        {
            JMh = compressGamut(JMh, 0);
        }
    }
    else
    {
        JMh = XYZ_to_Hellwig2022_JMh(XYZ, d65White);
        if (gamutCompress)
        {
            JMh = compressGamut(JMh, 1);
        }
        if (toneCurve)
        {
            JMh = inverseTonescale(JMh, compressChroma);
        }
    }
    if (JMhOut)
    {
        out.x = JMh.x / referenceLuminance;
        out.y = JMh.y / referenceLuminance;
        out.z = JMh.z / 360.0f;
    }
    else
    {
        if (!invert)
        {
            if (!d60Sim)
            {
                XYZ = Hellwig2022_JMh_to_XYZ(JMh , d65White) / referenceLuminance;
            }
            else
            {
                XYZ = Hellwig2022_JMh_to_XYZ(JMh , inWhite) / referenceLuminance;
                float3 creativeWhiteXYZ = vector_dot(RGB_to_XYZ_P3D60, make_float3(1.0f, 1.0f, 1.0f));
                float3 creativeWhiteRGB = vector_dot(XYZ_to_RGB_limit, creativeWhiteXYZ);
                XYZ *= 1.0f / max(creativeWhiteRGB.x, max(creativeWhiteRGB.y, creativeWhiteRGB.z));
            }
            out = vector_dot(XYZ_to_RGB_limit, XYZ);

            // Soft clamp by compressing negative display linear values
            if (softClip)
            {
				float3 compr = make_float3(clamp_thr, clamp_dist, 1.2f);
				out = compress_aces(out, compr, compr, compr, 0);
            }

            // hard clip 0-1
            if (hardClip)
            {
				out = clamp3(out, 0.0f, 1.0f);
            }
            
            if (asPQ)
            {
                out *= 48.0f;
                out.x = linear_to_ST2084(out.x);
                out.y = linear_to_ST2084(out.y);
                out.z = linear_to_ST2084(out.z);
            }
            else
            {
                out = float3spow(out, 1.0f / 2.6f);
            }
        }
        else
        {
            XYZ = Hellwig2022_JMh_to_XYZ(JMh , inWhite) / referenceLuminance;
            out = vector_dot(XYZ_to_AP0_ACES_matrix, XYZ);
        }
    }

    return out;
}