DEFINE_ACES_PARAM(IS_PARAMETRIC_ACES_TRANSFORM: 0)

DEFINE_UI_PARAMS(toneCurve, Tone Curve, DCTLUI_CHECK_BOX, 1)
DEFINE_UI_PARAMS(compressChroma, Compress Chroma, DCTLUI_CHECK_BOX, 1)
DEFINE_UI_PARAMS(gamutCompress, Gamut Compress, DCTLUI_CHECK_BOX, 1)
DEFINE_UI_PARAMS(d60Sim, D60 Sim, DCTLUI_CHECK_BOX, 0)
DEFINE_UI_PARAMS(asPQ, Encode as BT.2100 PQ, DCTLUI_CHECK_BOX, 0)
DEFINE_UI_PARAMS(ap1Clip, AP1 Clamp, DCTLUI_CHECK_BOX, 1)
DEFINE_UI_PARAMS(softClip, Soft Clip, DCTLUI_CHECK_BOX, 0)
DEFINE_UI_PARAMS(hardClip, Clamp, DCTLUI_CHECK_BOX, 1)
DEFINE_UI_PARAMS(invert, Invert, DCTLUI_CHECK_BOX, 1)
DEFINE_UI_PARAMS(JMhOut, Diagnostic JMh Output, DCTLUI_CHECK_BOX, 0)


typedef struct
{
    float3 x;
    float3 y;
    float3 z;
} float3x3;

// Constant values generated in Python
// https://github.com/nick-shaw/aces-ot-vwg-experiments/blob/master/python/v55_init_plot.py

__CONSTANT__ float3x3 XYZ_to_RGB_limit =
{
// XYZ to sRGB matrix
    {  3.2409699419f, -1.5373831776f, -0.4986107603f},
    { -0.9692436363f,  1.8759675015f,  0.0415550574f},
    {  0.0556300797f, -0.2039769589f,  1.0569715142f}
};

__CONSTANT__ float3x3 RGB_to_XYZ_output =
{
// sRGB to XYZ matrix
    {  0.4123907993f,  0.3575843394f,  0.1804807884f},
    {  0.2126390059f,  0.7151686788f,  0.0721923154f},
    {  0.0193308187f,  0.1191947798f,  0.9505321522f}
};

__CONSTANT__ float3x3 RGB_to_XYZ_709D60 =
{
    {  0.4318156527f,  0.3556330533f,  0.1651973686f},
    {  0.2226549459f,  0.7112661067f,  0.0660789474f},
    {  0.0202413587f,  0.1185443511f,  0.8700394745f}
};

__CONSTANT__ float3x3 BT709_to_BT2020 =
{
    {  0.6274038959f, 0.3292830384f, 0.0433130657f},
    {  0.0690972894f, 0.9195403951f, 0.0113623156f},
    {  0.0163914389f, 0.0880133079f, 0.8955952532f}
};

__CONSTANT__ float limitJmax = 100.0f;
__CONSTANT__ float midJ = 34.0965348204f; // ~10 nits in Hellwig J
__CONSTANT__ float focusDist = 1.35f;

__CONSTANT__ float daniele_n = 100.0f; // peak white
__CONSTANT__ float daniele_m_2 = 1.0471037624f;
__CONSTANT__ float daniele_s_2 = 0.9198582542f;
__CONSTANT__ float daniele_u_2 = 0.9917990155f;

// Chroma compression scaling for HDR/SDR appearance match
__CONSTANT__ float compr = 2.4f;
__CONSTANT__ float sat = 1.3f;
__CONSTANT__ float sat_thr = 0.005f;

__CONSTANT__ float3 gamutCuspTable[360] = 
{
    { 54.1476177130f,  67.8669042191f,  0.8549357905f },
    { 53.8600307220f,  68.3057302802f,  1.8725432481f },
    { 53.5697051711f,  68.7621370936f,  2.9237082164f },
    { 53.2764994869f,  69.2371810347f,  4.0125972684f },
    { 52.9802514755f,  69.7321161051f,  5.1442429981f },
    { 52.6807728454f,  70.2484603321f,  6.3247976021f },
    { 52.3778415870f,  70.7880923332f,  7.5618880541f },
    { 52.0711910756f,  71.3533956493f,  8.8651269197f },
    { 51.7604939724f,  71.9474815102f,  10.2468702949f },
    { 51.4453375104f,  72.5745460195f,  11.7233851887f },
    { 51.1251837396f,  73.2404700278f,  13.3167312478f },
    { 50.7993017606f,  73.9538864090f,  15.0579712101f },
    { 50.4666433072f,  74.7282249980f,  16.9930636149f },
    { 50.1255904928f,  75.5860398987f,  19.1947919213f },
    { 49.7733671282f,  76.5695572697f,  21.7905246576f },
    { 49.4043270882f,  77.7727734904f,  25.0425742348f },
    { 50.4892243396f,  74.6422746734f,  26.5158751188f },
    { 51.5423867377f,  71.8021770347f,  28.0113732628f },
    { 52.5667218028f,  69.2174412657f,  29.5284860512f },
    { 53.5646837277f,  66.8593432142f,  31.0663367804f },
    { 54.5383702365f,  64.7040213604f,  32.6237820966f },
    { 55.4895939304f,  62.7314165695f,  34.1994349870f },
    { 56.4199359376f,  60.9244828187f,  35.7916856950f },
    { 57.3307869919f,  59.2685895201f,  37.3987221212f },
    { 58.2233793971f,  57.7510621461f,  39.0185507181f },
    { 59.0988122555f,  56.3608245577f,  40.6490184807f },
    { 59.9580716373f,  55.0881173872f,  42.2878363244f },
    { 60.8020468930f,  53.9242741661f,  43.9326038983f },
    { 61.6315439853f,  52.8615419098f,  45.5808356839f },
    { 62.4472964876f,  51.8929363542f,  47.2299880753f },
    { 63.2499747392f,  51.0121245080f,  48.8774870192f },
    { 64.0401935239f,  50.2133289469f,  50.5207557106f },
    { 64.8185185601f,  49.4912495571f,  52.1572417973f },
    { 65.5854720215f,  48.8409993774f,  53.7844435343f },
    { 66.3415372637f,  48.2580518926f,  55.3999343527f },
    { 67.0871628937f,  47.7381976575f,  57.0013853564f },
    { 67.8227662927f,  47.2775085399f,  58.5865853360f },
    { 68.5487366809f,  46.8723081837f,  60.1534579793f },
    { 69.2654377965f,  46.5191475455f,  61.7000760581f },
    { 69.9732102468f,  46.2147845552f,  63.2246724788f },
    { 70.6723735820f,  45.9561671179f,  64.7256481843f },
    { 71.3632281285f,  45.7404188063f,  66.2015769907f },
    { 72.0460566181f,  45.5648267087f,  67.6512075246f },
    { 72.7211256395f,  45.4268309912f,  69.0734624923f },
    { 73.3886869357f,  45.3240158141f,  70.4674355655f },
    { 74.0489785671f,  45.2541013105f,  71.8323861991f },
    { 74.7022259580f,  45.2149363948f,  73.1677327150f },
    { 75.3486428393f,  45.2044922149f,  74.4730439909f },
    { 75.9884321018f,  45.2208561049f,  75.7480300801f },
    { 76.6217865682f,  45.2622259287f,  76.9925320739f },
    { 77.2488896954f,  45.3269047313f,  78.2065114862f },
    { 77.8699162130f,  45.4132956371f,  79.3900394164f },
    { 78.4850327067f,  45.5198969543f,  80.5432857044f },
    { 79.0943981504f,  45.6452974556f,  81.6665082643f },
    { 79.6981643948f,  45.7881718155f,  82.7600427443f },
    { 80.2964766144f,  45.9472761963f,  83.8242926320f },
    { 80.8894737199f,  46.1214439749f,  84.8597198914f },
    { 81.4772887361f,  46.3095816096f,  85.8668361948f },
    { 82.0600491524f,  46.5106646484f,  86.8461947890f },
    { 82.6378772448f,  46.7237338792f,  87.7983830129f },
    { 83.2108903747f,  46.9478916256f,  88.7240154730f },
    { 83.7792012657f,  47.1822981895f,  89.6237278653f },
    { 84.3429182601f,  47.4261684429f,  90.4981714246f },
    { 84.9021455569f,  47.6787685702f,  91.3480079735f },
    { 85.4569834341f,  47.9394129602f,  92.1739055398f },
    { 86.0075284547f,  48.2074612481f,  92.9765345029f },
    { 86.5538736594f,  48.4823155060f,  93.7565642347f },
    { 87.0961087463f,  48.7634175791f,  94.5146601919f },
    { 87.6343202385f,  49.0502465645f,  95.2514814230f },
    { 88.1685916416f,  49.3423164297f,  95.9676784513f },
    { 88.6990035906f,  49.6391737661f,  96.6638914954f },
    { 89.2256339878f,  49.9403956723f,  97.3407489945f },
    { 89.7485581320f,  50.2455877638f,  97.9988664043f },
    { 90.2678488405f,  50.5543823022f,  98.6388452329f },
    { 90.7835765630f,  50.8664364395f,  99.2612722890f },
    { 91.2958094889f,  51.1814305721f,  99.8667191154f },
    { 91.1011887692f,  51.1583743413f,  100.4642996151f },
    { 90.9060290102f,  51.1410066218f,  101.0653711856f },
    { 90.7103258094f,  51.1294200420f,  101.6698325502f },
    { 90.5140747029f,  51.1237070224f,  102.2775783162f },
    { 90.3172711639f,  51.1239597089f,  102.8884990352f },
    { 90.1199106021f,  51.1302699062f,  103.5024812735f },
    { 89.9219883617f,  51.1427290111f,  104.1194076954f },
    { 89.7234997204f,  51.1614279465f,  104.7391571569f },
    { 89.5244398883f,  51.1864570954f,  105.3616048114f },
    { 89.3248040060f,  51.2179062360f,  105.9866222270f },
    { 89.1245871436f,  51.2558644780f,  106.6140775149f },
    { 88.9237842990f,  51.3004201996f,  107.2438354689f },
    { 88.7223903966f,  51.3516609871f,  107.8757577167f },
    { 88.5204002854f,  51.4096735746f,  108.5097028802f },
    { 88.3178087378f,  51.4745437875f,  109.1455267476f },
    { 88.1146104479f,  51.5463564873f,  109.7830824544f },
    { 87.9108000297f,  51.6251955192f,  110.4222206744f },
    { 87.7063720152f,  51.7111436620f,  111.0627898184f },
    { 87.5013208533f,  51.8042825820f,  111.7046362422f },
    { 87.2956409071f,  51.9046927891f,  112.3476044616f },
    { 87.0893264530f,  52.0124535972f,  112.9915373735f },
    { 86.8823716777f,  52.1276430872f,  113.6362764847f },
    { 86.6747706773f,  52.2503380754f,  114.2816621437f },
    { 86.4665174545f,  52.3806140839f,  114.9275337788f },
    { 86.2576059167f,  52.5185453175f,  115.5737301386f },
    { 86.0480298742f,  52.6642046428f,  116.2200895353f },
    { 85.8377830375f,  52.8176635732f,  116.8664500899f },
    { 85.6268590153f,  52.9789922578f,  117.5126499779f },
    { 85.4152513121f,  53.1482594755f,  118.1585276751f },
    { 85.2029533257f,  53.3255326335f,  118.8039222022f },
    { 84.9899583449f,  53.5108777705f,  119.4486733672f },
    { 84.7762595466f,  53.7043595654f,  120.0926220053f },
    { 84.5618499937f,  53.9060413505f,  120.7356102144f },
    { 84.3467226317f,  54.1159851294f,  121.3774815868f },
    { 84.1308702864f,  54.3342516006f,  122.0180814343f },
    { 83.9142856610f,  54.5609001850f,  122.6572570083f },
    { 83.6969613326f,  54.7959890592f,  123.2948577118f },
    { 83.4788897498f,  55.0395751927f,  123.9307353044f },
    { 83.2600632289f,  55.2917143909f,  124.5647440983f },
    { 83.0404739512f,  55.5524613413f,  125.1967411461f },
    { 82.8201139591f,  55.8218696656f,  125.8265864187f },
    { 82.5989751530f,  56.0999919757f,  126.4541429730f },
    { 82.3770492873f,  56.3868799334f,  127.0792771097f },
    { 82.1543279670f,  56.6825843152f,  127.7018585202f },
    { 81.9308026439f,  56.9871550808f,  128.3217604224f },
    { 81.7064646120f,  57.3006414449f,  128.9388596854f },
    { 81.4813050043f,  57.6230919538f,  129.5530369427f },
    { 81.2553147878f,  57.9545545645f,  130.1641766940f },
    { 81.0284847593f,  58.2950767277f,  130.7721673953f },
    { 80.8008055412f,  58.6447054743f,  131.3769015379f },
    { 80.5722675761f,  59.0034875044f,  131.9782757155f },
    { 80.3428611226f,  59.3714692797f,  132.5761906805f },
    { 80.1125762498f,  59.7486971184f,  133.1705513882f },
    { 79.8814028323f,  60.1352172928f,  133.7612670317f },
    { 79.6493305448f,  60.5310761295f,  134.3482510647f },
    { 79.4163488560f,  60.9363201118f,  134.9314212148f },
    { 79.1824470236f,  61.3509959845f,  135.5106994864f },
    { 78.9476140876f,  61.7751508605f,  136.0860121546f },
    { 78.7118388643f,  62.2088323299f,  136.6572897492f },
    { 78.4751099398f,  62.6520885704f,  137.2244670305f },
    { 78.6687269551f,  60.9596074439f,  138.1191057892f },
    { 78.8602045344f,  59.3865851766f,  139.0132919010f },
    { 79.0497764501f,  57.9180438985f,  139.9088107920f },
    { 79.2376305322f,  56.5419922726f,  140.8070581309f },
    { 79.4239204170f,  55.2486614317f,  141.7091350754f },
    { 79.6087737053f,  54.0299741595f,  142.6159139292f },
    { 79.7922977843f,  52.8791659130f,  143.5280845959f },
    { 79.9745840806f,  51.7905078223f,  144.4461881854f },
    { 80.1557112306f,  50.7591000476f,  145.3706418033f },
    { 80.3357474862f,  49.7807148307f,  146.3017571544f },
    { 80.5147525709f,  48.8516753766f,  147.2397547301f },
    { 80.6927791293f,  47.9687610490f,  148.1847747934f },
    { 80.8698738763f,  47.1291322072f,  149.1368860165f },
    { 81.0460785168f,  46.3302699255f,  150.0960923824f },
    { 81.2214304899f,  45.5699271366f,  151.0623387970f },
    { 81.3959635774f,  44.8460886558f,  152.0355157426f },
    { 81.5697084045f,  44.1569381842f,  153.0154632211f },
    { 81.7426928556f,  43.5008308540f,  154.0019741764f },
    { 81.9149424227f,  42.8762702178f,  154.9947975413f },
    { 82.0864804986f,  42.2818888333f,  155.9936410215f },
    { 82.2573286245f,  41.7164317806f,  156.9981737036f },
    { 82.4275067027f,  41.1787425925f,  158.0080285560f },
    { 82.5970331771f,  40.6677511834f,  159.0228048731f },
    { 82.7659251903f,  40.1824634476f,  160.0420707040f },
    { 82.9341987183f,  39.7219522597f,  161.0653652936f },
    { 83.1018686883f,  39.2853496623f,  162.0922015568f },
    { 83.2689490812f,  38.8718400645f,  163.1220685983f },
    { 83.4354530217f,  38.4806543053f,  164.1544342850f },
    { 83.6013928575f,  38.1110644650f,  165.1887478710f },
    { 83.7667802290f,  37.7623793212f,  166.2244426719f },
    { 83.9316261313f,  37.4339403688f,  167.2609387802f },
    { 84.0959409691f,  37.1251183323f,  168.2976458109f },
    { 84.2597346059f,  36.8353101098f,  169.3339656629f },
    { 84.4230164076f,  36.5639360997f,  170.3692952793f },
    { 84.5857952818f,  36.3104378628f,  171.4030293902f },
    { 84.7480797135f,  36.0742760851f,  172.4345632178f },
    { 84.9098777963f,  35.8549288039f,  173.4632951246f },
    { 85.0711972614f,  35.6518898712f,  174.4886291857f },
    { 85.2320455038f,  35.4646676257f,  175.5099776658f },
    { 85.3924296054f,  35.2927837515f,  176.5267633829f },
    { 85.5523563570f,  35.1357723018f,  177.5384219424f },
    { 85.7118322772f,  34.9931788686f,  178.5444038262f },
    { 85.8708636308f,  34.8645598824f,  179.5441763229f },
    { 86.0294564447f,  34.7494820242f,  180.5372252895f },
    { 86.1876165231f,  34.6475217381f,  181.5230567351f },
    { 86.3453494610f,  34.5582648294f,  182.5011982197f },
    { 86.5026606568f,  34.4813061384f,  183.4712000653f },
    { 86.6595553239f,  34.4162492769f,  184.4326363764f },
    { 86.8160385015f,  34.3627064199f,  185.3851058715f },
    { 86.9721150645f,  34.3202981425f,  186.3282325284f },
    { 87.1277897322f,  34.2886532941f,  187.2616660469f },
    { 87.2830670773f,  34.2674089026f,  188.1850821375f },
    { 87.4379515333f,  34.2562101034f,  189.0981826425f },
    { 87.5924474023f,  34.2547100852f,  190.0006954997f },
    { 87.7465588609f,  34.2625700508f,  190.8923745596f },
    { 87.9002899675f,  34.2794591851f,  191.7729992666f },
    { 88.0536446675f,  34.3050546297f,  192.6423742179f },
    { 88.2066267990f,  34.3390414581f,  193.5003286101f },
    { 88.3592400977f,  34.3811126513f,  194.3467155886f },
    { 88.5114882021f,  34.4309690700f,  195.1814115109f },
    { 87.9776410584f,  34.2609262425f,  196.0184345088f },
    { 87.4398814951f,  34.0974188512f,  196.8714638643f },
    { 86.8981283012f,  33.9407587683f,  197.7405841493f },
    { 86.3522974404f,  33.7912681435f,  198.6258537321f },
    { 85.8023019121f,  33.6492794156f,  199.5273024822f },
    { 85.2480516035f,  33.5151352882f,  200.4449294381f },
    { 84.6894531320f,  33.3891886677f,  201.3787004575f },
    { 84.1264096771f,  33.2718025614f,  202.3285458708f },
    { 83.5588208010f,  33.1633499356f,  203.2943581632f },
    { 82.9865822577f,  33.0642135296f,  204.2759897123f },
    { 82.4095857878f,  32.9747856290f,  205.2732506119f },
    { 81.8277188999f,  32.8954677954f,  206.2859066139f },
    { 81.2408646356f,  32.8266705551f,  207.3136772217f },
    { 80.6489013188f,  32.7688130482f,  208.3562339734f },
    { 80.0517022849f,  32.7223226416f,  209.4131989487f },
    { 79.4491355911f,  32.6876345098f,  210.4841435391f },
    { 78.8410637043f,  32.6651911880f,  211.5685875159f },
    { 78.2273431646f,  32.6554421053f,  212.6659984331f },
    { 77.6078242228f,  32.6588431063f,  213.7757913958f },
    { 76.9823504487f,  32.6758559681f,  214.8973292246f },
    { 76.3507583074f,  32.7069479265f,  216.0299230404f },
    { 75.7128767009f,  32.7525912220f,  217.1728332881f },
    { 75.0685264706f,  32.8132626792f,  218.3252712112f },
    { 74.4175198570f,  32.8894433354f,  219.4864007834f },
    { 73.7596599126f,  32.9816181344f,  220.6553410911f },
    { 73.0947398610f,  33.0902757029f,  221.8311691560f },
    { 72.4225423994f,  33.2159082280f,  223.0129231742f },
    { 71.7428389342f,  33.3590114564f,  224.1996061399f },
    { 71.0553887451f,  33.5200848347f,  225.3901898117f },
    { 70.3599380679f,  33.6996318133f,  226.5836189710f },
    { 69.6562190859f,  33.8981603357f,  227.7788159118f },
    { 68.9439488189f,  34.1161835366f,  228.9746850945f },
    { 68.2228278972f,  34.3542206729f,  230.1701178890f },
    { 67.4925392050f,  34.6127983135f,  231.3639973255f },
    { 66.7527463763f,  34.8924518126f,  232.5552027696f },
    { 66.0030921229f,  35.1937270980f,  233.7426144314f },
    { 65.2431963712f,  35.5171828030f,  234.9251176185f },
    { 64.4726541805f,  35.8633927761f,  236.1016066419f },
    { 63.6910334105f,  36.2329490083f,  237.2709882792f },
    { 62.8978720997f,  36.6264650200f,  238.4321847051f },
    { 62.0926755108f,  37.0445797592f,  239.5841357918f },
    { 61.2749127883f,  37.4879620703f,  240.7258006849f },
    { 60.4440131663f,  37.9573158054f,  241.8561585533f },
    { 59.5993616478f,  38.4533856645f,  242.9742084056f },
    { 58.7402940648f,  38.9769638693f,  244.0789678542f },
    { 57.8660914064f,  39.5288978011f,  245.1694706904f },
    { 56.9759732766f,  40.1100987627f,  246.2447631074f },
    { 56.0690903153f,  40.7215520635f,  247.3038983716f },
    { 55.1445153727f,  41.3643286807f,  248.3459296910f },
    { 54.2012331762f,  42.0395988104f,  249.3699009540f },
    { 53.2381281648f,  42.7486477150f,  250.3748349147f },
    { 52.2539700761f,  43.4928943821f,  251.3597182576f },
    { 51.2473967553f,  44.2739136649f,  252.3234827835f },
    { 50.2168935049f,  45.0934627802f,  253.2649816821f },
    { 49.1607680811f,  45.9535133195f,  254.1829594778f },
    { 48.0771201604f,  46.8562903240f,  255.0760136796f },
    { 46.9638037017f,  47.8043205241f,  255.9425453757f },
    { 45.8183800714f,  48.8004926434f,  256.7806948350f },
    { 44.6380589943f,  49.8481338356f,  257.5882564238f },
    { 43.4196232234f,  50.9511080775f,  258.3625644569f },
    { 43.9071757392f,  50.1913042715f,  260.1864564940f },
    { 44.3873271978f,  49.4974096345f,  262.0116262379f },
    { 44.8604103319f,  48.8666194296f,  263.8356450367f },
    { 45.3267332595f,  48.2962471694f,  265.6560374573f },
    { 45.7865819711f,  47.7837077085f,  267.4703090931f },
    { 46.2402225030f,  47.3265037478f,  269.2759742571f },
    { 46.6879028429f,  46.9222152997f,  271.0705829517f },
    { 47.1298546085f,  46.5684917060f,  272.8517465314f },
    { 47.5662945295f,  46.2630458327f,  274.6171615190f },
    { 47.9974257620f,  46.0036500930f,  276.3646311040f },
    { 48.4234390565f,  45.7881339782f,  278.0920839473f },
    { 48.8445138002f,  45.6143827986f,  279.7975900142f },
    { 49.2608189490f,  45.4803373645f,  281.4793732689f },
    { 49.6725138629f,  45.3839943617f,  283.1358211699f },
    { 50.0797490579f,  45.3234072058f,  284.7654910090f },
    { 50.4826668830f,  45.2966871861f,  286.3671132260f },
    { 50.8814021321f,  45.3020047398f,  287.9395919068f },
    { 51.2760825982f,  45.3375907239f,  289.4820027335f },
    { 51.6668295757f,  45.4017375791f,  290.9935886946f },
    { 52.0537583182f,  45.4928003062f,  292.4737538898f },
    { 52.4369784545f,  45.6091971967f,  293.9220557730f },
    { 52.8165943687f,  45.7494102801f,  295.3381961718f },
    { 53.1927055483f,  45.9119854679f,  296.7220114068f },
    { 53.5654069023f,  46.0955323892f,  298.0734618113f },
    { 53.9347890537f,  46.2987239238f,  299.3926209186f },
    { 54.3009386079f,  46.5202954475f,  300.6796645554f },
    { 54.6639383999f,  46.7590438137f,  301.9348600400f },
    { 55.0238677227f,  47.0138260956f,  303.1585556522f },
    { 55.3808025373f,  47.2835581209f,  304.3511705066f },
    { 55.7348156676f,  47.5672128278f,  305.5131849307f },
    { 56.0859769802f,  47.8638184753f,  306.6451314209f },
    { 56.4343535521f,  48.1724567362f,  307.7475862249f },
    { 56.7800098249f,  48.4922607017f,  308.8211615772f },
    { 57.1230077494f,  48.8224128247f,  309.8664985982f },
    { 57.4634069197f,  49.1621428249f,  310.8842608513f },
    { 57.8012646978f,  49.5107255774f,  311.8751285417f },
    { 58.1366363302f,  49.8674790033f,  312.8397933328f },
    { 58.4695750565f,  50.2317619796f,  313.7789537481f },
    { 58.8001322113f,  50.6029722804f,  314.6933111225f },
    { 59.1283573190f,  50.9805445622f,  315.5835660663f },
    { 59.4542981828f,  51.3639484021f,  316.4504154006f },
    { 59.7780009684f,  51.7526863963f,  317.2945495244f },
    { 60.0995102820f,  52.1462923244f,  318.1166501757f },
    { 60.4188692438f,  52.5443293838f,  318.9173885466f },
    { 60.7361195573f,  52.9463884972f,  319.6974237174f },
    { 61.0513015742f,  53.3520866941f,  320.4574013753f },
    { 61.3644543556f,  53.7610655677f,  321.1979527863f },
    { 61.6756157295f,  54.1729898070f,  321.9196939894f },
    { 61.9848223452f,  54.5875458030f,  322.6232251880f },
    { 62.2921097249f,  55.0044403279f,  323.3091303120f },
    { 62.5975123118f,  55.4233992849f,  323.9779767293f },
    { 62.9010635159f,  55.8441665280f,  324.6303150858f },
    { 63.2027957576f,  56.2665027477f,  325.2666792563f },
    { 63.5027405085f,  56.6901844209f,  325.8875863891f },
    { 63.8009283301f,  57.1150028229f,  326.4935370315f },
    { 64.0973889107f,  57.5407630966f,  327.0850153215f },
    { 64.3921511004f,  57.9672833796f,  327.6624892353f },
    { 64.6852429440f,  58.3943939824f,  328.2264108811f },
    { 64.9766917125f,  58.8219366187f,  328.7772168294f },
    { 65.2665239332f,  59.2497636820f,  329.3153284734f },
    { 65.0472036707f,  59.2848611429f,  329.8488205655f },
    { 64.8269142223f,  59.3247255635f,  330.3878353270f },
    { 64.6056417117f,  59.3694767690f,  330.9324358037f },
    { 64.3833718843f,  59.4192374826f,  331.4826872759f },
    { 64.1600900911f,  59.4741334088f,  332.0386575075f },
    { 63.9357812708f,  59.5342933201f,  332.6004170221f },
    { 63.7104299318f,  59.5998491482f,  333.1680394094f },
    { 63.4840201321f,  59.6709360816f,  333.7416016641f },
    { 63.2565354584f,  59.7476926680f,  334.3211845627f },
    { 63.0279590038f,  59.8302609234f,  334.9068730799f },
    { 62.7982733434f,  59.9187864484f,  335.4987568514f },
    { 62.5674605089f,  60.0134185520f,  336.0969306872f },
    { 62.3355019609f,  60.1143103851f,  336.7014951409f },
    { 62.1023785592f,  60.2216190824f,  337.3125571428f },
    { 61.8680705312f,  60.3355059167f,  337.9302307033f },
    { 61.6325574371f,  60.4561364641f,  338.5546376957f },
    { 61.3958181329f,  60.5836807848f,  339.1859087283f },
    { 61.1578307305f,  60.7183136174f,  339.8241841174f },
    { 60.9185725537f,  60.8602145933f,  340.4696149737f },
    { 60.6780200911f,  61.0095684693f,  341.1223644177f },
    { 60.4361489444f,  61.1665653844f,  341.7826089417f },
    { 60.1929337720f,  61.3314011430f,  342.4505399390f },
    { 59.9483482273f,  61.5042775278f,  343.1263654236f },
    { 59.7023648910f,  61.6854026486f,  343.8103119690f },
    { 59.4549551966f,  61.8749913317f,  344.5026268995f },
    { 59.2060893477f,  62.0732655566f,  345.2035807722f },
    { 58.9557362272f,  62.2804549489f,  345.9134701972f },
    { 58.7038632952f,  62.4967973390f,  346.6326210509f },
    { 58.4504364763f,  62.7225393981f,  347.3613921486f },
    { 58.1954200323f,  62.9579373683f,  348.1001794579f },
    { 57.9387764197f,  63.2032579023f,  348.8494209488f },
    { 57.6804661283f,  63.4587790388f,  349.6096021994f },
    { 57.4204474979f,  63.7247913407f,  350.3812629029f },
    { 57.1586765095f,  64.0015992317f,  351.1650044543f },
    { 56.8951065457f,  64.2895225791f,  351.9614988398f },
    { 56.6296881133f,  64.5888985809f,  352.7714991071f },
    { 56.3623685228f,  64.9000840335f,  353.5958517679f },
    { 56.0930915119f,  65.2234580790f,  354.4355115775f },
    { 55.8217968036f,  65.5594255639f,  355.2915592654f },
    { 55.5484195809f,  65.9084211811f,  356.1652229548f },
    { 55.2728898580f,  66.2709146299f,  357.0579042423f },
    { 54.9951317209f,  66.6474171093f,  357.9712102164f },
    { 54.7150624006f,  67.0384895803f,  358.9069931327f },
    { 54.4325911295f,  67.4447534047f,  359.8674000721f }
};

__CONSTANT__ float gamutCuspTableReach[360] = 
{
    162.274f,
    164.783f,
    167.267f,
    169.727f,
    172.144f,
    174.506f,
    176.813f,
    179.041f,
    181.189f,
    183.246f,
    185.199f,
    187.054f,
    188.800f,
    190.442f,
    191.968f,
    193.390f,
    194.708f,
    195.923f,
    197.046f,
    198.071f,
    199.023f,
    199.896f,
    200.702f,
    201.447f,
    202.148f,
    194.867f,
    187.598f,
    180.914f,
    174.738f,
    169.025f,
    163.727f,
    158.795f,
    154.199f,
    149.908f,
    145.898f,
    142.133f,
    138.605f,
    135.284f,
    132.159f,
    129.218f,
    126.440f,
    123.816f,
    121.338f,
    118.988f,
    116.766f,
    114.661f,
    112.659f,
    110.767f,
    108.966f,
    107.251f,
    105.627f,
    104.077f,
    102.606f,
    101.208f,
    99.878f,
    98.608f,
    97.406f,
    96.259f,
    95.166f,
    94.122f,
    93.134f,
    92.194f,
    91.302f,
    90.454f,
    89.642f,
    88.879f,
    88.153f,
    87.463f,
    86.816f,
    86.200f,
    85.620f,
    85.071f,
    84.558f,
    84.076f,
    83.624f,
    83.197f,
    82.806f,
    82.446f,
    82.111f,
    81.799f,
    81.519f,
    81.262f,
    81.036f,
    80.835f,
    80.658f,
    80.505f,
    80.377f,
    80.273f,
    80.200f,
    80.145f,
    80.121f,
    80.115f,
    80.133f,
    80.182f,
    80.249f,
    80.347f,
    80.463f,
    80.609f,
    80.780f,
    80.975f,
    81.195f,
    81.439f,
    81.714f,
    82.013f,
    82.343f,
    82.697f,
    83.081f,
    83.496f,
    83.936f,
    84.412f,
    84.912f,
    85.449f,
    86.023f,
    86.627f,
    87.268f,
    87.946f,
    88.660f,
    89.410f,
    90.204f,
    91.040f,
    91.925f,
    92.847f,
    93.823f,
    94.849f,
    95.923f,
    97.052f,
    98.242f,
    99.487f,
    100.800f,
    102.179f,
    103.625f,
    105.151f,
    106.750f,
    108.435f,
    110.205f,
    112.073f,
    114.038f,
    116.107f,
    118.292f,
    120.599f,
    123.035f,
    125.616f,
    128.339f,
    131.226f,
    134.290f,
    135.352f,
    131.775f,
    128.436f,
    125.305f,
    122.363f,
    119.598f,
    116.992f,
    114.539f,
    112.225f,
    110.040f,
    107.971f,
    106.018f,
    104.169f,
    102.411f,
    100.751f,
    99.170f,
    97.675f,
    96.252f,
    94.904f,
    93.622f,
    92.407f,
    91.248f,
    90.149f,
    89.099f,
    88.110f,
    87.164f,
    86.267f,
    85.419f,
    84.607f,
    83.844f,
    83.118f,
    82.434f,
    81.781f,
    81.171f,
    80.591f,
    80.042f,
    79.529f,
    79.047f,
    78.595f,
    78.174f,
    77.783f,
    77.417f,
    77.081f,
    76.770f,
    76.489f,
    76.233f,
    76.001f,
    75.793f,
    75.616f,
    75.458f,
    75.330f,
    75.220f,
    75.134f,
    75.079f,
    75.043f,
    75.031f,
    75.043f,
    75.079f,
    75.134f,
    75.220f,
    75.330f,
    75.458f,
    75.616f,
    75.793f,
    76.001f,
    76.233f,
    76.489f,
    76.776f,
    77.081f,
    77.423f,
    77.789f,
    78.180f,
    78.607f,
    79.059f,
    79.541f,
    80.060f,
    80.609f,
    81.189f,
    81.812f,
    82.465f,
    83.154f,
    83.887f,
    84.662f,
    85.474f,
    86.334f,
    87.244f,
    88.196f,
    89.203f,
    90.265f,
    91.382f,
    92.560f,
    93.799f,
    95.105f,
    96.484f,
    97.937f,
    99.469f,
    101.086f,
    102.795f,
    104.608f,
    106.519f,
    108.545f,
    110.687f,
    112.970f,
    115.393f,
    117.969f,
    119.446f,
    117.694f,
    116.022f,
    114.429f,
    112.903f,
    111.450f,
    110.065f,
    108.740f,
    107.477f,
    106.268f,
    105.115f,
    104.016f,
    102.966f,
    101.965f,
    101.013f,
    100.104f,
    99.237f,
    98.413f,
    97.626f,
    96.881f,
    96.173f,
    95.502f,
    94.867f,
    94.269f,
    93.701f,
    93.164f,
    92.657f,
    92.188f,
    91.748f,
    91.333f,
    90.948f,
    90.594f,
    90.265f,
    89.966f,
    89.691f,
    89.447f,
    89.221f,
    89.032f,
    88.861f,
    88.715f,
    88.599f,
    88.501f,
    88.434f,
    88.391f,
    88.367f,
    88.373f,
    88.403f,
    88.458f,
    88.531f,
    88.635f,
    88.763f,
    88.916f,
    89.093f,
    89.294f,
    89.520f,
    89.771f,
    90.051f,
    90.356f,
    90.686f,
    91.046f,
    91.431f,
    91.840f,
    92.285f,
    92.755f,
    93.250f,
    93.781f,
    94.342f,
    94.928f,
    95.551f,
    96.210f,
    96.893f,
    97.620f,
    98.376f,
    99.170f,
    100.000f,
    100.867f,
    101.776f,
    102.722f,
    103.711f,
    104.736f,
    105.811f,
    106.927f,
    108.093f,
    109.308f,
    110.565f,
    111.871f,
    113.232f,
    114.648f,
    116.113f,
    117.633f,
    119.214f,
    120.844f,
    122.540f,
    124.292f,
    126.099f,
    127.972f,
    129.901f,
    131.891f,
    133.942f,
    136.053f,
    138.220f,
    140.442f,
    142.719f,
    145.050f,
    147.418f,
    149.829f,
    152.277f,
    154.755f,
    157.251f,
    159.760f
};

__CONSTANT__ float3 cGamutCuspTable[360] = 
{
    { 61.7659567473f,  108.0199429571f,  0.4498455949f },
    { 61.5258329766f,  108.6342655905f,  1.0432514535f },
    { 61.2836977682f,  109.2595313825f,  1.6517364179f },
    { 61.0394618297f,  109.8958997470f,  2.2769065013f },
    { 60.7930256564f,  110.5435321051f,  2.9206317400f },
    { 60.5442774572f,  111.2025932683f,  3.5851069768f },
    { 60.2930904674f,  111.8732538457f,  4.2729314381f },
    { 60.0393194055f,  112.5556943083f,  4.9872146270f },
    { 59.7827957123f,  113.2501117577f,  5.7317198745f },
    { 59.5233210094f,  113.9567311625f,  6.5110631075f },
    { 59.2606578825f,  114.6758241328f,  7.3309948938f },
    { 58.9945165089f,  115.4077407265f,  8.1988122743f },
    { 58.7245345699f,  116.1529645451f,  9.1239808519f },
    { 58.4502457968f,  116.9122111956f,  10.1191136868f },
    { 58.1710281433f,  117.6866118698f,  11.2015910887f },
    { 57.8860127315f,  118.4780757485f,  12.3964166096f },
    { 57.5939099413f,  119.2900635438f,  13.7416882994f },
    { 57.2926370266f,  120.1294316856f,  15.3003422612f },
    { 56.9783748380f,  121.0116274480f,  17.1899546689f },
    { 56.6424047727f,  121.9801370623f,  19.6827959358f },
    { 56.2508797599f,  123.2486945316f,  23.8458623392f },
    { 57.1258074835f,  118.9562503079f,  25.0750757343f },
    { 57.9763829415f,  114.9847081987f,  26.3234110479f },
    { 58.8049339041f,  111.3004412039f,  27.5913840881f },
    { 59.6134160687f,  107.8754838138f,  28.8792945415f },
    { 60.4034924316f,  104.6863076945f,  30.1872438856f },
    { 61.1765921026f,  101.7129124299f,  31.5151481771f },
    { 61.9339547124f,  98.9381374963f,  32.8627473789f },
    { 62.6766645024f,  96.3471329402f,  34.2296124691f },
    { 63.4056768823f,  93.9269460944f,  35.6151512756f },
    { 64.1218393947f,  91.6661946046f,  37.0186137683f },
    { 64.8259084627f,  89.5548046705f,  38.4390973791f },
    { 65.5185629137f,  87.5837992768f,  39.8755527987f },
    { 66.2004150073f,  85.7451252677f,  41.3267905933f },
    { 66.8720195097f,  84.0315109897f,  42.7914888988f },
    { 67.5338812216f,  82.4363482858f,  44.2682023672f },
    { 68.1864612710f,  80.9535941157f,  45.7553724641f },
    { 68.8301824114f,  79.5776881702f,  47.2513391443f },
    { 69.4654335097f,  78.3034836590f,  48.7543538615f },
    { 70.0925733733f,  77.1261890549f,  50.2625938055f },
    { 70.7119340302f,  76.0413190344f,  51.7741771982f },
    { 71.3238235560f,  75.0446531956f,  53.2871794307f },
    { 71.9285285223f,  74.1322013980f,  54.7996497800f },
    { 72.5263161268f,  73.3001747681f,  56.3096284137f },
    { 73.1174360557f,  72.5449615647f,  57.8151633719f },
    { 73.7021221162f,  71.8631072227f,  59.3143272091f },
    { 74.2805936764f,  71.2512979800f,  60.8052329891f },
    { 74.8530569370f,  70.7063475724f,  62.2860493411f },
    { 75.4197060603f,  70.2251865382f,  63.7550143203f },
    { 75.9807241746f,  69.8048537266f,  65.2104478514f },
    { 76.5362842713f,  69.4424896474f,  66.6507625834f },
    { 77.0865500084f,  69.1353313383f,  68.0744730321f },
    { 77.6316764316f,  68.8807084620f,  69.4802029372f },
    { 78.1718106240f,  68.6760403789f,  70.8666908153f },
    { 78.7070922926f,  68.5188339716f,  72.2327937334f },
    { 79.2376542992f,  68.4066820279f,  73.5774893718f },
    { 79.7636231411f,  68.3372620160f,  74.8998764811f },
    { 80.2851193896f,  68.3083351133f,  76.1991738672f },
    { 80.8022580882f,  68.3177453733f,  77.4747180585f },
    { 81.3151491166f,  68.3634189387f,  78.7259598243f },
    { 81.8238975241f,  68.4433632275f,  79.9524597203f },
    { 82.3286038340f,  68.5556660393f,  81.1538828387f },
    { 82.8293643244f,  68.6984945432f,  82.3299929340f },
    { 83.3262712855f,  68.8700941223f,  83.4806460885f },
    { 83.8194132571f,  69.0687870622f,  84.6057840692f },
    { 84.3088752475f,  69.2929710796f,  85.7054275125f },
    { 84.7947389360f,  69.5411176937f,  86.7796690575f },
    { 85.2770828599f,  69.8117704519f,  87.8286665333f },
    { 85.7559825887f,  70.1035430202f,  88.8526362869f },
    { 86.2315108845f,  70.4151171579f,  89.8518467253f },
    { 86.7037378524f,  70.7452405918f,  90.8266121276f },
    { 87.1727310795f,  71.0927248120f,  91.7772867713f },
    { 87.6385557648f,  71.4564428046f,  92.7042594032f },
    { 88.1012748404f,  71.8353267435f,  93.6079480757f },
    { 88.5609490846f,  72.2283656564f,  94.4887953586f },
    { 89.0176372275f,  72.6346030827f,  95.3472639297f },
    { 89.4713960504f,  73.0531347372f,  96.1838325410f },
    { 89.9222804781f,  73.4831061945f,  96.9989923509f },
    { 90.3703436661f,  73.9237106041f,  97.7932436101f },
    { 90.8156370826f,  74.3741864477f,  98.5670926852f },
    { 91.2582105849f,  74.8338153468f,  99.3210494018f },
    { 90.9944406784f,  74.8001484877f,  100.0659617848f },
    { 90.7296149522f,  74.7794700302f,  100.8163177985f },
    { 90.4637207658f,  74.7720492348f,  101.5719240561f },
    { 90.1967452207f,  74.7781550898f,  102.3325774192f },
    { 89.9286751533f,  74.7980560432f,  103.0980651847f },
    { 89.6594971267f,  74.8320197351f,  103.8681653126f },
    { 89.3891974230f,  74.8803127309f,  104.6426466962f },
    { 89.1177620347f,  74.9432002599f,  105.4212694751f },
    { 88.8451766564f,  75.0209459569f,  106.2037853897f },
    { 88.5714266757f,  75.1138116123f,  106.9899381775f },
    { 88.2964971635f,  75.2220569299f,  107.7794640101f },
    { 88.0203728649f,  75.3459392949f,  108.5720919692f },
    { 87.7430381886f,  75.4857135544f,  109.3675445596f },
    { 87.4644771968f,  75.6416318110f,  110.1655382588f },
    { 87.1846735940f,  75.8139432323f,  110.9657840985f },
    { 86.9036107156f,  76.0028938771f,  111.7679882773f },
    { 86.6212715165f,  76.2087265406f,  112.5718528001f },
    { 86.3376385583f,  76.4316806194f,  113.3770761423f },
    { 86.0526939965f,  76.6719919983f,  114.1833539337f },
    { 85.7664195676f,  76.9298929601f,  114.9903796598f },
    { 85.4787965746f,  77.2056121197f,  115.7978453756f },
    { 85.1898058725f,  77.4993743831f,  116.6054424282f },
    { 84.8994278536f,  77.8114009333f,  117.4128621840f },
    { 84.6076424310f,  78.1419092430f,  118.2197967564f },
    { 84.3144290224f,  78.4911131155f,  119.0259397292f },
    { 84.0197665328f,  78.8592227537f,  119.8309868727f },
    { 83.7236333363f,  79.2464448587f,  120.6346368469f },
    { 83.4260072570f,  79.6529827572f,  121.4365918891f },
    { 83.1268655497f,  80.0790365586f,  122.2365584815f },
    { 82.8261848788f,  80.5248033415f,  123.0342479956f },
    { 82.5239412967f,  80.9904773700f,  123.8293773097f },
    { 82.2201102209f,  81.4762503386f,  124.6216693964f },
    { 81.9146664105f,  81.9823116470f,  125.4108538778f },
    { 81.6075839411f,  82.5088487030f,  126.1966675461f },
    { 81.2988361785f,  83.0560472536f,  126.9788548464f },
    { 80.9883957512f,  83.6240917441f,  127.7571683216f },
    { 80.6762345214f,  84.2131657040f,  128.5313690164f },
    { 80.3623235549f,  84.8234521600f,  129.3012268413f },
    { 80.0466330891f,  85.4551340746f,  130.0665208933f },
    { 79.7291324990f,  86.1083948105f,  130.8270397364f },
    { 79.4097902624f,  86.7834186194f,  131.5825816383f },
    { 79.0885739223f,  87.4803911562f,  132.3329547669f },
    { 78.7654500476f,  88.1995000163f,  133.0779773450f },
    { 78.4403841921f,  88.9409352969f,  133.8174777652f },
    { 78.1133408503f,  89.7048901823f,  134.5512946661f },
    { 77.7842834116f,  90.4915615516f,  135.2792769706f },
    { 77.4531741115f,  91.3011506103f,  136.0012838890f },
    { 77.1199739800f,  92.1338635457f,  136.7171848878f },
    { 76.7846427873f,  92.9899122056f,  137.4268596264f },
    { 76.4471389857f,  93.8695148020f,  138.1301978639f },
    { 76.1074196488f,  94.7728966393f,  138.8270993379f },
    { 75.7654404065f,  95.7002908695f,  139.5174736185f },
    { 75.4211553763f,  96.6519392742f,  140.2012399375f },
    { 75.0745170900f,  97.6280930755f,  140.8783269982f },
    { 74.7254764164f,  98.6290137782f,  141.5486727653f },
    { 74.3739824783f,  99.6549740438f,  142.2122242390f },
    { 74.0199825649f,  100.7062586004f,  142.8689372146f },
    { 73.6634220380f,  101.7831651902f,  143.5187760301f },
    { 73.3042442318f,  102.8860055583f,  144.1617133043f },
    { 72.9423903469f,  104.0151064862f,  144.7977296662f },
    { 73.1737770306f,  100.2259992898f,  146.2885560169f },
    { 73.3926421235f,  97.1724522755f,  147.6153629898f },
    { 73.6032712109f,  94.5962069754f,  148.8363153220f },
    { 73.8079242210f,  92.3610745292f,  149.9820439294f },
    { 74.0079616899f,  90.3850653347f,  151.0709171676f },
    { 74.2042762442f,  88.6143896876f,  152.1149111470f },
    { 74.3974902015f,  87.0115511535f,  153.1223048868f },
    { 74.5880575650f,  85.5492003847f,  154.0990742007f },
    { 74.7763214344f,  84.2066751783f,  155.0496775267f },
    { 74.9625485244f,  82.9679198496f,  155.9775290285f },
    { 75.1469510294f,  81.8201671747f,  156.8852985796f },
    { 75.3297010681f,  80.7530674163f,  157.7751101464f },
    { 75.5109405667f,  79.7580923169f,  158.6486776336f },
    { 75.6907882230f,  78.8281150700f,  159.5074006776f },
    { 75.8693445377f,  77.9571067787f,  160.3524339149f },
    { 76.0466955301f,  77.1399122766f,  161.1847381702f },
    { 76.2229155346f,  76.3720813926f,  162.0051190077f },
    { 76.3980693400f,  75.6497398076f,  162.8142562544f },
    { 76.5722138526f,  74.9694887376f,  163.6127269482f },
    { 76.7453994037f,  74.3283259685f,  164.4010234118f },
    { 76.9176707923f,  73.7235829548f,  165.1795676573f },
    { 77.0890681243f,  73.1528741713f,  165.9487229898f },
    { 77.2596274951f,  72.6140559310f,  166.7088034446f },
    { 77.4293815494f,  72.1051925994f,  167.4600815287f },
    { 77.5983599447f,  71.6245286502f,  168.2027946216f },
    { 77.7665897375f,  71.1704653779f,  168.9371503049f },
    { 77.9340957076f,  70.7415413561f,  169.6633308281f },
    { 78.1009006317f,  70.3364159345f,  170.3814968720f },
    { 78.2670255168f,  69.9538552175f,  171.0917907358f },
    { 78.4324897990f,  69.5927200856f,  171.7943390492f },
    { 78.5973115143f,  69.2519559098f,  172.4892550892f },
    { 78.7615074468f,  68.9305836747f,  173.1766407651f },
    { 78.9250932561f,  68.6276922845f,  173.8565883259f },
    { 79.0880835899f,  68.3424318638f,  174.5291818307f },
    { 79.2504921805f,  68.0740079029f,  175.1944984194f },
    { 79.4123319317f,  67.8216761190f,  175.8526094107f },
    { 79.5736149934f,  67.5847379322f,  176.5035812532f },
    { 79.7343528290f,  67.3625364664f,  177.1474763487f },
    { 79.8945562745f,  67.1544530041f,  177.7843537663f },
    { 80.0542355914f,  66.9599038335f,  178.4142698601f },
    { 80.2134005136f,  66.7783374355f,  179.0372788036f },
    { 80.3720602898f,  66.6092319672f,  179.6534330516f },
    { 80.5302237212f,  66.4520930040f,  180.2627837384f },
    { 80.6878991957f,  66.3064515090f,  180.8653810201f },
    { 80.8450947184f,  66.1718620015f,  181.4612743676f },
    { 81.0018179396f,  66.0479009011f,  182.0505128167f },
    { 81.1580761799f,  65.9341650272f,  182.6331451798f },
    { 81.3138764530f,  65.8302702360f,  183.2092202247f },
    { 81.4692254865f,  65.7358501795f,  183.7787868233f },
    { 81.6241297409f,  65.6505551735f,  184.3418940745f },
    { 81.7785954272f,  65.5740511625f,  184.8985914044f },
    { 81.9326285222f,  65.5060187711f,  185.4489286458f },
    { 82.0862347833f,  65.4461524338f,  185.9929561006f },
    { 82.2394197622f,  65.3941595937f,  186.5307245860f },
    { 82.3921888166f,  65.3497599650f,  187.0622854679f },
    { 82.5445471217f,  65.3126848513f,  187.5876906814f },
    { 82.6964996810f,  65.2826765157f,  188.1069927416f },
    { 82.8480513355f,  65.2594875970f,  188.6202447452f },
    { 82.9992067728f,  65.2428805678f,  189.1275003646f },
    { 83.1499705353f,  65.2326272306f,  189.6288138348f },
    { 82.6552641854f,  64.7953381170f,  190.1327347012f },
    { 82.1569776446f,  64.3597566824f,  190.6477349489f },
    { 81.6550375270f,  63.9260508954f,  191.1741303355f },
    { 81.1493679274f,  63.4943982845f,  191.7122453020f },
    { 80.6398902983f,  63.0649864768f,  192.2624130054f },
    { 80.1265233208f,  62.6380137655f,  192.8249753185f },
    { 79.6091827653f,  62.2136897082f,  193.4002827930f },
    { 79.0877813444f,  61.7922357578f,  193.9886945795f },
    { 78.5622285560f,  61.3738859257f,  194.5905783000f },
    { 78.0324305151f,  60.9588874812f,  195.2063098657f },
    { 77.4982897753f,  60.5475016856f,  195.8362732332f },
    { 76.9597051370f,  60.1400045643f,  196.4808600924f },
    { 76.4165714427f,  59.7366877169f,  197.1404694778f },
    { 75.8687793577f,  59.3378591678f,  197.8155072946f },
    { 75.3162151346f,  58.9438442568f,  198.5063857501f },
    { 74.7587603612f,  58.5549865715f,  199.2135226810f },
    { 74.1962916886f,  58.1716489228f,  199.9373407670f },
    { 73.6286805398f,  57.7942143637f,  200.6782666181f },
    { 73.0557927947f,  57.4230872516f,  201.4367297261f },
    { 72.4774884508f,  57.0586943558f,  202.2131612679f },
    { 71.8936212576f,  56.7014860096f,  203.0079927494f },
    { 71.3040383195f,  56.3519373071f,  203.8216544773f },
    { 70.7085796675f,  56.0105493454f,  204.6545738485f },
    { 70.1070777935f,  55.6778505113f,  205.5071734446f },
    { 69.4993571455f,  55.3543978126f,  206.3798689230f },
    { 68.8852335779f,  55.0407782537f,  207.2730666928f },
    { 68.2645137529f,  54.7376102549f,  208.1871613698f },
    { 67.6369944872f,  54.4455451153f,  209.1225330043f },
    { 67.0024620379f,  54.1652685194f,  210.0795440780f },
    { 66.3606913206f,  53.8975020877f,  211.0585362704f },
    { 65.7114450519f,  53.6430049717f,  212.0598269985f },
    { 65.0544728058f,  53.4025754967f,  213.0837057384f },
    { 64.3895099756f,  53.1770528543f,  214.1304301409f },
    { 63.7162766273f,  52.9673188501f,  215.2002219628f },
    { 63.0344762315f,  52.7742997144f,  216.2932628386f },
    { 62.3437942575f,  52.5989679857f,  217.4096899264f },
    { 61.6438966103f,  52.4423444824f,  218.5495914705f },
    { 60.9344278897f,  52.3055003801f,  219.7130023299f },
    { 60.2150094446f,  52.1895594229f,  220.8998995321f },
    { 59.4852371940f,  52.0957002990f,  222.1101979186f },
    { 58.7446791777f,  52.0251592256f,  223.3437459601f },
    { 57.9928727967f,  51.9792327961f,  224.6003218227f },
    { 57.2293216921f,  51.9592811584f,  225.8796297766f },
    { 56.4534922040f,  51.9667316105f,  227.1812970421f },
    { 55.6648093388f,  52.0030827191f,  228.5048711707f },
    { 54.8626521593f,  52.0699090945f,  229.8498180584f },
    { 54.0463484928f,  52.1688669839f,  231.2155206851f },
    { 53.2151688310f,  52.3017008843f,  232.6012786666f },
    { 52.3683192640f,  52.4702514238f,  234.0063086905f },
    { 51.5049332561f,  52.6764648152f,  235.4297458907f },
    { 50.6240620227f,  52.9224042604f,  236.8706461891f },
    { 49.7246632057f,  53.2102637756f,  238.3279895968f },
    { 48.8055874662f,  53.5423850203f,  239.8006844272f },
    { 47.8655625047f,  53.9212778693f,  241.2875723131f },
    { 46.9031738817f,  54.3496456584f,  242.7874338512f },
    { 45.9168418183f,  54.8304163018f,  244.2989945966f },
    { 44.9047928978f,  55.3667808304f,  245.8209310046f },
    { 43.8650252293f,  55.9622413829f,  247.3518757333f },
    { 42.7952651285f,  56.6206713573f,  248.8904214568f },
    { 41.6929126477f,  57.3463913778f,  250.4351219483f },
    { 42.4088722861f,  55.6791623279f,  253.4692702535f },
    { 43.1068015758f,  54.2239249082f,  256.5502295332f },
    { 43.7880181863f,  52.9704797675f,  259.6656364138f },
    { 44.4536858858f,  51.9089882292f,  262.8017890532f },
    { 45.1048385499f,  51.0297540091f,  265.9440539464f },
    { 45.7423995698f,  50.3230773693f,  269.0773344822f },
    { 46.3671976916f,  49.7791744291f,  272.1865684892f },
    { 46.9799800559f,  49.3881531133f,  275.2572174740f },
    { 47.5814230191f,  49.1400356077f,  278.2757110920f },
    { 48.1721412003f,  49.0248158980f,  281.2298163954f },
    { 48.7526950958f,  49.0325404614f,  284.1089112112f },
    { 49.3235975290f,  49.1534006410f,  286.9041525993f },
    { 49.8853191460f,  49.3778266118f,  289.6085425596f },
    { 50.4382931231f,  49.6965748835f,  292.2169022777f },
    { 50.9829192216f,  50.1008036387f,  294.7257722416f },
    { 51.5195672939f,  50.5821325417f,  297.1332583256f },
    { 52.0485803329f,  51.1326857100f,  299.4388438616f },
    { 52.5702771316f,  51.7451181664f,  301.6431855843f },
    { 53.0849546143f,  52.4126272275f,  303.7479080154f },
    { 53.5928898872f,  53.1289509670f,  305.7554071107f },
    { 54.0943420475f,  53.8883561897f,  307.6686704081f },
    { 54.5895537863f,  54.6856183691f,  309.4911178115f },
    { 55.0787528124f,  55.5159958198f,  311.2264646975f },
    { 55.5621531209f,  56.3752000953f,  312.8786072423f },
    { 56.0399561271f,  57.2593642630f,  314.4515286736f },
    { 56.5123516824f,  58.1650103788f,  315.9492244410f },
    { 56.9795189874f,  59.0890171672f,  317.3756439649f },
    { 57.4416274139f,  60.0285886458f,  318.7346465421f },
    { 57.8988372473f,  60.9812242033f,  320.0299690812f },
    { 58.3513003581f,  61.9446904570f,  321.2652035357f },
    { 58.7991608110f,  62.9169950753f,  322.4437821467f },
    { 59.2425554185f,  63.8963626411f,  323.5689688681f },
    { 59.6816142448f,  64.8812125539f,  324.6438556007f },
    { 60.1164610654f,  65.8701389152f,  325.6713620967f },
    { 60.5472137875f,  66.8618923022f,  326.6542386056f },
    { 60.9739848346f,  67.8553633148f,  327.5950705109f },
    { 61.3968814991f,  68.8495677670f,  328.4962843629f },
    { 61.8160062668f,  69.8436333908f,  329.3601548399f },
    { 62.2314571147f,  70.8367879189f,  330.1888122729f },
    { 62.6433277860f,  71.8283484202f,  330.9842504574f },
    { 63.0517080436f,  72.8177117653f,  331.7483345423f },
    { 63.4566839042f,  73.8043461103f,  332.4828088406f },
    { 63.8583378557f,  74.7877832928f,  333.1893044513f },
    { 64.2567490574f,  75.7676120459f,  333.8693466118f },
    { 64.6519935267f,  76.7434719430f,  334.5243617319f },
    { 65.0441443126f,  77.7150479936f,  335.1556840738f },
    { 65.4332716561f,  78.6820658208f,  335.7645620631f },
    { 65.8194431406f,  79.6442873569f,  336.3521642246f },
    { 66.2027238315f,  80.6015069997f,  336.9195847447f },
    { 66.5831764067f,  81.5535481793f,  337.4678486696f },
    { 66.9608612783f,  82.5002602902f,  337.9979167516f },
    { 67.3358367068f,  83.4415159491f,  338.5106899585f },
    { 67.7081589074f,  84.3772085418f,  339.0070136649f },
    { 68.0778821502f,  85.3072500282f,  339.4876815407f },
    { 68.4450588537f,  86.2315689773f,  339.9534391582f },
    { 68.8097396731f,  87.1501088065f,  340.4049873337f },
    { 69.1719735824f,  88.0628262039f,  340.8429852228f },
    { 69.5318079526f,  88.9696897135f,  341.2680531866f },
    { 69.8892886246f,  89.8706784658f,  341.6807754444f },
    { 70.2444599782f,  90.7657810381f,  342.0817025293f },
    { 70.0523865328f,  91.0555435502f,  342.4771243840f },
    { 69.8595104850f,  91.3512328607f,  342.8745253084f },
    { 69.6658198254f,  91.6529372676f,  343.2739464532f },
    { 69.4713021913f,  91.9607466599f,  343.6754320761f },
    { 69.2759448499f,  92.2747525544f,  344.0790297765f },
    { 69.0797346811f,  92.5950481343f,  344.4847907493f },
    { 68.8826581583f,  92.9217282874f,  344.8927700619f },
    { 68.6847013288f,  93.2548896448f,  345.3030269553f },
    { 68.4858497916f,  93.5946306202f,  345.7156251736f },
    { 68.2860886750f,  93.9410514487f,  346.1306333233f },
    { 68.0854026112f,  94.2942542258f,  346.5481252677f },
    { 67.8837757102f,  94.6543429464f,  346.9681805590f },
    { 67.6811915305f,  95.0214235427f,  347.3908849134f },
    { 67.4776330483f,  95.3956039219f,  347.8163307347f },
    { 67.2730826240f,  95.7769940027f,  348.2446176916f },
    { 67.0675219657f,  96.1657057502f,  348.6758533565f },
    { 66.8609320894f,  96.5618532095f,  349.1101539131f },
    { 66.6532932764f,  96.9655525367f,  349.5476449430f },
    { 66.4445850259f,  97.3769220274f,  349.9884623009f },
    { 66.2347860040f,  97.7960821421f,  350.4327530916f },
    { 66.0238739871f,  98.2231555274f,  350.8806767634f },
    { 65.8118258002f,  98.6582670330f,  351.3324063350f },
    { 65.5986172484f,  99.1015437226f,  351.7881297759f },
    { 65.3842230416f,  99.5531148796f,  352.2480515638f },
    { 65.1686167105f,  100.0131120040f,  352.7123944484f },
    { 64.9517705139f,  100.4816688024f,  353.1814014537f },
    { 64.7336553339f,  100.9589211673f,  353.6553381602f },
    { 64.5142405594f,  101.4450071458f,  354.1344953153f },
    { 64.2934939550f,  101.9400668963f,  354.6191918296f },
    { 64.0713815117f,  102.4442426317f,  355.1097782311f },
    { 63.8478672783f,  102.9576785470f,  355.6066406637f },
    { 63.6229131689f,  103.4805207317f,  356.1102055380f },
    { 63.3964787413f,  104.0129170651f,  356.6209449646f },
    { 63.1685209423f,  104.5550170945f,  357.1393831371f },
    { 62.9389938111f,  105.1069718978f,  357.6661038709f },
    { 62.7078481335f,  105.6689339317f,  358.2017595600f },
    { 62.4750310347f,  106.2410568720f,  358.7470818872f },
    { 62.2404854973f,  106.8234954539f,  359.3028947182f },
    { 62.0041497848f,  107.4164053281f,  359.8701297419f }
};

// cGamutReachTable removed as it duplicates gamutCuspTableReach

__CONSTANT__ float gamutTopGamma[360] = 
{
    0.883319091796875f,
    0.882440185546875f,
    0.881579589843750f,
    0.880755615234375f,
    0.879949951171875f,
    0.879174804687500f,
    0.878430175781250f,
    0.877716064453125f,
    0.877038574218750f,
    0.876391601562500f,
    0.875781250000000f,
    0.875201416015625f,
    0.874664306640625f,
    0.874157714843750f,
    0.873693847656250f,
    0.873272705078125f,
    0.872875976562500f,
    0.872534179687500f,
    0.872210693359375f,
    0.871948242187500f,
    0.871704101562500f,
    0.871508789062500f,
    0.871356201171875f,
    0.871215820312500f,
    0.871136474609375f,
    0.871105957031250f,
    0.873925781250000f,
    0.876800537109375f,
    0.879589843750000f,
    0.882122802734375f,
    0.884606933593750f,
    0.887023925781250f,
    0.889257812500000f,
    0.891467285156250f,
    0.893591308593750f,
    0.895599365234375f,
    0.897595214843750f,
    0.899487304687500f,
    0.901330566406250f,
    0.903167724609375f,
    0.904876708984375f,
    0.906591796875000f,
    0.908251953125000f,
    0.909863281250000f,
    0.911474609375000f,
    0.913000488281250f,
    0.914532470703125f,
    0.916033935546875f,
    0.917480468750000f,
    0.918951416015625f,
    0.920349121093750f,
    0.921752929687500f,
    0.923150634765625f,
    0.924499511718750f,
    0.925860595703125f,
    0.927191162109375f,
    0.928509521484375f,
    0.929846191406250f,
    0.931127929687500f,
    0.932427978515625f,
    0.933721923828125f,
    0.934991455078125f,
    0.936279296875000f,
    0.937554931640625f,
    0.938818359375000f,
    0.940106201171875f,
    0.941381835937500f,
    0.942645263671875f,
    0.943933105468750f,
    0.945233154296875f,
    0.946514892578125f,
    0.947814941406250f,
    0.949139404296875f,
    0.950463867187500f,
    0.951788330078125f,
    0.953137207031250f,
    0.954516601562500f,
    0.955926513671875f,
    0.957330322265625f,
    0.958758544921875f,
    0.960229492187500f,
    0.961730957031250f,
    0.963275146484375f,
    0.964855957031250f,
    0.966491699218750f,
    0.968176269531250f,
    0.969915771484375f,
    0.971722412109375f,
    0.973608398437500f,
    0.975585937500000f,
    0.977667236328125f,
    0.979882812500000f,
    0.982257080078125f,
    0.984820556640625f,
    0.974450683593750f,
    0.954150390625000f,
    0.933551025390625f,
    0.912408447265625f,
    0.890625000000000f,
    0.867816162109375f,
    0.847589111328125f,
    0.851385498046875f,
    0.854931640625000f,
    0.858258056640625f,
    0.861389160156250f,
    0.864331054687500f,
    0.867114257812500f,
    0.869738769531250f,
    0.872229003906250f,
    0.874591064453125f,
    0.876837158203125f,
    0.878967285156250f,
    0.880999755859375f,
    0.882934570312500f,
    0.884783935546875f,
    0.886547851562500f,
    0.888238525390625f,
    0.889849853515625f,
    0.891400146484375f,
    0.892883300781250f,
    0.894305419921875f,
    0.895672607421875f,
    0.896978759765625f,
    0.898236083984375f,
    0.899450683593750f,
    0.900610351562500f,
    0.901727294921875f,
    0.902801513671875f,
    0.903833007812500f,
    0.904821777343750f,
    0.905773925781250f,
    0.906689453125000f,
    0.907568359375000f,
    0.908410644531250f,
    0.909216308593750f,
    0.909991455078125f,
    0.910729980468750f,
    0.911437988281250f,
    0.913812255859375f,
    0.916528320312500f,
    0.919024658203125f,
    0.921350097656250f,
    0.923529052734375f,
    0.925567626953125f,
    0.927484130859375f,
    0.929278564453125f,
    0.930969238281250f,
    0.932562255859375f,
    0.934057617187500f,
    0.935473632812500f,
    0.936804199218750f,
    0.938061523437500f,
    0.939251708984375f,
    0.940374755859375f,
    0.941436767578125f,
    0.942437744140625f,
    0.943383789062500f,
    0.944281005859375f,
    0.945129394531250f,
    0.945928955078125f,
    0.946679687500000f,
    0.947393798828125f,
    0.948065185546875f,
    0.948693847656250f,
    0.949285888671875f,
    0.949841308593750f,
    0.950360107421875f,
    0.950842285156250f,
    0.951293945312500f,
    0.951708984375000f,
    0.952087402343750f,
    0.952441406250000f,
    0.952758789062500f,
    0.953039550781250f,
    0.953295898437500f,
    0.953515625000000f,
    0.953704833984375f,
    0.953857421875000f,
    0.953979492187500f,
    0.954071044921875f,
    0.954125976562500f,
    0.954144287109375f,
    0.954132080078125f,
    0.954077148437500f,
    0.953991699218750f,
    0.953863525390625f,
    0.953692626953125f,
    0.953485107421875f,
    0.953228759765625f,
    0.952929687500000f,
    0.952581787109375f,
    0.952172851562500f,
    0.951715087890625f,
    0.951196289062500f,
    0.950622558593750f,
    0.949987792968750f,
    0.964013671875000f,
    0.965936279296875f,
    0.966912841796875f,
    0.967755126953125f,
    0.968499755859375f,
    0.969146728515625f,
    0.969714355468750f,
    0.970214843750000f,
    0.970660400390625f,
    0.971044921875000f,
    0.971386718750000f,
    0.971685791015625f,
    0.971948242187500f,
    0.972174072265625f,
    0.972375488281250f,
    0.972546386718750f,
    0.972698974609375f,
    0.972827148437500f,
    0.972937011718750f,
    0.973028564453125f,
    0.973095703125000f,
    0.973150634765625f,
    0.973187255859375f,
    0.973205566406250f,
    0.973217773437500f,
    0.973217773437500f,
    0.973211669921875f,
    0.973193359375000f,
    0.973150634765625f,
    0.973101806640625f,
    0.973046875000000f,
    0.972979736328125f,
    0.972906494140625f,
    0.972827148437500f,
    0.972729492187500f,
    0.972619628906250f,
    0.972509765625000f,
    0.972387695312500f,
    0.972253417968750f,
    0.972119140625000f,
    0.971966552734375f,
    0.971801757812500f,
    0.971624755859375f,
    0.971441650390625f,
    0.971252441406250f,
    0.971044921875000f,
    0.970831298828125f,
    0.970605468750000f,
    0.970361328125000f,
    0.970104980468750f,
    0.969830322265625f,
    0.969537353515625f,
    0.969232177734375f,
    0.968908691406250f,
    0.968560791015625f,
    0.968188476562500f,
    0.967791748046875f,
    0.967370605468750f,
    0.966912841796875f,
    0.966418457031250f,
    0.965875244140625f,
    0.965270996093750f,
    0.964599609375000f,
    0.964355468750000f,
    0.964416503906250f,
    0.964447021484375f,
    0.964526367187500f,
    0.964538574218750f,
    0.964605712890625f,
    0.964630126953125f,
    0.964685058593750f,
    0.964721679687500f,
    0.964758300781250f,
    0.964807128906250f,
    0.964837646484375f,
    0.964898681640625f,
    0.964910888671875f,
    0.964965820312500f,
    0.964990234375000f,
    0.965032958984375f,
    0.965069580078125f,
    0.965093994140625f,
    0.965148925781250f,
    0.965161132812500f,
    0.965209960937500f,
    0.965234375000000f,
    0.965264892578125f,
    0.965307617187500f,
    0.965325927734375f,
    0.965368652343750f,
    0.965393066406250f,
    0.965417480468750f,
    0.965460205078125f,
    0.965478515625000f,
    0.965502929687500f,
    0.965551757812500f,
    0.965563964843750f,
    0.965588378906250f,
    0.965631103515625f,
    0.965649414062500f,
    0.965667724609375f,
    0.965698242187500f,
    0.965734863281250f,
    0.965747070312500f,
    0.965771484375000f,
    0.965802001953125f,
    0.965832519531250f,
    0.965850830078125f,
    0.965869140625000f,
    0.965893554687500f,
    0.965911865234375f,
    0.965936279296875f,
    0.965960693359375f,
    0.965985107421875f,
    0.966003417968750f,
    0.966021728515625f,
    0.966040039062500f,
    0.966058349609375f,
    0.966070556640625f,
    0.966088867187500f,
    0.966101074218750f,
    0.966113281250000f,
    0.966131591796875f,
    0.966143798828125f,
    0.966149902343750f,
    0.966156005859375f,
    0.966168212890625f,
    0.966162109375000f,
    0.966174316406250f,
    0.958422851562500f,
    0.948925781250000f,
    0.939556884765625f,
    0.930303955078125f,
    0.921142578125000f,
    0.917340087890625f,
    0.915991210937500f,
    0.914660644531250f,
    0.913348388671875f,
    0.912048339843750f,
    0.910772705078125f,
    0.909509277343750f,
    0.908258056640625f,
    0.907025146484375f,
    0.905804443359375f,
    0.904595947265625f,
    0.903405761718750f,
    0.902221679687500f,
    0.901049804687500f,
    0.899896240234375f,
    0.898748779296875f,
    0.897619628906250f,
    0.896502685546875f,
    0.895397949218750f,
    0.894299316406250f,
    0.893218994140625f,
    0.892156982421875f,
    0.891107177734375f,
    0.890069580078125f,
    0.889050292968750f,
    0.888043212890625f,
    0.887060546875000f,
    0.886096191406250f,
    0.885150146484375f,
    0.884222412109375f
};

#include "hellwig_lib_v055.h"

__DEVICE__ float3 transform(int p_Width, int p_Height, int p_X, int p_Y, float p_R, float p_G, float p_B)
{
    float3 in = make_float3(p_R, p_G, p_B);
    float3 out = in;

    float3 XYZ;

    if (!invert)
    {
        XYZ = vector_dot(AP0_ACES_to_XYZ_matrix, in);
        if (ap1Clip)
        {
            float3 AP1 = vector_dot(XYZ_to_AP1_ACES_matrix, XYZ);
            AP1.x = _fmaxf(AP1.x, 0.0f);
            AP1.y = _fmaxf(AP1.y, 0.0f);
            AP1.z = _fmaxf(AP1.z, 0.0f);
            XYZ = vector_dot(AP1_ACES_to_XYZ_matrix, AP1);
        }
    }
    else
    {
        in = float3spow(in, 2.4f);
        XYZ = vector_dot(RGB_to_XYZ_output, in);
    }
    XYZ *= referenceLuminance;
    float3 JMh;
    if (!invert)
    {
        JMh = XYZ_to_Hellwig2022_JMh(XYZ, inWhite);
        if (toneCurve)
        {
            JMh = forwardTonescale(JMh, compressChroma);
        }
        if (gamutCompress)
        {
            JMh = compressGamut(JMh, 0);
        }
    }
    else
    {
        JMh = XYZ_to_Hellwig2022_JMh(XYZ, d65White);
        if (gamutCompress)
        {
            JMh = compressGamut(JMh, 1);
        }
        if (toneCurve)
        {
            JMh = inverseTonescale(JMh, compressChroma);
        }
    }
    if (JMhOut)
    {
        out.x = JMh.x / referenceLuminance;
        out.y = JMh.y / referenceLuminance;
        out.z = JMh.z / 360.0f;
    }
    else
    {
        if (!invert)
        {
            if (!d60Sim)
            {
                XYZ = Hellwig2022_JMh_to_XYZ(JMh , d65White) / referenceLuminance;
            }
            else
            {
                XYZ = Hellwig2022_JMh_to_XYZ(JMh , inWhite) / referenceLuminance;
                float3 creativeWhiteXYZ = vector_dot(RGB_to_XYZ_709D60, make_float3(1.0f, 1.0f, 1.0f));
                float3 creativeWhiteRGB = vector_dot(XYZ_to_RGB_limit, creativeWhiteXYZ);
                XYZ *= 1.0f / max(creativeWhiteRGB.x, max(creativeWhiteRGB.y, creativeWhiteRGB.z));
            }
            out = vector_dot(XYZ_to_RGB_limit, XYZ);

            // Soft clamp by compressing negative display linear values
            if (softClip)
            {
                float3 compr = make_float3(clamp_thr, clamp_dist, 1.2f);
                out = compress_aces(out, compr, compr, compr, 0);
            }

            // hard clip 0-1
            if (hardClip)
            {
                out = clamp3(out, 0.0f, 1.0f);
            }
            
            if (asPQ)
            {
                out = referenceLuminance * vector_dot(BT709_to_BT2020, out);
                out.x = linear_to_ST2084(out.x);
                out.y = linear_to_ST2084(out.y);
                out.z = linear_to_ST2084(out.z);
            }
            else
            {
                out = float3spow(out, 1.0f / 2.4f);
            }
        }
        else
        {
            XYZ = Hellwig2022_JMh_to_XYZ(JMh , inWhite) / referenceLuminance;
            out = vector_dot(XYZ_to_AP0_ACES_matrix, XYZ);
        }
    }

    return out;
}