DEFINE_ACES_PARAM(IS_PARAMETRIC_ACES_TRANSFORM: 0)

DEFINE_UI_PARAMS(toneCurve, Tone Curve, DCTLUI_CHECK_BOX, 1)
DEFINE_UI_PARAMS(compressChroma, Compress Chroma, DCTLUI_CHECK_BOX, 1)
DEFINE_UI_PARAMS(gamutCompress, Gamut Compress, DCTLUI_CHECK_BOX, 1)
DEFINE_UI_PARAMS(d60Sim, D60 Sim, DCTLUI_CHECK_BOX, 0)
DEFINE_UI_PARAMS(asPQ, Encode as BT.2100 PQ, DCTLUI_CHECK_BOX, 0)
DEFINE_UI_PARAMS(ap1Clip, AP1 Clamp, DCTLUI_CHECK_BOX, 1)
DEFINE_UI_PARAMS(softClip, Soft Clip, DCTLUI_CHECK_BOX, 0)
DEFINE_UI_PARAMS(hardClip, Clamp, DCTLUI_CHECK_BOX, 1)
DEFINE_UI_PARAMS(invert, Invert, DCTLUI_CHECK_BOX, 1)
DEFINE_UI_PARAMS(JMhOut, Diagnostic JMh Output, DCTLUI_CHECK_BOX, 0)


typedef struct
{
    float3 x;
    float3 y;
    float3 z;
} float3x3;

// Constant values generated in Python
// https://github.com/nick-shaw/aces-ot-vwg-experiments/blob/master/python/v58_init_plot.py

__CONSTANT__ float3x3 XYZ_to_RGB_limit =
{
// XYZ to sRGB matrix
    {  3.2409699419f, -1.5373831776f, -0.4986107603f},
    { -0.9692436363f,  1.8759675015f,  0.0415550574f},
    {  0.0556300797f, -0.2039769589f,  1.0569715142f}
};

__CONSTANT__ float3x3 RGB_to_XYZ_output =
{
// sRGB to XYZ matrix
    {  0.4123907993f,  0.3575843394f,  0.1804807884f},
    {  0.2126390059f,  0.7151686788f,  0.0721923154f},
    {  0.0193308187f,  0.1191947798f,  0.9505321522f}
};

__CONSTANT__ float3x3 RGB_to_XYZ_709D60 =
{
    {  0.4318156527f,  0.3556330533f,  0.1651973686f},
    {  0.2226549459f,  0.7112661067f,  0.0660789474f},
    {  0.0202413587f,  0.1185443511f,  0.8700394745f}
};

__CONSTANT__ float3x3 BT709_to_BT2020 =
{
    {  0.6274038959f, 0.3292830384f, 0.0433130657f},
    {  0.0690972894f, 0.9195403951f, 0.0113623156f},
    {  0.0163914389f, 0.0880133079f, 0.8955952532f}
};

__CONSTANT__ float limitJmax = 100.0f;
__CONSTANT__ float midJ = 34.0965348204f; // ~10 nits in Hellwig J
__CONSTANT__ float focusDist = 1.35f;

__CONSTANT__ float daniele_n = 100.0f; // peak white
__CONSTANT__ float daniele_m_2 = 1.0471037624f;
__CONSTANT__ float daniele_s_2 = 0.9198582542f;
__CONSTANT__ float daniele_u_2 = 0.9917990155f;

// Chroma compression scaling for HDR/SDR appearance match
__CONSTANT__ float compr = 2.4f;
__CONSTANT__ float sat = 1.3f;
__CONSTANT__ float sat_thr = 0.005f;

__CONSTANT__ float3 gamutCuspTable[360] = 
{
    { 54.0476312661f,  68.7457035890f,  0.7302962138f },
    { 53.7691170740f,  68.9407685377f,  1.7567935919f },
    { 53.4880853747f,  69.1494734731f,  2.8242870469f },
    { 53.2044046647f,  69.3730047674f,  3.9374311870f },
    { 52.9179234646f,  69.6127963030f,  5.1018093950f },
    { 52.6284648940f,  69.8706117438f,  6.3242025306f },
    { 52.3358191093f,  70.1486633341f,  7.6129643561f },
    { 52.0397324679f,  70.4497881332f,  8.9785600992f },
    { 51.7398914984f,  70.7777178630f,  10.4343634678f },
    { 51.4358982588f,  71.1375080217f,  11.9978809261f },
    { 51.1272306587f,  71.5362524286f,  13.6927197411f },
    { 50.8131747716f,  71.9843434267f,  15.5519364488f },
    { 50.4927004891f,  72.4978649845f,  17.6241658168f },
    { 50.1642093141f,  73.1036108822f,  19.9859936968f },
    { 49.8249456432f,  73.8512035088f,  22.7706695319f },
    { 49.4692848038f,  74.8496205424f,  26.2509880110f },
    { 50.5589209905f,  71.6861436289f,  27.8759787296f },
    { 51.6166013311f,  68.8219544726f,  29.5321198974f },
    { 52.6452577831f,  66.2217783384f,  31.2185777347f },
    { 53.6473649041f,  63.8567031116f,  32.9341114709f },
    { 54.6250375939f,  61.7027075000f,  34.6770971641f },
    { 55.5801030918f,  59.7395856345f,  36.4455495148f },
    { 56.5141551167f,  57.9501457020f,  38.2371444816f },
    { 57.4285953219f,  56.3196025745f,  40.0492445790f },
    { 58.3246655507f,  54.8351107491f,  41.8789280436f },
    { 59.2034732940f,  53.4854007561f,  43.7230224765f },
    { 60.0660120434f,  52.2604932410f,  45.5781430821f },
    { 60.9131777508f,  51.1514723109f,  47.4407351852f },
    { 61.7457822796f,  50.1503047688f,  49.3071203385f },
    { 62.5645645022f,  49.2496953455f,  51.1735450237f },
    { 63.3701995360f,  48.4429704827f,  53.0362307203f },
    { 64.1633064905f,  47.7239849640f,  54.8914239755f },
    { 64.9444550138f,  47.0870469406f,  56.7354450589f },
    { 65.7141708616f,  46.5268578245f,  58.5647338317f },
    { 66.4729406649f,  46.0384642004f,  60.3758915886f },
    { 67.2212160341f,  45.6172194343f,  62.1657178300f },
    { 67.9594171122f,  45.2587530614f,  63.9312411755f },
    { 68.6879356653f,  44.9589463641f,  65.6697439104f },
    { 69.4071377843f,  44.7139128199f,  67.3787799436f },
    { 70.1173662555f,  44.5199823238f,  69.0561862324f },
    { 70.8189426511f,  44.3736882877f,  70.7000879707f },
    { 71.5121691785f,  44.2717568822f,  72.3088980392f },
    { 72.1973303219f,  44.2110978348f,  73.8813113652f },
    { 72.8746943059f,  44.1887963235f,  75.4162949391f },
    { 73.5445144031f,  44.2021056114f,  76.9130742828f },
    { 74.2070301067f,  44.2484401580f,  78.3711171700f },
    { 74.8624681847f,  44.3253690203f,  79.7901153666f },
    { 75.5110436309f,  44.4306094134f,  81.1699651012f },
    { 76.1529605236f,  44.5620203534f,  82.5107468960f },
    { 76.7884128047f,  44.7175963378f,  83.8127053015f },
    { 77.4175849866f,  44.8954610497f,  85.0762289830f },
    { 78.0406527959f,  45.0938610871f,  86.3018315163f },
    { 78.6577837607f,  45.3111597376f,  87.4901331656f },
    { 79.2691377475f,  45.5458308187f,  88.6418438342f },
    { 79.8748674526f,  45.7964526150f,  89.7577473170f },
    { 80.4751188529f,  46.0617019377f,  90.8386869185f },
    { 81.0700316208f,  46.3403483359f,  91.8855524609f },
    { 81.6597395056f,  46.6312484824f,  92.8992686627f },
    { 82.2443706857f,  46.9333407554f,  93.8807848434f },
    { 82.8240480933f,  47.2456400314f,  94.8310658889f },
    { 83.3988897154f,  47.5672327040f,  95.7510843956f },
    { 83.9690088722f,  47.8972719358f,  96.6418139067f },
    { 84.5345144758f,  48.2349731478f,  97.5042231447f },
    { 85.0955112696f,  48.5796097509f,  98.3392711479f },
    { 85.6521000520f,  48.9305091147f,  99.1479032180f },
    { 86.2043778843f,  49.2870487740f,  99.9310475897f },
    { 86.7524382839f,  49.6486528647f,  100.6896127386f },
    { 87.2963714061f,  50.0147887841f,  101.4244852499f },
    { 87.8362642124f,  50.3849640671f,  102.1365281743f },
    { 88.3722006287f,  50.7587234683f,  102.8265798088f },
    { 88.9042616940f,  51.1356462423f,  103.4954528387f },
    { 89.4325256982f,  51.5153436106f,  104.1439337925f },
    { 89.9570683133f,  51.8974564061f,  104.7727827591f },
    { 90.4779627151f,  52.2816528843f,  105.3827333265f },
    { 90.9952796984f,  52.6676266915f,  105.9744927062f },
    { 91.5090877851f,  53.0550949807f,  106.5487420094f },
    { 91.3144320984f,  53.0913279567f,  107.1148894226f },
    { 91.1192381938f,  53.1331590370f,  107.6830560919f },
    { 90.9235016813f,  53.1806597269f,  108.2531419231f },
    { 90.7272181094f,  53.2339010806f,  108.8250446632f },
    { 90.5303829644f,  53.2929536660f,  109.3986599968f },
    { 90.3329916689f,  53.3578875288f,  109.9738816490f },
    { 90.1350395804f,  53.4287721592f,  110.5506014931f },
    { 89.9365219905f,  53.5056764592f,  111.1287096638f },
    { 89.7374341228f,  53.5886687115f,  111.7080946759f },
    { 89.5377711323f,  53.6778165508f,  112.2886435470f },
    { 89.3375281034f,  53.7731869358f,  112.8702419253f },
    { 89.1367000487f,  53.8748461240f,  113.4527742210f },
    { 88.9352819076f,  53.9828596477f,  114.0361237419f },
    { 88.7332685443f,  54.0972922931f,  114.6201728319f },
    { 88.5306547470f,  54.2182080808f,  115.2048030129f },
    { 88.3274352255f,  54.3456702487f,  115.7898951288f },
    { 88.1236046099f,  54.4797412382f,  116.3753294920f },
    { 87.9191574491f,  54.6204826816f,  116.9609860313f },
    { 87.7140882087f,  54.7679553932f,  117.5467444413f },
    { 87.5083912691f,  54.9222193623f,  118.1324843321f },
    { 87.3020609240f,  55.0833337497f,  118.7180853798f },
    { 87.0950913785f,  55.2513568859f,  119.3034274765f },
    { 86.8874767468f,  55.4263462732f,  119.8883908798f },
    { 86.6792110502f,  55.6083585904f,  120.4728563611f },
    { 86.4702882154f,  55.7974496996f,  121.0567053523f },
    { 86.2607020722f,  55.9936746572f,  121.6398200909f },
    { 86.0504463509f,  56.1970877268f,  122.2220837621f },
    { 85.8395146807f,  56.4077423955f,  122.8033806383f },
    { 85.6279005869f,  56.6256913934f,  123.3835962156f },
    { 85.4155974884f,  56.8509867153f,  123.9626173463f },
    { 85.2025986959f,  57.0836796460f,  124.5403323674f },
    { 84.9888974085f,  57.3238207881f,  125.1166312248f },
    { 84.7744867116f,  57.5714600930f,  125.6914055933f },
    { 84.5593595741f,  57.8266468940f,  126.2645489906f },
    { 84.3435088455f,  58.0894299436f,  126.8359568873f },
    { 84.1269272531f,  58.3598574517f,  127.4055268103f },
    { 83.9096073990f,  58.6379771278f,  127.9731584414f },
    { 83.6915417571f,  58.9238362257f,  128.5387537093f },
    { 83.4727226697f,  59.2174815900f,  129.1022168763f },
    { 83.2531423446f,  59.5189597059f,  129.6634546180f },
    { 83.0327928516f,  59.8283167510f,  130.2223760979f },
    { 82.8116661186f,  60.1455986496f,  130.7788930343f },
    { 82.5897539287f,  60.4708511293f,  131.3329197617f },
    { 82.3670479162f,  60.8041197799f,  131.8843732860f },
    { 82.1435395625f,  61.1454501141f,  132.4331733326f },
    { 81.9192201924f,  61.4948876308f,  132.9792423888f },
    { 81.6940809702f,  61.8524778798f,  133.5225057396f },
    { 81.4681128949f,  62.2182665295f,  134.0628914973f },
    { 81.2413067964f,  62.5922994351f,  134.6003306255f },
    { 81.0136533307f,  62.9746227096f,  135.1347569562f },
    { 80.7851429751f,  63.3652827967f,  135.6661072025f },
    { 80.5557660235f,  63.7643265444f,  136.1943209641f },
    { 80.3255125816f,  64.1718012815f,  136.7193407285f },
    { 80.0943725611f,  64.5877548950f,  137.2411118668f },
    { 79.8623356748f,  65.0122359095f,  137.7595826234f },
    { 79.6293914311f,  65.4452935676f,  138.2747041024f },
    { 79.3955291276f,  65.8869779129f,  138.7864302483f },
    { 79.1607378459f,  66.3373398734f,  139.2947178228f },
    { 78.9250064446f,  66.7964313474f,  139.7995263770f },
    { 78.6883235535f,  67.2643052902f,  140.3008182205f },
    { 78.8779102686f,  65.5148677671f,  141.1419715447f },
    { 79.0653783907f,  63.8818132600f,  141.9770169091f },
    { 79.2509615679f,  62.3503752585f,  142.8082292689f },
    { 79.4348474888f,  60.9087314985f,  143.6374326247f },
    { 79.6171896363f,  59.5472511055f,  144.4661133148f },
    { 79.7981154493f,  58.2579716696f,  145.2954984222f },
    { 79.9777321471f,  57.0342259911f,  146.1266114760f },
    { 80.1561309843f,  55.8703693385f,  146.9603129075f },
    { 80.3333904225f,  54.7615760476f,  147.7973299931f },
    { 80.5095785373f,  53.7036850917f,  148.6382793760f },
    { 80.6847548746f,  52.6930809557f,  149.4836842438f },
    { 80.8589719013f,  51.7266004339f,  150.3339875884f },
    { 81.0322761547f,  50.8014587744f,  151.1895625475f },
    { 81.2047091627f,  49.9151904762f,  152.0507205461f },
    { 81.3763081882f,  49.0656013313f,  152.9177177564f },
    { 81.5471068376f,  48.2507292017f,  153.7907602641f },
    { 81.7171355622f,  47.4688116568f,  154.6700082292f },
    { 81.8864220740f,  46.7182590520f,  155.5555792625f },
    { 82.0549916937f,  45.9976319650f,  156.4475511887f },
    { 82.2228676445f,  45.3056221515f,  157.3459643291f },
    { 82.3900713001f,  44.6410363654f,  158.2508234097f },
    { 82.5566223962f,  44.0027825293f,  159.1620991808f },
    { 82.7225392127f,  43.3898578456f,  160.0797298143f },
    { 82.8878387294f,  42.8013385228f,  161.0036221390f },
    { 83.0525367616f,  42.2363708514f,  161.9336527563f },
    { 83.2166480775f,  41.6941634182f,  162.8696690786f },
    { 83.3801865009f,  41.1739802825f,  163.8114903199f },
    { 83.5431650013f,  40.6751349746f,  164.7589084679f },
    { 83.7055957729f,  40.1969851947f,  165.7116892583f },
    { 83.8674903045f,  39.7389281193f,  166.6695731722f },
    { 84.0288594414f,  39.3003962294f,  167.6322764691f },
    { 84.1897134404f,  38.8808535966f,  168.5994922702f },
    { 84.3500620187f,  38.4797925674f,  169.5708917002f },
    { 84.5099143979f,  38.0967307985f,  170.5461250949f },
    { 84.6692793432f,  37.7312086035f,  171.5248232782f },
    { 84.8281651985f,  37.3827865743f,  172.5065989123f },
    { 84.9865799184f,  37.0510434494f,  173.4910479192f },
    { 85.1445310967f,  36.7355742036f,  174.4777509730f },
    { 85.3020259928f,  36.4359883356f,  175.4662750585f },
    { 85.4590715546f,  36.1519083371f,  176.4561750903f },
    { 85.6156744404f,  35.8829683243f,  177.4469955863f },
    { 85.7718410384f,  35.6288128184f,  178.4382723857f },
    { 85.9275774841f,  35.3890956633f,  179.4295344026f },
    { 86.0828896770f,  35.1634790655f,  180.4203054047f },
    { 86.2377832955f,  34.9516327504f,  181.4101058053f },
    { 86.3922638100f,  34.7532332215f,  182.3984544554f },
    { 86.5463364964f,  34.5679631160f,  183.3848704261f },
    { 86.7000064466f,  34.3955106485f,  184.3688747660f },
    { 86.8532785802f,  34.2355691352f,  185.3499922229f },
    { 87.0061576535f,  34.0878365913f,  186.3277529169f },
    { 87.1586482691f,  33.9520153958f,  187.3016939538f },
    { 87.3107548843f,  33.8278120169f,  188.2713609673f },
    { 87.4624818185f,  33.7149367927f,  189.2363095804f },
    { 87.6138332611f,  33.6131037609f,  190.1961067776f },
    { 87.7648132775f,  33.5220305334f,  191.1503321780f },
    { 87.9154258162f,  33.4414382090f,  192.0985792054f },
    { 88.0656747139f,  33.3710513218f,  193.0404561479f },
    { 88.2155637015f,  33.3105978185f,  193.9755871037f },
    { 88.3650964087f,  33.2598090619f,  194.9036128112f },
    { 88.5142763692f,  33.2184198562f,  195.8241913603f },
    { 87.9773221667f,  32.9658997506f,  196.7526941598f },
    { 87.4364100700f,  32.7199119689f,  197.7044875044f },
    { 86.8914574610f,  32.4808697726f,  198.6799817203f },
    { 86.3423788320f,  32.2492053184f,  199.6795585722f },
    { 85.7890856419f,  32.0253699955f,  200.7035663255f },
    { 85.2314861647f,  31.8098346906f,  201.7523144691f },
    { 84.6694853268f,  31.6030899701f,  202.8260681201f },
    { 84.1029845341f,  31.4056461671f,  203.9250421403f },
    { 83.5318814875f,  31.2180333629f,  205.0493950061f },
    { 82.9560699859f,  31.0408012507f,  206.1992224877f },
    { 82.3754397149f,  30.8745188707f,  207.3745512052f },
    { 81.7898760212f,  30.7197742068f,  208.5753321448f },
    { 81.1992596710f,  30.5771736369f,  209.8014342351f },
    { 80.6034665901f,  30.4473412290f,  211.0526380953f },
    { 80.0023675856f,  30.3309178806f,  212.3286300843f },
    { 79.3958280460f,  30.2285602983f,  213.6289967923f },
    { 78.7837076191f,  30.1409398225f,  214.9532201264f },
    { 78.1658598642f,  30.0687411027f,  216.3006731508f },
    { 77.5421318772f,  30.0126606348f,  217.6706168459f },
    { 76.9123638855f,  29.9734051792f,  219.0621979485f },
    { 76.2763888097f,  29.9516900802f,  220.4744480314f },
    { 75.6340317885f,  29.9482375174f,  221.9062839641f },
    { 74.9851096636f,  29.9637747216f,  223.3565098802f },
    { 74.3294304200f,  29.9990321980f,  224.8238207481f },
    { 73.6667925762f,  30.0547420000f,  226.3068076102f },
    { 72.9969845205f,  30.1316361065f,  227.8039645163f },
    { 72.3197837853f,  30.2304449563f,  229.3136971335f },
    { 71.6349562542f,  30.3518961990f,  230.8343329694f },
    { 70.9422552928f,  30.4967137209f,  232.3641330964f },
    { 70.2414207942f,  30.6656170088f,  233.9013052205f },
    { 69.5321781295f,  30.8593209122f,  235.4440178925f },
    { 68.8142369905f,  31.0785358636f,  236.9904156247f },
    { 68.0872901120f,  31.3239686152f,  238.5386346448f },
    { 67.3510118564f,  31.5963235475f,  240.0868190008f },
    { 66.6050566437f,  31.8963046022f,  241.6331367192f },
    { 65.8490572046f,  32.2246178903f,  243.1757957246f },
    { 65.0826226323f,  32.5819750241f,  244.7130592394f },
    { 64.3053362041f,  32.9690972229f,  246.2432604101f },
    { 63.5167529378f,  33.3867202421f,  247.7648159404f },
    { 62.7163968434f,  33.8356001834f,  249.2762385531f },
    { 61.9037578217f,  34.3165202515f,  250.7761481555f },
    { 61.0782881539f,  34.8302985338f,  252.2632816305f },
    { 60.2393985122f,  35.3777969032f,  253.7365012379f },
    { 59.3864534114f,  35.9599311654f,  255.1948016606f },
    { 58.5187660015f,  36.5776826093f,  256.6373157884f },
    { 57.6355920814f,  37.2321111626f,  258.0633193855f },
    { 56.7361231861f,  37.9243704122f,  259.4722348389f },
    { 55.8194785660f,  38.6557248261f,  260.8636342357f },
    { 54.8846958351f,  39.4275696041f,  262.2372420710f },
    { 53.9307200050f,  40.2414537175f,  263.5929379423f },
    { 52.9563905541f,  41.0991068530f,  264.9307596498f },
    { 51.9604260825f,  42.0024711988f,  266.2509072044f },
    { 50.9414059781f,  42.9537392944f,  267.5537483408f },
    { 49.8977483526f,  43.9553995592f,  268.8398262787f },
    { 48.8276832751f,  45.0102916460f,  270.1098706636f },
    { 47.7292200189f,  46.1216745143f,  271.3648128979f },
    { 46.6001066018f,  47.2933111690f,  272.6058074785f },
    { 45.4377792809f,  48.5295755279f,  273.8342615512f },
    { 44.2392987797f,  49.8355891055f,  275.0518757960f },
    { 43.0012687249f,  51.2173985358f,  276.2607011365f },
    { 43.4868077334f,  50.9581013710f,  278.0199299140f },
    { 43.9652373389f,  50.7470887301f,  279.7477740937f },
    { 44.4368635595f,  50.5812705087f,  281.4431590554f },
    { 44.9019706672f,  50.4577321889f,  283.1051826347f },
    { 45.3608233076f,  50.3737241688f,  284.7331128788f },
    { 45.8136683601f,  50.3266524436f,  286.3263833214f },
    { 46.2607365770f,  50.3140703222f,  287.8845861942f },
    { 46.7022440328f,  50.3336709328f,  289.4074639903f },
    { 47.1383934095f,  50.3832803306f,  290.8948997763f },
    { 47.5693751405f,  50.4608510618f,  292.3469066224f },
    { 47.9953684312f,  50.5644560811f,  293.7636164830f },
    { 48.4165421731f,  50.6922829456f,  295.1452688206f },
    { 48.8330557628f,  50.8426282338f,  296.4921992243f },
    { 49.2450598406f,  51.0138921547f,  297.8048282303f },
    { 49.6526969550f,  51.2045733262f,  299.0836505123f },
    { 50.0561021644f,  51.4132637115f,  300.3292245701f },
    { 50.4554035821f,  51.6386437087f,  301.5421630135f },
    { 50.8507228707f,  51.8794773946f,  302.7231235039f },
    { 51.2421756926f,  52.1346079234f,  303.8728003943f },
    { 51.6298721200f,  52.4029530861f,  304.9919170847f },
    { 52.0139170101f,  52.6835010338f,  306.0812190909f },
    { 52.3944103476f,  52.9753061685f,  307.1414678139f },
    { 52.7714475594f,  53.2774852067f,  308.1734349836f },
    { 53.1451198028f,  53.5892134143f,  309.1778977436f },
    { 53.5155142314f,  53.9097210176f,  310.1556343388f },
    { 53.8827142393f,  54.2382897875f,  311.1074203629f },
    { 54.2467996864f,  54.5742497963f,  312.0340255226f },
    { 54.6078471069f,  54.9169763455f,  312.9362108748f },
    { 54.9659299023f,  55.2658870596f,  313.8147264911f },
    { 55.3211185192f,  55.6204391432f,  314.6703095103f },
    { 55.6734806154f,  55.9801267951f,  315.5036825350f },
    { 56.0230812135f,  56.3444787752f,  316.3155523386f },
    { 56.3699828436f,  56.7130561178f,  317.1066088426f },
    { 56.7142456769f,  57.0854499847f,  317.8775243363f },
    { 57.0559276493f,  57.4612796528f,  318.6289529042f },
    { 57.3950845770f,  57.8401906283f,  319.3615300377f },
    { 57.7317702652f,  58.2218528828f,  320.0758724041f },
    { 58.0660366086f,  58.6059592031f,  320.7725777510f },
    { 58.3979336861f,  58.9922236499f,  321.4522249276f },
    { 58.7275098495f,  59.3803801173f,  322.1153740029f },
    { 59.0548118066f,  59.7701809900f,  322.7625664665f },
    { 59.3798846990f,  60.1613958890f,  323.3943254990f },
    { 59.7027721755f,  60.5538105027f,  324.0111562967f },
    { 60.0235164612f,  60.9472254975f,  324.6135464437f },
    { 60.3421584218f,  61.3414555018f,  325.2019663193f },
    { 60.6587376252f,  61.7363281602f,  325.7768695334f },
    { 60.9732923987f,  62.1316832517f,  326.3386933841f },
    { 61.2858598835f,  62.5273718690f,  326.8878593289f },
    { 61.5964760857f,  62.9232556538f,  327.4247734671f },
    { 61.9051759251f,  63.3192060851f,  327.9498270274f },
    { 62.2119932808f,  63.7151038159f,  328.4633968567f },
    { 62.5169610342f,  64.1108380558f,  328.9658459088f },
    { 62.8201111106f,  64.5063059965f,  329.4575237279f },
    { 63.1214745176f,  64.9014122761f,  329.9387669267f },
    { 63.4210813823f,  65.2960684806f,  330.4098996565f },
    { 63.7189609859f,  65.6901926793f,  330.8712340676f },
    { 64.0151417969f,  66.0837089924f,  331.3230707599f },
    { 64.3096515030f,  66.4765471882f,  331.7656992212f },
    { 64.6025170405f,  66.8686423068f,  332.1993982542f },
    { 64.8937646232f,  67.2599343111f,  332.6244363906f },
    { 64.6787420048f,  67.2029959907f,  333.0469446806f },
    { 64.4628010335f,  67.1485064676f,  333.4752206330f },
    { 64.2459291088f,  67.0965404660f,  333.9093880280f },
    { 64.0281132978f,  67.0471750515f,  334.3495753081f },
    { 63.8093403211f,  67.0004897219f,  334.7959158824f },
    { 63.5895965369f,  66.9565665029f,  335.2485484586f },
    { 63.3688679257f,  66.9154900500f,  335.7076174051f },
    { 63.1471400725f,  66.8773477560f,  336.1732731478f },
    { 62.9243981486f,  66.8422298660f,  336.6456726041f },
    { 62.7006268918f,  66.8102295990f,  337.1249796591f },
    { 62.4758105857f,  66.7814432796f,  337.6113656889f },
    { 62.2499330368f,  66.7559704769f,  338.1050101365f },
    { 62.0229775501f,  66.7339141556f,  338.6061011457f },
    { 61.7949269035f,  66.7153808375f,  339.1148362620f },
    { 61.5657633194f,  66.7004807769f,  339.6314232067f },
    { 61.3354684341f,  66.6893281498f,  340.1560807347f },
    { 61.1040232653f,  66.6820412605f,  340.6890395870f },
    { 60.8714081763f,  66.6787427665f,  341.2305435487f },
    { 60.6376028370f,  66.6795599250f,  341.7808506287f },
    { 60.4025861820f,  66.6846248637f,  342.3402343764f },
    { 60.1663363644f,  66.6940748805f,  342.9089853549f },
    { 59.9288307049f,  66.7080527745f,  343.4874127927f },
    { 59.6900456371f,  66.7267072153f,  344.0758464412f },
    { 59.4499566455f,  66.7501931562f,  344.6746386667f },
    { 59.2085381989f,  66.7786722976f,  345.2841668147f },
    { 58.9657636752f,  66.8123136109f,  345.9048358882f },
    { 58.7216052782f,  66.8512939331f,  346.5370815911f },
    { 58.4760339455f,  66.8957986441f,  347.1813737964f },
    { 58.2290192440f,  66.9460224446f,  347.8382205123f },
    { 57.9805292535f,  67.0021702526f,  348.5081724322f },
    { 57.7305304347f,  67.0644582426f,  349.1918281757f },
    { 57.4789874800f,  67.1331150590f,  349.8898403463f },
    { 57.2258631424f,  67.2083832402f,  350.6029225647f },
    { 56.9711180408f,  67.2905208998f,  351.3318576702f },
    { 56.7147104342f,  67.3798037275f,  352.0775073295f },
    { 56.4565959619f,  67.4765273836f,  352.8408233524f },
    { 56.1967273383f,  67.5810103868f,  353.6228610916f },
    { 55.9350539967f,  67.6935976234f,  354.4247954025f },
    { 55.6715216664f,  67.8146646448f,  355.2479397767f },
    { 55.4060718703f,  67.9446229739f,  356.0937694380f },
    { 55.1386413191f,  68.0839267181f,  356.9639494330f },
    { 54.8691611789f,  68.2330808861f,  357.8603690793f },
    { 54.5975561716f,  68.3926519555f,  358.7851845913f },
    { 54.3237434626f,  68.5632814499f,  359.7408723507f }
};

__CONSTANT__ float gamutCuspTableReach[360] = 
{
    166.785f,
    168.475f,
    170.129f,
    171.753f,
    173.340f,
    174.878f,
    176.367f,
    177.802f,
    179.181f,
    180.505f,
    181.763f,
    182.965f,
    184.106f,
    185.187f,
    186.212f,
    187.177f,
    188.086f,
    188.947f,
    189.758f,
    190.527f,
    191.254f,
    191.949f,
    192.615f,
    193.250f,
    193.872f,
    194.360f,
    187.091f,
    180.402f,
    174.237f,
    168.524f,
    163.226f,
    158.301f,
    153.711f,
    149.426f,
    145.416f,
    141.663f,
    138.135f,
    134.821f,
    131.702f,
    128.766f,
    125.995f,
    123.376f,
    120.898f,
    118.555f,
    116.339f,
    114.233f,
    112.244f,
    110.345f,
    108.551f,
    106.842f,
    105.219f,
    103.680f,
    102.209f,
    100.818f,
    99.487f,
    98.224f,
    97.021f,
    95.874f,
    94.781f,
    93.744f,
    92.761f,
    91.821f,
    90.930f,
    90.082f,
    89.276f,
    88.513f,
    87.787f,
    87.103f,
    86.450f,
    85.840f,
    85.260f,
    84.711f,
    84.198f,
    83.716f,
    83.264f,
    82.843f,
    82.452f,
    82.086f,
    81.750f,
    81.445f,
    81.165f,
    80.908f,
    80.682f,
    80.481f,
    80.304f,
    80.151f,
    80.023f,
    79.919f,
    79.840f,
    79.791f,
    79.761f,
    79.755f,
    79.773f,
    79.816f,
    79.889f,
    79.980f,
    80.096f,
    80.243f,
    80.408f,
    80.603f,
    80.817f,
    81.061f,
    81.335f,
    81.635f,
    81.958f,
    82.312f,
    82.690f,
    83.099f,
    83.539f,
    84.009f,
    84.509f,
    85.046f,
    85.614f,
    86.212f,
    86.847f,
    87.518f,
    88.226f,
    88.977f,
    89.764f,
    90.601f,
    91.473f,
    92.395f,
    93.359f,
    94.379f,
    95.447f,
    96.570f,
    97.748f,
    98.993f,
    100.293f,
    101.660f,
    103.101f,
    104.614f,
    106.201f,
    107.880f,
    109.637f,
    111.493f,
    113.446f,
    115.503f,
    117.670f,
    119.965f,
    122.382f,
    124.939f,
    127.649f,
    130.518f,
    133.563f,
    136.792f,
    140.222f,
    143.878f,
    141.687f,
    138.110f,
    134.729f,
    131.525f,
    128.491f,
    125.616f,
    122.888f,
    120.300f,
    117.841f,
    115.497f,
    113.269f,
    111.151f,
    109.131f,
    107.202f,
    105.371f,
    103.619f,
    101.947f,
    100.354f,
    98.828f,
    97.375f,
    95.984f,
    94.659f,
    93.390f,
    92.175f,
    91.016f,
    89.911f,
    88.849f,
    87.836f,
    86.871f,
    85.950f,
    85.065f,
    84.222f,
    83.417f,
    82.654f,
    81.921f,
    81.226f,
    80.560f,
    79.926f,
    79.327f,
    78.754f,
    78.217f,
    77.698f,
    77.216f,
    76.758f,
    76.324f,
    75.916f,
    75.537f,
    75.177f,
    74.847f,
    74.536f,
    74.249f,
    73.987f,
    73.743f,
    73.523f,
    73.328f,
    73.151f,
    72.992f,
    72.858f,
    72.742f,
    72.650f,
    72.577f,
    72.522f,
    72.491f,
    72.479f,
    72.485f,
    72.516f,
    72.565f,
    72.632f,
    72.717f,
    72.827f,
    72.961f,
    73.108f,
    73.279f,
    73.474f,
    73.688f,
    73.926f,
    74.182f,
    74.463f,
    74.768f,
    75.092f,
    75.446f,
    75.818f,
    76.215f,
    76.642f,
    77.094f,
    77.570f,
    78.070f,
    78.601f,
    79.163f,
    79.749f,
    80.371f,
    81.024f,
    81.708f,
    82.422f,
    83.173f,
    83.960f,
    84.784f,
    85.645f,
    86.548f,
    87.488f,
    88.477f,
    89.508f,
    90.588f,
    91.711f,
    92.889f,
    94.122f,
    95.404f,
    96.747f,
    98.157f,
    99.622f,
    101.154f,
    102.759f,
    104.437f,
    106.195f,
    108.032f,
    109.949f,
    111.963f,
    114.069f,
    116.272f,
    118.585f,
    121.002f,
    120.929f,
    119.934f,
    118.988f,
    118.085f,
    117.230f,
    116.418f,
    115.643f,
    114.911f,
    114.221f,
    113.568f,
    112.952f,
    112.372f,
    111.823f,
    111.316f,
    110.840f,
    110.394f,
    109.985f,
    109.607f,
    109.265f,
    108.948f,
    108.661f,
    108.411f,
    108.185f,
    107.990f,
    107.825f,
    107.684f,
    107.581f,
    107.501f,
    107.446f,
    107.422f,
    107.428f,
    107.458f,
    107.520f,
    107.611f,
    107.727f,
    107.874f,
    108.044f,
    108.246f,
    108.472f,
    108.728f,
    109.015f,
    109.332f,
    109.674f,
    110.046f,
    110.449f,
    110.883f,
    111.346f,
    111.841f,
    112.366f,
    112.921f,
    113.507f,
    114.124f,
    114.777f,
    115.460f,
    116.180f,
    116.931f,
    117.719f,
    118.536f,
    119.397f,
    120.288f,
    121.216f,
    122.186f,
    123.187f,
    124.225f,
    125.305f,
    126.422f,
    127.582f,
    128.772f,
    130.005f,
    131.281f,
    132.593f,
    133.942f,
    135.327f,
    136.755f,
    138.220f,
    139.722f,
    141.254f,
    142.822f,
    144.421f,
    146.057f,
    147.711f,
    149.396f,
    151.099f,
    152.826f,
    154.565f,
    156.317f,
    158.075f,
    159.833f,
    161.584f,
    163.336f,
    165.070f
};

__CONSTANT__ float3 cGamutCuspTable[360] = 
{
    { 61.5938248798f,  109.6780346366f,  0.3192278701f },
    { 61.3633410763f,  110.0528646103f,  0.9158853007f },
    { 61.1310558386f,  110.4349848830f,  1.5302522745f },
    { 60.8968881058f,  110.8245141528f,  2.1640631768f },
    { 60.6607470606f,  111.2215801672f,  2.8193322408f },
    { 60.4225300883f,  111.6263237464f,  3.4984175124f },
    { 60.1821201255f,  112.0389047296f,  4.2041044811f },
    { 59.9393821551f,  112.4595108387f,  4.9397172210f },
    { 59.6941584878f,  112.8883710465f,  5.7092688529f },
    { 59.4462622657f,  113.3257760482f,  6.5176695985f },
    { 59.1954682956f,  113.7721102238f,  7.3710215956f },
    { 58.9414997291f,  114.2279027570f,  8.2770487773f },
    { 58.6840080325f,  114.6939118837f,  9.2457453083f },
    { 58.4225415933f,  115.1712690476f,  10.2903944912f },
    { 58.1564939536f,  115.6617375616f,  11.4292523436f },
    { 57.8850128169f,  116.1682060839f,  12.6885117445f },
    { 57.6068261850f,  116.6957101034f,  14.1079725248f },
    { 57.3198699850f,  117.2538002908f,  15.7531935586f },
    { 57.0203446851f,  117.8630445960f,  17.7462839346f },
    { 56.6995516784f,  118.5787766775f,  20.3691087820f },
    { 56.3236603672f,  119.6601512528f,  24.7221846115f },
    { 57.2041962736f,  115.3201255654f,  26.0487208398f },
    { 58.0601289695f,  111.3096585971f,  27.3997823286f },
    { 58.8938131248f,  107.5948708003f,  28.7759046137f },
    { 59.7072269670f,  104.1476114840f,  30.1773649082f },
    { 60.5020525776f,  100.9442166403f,  31.6041962772f },
    { 61.2797353950f,  97.9645855890f,  33.0561968503f },
    { 62.0415291442f,  95.1914814866f,  34.5329359267f },
    { 62.7885303280f,  92.6099924341f,  36.0337584040f },
    { 63.5217050989f,  90.2071100381f,  37.5577886655f },
    { 64.2419104715f,  87.9713953891f,  39.1039348367f },
    { 64.9499112692f,  85.8927111662f,  40.6708941446f },
    { 65.6463938084f,  83.9620045325f,  42.2571599707f },
    { 66.3319770578f,  82.1711296148f,  43.8610310458f },
    { 67.0072218204f,  80.5127012745f,  45.4806231083f },
    { 67.6726383511f,  78.9799739531f,  47.1138832108f },
    { 68.3286927244f,  77.5667408828f,  48.7586067276f },
    { 68.9758121955f,  76.2672500474f,  50.4124569800f },
    { 69.6143897418f,  75.0761340840f,  52.0729872669f },
    { 70.2447879351f,  73.9883519112f,  53.7376649649f },
    { 70.8673422608f,  72.9991403081f,  55.4038972554f },
    { 71.4823639783f,  72.1039739933f,  57.0690579498f },
    { 72.0901425987f,  71.2985329962f,  58.7305148188f },
    { 72.6909480397f,  70.5786762908f,  60.3856568011f },
    { 73.2850325099f,  69.9404208006f,  62.0319204616f },
    { 73.8726321609f,  69.3799249864f,  63.6668150950f },
    { 74.4539685438f,  68.8934763114f,  65.2879459290f },
    { 75.0292498959f,  68.4774819496f,  66.8930349528f },
    { 75.5986722829f,  68.1284621615f,  68.4799390002f },
    { 76.1624206150f,  67.8430458199f,  70.0466648166f },
    { 76.7206695544f,  67.6179676186f,  71.5913809580f },
    { 77.2735843281f,  67.4500665526f,  73.1124264744f },
    { 77.8213214576f,  67.3362853080f,  74.6083164370f },
    { 78.3640294157f,  67.2736702493f,  76.0777444564f },
    { 78.9018492200f,  67.2593717443f,  77.5195824139f },
    { 79.4349149696f,  67.2906446106f,  78.9328776868f },
    { 79.9633543319f,  67.3648485124f,  80.3168481846f },
    { 80.4872889853f,  67.4794481789f,  81.6708755410f },
    { 81.0068350225f,  67.6320133490f,  82.9944968051f },
    { 81.5221033184f,  67.8202183799f,  84.2873949773f },
    { 82.0331998671f,  68.0418414858f,  85.5493887094f },
    { 82.5402260901f,  68.2947635924f,  86.7804214692f },
    { 83.0432791200f,  68.5769668134f,  87.9805504340f },
    { 83.5424520606f,  68.8865325676f,  89.1499353447f },
    { 84.0378342271f,  69.2216393678f,  90.2888275167f },
    { 84.5295113677f,  69.5805603141f,  91.3975591661f },
    { 85.0175658676f,  69.9616603368f,  92.4765331801f },
    { 85.5020769392f,  70.3633932272f,  93.5262134246f },
    { 85.9831207968f,  70.7842985015f,  94.5471156586f },
    { 86.4607708202f,  71.2229981375f,  95.5397990971f },
    { 86.9350977054f,  71.6781932239f,  96.5048586472f },
    { 87.4061696061f,  72.1486605571f,  97.4429178204f },
    { 87.8740522645f,  72.6332492191f,  98.3546223158f },
    { 88.3388091338f,  73.1308771638f,  99.2406342515f },
    { 88.8005014927f,  73.6405278376f,  100.1016270191f },
    { 89.2591885522f,  74.1612468557f,  100.9382807276f },
    { 89.7149275555f,  74.6921387505f,  101.7512781982f },
    { 90.1677738720f,  75.2323638081f,  102.5413014704f },
    { 90.6177810852f,  75.7811350041f,  103.3090287807f },
    { 91.0650010748f,  76.3377150467f,  104.0551319701f },
    { 91.5094840951f,  76.9014135343f,  104.7802742830f },
    { 91.2457255635f,  76.9569697441f,  105.4958127196f },
    { 90.9809128348f,  77.0254360602f,  106.2148940096f },
    { 90.7150332965f,  77.1070331373f,  106.9373229645f },
    { 90.4480740787f,  77.2019805380f,  107.6628985412f },
    { 90.1800220467f,  77.3104965726f,  108.3914141336f },
    { 89.9108637938f,  77.4327981437f,  109.1226578861f },
    { 89.6405856325f,  77.5691006004f,  109.8564130332f },
    { 89.3691735868f,  77.7196175995f,  110.5924582596f },
    { 89.0966133834f,  77.8845609773f,  111.3305680827f },
    { 88.8228904427f,  78.0641406315f,  112.0705132542f },
    { 88.5479898695f,  78.2585644150f,  112.8120611805f },
    { 88.2718964432f,  78.4680380424f,  113.5549763582f },
    { 87.9945946082f,  78.6927650097f,  114.2990208250f },
    { 87.7160684629f,  78.9329465284f,  115.0439546228f },
    { 87.4363017490f,  79.1887814752f,  115.7895362698f },
    { 87.1552778403f,  79.4604663572f,  116.5355232420f },
    { 86.8729797306f,  79.7481952943f,  117.2816724590f },
    { 86.5893900220f,  80.0521600179f,  118.0277407733f },
    { 86.3044909112f,  80.3725498890f,  118.7734854605f },
    { 86.0182641772f,  80.7095519329f,  119.5186647073f },
    { 85.7306911663f,  81.0633508946f,  120.2630380956f },
    { 85.4417527785f,  81.4341293117f,  121.0063670803f },
    { 85.1514294519f,  81.8220676077f,  121.7484154577f },
    { 84.8597011468f,  82.2273442047f,  122.4889498235f },
    { 84.5665473296f,  82.6501356559f,  123.2277400170f },
    { 84.2719469552f,  83.0906167982f,  123.9645595509f },
    { 83.9758784488f,  83.5489609241f,  124.6991860231f },
    { 83.6783196877f,  84.0253399743f,  125.4314015108f },
    { 83.3792479808f,  84.5199247498f,  126.1609929433f },
    { 83.0786400485f,  85.0328851432f,  126.8877524541f },
    { 82.7764720008f,  85.5643903902f,  127.6114777090f },
    { 82.4727193146f,  86.1146093402f,  128.3319722115f },
    { 82.1673568102f,  86.6837107460f,  129.0490455828f },
    { 81.8603586261f,  87.2718635726f,  129.7625138163f },
    { 81.5516981930f,  87.8792373243f,  130.4721995071f },
    { 81.2413482065f,  88.5060023910f,  131.1779320544f },
    { 80.9292805979f,  89.1523304127f,  131.8795478390f },
    { 80.6154665044f,  89.8183946617f,  132.5768903741f },
    { 80.2998762369f,  90.5043704434f,  133.2698104300f },
    { 79.9824792464f,  91.2104355156f,  133.9581661348f },
    { 79.6632440894f,  91.9367705250f,  134.6418230489f },
    { 79.3421383899f,  92.6835594625f,  135.3206542167f },
    { 79.0191288010f,  93.4509901370f,  135.9945401944f },
    { 78.6941809630f,  94.2392546671f,  136.6633690556f },
    { 78.3672594605f,  95.0485499932f,  137.3270363763f },
    { 78.0383277757f,  95.8790784073f,  137.9854451991f },
    { 77.7073482404f,  96.7310481050f,  138.6385059785f },
    { 77.3742819845f,  97.6046737567f,  139.2861365094f },
    { 77.0390888814f,  98.5001771018f,  139.9282618378f },
    { 76.7017274908f,  99.4177875653f,  140.5648141578f },
    { 76.3621549975f,  100.3577428989f,  141.1957326936f },
    { 76.0203271469f,  101.3202898479f,  141.8209635701f },
    { 75.6761981763f,  102.3056848449f,  142.4404596714f },
    { 75.3297207423f,  103.3141947336f,  143.0541804905f },
    { 74.9808458431f,  104.3460975239f,  143.6620919693f },
    { 74.6295227363f,  105.4016831804f,  144.2641663329f },
    { 74.2756988513f,  106.4812544482f,  144.8603819163f },
    { 73.9193196961f,  107.5851277179f,  145.4507229876f },
    { 73.5603287570f,  108.7136339345f,  146.0351795669f },
    { 73.1986673933f,  109.8671195523f,  146.6137472427f },
    { 73.4261408090f,  106.0282623093f,  148.0463084504f },
    { 73.6411059005f,  102.9095471383f,  149.3105550520f },
    { 73.8478500680f,  100.2575377765f,  150.4662383547f },
    { 74.0486341271f,  97.9386787329f,  151.5449277134f },
    { 74.2448190874f,  95.8726232432f,  152.5656284874f },
    { 74.4372978324f,  94.0066999624f,  153.5407890925f },
    { 74.6266928111f,  92.3042227689f,  154.4790605811f },
    { 74.8134580805f,  90.7384577752f,  155.3867247111f },
    { 74.9979367427f,  89.2892278984f,  156.2684995295f },
    { 75.1803954805f,  87.9408714805f,  157.1280246507f },
    { 75.3610464312f,  86.6809493677f,  157.9681691335f },
    { 75.5400616393f,  85.4993907150f,  158.7912351924f },
    { 75.7175829438f,  84.3879085686f,  159.5990977608f },
    { 75.8937289457f,  83.3395880744f,  160.3933029532f },
    { 76.0686000418f,  82.3485889332f,  161.1751392948f },
    { 76.2422821422f,  81.4099256787f,  161.9456903830f },
    { 76.4148494679f,  80.5193023151f,  162.7058745670f },
    { 76.5863666917f,  79.6729857652f,  163.4564753523f },
    { 76.7568906013f,  78.8677075717f,  164.1981650470f },
    { 76.9264714081f,  78.1005865239f,  164.9315234021f },
    { 77.0951537904f,  77.3690670230f,  165.6570524816f },
    { 77.2629777323f,  76.6708694536f,  166.3751886577f },
    { 77.4299792074f,  76.0039498278f,  167.0863123825f },
    { 77.5961907383f,  75.3664666752f,  167.7907562221f },
    { 77.7616418608f,  74.7567536546f,  168.4888115178f },
    { 77.9263595098f,  74.1732967271f,  169.1807339519f },
    { 78.0903683441f,  73.6147149985f,  169.8667482321f },
    { 78.2536910201f,  73.0797445384f,  170.5470520593f },
    { 78.4163484249f,  72.5672246304f,  171.2218195108f },
    { 78.5783598756f,  72.0760860246f,  171.8912039404f },
    { 78.7397432901f,  71.6053408486f,  172.5553404781f },
    { 78.9005153350f,  71.1540739008f,  173.2143481961f },
    { 79.0606915538f,  70.7214351019f,  173.8683319927f },
    { 79.2202864786f,  70.3066329248f,  174.5173842403f },
    { 79.3793137275f,  69.9089286512f,  175.1615862301f },
    { 79.5377860906f,  69.5276313335f,  175.8010094461f },
    { 79.6957156057f,  69.1620933585f,  176.4357166894f },
    { 79.8531136247f,  68.8117065294f,  177.0657630768f },
    { 80.0099908734f,  68.4758985938f,  177.6911969268f },
    { 80.1663575041f,  68.1541301572f,  178.3120605514f },
    { 80.3222231427f,  67.8458919330f,  178.9283909619f },
    { 80.4775969306f,  67.5507022837f,  179.5402205020f },
    { 80.6324875633f,  67.2681050192f,  180.1475774156f },
    { 80.7869033235f,  66.9976674176f,  180.7504863567f },
    { 80.9408521127f,  66.7389784447f,  181.3489688487f },
    { 81.0943414783f,  66.4916471470f,  181.9430436975f },
    { 81.2473786393f,  66.2553011979f,  182.5327273652f },
    { 81.3999705086f,  66.0295855819f,  183.1180343058f },
    { 81.5521237144f,  65.8141613984f,  183.6989772695f },
    { 81.7038446187f,  65.6087047748f,  184.2755675767f },
    { 81.8551393347f,  65.4129058752f,  184.8478153655f },
    { 82.0060137428f,  65.2264679962f,  185.4157298155f },
    { 82.1564735050f,  65.0491067397f,  185.9793193490f },
    { 82.3065240785f,  64.8805492547f,  186.5385918127f },
    { 82.4561707276f,  64.7205335427f,  187.0935546410f },
    { 82.6054185350f,  64.5688078185f,  187.6442150032f },
    { 82.7542724126f,  64.4251299226f,  188.1905799347f },
    { 82.9027371109f,  64.2892667791f,  188.7326564552f },
    { 83.0508172280f,  64.1609938958f,  189.2704516736f },
    { 83.1985172177f,  64.0400949018f,  189.8039728815f },
    { 82.7003586663f,  63.5000000612f,  190.3423165932f },
    { 82.1985701011f,  62.9605134581f,  190.8946406839f },
    { 81.6930765803f,  62.4218142216f,  191.4614474885f },
    { 81.1838005696f,  61.8840945341f,  192.0432595257f },
    { 80.6706618154f,  61.3475605609f,  192.6406201462f },
    { 80.1535772099f,  60.8124334458f,  193.2540941616f },
    { 79.6324606474f,  60.2789503794f,  193.8842684444f },
    { 79.1072228711f,  59.7473657421f,  194.5317524894f },
    { 78.5777713098f,  59.2179523282f,  195.1971789235f },
    { 78.0440099035f,  58.6910026563f,  195.8812039511f },
    { 77.5058389172f,  58.1668303697f,  196.5845077179f },
    { 76.9631547415f,  57.6457717334f,  197.3077945748f },
    { 76.4158496795f,  57.1281872319f,  198.0517932214f },
    { 75.8638117177f,  56.6144632734f,  198.8172567039f },
    { 75.3069242811f,  56.1050140057f,  199.6049622409f },
    { 74.7450659691f,  55.6002832479f,  200.4157108459f },
    { 74.1781102724f,  55.1007465429f,  201.2503267125f },
    { 73.6059252677f,  54.6069133347f,  202.1096563238f },
    { 73.0283732888f,  54.1193292738f,  202.9945672444f },
    { 72.4453105711f,  53.6385786538f,  203.9059465476f },
    { 71.8565868679f,  53.1652869800f,  204.8446988292f },
    { 71.2620450353f,  52.7001236715f,  205.8117437535f },
    { 70.6615205814f,  52.2438048950f,  206.8080130735f },
    { 70.0548411777f,  51.7970965291f,  207.8344470678f },
    { 69.4418261281f,  51.3608172532f,  208.8919903311f },
    { 68.8222857902f,  50.9358417556f,  209.9815868583f },
    { 68.1960209444f,  50.5231040520f,  211.1041743625f },
    { 67.5628221049f,  50.1236009032f,  212.2606777716f },
    { 66.9224687654f,  49.7383953192f,  213.4520018554f },
    { 66.2747285726f,  49.3686201340f,  214.6790229479f },
    { 65.6193564175f,  49.0154816334f,  215.9425797404f },
    { 64.9560934361f,  48.6802632185f,  217.2434631485f },
    { 64.2846659066f,  48.3643290851f,  218.5824052763f },
    { 63.6047840308f,  48.0691279019f,  219.9600675384f },
    { 62.9161405835f,  47.7961964726f,  221.3770280396f },
    { 62.2184094132f,  47.5471633742f,  222.8337683590f },
    { 61.5112437726f,  47.3237525702f,  224.3306599427f },
    { 60.7942744550f,  47.1277870134f,  225.8679503660f },
    { 60.0671077083f,  46.9611922711f,  227.4457497993f },
    { 59.3293228934f,  46.8260002296f,  229.0640180756f },
    { 58.5804698472f,  46.7243529708f,  230.7225528337f },
    { 57.8200659044f,  46.6585069542f,  232.4209792776f },
    { 57.0475925209f,  46.6308376943f,  234.1587421548f },
    { 56.2624914328f,  46.6438451890f,  235.9351006098f },
    { 55.4641602709f,  46.7001604400f,  237.7491266044f },
    { 54.6519475310f,  46.8025535067f,  239.5997076157f },
    { 53.8251467833f,  46.9539436606f,  241.4855543203f },
    { 52.9829899729f,  47.1574123603f,  243.4052139494f },
    { 52.1246396319f,  47.4162199538f,  245.3570899576f },
    { 51.2491797774f,  47.7338272505f,  247.3394685953f },
    { 50.3556052150f,  48.1139233996f,  249.3505529192f },
    { 49.4428088907f,  48.5604618955f,  251.3885047427f },
    { 48.5095668370f,  49.0777070331f,  253.4514950343f },
    { 47.5545201290f,  49.6702938143f,  255.5377633587f },
    { 46.5761530879f,  50.3433052399f,  257.6456871665f },
    { 45.5727667298f,  51.1023722337f,  259.7738621297f },
    { 44.5424461228f,  51.9538033275f,  261.9211953928f },
    { 43.4830198473f,  52.9047539891f,  264.0870146695f },
    { 42.3920090790f,  53.9634495839f,  266.2711977673f },
    { 41.2665628365f,  55.1394822234f,  268.4743296610f },
    { 41.9735394029f,  54.4850638563f,  271.6931295580f },
    { 42.6635753777f,  54.0120303146f,  274.8523689914f },
    { 43.3378512060f,  53.7051524895f,  277.9394867389f },
    { 43.9974150424f,  53.5498819459f,  280.9436377004f },
    { 44.6432026299f,  53.5323637789f,  283.8558828485f },
    { 45.2760534998f,  53.6394682306f,  286.6692604305f },
    { 45.8967242921f,  53.8588269989f,  289.3787529088f },
    { 46.5058997980f,  54.1788645107f,  291.9811708000f },
    { 47.1042021805f,  54.5888182755f,  294.4749773161f },
    { 47.6921987299f,  55.0787455835f,  296.8600771286f },
    { 48.2704084258f,  55.6395161685f,  299.1375896655f },
    { 48.8393075252f,  56.2627920334f,  301.3096231916f },
    { 49.3993343452f,  56.9409965578f,  303.3790614234f },
    { 49.9508933791f,  57.6672753876f,  305.3493702342f },
    { 50.4943588558f,  58.4354516321f,  307.2244284814f },
    { 51.0300778307f,  59.2399776681f,  309.0083842781f },
    { 51.5583728828f,  60.0758855144f,  310.7055361127f },
    { 52.0795444767f,  60.9387373473f,  312.3202369934f },
    { 52.5938730387f,  61.8245773510f,  313.8568191140f },
    { 53.1016207894f,  62.7298857522f,  315.3195362583f },
    { 53.6030333652f,  63.6515355993f,  316.7125211564f },
    { 54.0983412592f,  64.5867526137f,  318.0397551747f },
    { 54.5877611042f,  65.5330782566f,  319.3050479823f },
    { 55.0714968196f,  66.4883360232f,  320.5120251438f },
    { 55.5497406385f,  67.4506008797f,  321.6641218916f },
    { 56.0226740301f,  68.4181716930f,  322.7645816281f },
    { 56.4904685313f,  69.3895464661f,  323.8164579679f },
    { 56.9532864960f,  70.3634001675f,  324.8226193625f },
    { 57.4112817742f,  71.3385649369f,  325.7857555446f },
    { 57.8646003269f,  72.3140124502f,  326.7083851949f },
    { 58.3133807855f,  73.2888382331f,  327.5928643663f },
    { 58.7577549608f,  74.2622477264f,  328.4413953124f },
    { 59.1978483067f,  75.2335439175f,  329.2560354544f },
    { 59.6337803452f,  76.2021163701f,  330.0387062885f },
    { 60.0656650547f,  77.1674314963f,  330.7912020931f },
    { 60.4936112261f,  78.1290239334f,  331.5151983361f },
    { 60.9177227898f,  79.0864888995f,  332.2122597174f },
    { 61.3380991175f,  80.0394754158f,  332.8838478037f },
    { 61.7548352990f,  80.9876802965f,  333.5313282355f },
    { 62.1680223985f,  81.9308428178f,  334.1559774978f },
    { 62.5777476911f,  82.8687399863f,  334.7589892568f },
    { 62.9840948817f,  83.8011823392f,  335.3414802724f },
    { 63.3871443081f,  84.7280102136f,  335.9044959023f },
    { 63.7869731290f,  85.6490904303f,  336.4490152153f },
    { 64.1836554988f,  86.5643133465f,  336.9759557343f },
    { 64.5772627306f,  87.4735902322f,  337.4861778307f },
    { 64.9678634471f,  88.3768509355f,  337.9804887925f },
    { 65.3555237223f,  89.2740418028f,  338.4596465865f },
    { 65.7403072129f,  90.1651238252f,  338.9243633375f },
    { 66.1222752815f,  91.0500709858f,  339.3753085436f },
    { 66.5014871116f,  91.9288687852f,  339.8131120474f },
    { 66.8779998155f,  92.8015129246f,  340.2383667818f },
    { 67.2518685352f,  93.6680081310f,  340.6516313075f },
    { 67.6231465370f,  94.5283671064f,  341.0534321573f },
    { 67.9918853004f,  95.3826095889f,  341.4442660050f },
    { 68.3581346017f,  96.2307615132f,  341.8246016688f },
    { 68.7219425927f,  97.0728542591f,  342.1948819666f },
    { 69.0833558741f,  97.9089239801f,  342.5555254310f },
    { 69.4424195656f,  98.7390110011f,  342.9069278983f },
    { 69.7991773715f,  99.5631592802f,  343.2494639791f },
    { 69.6121373648f,  99.7218862043f,  343.5883660129f },
    { 69.4243582888f,  99.8845132740f,  343.9301316821f },
    { 69.2358296750f,  100.0511033627f,  344.2748249832f },
    { 69.0465407539f,  100.2217204070f,  344.6225132981f },
    { 68.8564804413f,  100.3964294219f,  344.9732676407f },
    { 68.6656373225f,  100.5752965143f,  345.3271629265f },
    { 68.4739996365f,  100.7583888965f,  345.6842782654f },
    { 68.2815552586f,  100.9457748992f,  346.0446972819f },
    { 68.0882916815f,  101.1375239830f,  346.4085084657f },
    { 67.8941959956f,  101.3337067498f,  346.7758055540f },
    { 67.6992548671f,  101.5343949527f,  347.1466879525f },
    { 67.5034545148f,  101.7396615050f,  347.5212611968f },
    { 67.3067806852f,  101.9495804871f,  347.8996374602f },
    { 67.1092186247f,  102.1642271532f,  348.2819361143f },
    { 66.9107530506f,  102.3836779349f,  348.6682843469f },
    { 66.7113681187f,  102.6080104438f,  349.0588178464f },
    { 66.5110473880f,  102.8373034717f,  349.4536815613f },
    { 66.3097737833f,  103.0716369881f,  349.8530305428f },
    { 66.1075295523f,  103.3110921356f,  350.2570308847f },
    { 65.9042962206f,  103.5557512224f,  350.6658607711f },
    { 65.7000545406f,  103.8056977113f,  351.0797116506f },
    { 65.4947844359f,  104.0610162064f,  351.4987895522f },
    { 65.2884649396f,  104.3217924355f,  351.9233165665f },
    { 65.0810741260f,  104.5881132296f,  352.3535325170f },
    { 64.8725890338f,  104.8600664988f,  352.7896968504f },
    { 64.6629855817f,  105.1377412052f,  353.2320907842f },
    { 64.4522384718f,  105.4212273319f,  353.6810197508f },
    { 64.2403210827f,  105.7106158516f,  354.1368161931f },
    { 64.0272053475f,  106.0059986916f,  354.5998427708f },
    { 63.8128616155f,  106.3074687016f,  355.0704960540f },
    { 63.5972584948f,  106.6151196227f,  355.5492107961f },
    { 63.3803626715f,  106.9290460640f,  356.0364648988f },
    { 63.1621387012f,  107.2493434900f,  356.5327852077f },
    { 62.9425487682f,  107.5761082281f,  357.0387543155f },
    { 62.7215524038f,  107.9094375045f,  357.5550185878f },
    { 62.4991061569f,  108.2494295251f,  358.0822976896f },
    { 62.2751632038f,  108.5961836215f,  358.6213959646f },
    { 62.0496728849f,  108.9498004914f,  359.1732161200f },
    { 61.8225801489f,  109.3103825763f,  359.7387758068f }
};

__CONSTANT__ float gamutTopGamma[360] = 
{
    0.888653564453125f,
    0.887786865234375f,
    0.886938476562500f,
    0.886108398437500f,
    0.885302734375000f,
    0.884509277343750f,
    0.883728027343750f,
    0.882971191406250f,
    0.882238769531250f,
    0.881530761718750f,
    0.880834960937500f,
    0.880157470703125f,
    0.879516601562500f,
    0.878875732421875f,
    0.878271484375000f,
    0.877679443359375f,
    0.877117919921875f,
    0.876568603515625f,
    0.876049804687500f,
    0.875537109375000f,
    0.875079345703125f,
    0.874584960937500f,
    0.874151611328125f,
    0.873742675781250f,
    0.873309326171875f,
    0.872924804687500f,
    0.872595214843750f,
    0.874450683593750f,
    0.877093505859375f,
    0.879486083984375f,
    0.881823730468750f,
    0.884069824218750f,
    0.886157226562500f,
    0.888250732421875f,
    0.890148925781250f,
    0.892047119140625f,
    0.893841552734375f,
    0.895581054687500f,
    0.897290039062500f,
    0.898889160156250f,
    0.900512695312500f,
    0.901995849609375f,
    0.903521728515625f,
    0.904931640625000f,
    0.906359863281250f,
    0.907714843750000f,
    0.909057617187500f,
    0.910363769531250f,
    0.911633300781250f,
    0.912896728515625f,
    0.914105224609375f,
    0.915325927734375f,
    0.916479492187500f,
    0.917669677734375f,
    0.918774414062500f,
    0.919921875000000f,
    0.920996093750000f,
    0.922094726562500f,
    0.923156738281250f,
    0.924212646484375f,
    0.925262451171875f,
    0.926281738281250f,
    0.927319335937500f,
    0.928308105468750f,
    0.929333496093750f,
    0.930297851562500f,
    0.931286621093750f,
    0.932263183593750f,
    0.933221435546875f,
    0.934204101562500f,
    0.935131835937500f,
    0.936096191406250f,
    0.937036132812500f,
    0.937969970703125f,
    0.938922119140625f,
    0.939843750000000f,
    0.940765380859375f,
    0.941717529296875f,
    0.942626953125000f,
    0.943542480468750f,
    0.944476318359375f,
    0.945404052734375f,
    0.946307373046875f,
    0.947222900390625f,
    0.948156738281250f,
    0.949078369140625f,
    0.949981689453125f,
    0.950885009765625f,
    0.951800537109375f,
    0.952716064453125f,
    0.953625488281250f,
    0.954534912109375f,
    0.955438232421875f,
    0.956329345703125f,
    0.957208251953125f,
    0.958074951171875f,
    0.958923339843750f,
    0.959747314453125f,
    0.960552978515625f,
    0.961340332031250f,
    0.962078857421875f,
    0.962725830078125f,
    0.963323974609375f,
    0.963812255859375f,
    0.955480957031250f,
    0.932250976562500f,
    0.908294677734375f,
    0.895886230468750f,
    0.898358154296875f,
    0.900677490234375f,
    0.902850341796875f,
    0.904882812500000f,
    0.906799316406250f,
    0.908599853515625f,
    0.910302734375000f,
    0.911901855468750f,
    0.913421630859375f,
    0.914849853515625f,
    0.916204833984375f,
    0.917486572265625f,
    0.918695068359375f,
    0.919848632812500f,
    0.920935058593750f,
    0.921966552734375f,
    0.922943115234375f,
    0.923864746093750f,
    0.924743652343750f,
    0.925573730468750f,
    0.926354980468750f,
    0.927099609375000f,
    0.927795410156250f,
    0.928454589843750f,
    0.929071044921875f,
    0.929656982421875f,
    0.930194091796875f,
    0.930700683593750f,
    0.931170654296875f,
    0.931604003906250f,
    0.932006835937500f,
    0.932366943359375f,
    0.932696533203125f,
    0.934704589843750f,
    0.937341308593750f,
    0.939764404296875f,
    0.942047119140625f,
    0.944189453125000f,
    0.946215820312500f,
    0.948114013671875f,
    0.949884033203125f,
    0.951556396484375f,
    0.953137207031250f,
    0.954638671875000f,
    0.956060791015625f,
    0.957397460937500f,
    0.958654785156250f,
    0.959857177734375f,
    0.960992431640625f,
    0.962072753906250f,
    0.963098144531250f,
    0.964080810546875f,
    0.965008544921875f,
    0.965893554687500f,
    0.966723632812500f,
    0.967517089843750f,
    0.968267822265625f,
    0.968981933593750f,
    0.969665527343750f,
    0.970306396484375f,
    0.970922851562500f,
    0.971502685546875f,
    0.972058105468750f,
    0.972576904296875f,
    0.973071289062500f,
    0.973535156250000f,
    0.973974609375000f,
    0.974389648437500f,
    0.974774169921875f,
    0.975134277343750f,
    0.975469970703125f,
    0.975781250000000f,
    0.976068115234375f,
    0.976330566406250f,
    0.976574707031250f,
    0.976788330078125f,
    0.976977539062500f,
    0.977148437500000f,
    0.977288818359375f,
    0.977410888671875f,
    0.977502441406250f,
    0.977575683593750f,
    0.977618408203125f,
    0.977636718750000f,
    0.977630615234375f,
    0.977593994140625f,
    0.977526855468750f,
    0.977429199218750f,
    0.979919433593750f,
    0.990911865234375f,
    0.990679931640625f,
    0.990454101562500f,
    0.990228271484375f,
    0.990008544921875f,
    0.989788818359375f,
    0.989575195312500f,
    0.989361572265625f,
    0.989147949218750f,
    0.988916015625000f,
    0.988696289062500f,
    0.988476562500000f,
    0.988269042968750f,
    0.988061523437500f,
    0.987860107421875f,
    0.987634277343750f,
    0.987420654296875f,
    0.987219238281250f,
    0.987023925781250f,
    0.986804199218750f,
    0.986590576171875f,
    0.986389160156250f,
    0.986193847656250f,
    0.985974121093750f,
    0.985766601562500f,
    0.985571289062500f,
    0.985351562500000f,
    0.985144042968750f,
    0.984942626953125f,
    0.984735107421875f,
    0.984515380859375f,
    0.984313964843750f,
    0.984100341796875f,
    0.983886718750000f,
    0.983679199218750f,
    0.983459472656250f,
    0.983239746093750f,
    0.983032226562500f,
    0.982806396484375f,
    0.982580566406250f,
    0.982373046875000f,
    0.982135009765625f,
    0.981909179687500f,
    0.981683349609375f,
    0.981439208984375f,
    0.981207275390625f,
    0.980969238281250f,
    0.980718994140625f,
    0.980480957031250f,
    0.980230712890625f,
    0.979968261718750f,
    0.979718017578125f,
    0.979449462890625f,
    0.979174804687500f,
    0.978906250000000f,
    0.978625488281250f,
    0.978338623046875f,
    0.978051757812500f,
    0.977752685546875f,
    0.977441406250000f,
    0.977130126953125f,
    0.976818847656250f,
    0.976477050781250f,
    0.976141357421875f,
    0.975799560546875f,
    0.975439453125000f,
    0.975061035156250f,
    0.974682617187500f,
    0.974304199218750f,
    0.973889160156250f,
    0.973461914062500f,
    0.973028564453125f,
    0.972589111328125f,
    0.972119140625000f,
    0.971624755859375f,
    0.971118164062500f,
    0.970593261718750f,
    0.970056152343750f,
    0.969488525390625f,
    0.968884277343750f,
    0.968774414062500f,
    0.968872070312500f,
    0.968920898437500f,
    0.969012451171875f,
    0.969079589843750f,
    0.969152832031250f,
    0.969238281250000f,
    0.969299316406250f,
    0.969384765625000f,
    0.969458007812500f,
    0.969525146484375f,
    0.969616699218750f,
    0.969677734375000f,
    0.969750976562500f,
    0.969842529296875f,
    0.969909667968750f,
    0.969982910156250f,
    0.970068359375000f,
    0.970147705078125f,
    0.970220947265625f,
    0.970300292968750f,
    0.970385742187500f,
    0.970471191406250f,
    0.970544433593750f,
    0.970623779296875f,
    0.970709228515625f,
    0.970794677734375f,
    0.970886230468750f,
    0.970977783203125f,
    0.971063232421875f,
    0.971148681640625f,
    0.971240234375000f,
    0.971331787109375f,
    0.971429443359375f,
    0.971520996093750f,
    0.971624755859375f,
    0.971722412109375f,
    0.971813964843750f,
    0.971917724609375f,
    0.972021484375000f,
    0.972131347656250f,
    0.972241210937500f,
    0.972351074218750f,
    0.972467041015625f,
    0.972583007812500f,
    0.972698974609375f,
    0.972821044921875f,
    0.972955322265625f,
    0.973077392578125f,
    0.973205566406250f,
    0.973345947265625f,
    0.967376708984375f,
    0.956134033203125f,
    0.945123291015625f,
    0.934307861328125f,
    0.923669433593750f,
    0.916668701171875f,
    0.915515136718750f,
    0.914367675781250f,
    0.913226318359375f,
    0.912091064453125f,
    0.910968017578125f,
    0.909851074218750f,
    0.908740234375000f,
    0.907635498046875f,
    0.906542968750000f,
    0.905456542968750f,
    0.904382324218750f,
    0.903314208984375f,
    0.902252197265625f,
    0.901202392578125f,
    0.900164794921875f,
    0.899139404296875f,
    0.898120117187500f,
    0.897113037109375f,
    0.896124267578125f,
    0.895141601562500f,
    0.894171142578125f,
    0.893212890625000f,
    0.892272949218750f,
    0.891345214843750f,
    0.890429687500000f,
    0.889532470703125f
};

#include "hellwig_lib_v058.h"

__DEVICE__ float3 transform(int p_Width, int p_Height, int p_X, int p_Y, float p_R, float p_G, float p_B)
{
    float3 in = make_float3(p_R, p_G, p_B);
    float3 out = in;

    float3 XYZ;

    if (!invert)
    {
        XYZ = vector_dot(AP0_ACES_to_XYZ_matrix, in);
        if (ap1Clip)
        {
            float3 AP1 = vector_dot(XYZ_to_AP1_ACES_matrix, XYZ);
            AP1.x = _fmaxf(AP1.x, 0.0f);
            AP1.y = _fmaxf(AP1.y, 0.0f);
            AP1.z = _fmaxf(AP1.z, 0.0f);
            XYZ = vector_dot(AP1_ACES_to_XYZ_matrix, AP1);
        }
    }
    else
    {
        in = float3spow(in, 2.4f);
        XYZ = vector_dot(RGB_to_XYZ_output, in);
    }
    XYZ *= referenceLuminance;
    float3 JMh;
    if (!invert)
    {
        JMh = XYZ_to_Hellwig2022_JMh(XYZ, inWhite);
        if (toneCurve)
        {
            JMh = forwardTonescale(JMh, compressChroma);
        }
        if (gamutCompress)
        {
            JMh = compressGamut(JMh, 0);
        }
    }
    else
    {
        JMh = XYZ_to_Hellwig2022_JMh(XYZ, d65White);
        if (gamutCompress)
        {
            JMh = compressGamut(JMh, 1);
        }
        if (toneCurve)
        {
            JMh = inverseTonescale(JMh, compressChroma);
        }
    }
    if (JMhOut)
    {
        out.x = JMh.x / referenceLuminance;
        out.y = JMh.y / referenceLuminance;
        out.z = JMh.z / 360.0f;
    }
    else
    {
        if (!invert)
        {
            if (!d60Sim)
            {
                XYZ = Hellwig2022_JMh_to_XYZ(JMh , d65White) / referenceLuminance;
            }
            else
            {
                XYZ = Hellwig2022_JMh_to_XYZ(JMh , inWhite) / referenceLuminance;
                float3 creativeWhiteXYZ = vector_dot(RGB_to_XYZ_709D60, make_float3(1.0f, 1.0f, 1.0f));
                float3 creativeWhiteRGB = vector_dot(XYZ_to_RGB_limit, creativeWhiteXYZ);
                XYZ *= 1.0f / max(creativeWhiteRGB.x, max(creativeWhiteRGB.y, creativeWhiteRGB.z));
            }
            out = vector_dot(XYZ_to_RGB_limit, XYZ);

            // Soft clamp by compressing negative display linear values
            if (softClip)
            {
                float3 compr = make_float3(clamp_thr, clamp_dist, 1.2f);
                out = compress_aces(out, compr, compr, compr, 0);
            }

            // hard clip 0-1
            if (hardClip)
            {
                out = clamp3(out, 0.0f, 1.0f);
            }
            
            if (asPQ)
            {
                out = referenceLuminance * vector_dot(BT709_to_BT2020, out);
                out.x = linear_to_ST2084(out.x);
                out.y = linear_to_ST2084(out.y);
                out.z = linear_to_ST2084(out.z);
            }
            else
            {
                out = float3spow(out, 1.0f / 2.4f);
            }
        }
        else
        {
            XYZ = Hellwig2022_JMh_to_XYZ(JMh , inWhite) / referenceLuminance;
            out = vector_dot(XYZ_to_AP0_ACES_matrix, XYZ);
        }
    }

    return out;
}