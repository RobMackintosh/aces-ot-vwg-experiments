DEFINE_UI_PARAMS(toneCurve, Tone Curve, DCTLUI_CHECK_BOX, 1)
DEFINE_UI_PARAMS(compressChroma, Compress Chroma, DCTLUI_CHECK_BOX, 1)
DEFINE_UI_PARAMS(gamutCompress, Gamut Compress, DCTLUI_CHECK_BOX, 1)
DEFINE_UI_PARAMS(d60Sim, D60 Sim, DCTLUI_CHECK_BOX, 0)
DEFINE_UI_PARAMS(asPQ, Encode as BT.2100 PQ, DCTLUI_CHECK_BOX, 1)
DEFINE_UI_PARAMS(ap1Clip, AP1 Clamp, DCTLUI_CHECK_BOX, 1)
DEFINE_UI_PARAMS(softClip, Soft Clip, DCTLUI_CHECK_BOX, 0)
DEFINE_UI_PARAMS(hardClip, Clamp, DCTLUI_CHECK_BOX, 1)
DEFINE_UI_PARAMS(invert, Invert, DCTLUI_CHECK_BOX, 0)
DEFINE_UI_PARAMS(JMhOut, Diagnostic JMh Output, DCTLUI_CHECK_BOX, 0)


typedef struct
{
    float3 x;
    float3 y;
    float3 z;
} float3x3;

// Constant values generated in Python
// https://github.com/nick-shaw/aces-ot-vwg-experiments/blob/master/python/v55_init_plot.py

__CONSTANT__ float3x3 XYZ_to_RGB_limit =
{
// XYZ to P3-D65 matrix
    { 2.4934969119f, -0.9313836179f, -0.4027107845f },
    {-0.8294889696f,  1.7626640603f,  0.0236246858f },
    { 0.0358458302f, -0.0761723893f,  0.9568845240f }
};

__CONSTANT__ float3x3 RGB_to_XYZ_output =
{
// Rec.2020 to XYZ matrix
    { 0.6369580483f,  0.1446169036f,  0.1688809752f },
    { 0.2627002120f,  0.6779980715f,  0.0593017165f },
    { 0.0000000000f,  0.0280726930f,  1.0609850577f }
};

__CONSTANT__ float3x3 RGB_to_XYZ_P3D60 =
{
    { 0.5049495342f,  0.2646814889f,  0.1830150515f },
    { 0.2376233102f,  0.6891706692f,  0.0732060206f },
    {-0.0000000000f,  0.0449459132f,  0.9638792711f }
};

__CONSTANT__ float3x3 P3D65_to_BT2020 =
{
    { 0.7538330344f,  0.1985973691f,  0.0475695966f },
    { 0.0457438490f,  0.9417772198f,  0.0124789312f },
    {-0.0012103404f,  0.0176017173f,  0.9836086231f }
};

__CONSTANT__ float limitJmax = 283.249899f;
__CONSTANT__ float midJ = 40.8168834391f; // ~15 nits in Hellwig J
__CONSTANT__ float focusDist = 3.7125f;

__CONSTANT__ float daniele_n = 1000.0f; // peak white
__CONSTANT__ float daniele_m_2 = 10.1729113787f;
__CONSTANT__ float daniele_s_2 = 5.8959268851f;
__CONSTANT__ float daniele_u_2 = 0.9869191713f;

// Chroma compression scaling for HDR/SDR appearance match
__CONSTANT__ float sat = 0.403f;
__CONSTANT__ float sat_thr = 0.0005f;
__CONSTANT__ float compr = 10.32f;

__CONSTANT__ float3 gamutCuspTable[360] = 
{
    { 164.3075426607f,  202.3475210416f,  0.8162433607f },
    { 163.4550876354f,  203.7601505230f,  1.6995195068f },
    { 162.5937903597f,  205.2152890083f,  2.6133673021f },
    { 161.7231812753f,  206.7148683923f,  3.5617697932f },
    { 160.8427221154f,  208.2611408001f,  4.5495532279f },
    { 159.9517874756f,  209.8567941811f,  5.5826405915f },
    { 159.0496390494f,  211.5051251204f,  6.6684095508f },
    { 158.1353885531f,  213.2103046680f,  7.8162119195f },
    { 157.2079425383f,  214.9778011068f,  9.0381524863f },
    { 156.2659168579f,  216.8150795471f,  10.3503032777f },
    { 155.3074974148f,  218.7328170530f,  11.7746896203f },
    { 154.3301990922f,  220.7471452976f,  13.3427400417f },
    { 153.3304139772f,  222.8841288971f,  15.1017654710f },
    { 152.3024689701f,  225.1897184193f,  17.1284865383f },
    { 151.2363312304f,  227.7555924671f,  19.5619555135f },
    { 150.1104372545f,  230.8055512250f,  22.7062379006f },
    { 148.8540721692f,  235.1860596733f,  27.5666786166f },
    { 151.6713680072f,  226.1991502484f,  29.0215414345f },
    { 154.4039653064f,  218.0138617375f,  30.5028655247f },
    { 157.0599304015f,  210.5389312983f,  32.0087331495f },
    { 159.6460202880f,  203.6989131974f,  33.5373148614f },
    { 162.1679717248f,  197.4306380326f,  35.0867673536f },
    { 164.6307120003f,  191.6806023499f,  36.6551773656f },
    { 167.0385160349f,  186.4030089150f,  38.2405326001f },
    { 169.3951257458f,  181.5582718072f,  39.8407095772f },
    { 171.7038422768f,  177.1118600612f,  41.4534727977f },
    { 173.9675983248f,  173.0333922701f,  43.0764818774f },
    { 176.1890156145f,  169.2959202374f,  44.7073045210f },
    { 178.3704511184f,  165.8753571470f,  46.3434338436f },
    { 180.5140346263f,  162.7500176944f,  47.9823088921f },
    { 182.6216995831f,  159.9002460047f,  49.6213374017f },
    { 184.6952086286f,  157.3081131200f,  51.2579199231f },
    { 186.7361749220f,  154.9571701259f,  52.8894745246f },
    { 188.7460800805f,  152.8322461155f,  54.5134613286f },
    { 190.7262893767f,  150.9192825030f,  56.1274062043f },
    { 192.6780646936f,  149.2051969293f,  57.7289230108f },
    { 194.6025756363f,  147.6777713171f,  59.3157338719f },
    { 196.5009091148f,  146.3255596505f,  60.8856870614f },
    { 198.3740776506f,  145.1378118466f,  62.4367721861f },
    { 200.2230266127f,  144.1044107232f,  63.9671324634f },
    { 202.0486405488f,  143.2158195799f,  65.4750739997f },
    { 203.8517487491f,  142.4630383352f,  66.9590720778f },
    { 205.6331301547f,  141.8375665139f,  68.4177745547f },
    { 207.3935177042f,  141.3313716782f,  69.8500025448f },
    { 209.1336021968f,  140.9368621496f,  71.2547486297f },
    { 210.8540357365f,  140.6468630817f,  72.6311728773f },
    { 212.5554348134f,  140.4545951306f,  73.9785969810f },
    { 214.2383830676f,  140.3536551207f,  75.2964968434f },
    { 215.9034337766f,  140.3379982384f,  76.5844939281f },
    { 217.5511120990f,  140.4019213928f,  77.8423456912f },
    { 219.1819171036f,  140.5400474724f,  79.0699353814f },
    { 220.7963236098f,  140.7473103006f,  80.2672614746f },
    { 222.3947838593f,  141.0189401504f,  81.4344269734f },
    { 223.9777290396f,  141.3504497256f,  82.5716287725f },
    { 225.5455706738f,  141.7376205494f,  83.6791472556f },
    { 227.0987018919f,  142.1764897276f,  84.7573362585f },
    { 228.6374985960f,  142.6633370735f,  85.8066135013f },
    { 230.1623205298f,  143.1946725941f,  86.8274515670f },
    { 231.6735122618f,  143.7672243433f,  87.8203694793f },
    { 233.1714040921f,  144.3779266558f,  88.7859249083f },
    { 234.6563128879f,  145.0239087729f,  89.7247070205f },
    { 236.1285428564f,  145.7024838770f,  90.6373299696f },
    { 237.5883862600f,  146.4111385426f,  91.5244270167f },
    { 239.0361240794f,  147.1475226160f,  92.3866452571f },
    { 240.4720266285f,  147.9094395299f,  93.2246409257f },
    { 241.8963541267f,  148.6948370542f,  94.0390752472f },
    { 243.3093572310f,  149.5017984861f,  94.8306107956f },
    { 244.7112775319f,  150.3285342741f,  95.5999083243f },
    { 246.1023480161f,  151.1733740721f,  96.3476240287f },
    { 247.4827934988f,  152.0347592155f,  97.0744072034f },
    { 248.8528310274f,  152.9112356077f,  97.7808982565f },
    { 250.2126702604f,  153.8014470077f,  98.4677270461f },
    { 251.5625138212f,  154.7041287035f,  99.1355115052f },
    { 252.9025576310f,  155.6181015580f,  99.7848565227f },
    { 254.2329912206f,  156.5422664126f,  100.4163530531f },
    { 255.5539980244f,  157.4755988321f,  101.0305774259f },
    { 256.8657556556f,  158.4171441751f,  101.6280908317f },
    { 256.2801082129f,  158.3756508993f,  102.2157993627f },
    { 255.6924553930f,  158.3515118488f,  102.8072382915f },
    { 255.1027779737f,  158.3450450099f,  103.4023169300f },
    { 254.5110564199f,  158.3565693015f,  104.0009403843f },
    { 253.9172708765f,  158.3864043981f,  104.6030095874f },
    { 253.3214011611f,  158.4348705508f,  105.2084213429f },
    { 252.7234267561f,  158.5022884080f,  105.8170683799f },
    { 252.1233268009f,  158.5889788340f,  106.4288394183f },
    { 251.5210800838f,  158.6952627298f,  107.0436192471f },
    { 250.9166650338f,  158.8214608533f,  107.6612888129f },
    { 250.3100597115f,  158.9678936421f,  108.2817253204f },
    { 249.7012418008f,  159.1348810382f,  108.9048023446f },
    { 249.0901885992f,  159.3227423164f,  109.5303899540f },
    { 248.4768770087f,  159.5317959162f,  110.1583548453f },
    { 247.8612835256f,  159.7623592791f,  110.7885604895f },
    { 247.2433842310f,  160.0147486911f,  111.4208672878f },
    { 246.6231547798f,  160.2892791322f,  112.0551327388f },
    { 246.0005703905f,  160.5862641326f,  112.6912116157f },
    { 245.3756058334f,  160.9060156378f,  113.3289561522f },
    { 244.7482354200f,  161.2488438816f,  113.9682162385f },
    { 244.1184329905f,  161.6150572706f,  114.6088396249f },
    { 243.4861719017f,  162.0049622771f,  115.2506721336f },
    { 242.8514250145f,  162.4188633454f,  115.8935578777f },
    { 242.2141646807f,  162.8570628088f,  116.5373394861f },
    { 241.5743627295f,  163.3198608199f,  117.1818583343f },
    { 240.9319904536f,  163.8075552946f,  117.8269547803f },
    { 240.2870185944f,  164.3204418698f,  118.4724684034f },
    { 239.6394173274f,  164.8588138764f,  119.1182382471f },
    { 238.9891562464f,  165.4229623267f,  119.7641030636f },
    { 238.3362043475f,  166.0131759190f,  120.4099015595f },
    { 237.6805300126f,  166.6297410570f,  121.0554726419f },
    { 237.0221009921f,  167.2729418873f,  121.7006556637f },
    { 236.3608843867f,  167.9430603533f,  122.3452906677f },
    { 235.6968466294f,  168.6403762665f,  122.9892186278f },
    { 235.0299534658f,  169.3651673963f,  123.6322816871f },
    { 234.3601699345f,  170.1177095766f,  124.2743233919f },
    { 233.6874603465f,  170.8982768320f,  124.9151889199f },
    { 233.0117882632f,  171.7071415210f,  125.5547253036f },
    { 232.3331164745f,  172.5445744988f,  126.1927816463f },
    { 231.6514069760f,  173.4108452975f,  126.8292093307f },
    { 230.9666209440f,  174.3062223259f,  127.4638622204f },
    { 230.2787187116f,  175.2309730870f,  128.0965968512f },
    { 229.5876597418f,  176.1853644141f,  128.7272726152f },
    { 228.8934026012f,  177.1696627258f,  129.3557519329f },
    { 228.1959049313f,  178.1841342989f,  129.9819004173f },
    { 227.4951234199f,  179.2290455594f,  130.6055870263f },
    { 226.7910137699f,  180.3046633917f,  131.2266842042f },
    { 226.0835306683f,  181.4112554662f,  131.8450680130f },
    { 225.3726277527f,  182.5490905841f,  132.4606182513f },
    { 224.6582575773f,  183.7184390402f,  133.0732185631f },
    { 223.9403715766f,  184.9195730035f,  133.6827565339f },
    { 223.2189200282f,  186.1527669148f,  134.2891237760f },
    { 222.4938520136f,  187.4182979027f,  134.8922160027f },
    { 221.7651153779f,  188.7164462157f,  135.4919330903f },
    { 221.0326566867f,  190.0474956732f,  136.0881791301f },
    { 220.2964211818f,  191.4117341327f,  136.6808624683f },
    { 219.5563527351f,  192.8094539753f,  137.2698957362f },
    { 218.8123937995f,  194.2409526090f,  137.8551958696f },
    { 218.0644853585f,  195.7065329890f,  138.4366841183f },
    { 217.3125668729f,  197.2065041578f,  139.0142860455f },
    { 217.9647857166f,  190.1489642485f,  140.1945441252f },
    { 218.6002061231f,  183.9639647875f,  141.3279193353f },
    { 219.2223998127f,  178.4517213060f,  142.4274216146f },
    { 219.8337594888f,  173.4785531792f,  143.5016429196f },
    { 220.4359792565f,  168.9499523785f,  144.5565530106f },
    { 221.0303099755f,  164.7962661503f,  145.5964543975f },
    { 221.6177061819f,  160.9644574542f,  146.6245318466f },
    { 222.1989159490f,  157.4130642494f,  147.6431884490f },
    { 222.7745385889f,  154.1089619176f,  148.6542614065f },
    { 223.3450632047f,  151.0251995064f,  149.6591662352f },
    { 223.9108953153f,  148.1395049771f,  150.6589964251f },
    { 224.4723757657f,  145.4332232849f,  151.6545943291f },
    { 225.0297944832f,  142.8905436236f,  152.6466028752f },
    { 225.5834006963f,  140.4979252630f,  153.6355041463f },
    { 226.1334106645f,  138.2436630990f,  154.6216487540f },
    { 226.6800136218f,  136.1175535902f,  155.6052786271f },
    { 227.2233764110f,  134.1106341912f,  156.5865450018f },
    { 227.7636471458f,  132.2149775022f,  157.5655228601f },
    { 228.3009581371f,  130.4235267704f,  158.5422226995f },
    { 228.8354282565f,  128.7299630720f,  159.5166002725f },
    { 229.3671648634f,  127.1285970656f,  160.4885647584f },
    { 229.8962653908f,  125.6142800195f,  161.4579857132f },
    { 230.4228186597f,  124.1823301166f,  162.4246990537f },
    { 230.9469059772f,  122.8284709805f,  163.3885122690f },
    { 231.4686020601f,  121.5487800690f,  164.3492090073f },
    { 231.9879758174f,  120.3396450955f,  165.3065531484f },
    { 232.5050910153f,  119.1977270312f,  166.2602924498f },
    { 233.0200068477f,  118.1199285428f,  167.2101618317f },
    { 233.5327784265f,  117.1033669433f,  168.1558863517f },
    { 234.0434572058f,  116.1453509173f,  169.0971839105f },
    { 234.5520913508f,  115.2433604172f,  170.0337677179f },
    { 235.0587260585f,  114.3950292387f,  170.9653485437f },
    { 235.5634038398f,  113.5981298697f,  171.8916367735f },
    { 236.0661647671f,  112.8505602766f,  172.8123442822f },
    { 236.5670466922f,  112.1503323492f,  173.7271861403f },
    { 237.0660854405f,  111.4955617686f,  174.6358821596f },
    { 237.5633149820f,  110.8844591024f,  175.5381582891f },
    { 238.0587675849f,  110.3153219586f,  176.4337478674f },
    { 238.5524739520f,  109.7865280581f,  177.3223927366f },
    { 239.0444633438f,  109.2965291028f,  178.2038442267f },
    { 239.5347636879f,  108.8438453379f,  179.0778640129f },
    { 240.0234016788f,  108.4270607171f,  179.9442248525f },
    { 240.5104028671f,  108.0448185951f,  180.8027112081f },
    { 240.9957917408f,  107.6958178810f,  181.6531197604f },
    { 241.4795917985f,  107.3788095932f,  182.4952598176f },
    { 241.9618256168f,  107.0925937680f,  183.3289536269f },
    { 242.4425149105f,  106.8360166766f,  184.1540365937f },
    { 242.9216805886f,  106.6079683130f,  184.9703574150f },
    { 243.3993428053f,  106.4073801191f,  185.7777781320f },
    { 243.8755210058f,  106.2332229189f,  186.5761741094f },
    { 244.3502339698f,  106.0845050347f,  187.3654339460f },
    { 244.8234998505f,  105.9602705657f,  188.1454593241f },
    { 245.2953362105f,  105.8595978057f,  188.9161648027f },
    { 245.7657600557f,  105.7815977872f,  189.6774775605f },
    { 246.2347878654f,  105.7254129334f,  190.4293370949f },
    { 246.7024356216f,  105.6902158073f,  191.1716948824f },
    { 247.1687188348f,  105.6752079455f,  191.9045140056f },
    { 247.6336525687f,  105.6796187669f,  192.6277687512f },
    { 248.0972514630f,  105.7027045485f,  193.3414441859f },
    { 248.5595297546f,  105.7437474594f,  194.0455357121f },
    { 247.1805715183f,  105.1671059005f,  194.7524267585f },
    { 245.7911799866f,  104.6022712807f,  195.4734410753f },
    { 244.3911445426f,  104.0498796788f,  196.2088057514f },
    { 242.9802474929f,  103.5105934238f,  196.9587402253f },
    { 241.5582637315f,  102.9851018381f,  197.7234549681f },
    { 240.1249603837f,  102.4741219620f,  198.5031500763f },
    { 238.6800964274f,  101.9783992565f,  199.2980137747f },
    { 237.2234222908f,  101.4987082782f,  200.1082208300f },
    { 235.7546794233f,  101.0358533221f,  200.9339308770f },
    { 234.2735998394f,  100.5906690249f,  201.7752866622f },
    { 232.7799056321f,  100.1640209258f,  202.6324122087f },
    { 231.2733084535f,  99.7568059769f,  203.5054109105f },
    { 229.7535089600f,  99.3699530002f,  204.3943635642f },
    { 228.2201962193f,  99.0044230834f,  205.2993263492f },
    { 226.6730470756f,  98.6612099127f,  206.2203287700f },
    { 225.1117254697f,  98.3413400364f,  207.1573715747f },
    { 223.5358817095f,  98.0458730571f,  208.1104246691f },
    { 221.9451516869f,  97.7759017504f,  209.0794250454f },
    { 220.3391560360f,  97.5325521094f,  210.0642747474f },
    { 218.7174992277f,  97.3169833152f,  211.0648388994f },
    { 217.0797685931f,  97.1303876371f,  212.0809438229f },
    { 215.4255332709f,  96.9739902664f,  213.1123752718f },
    { 213.7543430700f,  96.8490490933f,  214.1588768159f },
    { 212.0657272392f,  96.7568544349f,  215.2201484040f },
    { 210.3591931351f,  96.6987287309f,  216.2958451395f },
    { 208.6342247761f,  96.6760262214f,  217.3855763001f },
    { 206.8902812729f,  96.6901326320f,  218.4889046328f },
    { 205.1267951202f,  96.7424648884f,  219.6053459556f },
    { 203.3431703349f,  96.8344708935f,  220.7343690918f },
    { 201.5387804247f,  96.9676294014f,  221.8753961637f },
    { 199.7129661663f,  97.1434500293f,  223.0278032639f },
    { 197.8650331717f,  97.3634734538f,  224.1909215207f },
    { 195.9942492176f,  97.6292718434f,  225.3640385682f },
    { 194.0998413088f,  97.9424495861f,  226.5464004218f },
    { 192.1809924427f,  98.3046443766f,  227.7372137561f },
    { 190.2368380365f,  98.7175287356f,  228.9356485731f },
    { 188.2664619737f,  99.1828120389f,  230.1408412385f },
    { 186.2688922189f,  99.7022431449f,  231.3518978579f },
    { 184.2430959425f,  100.2776137166f,  232.5678979548f },
    { 182.1879740850f,  100.9107623423f,  233.7878984035f },
    { 180.1023552829f,  101.6035795755f,  235.0109375623f },
    { 177.9849890599f,  102.3580140219f,  236.2360395456f },
    { 175.8345381726f,  103.1760796230f,  237.4622185632f },
    { 173.6495699800f,  104.0598643008f,  238.6884832524f },
    { 171.4285466789f,  105.0115401558f,  239.9138409190f },
    { 169.1698142179f,  106.0333754365f,  241.1373015988f },
    { 166.8715896666f,  107.1277485388f,  242.3578818444f },
    { 164.5319467666f,  108.2971643373f,  243.5746081353f },
    { 162.1487993357f,  109.5442732108f,  244.7865198023f },
    { 159.7198821217f,  110.8718931997f,  245.9926713441f },
    { 157.2427286115f,  112.2830358241f,  247.1921340012f },
    { 154.7146451811f,  113.7809362177f,  248.3839964308f },
    { 152.1326808229f,  115.3690883868f,  249.5673642972f },
    { 149.4935914900f,  117.0512866069f,  250.7413585488f },
    { 146.7937978388f,  118.8316742377f,  251.9051120919f },
    { 144.0293348158f,  120.7148015845f,  253.0577644848f },
    { 141.1957910780f,  122.7056949037f,  254.1984541457f },
    { 138.2882356256f,  124.8099392734f,  255.3263073869f },
    { 135.3011281886f,  127.0337789062f,  256.4404233116f },
    { 132.2282087445f,  129.3842396554f,  257.5398532139f },
    { 133.6859472864f,  127.2184717411f,  259.6516729875f },
    { 135.1198222330f,  125.2706254773f,  261.7715167335f },
    { 136.5309491106f,  123.5320403696f,  263.8951115046f },
    { 137.9203582487f,  121.9942380343f,  266.0180636754f },
    { 139.2890036323f,  120.6488720944f,  268.1359241362f },
    { 140.6377706078f,  119.4876934893f,  270.2442546968f },
    { 141.9674826165f,  118.5025294624f,  272.3386934668f },
    { 143.2789071041f,  117.6852744237f,  274.4150170314f },
    { 144.5727607233f,  117.0278908252f,  276.4691974285f },
    { 145.8497139326f,  116.5224181556f,  278.4974522461f },
    { 147.1103950725f,  116.1609881730f,  280.4962865594f },
    { 148.3553939910f,  115.9358445625f,  282.4625258852f },
    { 149.5852652780f,  115.8393653283f,  284.3933397948f },
    { 150.8005311581f,  115.8640863981f,  286.2862562746f },
    { 152.0016840848f,  116.0027251260f,  288.1391673079f },
    { 153.1891890742f,  116.2482026107f,  289.9503264686f },
    { 154.3634858077f,  116.5936639809f,  291.7183395394f },
    { 155.5249905325f,  117.0324960402f,  293.4421493111f },
    { 156.6740977817f,  117.5583418741f,  295.1210157677f },
    { 157.8111819362f,  118.1651122218f,  296.7544928537f },
    { 158.9365986446f,  118.8469935764f,  298.3424029452f },
    { 160.0506861163f,  119.5984531077f,  299.8848100346f },
    { 161.1537663028f,  120.4142406067f,  301.3819925055f },
    { 162.2461459772f,  121.2893877163f,  302.8344162237f },
    { 163.3281177238f,  122.2192047607f,  304.2427085239f },
    { 164.3999608454f,  123.1992755058f,  305.6076335298f },
    { 165.4619421980f,  124.2254501882f,  306.9300691182f },
    { 166.5143169581f,  125.2938371396f,  308.2109857264f },
    { 167.5573293315f,  126.4007933145f,  309.4514271083f },
    { 168.5912132062f,  127.5429140027f,  310.6524930695f },
    { 169.6161927571f,  128.7170219779f,  311.8153241511f },
    { 170.6324830051f,  129.9201563014f,  312.9410881890f },
    { 171.6402903360f,  131.1495609713f,  314.0309686442f },
    { 172.6398129815f,  132.4026735729f,  315.0861545761f },
    { 173.6312414667f,  133.6771140616f,  316.1078321247f },
    { 174.6147590260f,  134.9706737826f,  317.0971773562f },
    { 175.5905419907f,  136.2813048079f,  318.0553503336f },
    { 176.5587601509f,  137.6071096545f,  318.9834902717f },
    { 177.5195770919f,  138.9463314258f,  319.8827116494f },
    { 178.4731505103f,  140.2973444087f,  320.7541011554f },
    { 179.4196325087f,  141.6586451429f,  321.5987153570f },
    { 180.3591698715f,  143.0288439720f,  322.4175789899f },
    { 181.2919043239f,  144.4066570756f,  323.2116837781f },
    { 182.2179727746f,  145.7908989768f,  323.9819877026f },
    { 183.1375075439f,  147.1804755145f,  324.7294146462f },
    { 184.0506365775f,  148.5743772656f,  325.4548543518f },
    { 184.9574836482f,  149.9716733996f,  326.1591626395f },
    { 185.8581685456f,  151.3715059470f,  326.8431618332f },
    { 186.7528072545f,  152.7730844602f,  327.5076413569f },
    { 187.6415121235f,  154.1756810475f,  328.1533584645f },
    { 188.5243920241f,  155.5786257577f,  328.7810390731f },
    { 189.4015525004f,  156.9813022944f,  329.3913786744f },
    { 190.2730959111f,  158.3831440401f,  329.9850433018f },
    { 191.1391215637f,  159.7836303698f,  330.5626705366f },
    { 191.9997258413f,  161.1822832344f,  331.1248705364f },
    { 192.8550023227f,  162.5786639963f,  331.6722270746f },
    { 193.7050418964f,  163.9723704984f,  332.2052985801f },
    { 194.5499328685f,  165.3630343513f,  332.7246191690f },
    { 195.3897610649f,  166.7503184228f,  333.2306996617f },
    { 196.2246099291f,  168.1339145136f,  333.7240285800f },
    { 195.5856077905f,  168.4884701769f,  334.2104907729f },
    { 194.9435399742f,  168.8569217624f,  334.7010244094f },
    { 194.2983605759f,  169.2395781519f,  335.1956802053f },
    { 193.6500223865f,  169.6367555387f,  335.6945118128f },
    { 192.9984768338f,  170.0487776522f,  336.1975761031f },
    { 192.3436739204f,  170.4759759939f,  336.7049334762f },
    { 191.6855621568f,  170.9186900845f,  337.2166482009f },
    { 191.0240884918f,  171.3772677233f,  337.7327887875f },
    { 190.3591982361f,  171.8520652617f,  338.2534283972f },
    { 189.6908349820f,  172.3434478899f,  338.7786452929f },
    { 189.0189405170f,  172.8517899398f,  339.3085233351f },
    { 188.3434547312f,  173.3774752043f,  339.8431525285f },
    { 187.6643155174f,  173.9208972743f,  340.3826296259f },
    { 186.9814586643f,  174.4824598961f,  340.9270587956f },
    { 186.2948177406f,  175.0625773497f,  341.4765523604f },
    { 185.6043239709f,  175.6616748499f,  342.0312316175f },
    { 184.9099061002f,  176.2801889744f,  342.5912277500f },
    { 184.2114902478f,  176.9185681189f,  343.1566828407f },
    { 183.5089997483f,  177.5772729845f,  343.7277510048f },
    { 182.8023549786f,  178.2567770992f,  344.3045996551f },
    { 182.0914731689f,  178.9575673790f,  344.8874109207f },
    { 181.3762681955f,  179.6801447328f,  345.4763832411f },
    { 180.6566503546f,  180.4250247174f,  346.0717331615f },
    { 179.9325261119f,  181.1927382484f,  346.6736973611f },
    { 179.2037978274f,  181.9838323778f,  347.2825349510f },
    { 178.4703634500f,  182.7988711463f,  347.8985300854f },
    { 177.7321161783f,  183.6384365243f,  348.5219949393f },
    { 176.9889440826f,  184.5031294566f,  349.1532731153f },
    { 176.2407296816f,  185.3935710305f,  349.7927435563f },
    { 175.4873494661f,  186.3104037925f,  350.4408250562f },
    { 174.7286733622f,  187.2542932423f,  351.0979814835f },
    { 173.9645641212f,  188.2259295460f,  351.7647278546f },
    { 173.1948766249f,  189.2260295171f,  352.4416374323f },
    { 172.4194570885f,  190.2553389316f,  353.1293500612f },
    { 171.6381421413f,  191.3146352623f,  353.8285820117f },
    { 170.8507577606f,  192.4047309449f,  354.5401376712f },
    { 170.0571180251f,  193.5264773251f,  355.2649235188f },
    { 169.2570236478f,  194.6807694880f,  356.0039649399f },
    { 168.4502602354f,  195.8685522415f,  356.7584266088f },
    { 167.6365962046f,  197.0908276275f,  357.5296373909f },
    { 166.8157802649f,  198.3486644780f,  358.3191210316f },
    { 165.9875383451f,  199.6432107437f,  359.1286343329f },
    { 165.1515697987f,  200.9757096306f,  359.9602151417f }
};

__CONSTANT__ float gamutCuspTableReach[360] = 
{
    387.885f,
    393.909f,
    399.872f,
    405.737f,
    411.481f,
    417.084f,
    422.516f,
    427.753f,
    432.782f,
    437.579f,
    442.145f,
    446.460f,
    450.525f,
    454.333f,
    457.892f,
    461.212f,
    464.301f,
    467.163f,
    469.818f,
    472.284f,
    474.573f,
    476.703f,
    478.693f,
    480.560f,
    482.330f,
    483.484f,
    465.295f,
    448.572f,
    433.148f,
    418.878f,
    405.640f,
    393.335f,
    381.873f,
    371.173f,
    361.163f,
    351.788f,
    342.987f,
    334.717f,
    326.941f,
    319.611f,
    312.695f,
    306.165f,
    299.988f,
    294.147f,
    288.617f,
    283.380f,
    278.406f,
    273.694f,
    269.214f,
    264.960f,
    260.913f,
    257.068f,
    253.412f,
    249.933f,
    246.625f,
    243.469f,
    240.472f,
    237.622f,
    234.900f,
    232.318f,
    229.858f,
    227.521f,
    225.299f,
    223.181f,
    221.173f,
    219.269f,
    217.462f,
    215.753f,
    214.130f,
    212.598f,
    211.151f,
    209.790f,
    208.508f,
    207.306f,
    206.177f,
    205.121f,
    204.144f,
    203.235f,
    202.393f,
    201.617f,
    200.916f,
    200.275f,
    199.701f,
    199.188f,
    198.743f,
    198.358f,
    198.029f,
    197.766f,
    197.565f,
    197.424f,
    197.345f,
    197.327f,
    197.363f,
    197.461f,
    197.626f,
    197.845f,
    198.126f,
    198.468f,
    198.871f,
    199.341f,
    199.872f,
    200.464f,
    201.123f,
    201.849f,
    202.643f,
    203.503f,
    204.437f,
    205.438f,
    206.512f,
    207.666f,
    208.893f,
    210.199f,
    211.591f,
    213.062f,
    214.618f,
    216.266f,
    218.005f,
    219.843f,
    221.777f,
    223.816f,
    225.964f,
    228.223f,
    230.597f,
    233.093f,
    235.718f,
    238.470f,
    241.370f,
    244.415f,
    247.607f,
    250.970f,
    254.498f,
    258.209f,
    262.109f,
    266.217f,
    270.532f,
    275.079f,
    279.871f,
    284.912f,
    290.234f,
    295.850f,
    301.782f,
    308.051f,
    314.685f,
    321.710f,
    329.163f,
    320.209f,
    311.780f,
    303.888f,
    296.490f,
    289.545f,
    283.014f,
    276.868f,
    271.069f,
    265.601f,
    260.431f,
    255.548f,
    250.928f,
    246.552f,
    242.407f,
    238.477f,
    234.747f,
    231.207f,
    227.844f,
    224.652f,
    221.625f,
    218.744f,
    216.003f,
    213.403f,
    210.931f,
    208.582f,
    206.354f,
    204.236f,
    202.222f,
    200.317f,
    198.505f,
    196.790f,
    195.172f,
    193.634f,
    192.181f,
    190.814f,
    189.526f,
    188.318f,
    187.177f,
    186.115f,
    185.120f,
    184.192f,
    183.337f,
    182.544f,
    181.818f,
    181.152f,
    180.548f,
    180.005f,
    179.523f,
    179.102f,
    178.735f,
    178.430f,
    178.186f,
    177.991f,
    177.856f,
    177.777f,
    177.759f,
    177.795f,
    177.887f,
    178.033f,
    178.241f,
    178.503f,
    178.821f,
    179.205f,
    179.639f,
    180.139f,
    180.701f,
    181.317f,
    182.001f,
    182.751f,
    183.563f,
    184.442f,
    185.394f,
    186.414f,
    187.506f,
    188.672f,
    189.911f,
    191.235f,
    192.639f,
    194.128f,
    195.703f,
    197.375f,
    199.133f,
    201.001f,
    202.966f,
    205.042f,
    207.227f,
    209.534f,
    211.969f,
    214.532f,
    217.236f,
    220.087f,
    223.090f,
    226.263f,
    229.608f,
    233.142f,
    236.871f,
    240.820f,
    244.995f,
    249.414f,
    254.102f,
    259.076f,
    264.362f,
    269.989f,
    273.663f,
    269.666f,
    265.851f,
    262.207f,
    258.728f,
    255.408f,
    252.240f,
    249.213f,
    246.320f,
    243.561f,
    240.930f,
    238.416f,
    236.017f,
    233.728f,
    231.549f,
    229.468f,
    227.490f,
    225.604f,
    223.816f,
    222.113f,
    220.496f,
    218.964f,
    217.511f,
    216.138f,
    214.838f,
    213.617f,
    212.463f,
    211.389f,
    210.376f,
    209.436f,
    208.557f,
    207.745f,
    207.001f,
    206.317f,
    205.695f,
    205.127f,
    204.626f,
    204.187f,
    203.802f,
    203.473f,
    203.204f,
    202.991f,
    202.838f,
    202.740f,
    202.698f,
    202.710f,
    202.783f,
    202.911f,
    203.088f,
    203.333f,
    203.625f,
    203.979f,
    204.388f,
    204.852f,
    205.383f,
    205.963f,
    206.610f,
    207.312f,
    208.075f,
    208.905f,
    209.796f,
    210.748f,
    211.768f,
    212.848f,
    214.001f,
    215.222f,
    216.510f,
    217.877f,
    219.312f,
    220.825f,
    222.412f,
    224.078f,
    225.824f,
    227.655f,
    229.572f,
    231.580f,
    233.673f,
    235.858f,
    238.141f,
    240.527f,
    243.005f,
    245.593f,
    248.285f,
    251.086f,
    254.004f,
    257.037f,
    260.187f,
    263.464f,
    266.864f,
    270.392f,
    274.054f,
    277.850f,
    281.787f,
    285.864f,
    290.082f,
    294.446f,
    298.956f,
    303.613f,
    308.411f,
    313.361f,
    318.451f,
    323.682f,
    329.047f,
    334.546f,
    340.161f,
    345.892f,
    351.721f,
    357.642f,
    363.623f,
    369.666f,
    375.739f,
    381.818f
};

__CONSTANT__ float3 cGamutCuspTable[360] = 
{
    { 178.3170995024f,  266.4500730573f,  0.4176289242f },
    { 177.6433351001f,  268.0292972776f,  1.0112067795f },
    { 176.9636525809f,  269.6355843891f,  1.6205357961f },
    { 176.2777883199f,  271.2693311414f,  2.2472982900f },
    { 175.5854484973f,  272.9309415161f,  2.8934533070f },
    { 174.8863029600f,  274.6208315318f,  3.5613004534f },
    { 174.1799772638f,  276.3394372746f,  4.2535634826f },
    { 173.4660421813f,  278.0872280830f,  4.9735015583f },
    { 172.7439995965f,  279.8647280561f,  5.7250601263f },
    { 172.0132631217f,  281.6725512189f,  6.5130798776f },
    { 171.2731307792f,  283.5114595607f,  7.3435933421f },
    { 170.5227453516f,  285.3824604103f,  8.2242580820f },
    { 169.7610348053f,  287.2869737665f,  9.1650112235f },
    { 168.9866189699f,  289.2271293597f,  10.1790996744f },
    { 168.1976557153f,  291.2063174467f,  11.2847852774f },
    { 167.3915706024f,  293.2302710145f,  12.5083520643f },
    { 166.5645403029f,  295.3093664060f,  13.8898686876f },
    { 165.7103859558f,  297.4640889859f,  15.4955598989f },
    { 164.8177684424f,  299.7403822081f,  17.4492094452f },
    { 163.8607772341f,  302.2669410016f,  20.0376146345f },
    { 162.7386830170f,  305.6728175343f,  24.3853759840f },
    { 165.2089788672f,  294.8005653753f,  25.6511608736f },
    { 167.6073760746f,  284.7587243775f,  26.9362243087f },
    { 169.9407729216f,  275.4596839658f,  28.2409954953f },
    { 172.2149637096f,  266.8305713803f,  29.5656734398f },
    { 174.4348744324f,  258.8100579207f,  30.9102458049f },
    { 176.6047373800f,  251.3459876949f,  32.2745027061f },
    { 178.7282229506f,  244.3935838697f,  33.6580471687f },
    { 180.8085408190f,  237.9140691920f,  35.0603035305f },
    { 182.8485187408f,  231.8735894272f,  36.4805247647f },
    { 184.8506647507f,  226.2423621541f,  37.9177994684f },
    { 186.8172168433f,  220.9939958809f,  39.3710590913f },
    { 188.7501830839f,  216.1049397807f,  40.8390858390f },
    { 190.6513743147f,  211.5540349708f,  42.3205215733f },
    { 192.5224310612f,  207.3221457544f,  43.8138779277f },
    { 194.3648458525f,  203.3918545992f,  45.3175477655f },
    { 196.1799818766f,  199.7472085081f,  46.8298180213f },
    { 197.9690886842f,  196.3735072818f,  48.3488838875f },
    { 199.7333154923f,  193.2571262752f,  49.8728642332f },
    { 201.4737225245f,  190.3853678178f,  51.3998180753f },
    { 203.1912907310f,  187.7463366462f,  52.9277618673f },
    { 204.8869301654f,  185.3288355885f,  54.4546873251f },
    { 206.5614872386f,  183.1222784179f,  55.9785794738f },
    { 208.2157510289f,  181.1166173115f,  57.4974345855f },
    { 209.8504587973f,  179.3022827542f,  59.0092776701f },
    { 211.4663008255f,  177.6701340422f,  60.5121791930f },
    { 213.0639246776f,  176.2114187901f,  62.0042707182f },
    { 214.6439389680f,  174.9177400514f,  63.4837592078f },
    { 216.2069167029f,  173.7810298320f,  64.9489397556f },
    { 217.7533982555f,  172.7935279187f,  66.3982065845f },
    { 219.2838940214f,  171.9477650767f,  67.8300621886f },
    { 220.7988867971f,  171.2365497798f,  69.2431245613f },
    { 222.2988339149f,  170.6529577454f,  70.6361325019f },
    { 223.7841691661f,  170.1903236408f,  72.0079490428f },
    { 225.2553045367f,  169.8422344172f,  73.3575630858f },
    { 226.7126317776f,  169.6025238118f,  74.6840893707f },
    { 228.1565238296f,  169.4652676344f,  75.9867669278f },
    { 229.5873361183f,  169.4247795252f,  77.2649561877f },
    { 231.0054077340f,  169.4756069347f,  78.5181349341f },
    { 232.4110625082f,  169.6125271323f,  79.7458932889f },
    { 233.8046099993f,  169.8305431000f,  80.9479279194f },
    { 235.1863463946f,  170.1248792126f,  82.1240356503f },
    { 236.5565553396f,  170.4909766378f,  83.2741066498f },
    { 237.9155086997f,  170.9244884244f,  84.3981173488f },
    { 239.2634672621f,  171.4212742683f,  85.4961232319f },
    { 240.6006813839f,  171.9773949655f,  86.5682516235f },
    { 241.9273915905f,  172.5891065757f,  87.6146945739f },
    { 243.2438291292f,  173.2528543313f,  88.6357019314f },
    { 244.5502164829f,  173.9652663318f,  89.6315746715f },
    { 245.8467678466f,  174.7231470683f,  90.6026585371f },
    { 247.1336895698f,  175.5234708253f,  91.5493380298f },
    { 248.4111805688f,  176.3633750042f,  92.4720307793f },
    { 249.6794327105f,  177.2401534149f,  93.3711823086f },
    { 250.9386311702f,  178.1512495751f,  94.2472612013f },
    { 252.1889547664f,  179.0942500563f,  95.1007546699f },
    { 253.4305762732f,  180.0668779108f,  95.9321645200f },
    { 254.6636627128f,  181.0669862097f,  96.7420034959f },
    { 255.8883756302f,  182.0925517179f,  97.5307919945f },
    { 257.1048713496f,  183.1416687278f,  98.2990551261f },
    { 258.3133012163f,  184.2125430702f,  99.0473201050f },
    { 259.5138118237f,  185.3034863162f,  99.7761139449f },
    { 258.7993001462f,  185.2454179612f,  100.4931858764f },
    { 258.0817197064f,  185.2173459351f,  101.2156141395f },
    { 257.3610334072f,  185.2199179116f,  101.9432321393f },
    { 256.6372033925f,  185.2537830592f,  102.6758644217f },
    { 255.9101910243f,  185.3195914995f,  103.4133267919f },
    { 255.1799568603f,  185.4179937631f,  104.1554264661f },
    { 254.4464606301f,  185.5496402447f,  104.9019622602f },
    { 253.7096612109f,  185.7151806624f,  105.6527248127f },
    { 252.9695166014f,  185.9152635222f,  106.4074968445f },
    { 252.2259838960f,  186.1505355931f,  107.1660534535f },
    { 251.4790192566f,  186.4216413954f,  107.9281624453f },
    { 250.7285778844f,  186.7292227051f,  108.6935846977f },
    { 249.9746139897f,  187.0739180795f,  109.4620745597f },
    { 249.2170807615f,  187.4563624064f,  110.2333802818f },
    { 248.4559303346f,  187.8771864809f,  111.0072444786f },
    { 247.6911137567f,  188.3370166135f,  111.7834046186f },
    { 246.9225809529f,  188.8364742734f,  112.5615935429f },
    { 246.1502806897f,  189.3761757695f,  113.3415400071f },
    { 245.3741605369f,  189.9567319741f,  114.1229692455f },
    { 244.5941668282f,  190.5787480905f,  114.9056035555f },
    { 243.8102446197f,  191.2428234691f,  115.6891628969f },
    { 243.0223376474f,  191.9495514753f,  116.4733655054f },
    { 242.2303882818f,  192.6995194097f,  117.2579285154f },
    { 241.4343374815f,  193.4933084854f,  118.0425685897f },
    { 240.6341247439f,  194.3314938640f,  118.8270025522f },
    { 239.8296880543f,  195.2146447516f,  119.6109480198f },
    { 239.0209638324f,  196.1433245572f,  120.3941240310f },
    { 238.2078868765f,  197.1180911154f,  121.1762516672f },
    { 237.3903903048f,  198.1394969737f,  121.9570546629f },
    { 236.5684054942f,  199.2080897460f,  122.7362600029f },
    { 235.7418620167f,  200.3244125338f,  123.5135985015f },
    { 234.9106875714f,  201.4890044136f,  124.2888053632f },
    { 234.0748079148f,  202.7024009935f,  125.0616207194f },
    { 233.2341467867f,  203.9651350366f,  125.8317901416f },
    { 232.3886258327f,  205.2777371531f,  126.5990651257f },
    { 231.5381645227f,  206.6407365605f,  127.3632035484f },
    { 230.6826800660f,  208.0546619102f,  128.1239700915f },
    { 229.8220873209f,  209.5200421823f,  128.8811366347f },
    { 228.9562987008f,  211.0374076468f,  129.6344826137f },
    { 228.0852240745f,  212.6072908913f,  130.3837953449f },
    { 227.2087706619f,  214.2302279147f,  131.1288703143f },
    { 226.3268429236f,  215.9067592863f,  131.8695114311f },
    { 225.4393424453f,  217.6374313703f,  132.6055312464f },
    { 224.5461678149f,  219.4227976166f,  133.3367511359f },
    { 223.6472144934f,  221.2634199158f,  134.0630014487f },
    { 222.7423746788f,  223.1598700210f,  134.7841216215f },
    { 221.8315371618f,  225.1127310359f,  135.4999602601f },
    { 220.9145871733f,  227.1225989702f,  136.2103751890f },
    { 219.9914062235f,  229.1900843641f,  136.9152334696f },
    { 219.0618719306f,  231.3158139833f,  137.6144113898f },
    { 218.1258578408f,  233.5004325871f,  138.3077944260f },
    { 217.1832332355f,  235.7446047714f,  138.9952771785f },
    { 216.2338629286f,  238.0490168915f,  139.6767632828f },
    { 215.2776070498f,  240.4143790673f,  140.3521652988f },
    { 214.3143208151f,  242.8414272759f,  141.0214045789f },
    { 213.3438542824f,  245.3309255372f,  141.6844111175f },
    { 212.3660520911f,  247.8836681991f,  142.3411233843f },
    { 211.3807531851f,  250.5004823278f,  142.9914881419f },
    { 210.3877905169f,  253.1822302132f,  143.6354602505f },
    { 209.3869907322f,  255.9298119978f,  144.2730024627f },
    { 210.0357090681f,  246.1231607505f,  145.8020282530f },
    { 210.6473712271f,  238.2424698467f,  147.1621858330f },
    { 211.2346909731f,  231.6093841066f,  148.4132534175f },
    { 211.8043672708f,  225.8665102466f,  149.5867067885f },
    { 212.3604302425f,  220.7988589452f,  150.7014171726f },
    { 212.9055223239f,  216.2654862638f,  151.7696855930f },
    { 213.4414846969f,  212.1682052656f,  152.8000133577f },
    { 213.9696598552f,  208.4354429706f,  153.7985349181f },
    { 214.4910618441f,  205.0131569120f,  154.7698256769f },
    { 215.0064785822f,  201.8593751709f,  155.7173883264f },
    { 215.5165366488f,  198.9407389398f,  156.6439612278f },
    { 216.0217440729f,  196.2302187264f,  157.5517223464f },
    { 216.5225196004f,  193.7055521285f,  158.4424288981f },
    { 217.0192133096f,  191.3481432713f,  159.3175158223f },
    { 217.5121215027f,  189.1422677324f,  160.1781669843f },
    { 218.0014976992f,  187.0744855418f,  161.0253677896f },
    { 218.4875609072f,  185.1331994989f,  161.8599448050f },
    { 218.9705019517f,  183.3083172310f,  162.6825960969f },
    { 219.4504883886f,  181.5909887622f,  163.4939148079f },
    { 219.9276683722f,  179.9734000009f,  164.2944077198f },
    { 220.4021737348f,  178.4486082826f,  165.0845100432f },
    { 220.8741224666f,  177.0104099844f,  165.8645973247f },
    { 221.3436207314f,  175.6532329090f,  166.6349951256f },
    { 221.8107645204f,  174.3720480198f,  167.3959869557f },
    { 222.2756410204f,  173.1622964520f,  168.1478208267f },
    { 222.7383297538f,  172.0198286995f,  168.8907147033f },
    { 223.1989035354f,  170.9408535949f,  169.6248610651f },
    { 223.6574292809f,  169.9218952281f,  170.3504307446f },
    { 224.1139686936f,  168.9597563501f,  171.0675761736f },
    { 224.5685788521f,  168.0514871132f,  171.7764341387f },
    { 225.0213127138f,  167.1943582288f,  172.4771281307f },
    { 225.4722195511f,  166.3858378071f,  173.1697703534f },
    { 225.9213453290f,  165.6235712805f,  173.8544634451f },
    { 226.3687330335f,  164.9053639258f,  174.5313019585f },
    { 226.8144229600f,  164.2291655859f,  175.2003736339f },
    { 227.2584529658f,  163.5930572636f,  175.8617604961f },
    { 227.7008586925f,  162.9952393128f,  176.5155398002f },
    { 228.1416737630f,  162.4340210030f,  177.1617848478f },
    { 228.5809299562f,  161.9078112649f,  177.8005656900f },
    { 229.0186573622f,  161.4151104574f,  178.4319497328f },
    { 229.4548845212f,  160.9545030223f,  179.0560022589f },
    { 229.8896385477f,  160.5246509103f,  179.6727868744f },
    { 230.3229452417f,  160.1242876817f,  180.2823658919f },
    { 230.7548291887f,  159.7522131979f,  180.8848006570f },
    { 231.1853138508f,  159.4072888325f,  181.4801518254f },
    { 231.6144216479f,  159.0884331399f,  182.0684795976f },
    { 232.0421740316f,  158.7946179284f,  182.6498439143f },
    { 232.4685915532f,  158.5248646917f,  183.2243046202f },
    { 232.8936939237f,  158.2782413585f,  183.7919215979f },
    { 233.3175000708f,  158.0538593260f,  184.3527548760f },
    { 233.7400281889f,  157.8508707458f,  184.9068647163f },
    { 234.1612957862f,  157.6684660365f,  185.4543116796f },
    { 234.5813197272f,  157.5058715985f,  185.9951566761f },
    { 235.0001162721f,  157.3623477121f,  186.5294610004f },
    { 235.4177011128f,  157.2371865985f,  187.0572863536f },
    { 235.8340894061f,  157.1297106294f,  187.5786948543f },
    { 236.2492958045f,  157.0392706704f,  188.0937490404f },
    { 236.6633344843f,  156.9652445454f,  188.6025118624f },
    { 237.0762191721f,  156.9070356106f,  189.1050466699f },
    { 237.4879631691f,  156.8640714293f,  189.6014171919f },
    { 236.1353021011f,  155.8875189216f,  190.1002974588f },
    { 234.7721828645f,  154.9146098961f,  190.6099278827f },
    { 233.3983890876f,  153.9457314261f,  191.1306112783f },
    { 232.0136969432f,  152.9812928620f,  191.6626588057f },
    { 230.6178747855f,  152.0217271000f,  192.2063900190f },
    { 229.2106827649f,  151.0674919223f,  192.7621328877f },
    { 227.7918724171f,  150.1190714126f,  193.3302237848f },
    { 226.3611862258f,  149.1769774493f,  193.9110074396f },
    { 224.9183571568f,  148.2417512813f,  194.5048368481f },
    { 223.4631081605f,  147.3139651894f,  195.1120731359f },
    { 221.9951516409f,  146.3942242379f,  195.7330853690f },
    { 220.5141888874f,  145.4831681188f,  196.3682503039f },
    { 219.0199094671f,  144.5814730942f,  197.0179520720f },
    { 217.5119905742f,  143.6898540392f,  197.6825817891f },
    { 215.9900963315f,  142.8090665897f,  198.3625370831f },
    { 214.4538770412f,  141.9399093989f,  199.0582215301f },
    { 212.9029683790f,  141.0832265063f,  199.7700439916f },
    { 211.3369905279f,  140.2399098219f,  200.4984178406f },
    { 209.7555472443f,  139.4109017300f,  201.2437600687f },
    { 208.1582248508f,  138.5971978153f,  202.0064902629f },
    { 206.5445911483f,  137.7998497148f,  202.7870294417f },
    { 204.9141942402f,  137.0199680984f,  203.5857987385f },
    { 203.2665612577f,  136.2587257807f,  204.4032179240f },
    { 201.6011969788f,  135.5173609686f,  205.2397037544f },
    { 199.9175823276f,  134.7971806453f,  206.0956681371f },
    { 198.2151727415f,  134.0995640955f,  206.9715161041f },
    { 196.4933963935f,  133.4259665753f,  207.8676435844f },
    { 194.7516522508f,  132.7779231294f,  208.7844349694f },
    { 192.9893079535f,  132.1570525629f,  209.7222604668f },
    { 191.2056974907f,  131.5650615717f,  210.6814732395f },
    { 189.4001186513f,  131.0037490409f,  211.6624063313f },
    { 187.5718302212f,  130.4750105221f,  212.6653693839f },
    { 185.7200488963f,  129.9808429025f,  213.6906451523f },
    { 183.8439458745f,  129.5233492860f,  214.7384858342f },
    { 181.9426430853f,  129.1047441091f,  215.8091092303f },
    { 180.0152090094f,  128.7273585252f,  216.9026947630f },
    { 178.0606540318f,  128.3936460969f,  218.0193793833f },
    { 176.0779252629f,  128.1061888516f,  219.1592534074f },
    { 174.0659007533f,  127.8677037673f,  220.3223563288f },
    { 172.0233830101f,  127.6810497764f,  221.5086726611f },
    { 169.9490917128f,  127.5492353965f,  222.7181278750f },
    { 167.8416555008f,  127.4754271278f,  223.9505844994f },
    { 165.6996026879f,  127.4629587883f,  225.2058384627f },
    { 163.5213507235f,  127.5153420024f,  226.4836157587f },
    { 161.3051941910f,  127.6362781110f,  227.7835695224f },
    { 159.0492910863f,  127.8296718321f,  229.1052776032f },
    { 156.7516470647f,  128.0996470832f,  230.4482407242f },
    { 154.4100972782f,  128.4505654677f,  231.8118813074f },
    { 152.0222853375f,  128.8870480533f,  233.1955430385f },
    { 149.5856388204f,  129.4140012141f,  234.5984912284f },
    { 147.0973406110f,  130.0366474968f,  236.0199140072f },
    { 144.5542951688f,  130.7605627122f,  237.4589243580f },
    { 141.9530885858f,  131.5917207510f,  238.9145629561f },
    { 139.2899409783f,  132.5365480260f,  240.3858017276f },
    { 136.5606493350f,  133.6019899541f,  241.8715479699f },
    { 133.7605183788f,  134.7955925862f,  243.3706487807f },
    { 130.8842762203f,  136.1256034220f,  244.8818954089f },
    { 127.9259705111f,  137.6010967197f,  246.4040269536f },
    { 124.8788392902f,  139.2321303835f,  247.9357325609f },
    { 121.7351485641f,  141.0299440119f,  249.4756508541f },
    { 123.7812614136f,  136.7099767887f,  252.5616033043f },
    { 125.7739812461f,  132.9369733387f,  255.7011156920f },
    { 127.7172227836f,  129.6847070983f,  258.8811312664f },
    { 129.6144429694f,  126.9278404812f,  262.0870252337f },
    { 131.4687124297f,  124.6413298559f,  265.3030452343f },
    { 133.2827732359f,  122.8000271273f,  268.5128319066f },
    { 135.0590860400f,  121.3784609575f,  271.6999818143f },
    { 136.7998688752f,  120.3507761475f,  274.8486083036f },
    { 138.5071293522f,  119.6908040576f,  277.9438558249f },
    { 140.1826915730f,  119.3722322775f,  280.9723298645f },
    { 141.8282187824f,  119.3688395518f,  283.9224163352f },
    { 143.4452325525f,  119.6547628738f,  286.7844784939f },
    { 145.0351291277f,  120.2047675000f,  289.5509333887f },
    { 146.5991934249f,  120.9944966049f,  292.2162212003f },
    { 148.1386110886f,  122.0006842973f,  294.7766883220f },
    { 149.6544789196f,  123.2013226785f,  297.2304083657f },
    { 151.1478139374f,  124.5757797079f,  299.5769650470f },
    { 152.6195612895f,  126.1048693834f,  301.8172181381f },
    { 154.0706011805f,  127.7708789879f,  303.9530694881f },
    { 155.5017549665f,  129.5575600078f,  305.9872414953f },
    { 156.9137905330f,  131.4500900524f,  307.9230760553f },
    { 158.3074270583f,  133.4350129909f,  309.7643583256f },
    { 159.6833392441f,  135.5001638847f,  311.5151667887f },
    { 161.0421610858f,  137.6345843663f,  313.1797490753f },
    { 162.3844892410f,  139.8284330835f,  314.7624216999f },
    { 163.7108860485f,  142.0728948257f,  316.2674911346f },
    { 165.0218822399f,  144.3600910345f,  317.6991933441f },
    { 166.3179793824f,  146.6829936231f,  319.0616488885f },
    { 167.5996520828f,  149.0353433873f,  320.3588308751f },
    { 168.8673499834f,  151.4115737891f,  321.5945433057f },
    { 170.1214995702f,  153.8067405058f,  322.7724076865f },
    { 171.3625058167f,  156.2164568551f,  323.8958560825f },
    { 172.5907536808f,  158.6368350036f,  324.9681291082f },
    { 173.8066094693f,  161.0644327301f,  325.9922776156f },
    { 175.0104220858f,  163.4962054280f,  326.9711670838f },
    { 176.2025241728f,  165.9294629802f,  327.9074839175f },
    { 177.3832331591f,  168.3618311197f,  328.8037430319f },
    { 178.5528522218f,  170.7912168825f,  329.6622962426f },
    { 179.7116711712f,  173.2157777729f,  330.4853410917f },
    { 180.8599672669f,  175.6338942748f,  331.2749298345f },
    { 181.9980059698f,  178.0441453704f,  332.0329783811f },
    { 183.1260416377f,  180.4452867511f,  332.7612750462f },
    { 184.2443181688f,  182.8362314308f,  333.4614890036f },
    { 185.3530695978f,  185.2160325028f,  334.1351783766f },
    { 186.4525206489f,  187.5838678024f,  334.7837979206f },
    { 187.5428872497f,  189.9390262634f,  335.4087062765f },
    { 188.6243770089f,  192.2808957803f,  336.0111727830f },
    { 189.6971896613f,  194.6089524057f,  336.5923838539f },
    { 190.7615174820f,  196.9227507333f,  337.1534489258f },
    { 191.8175456738f,  199.2219153320f,  337.6954059949f },
    { 192.8654527282f,  201.5061331145f,  338.2192267587f },
    { 193.9054107635f,  203.7751465327f,  338.7258213846f },
    { 194.9375858412f,  206.0287475091f,  339.2160429258f },
    { 195.9621382620f,  208.2667720209f,  339.6906914094f },
    { 196.9792228441f,  210.4890952644f,  340.1505176141f },
    { 197.9889891835f,  212.6956273346f,  340.5962265641f },
    { 198.9915818997f,  214.8863093636f,  341.0284807558f },
    { 199.9871408654f,  217.0611100676f,  341.4479031388f },
    { 200.9758014240f,  219.2200226564f,  341.8550798697f },
    { 201.9576945931f,  221.3630620677f,  342.2505628557f },
    { 201.4250501944f,  222.1411286735f,  342.6395216693f },
    { 200.8900531140f,  222.9337688615f,  343.0304428426f },
    { 200.3526679668f,  223.7412025272f,  343.4233718716f },
    { 199.8128583248f,  224.5636536183f,  343.8183575236f },
    { 199.2705866692f,  225.4013502272f,  344.2154520795f },
    { 198.7258143379f,  226.2545246840f,  344.6147115975f },
    { 198.1785014703f,  227.1234136510f,  345.0161961989f },
    { 197.6286069482f,  228.0082582171f,  345.4199703815f },
    { 197.0760883319f,  228.9093039915f,  345.8261033604f },
    { 196.5209017921f,  229.8268011981f,  346.2346694412f },
    { 195.9630020371f,  230.7610047687f,  346.6457484292f },
    { 195.4023422336f,  231.7121744338f,  347.0594260781f },
    { 194.8388739222f,  232.6805748132f,  347.4757945837f },
    { 194.2725469252f,  233.6664755022f,  347.8949531280f },
    { 193.7033092482f,  234.6701511554f,  348.3170084794f },
    { 193.1311069719f,  235.6918815652f,  348.7420756572f },
    { 192.5558841361f,  236.7319517359f,  349.1702786685f },
    { 191.9775826118f,  237.7906519498f,  349.6017513259f },
    { 191.3961419633f,  238.8682778267f,  350.0366381602f },
    { 190.8114992961f,  239.9651303730f,  350.4750954376f },
    { 190.2235890909f,  241.0815160199f,  350.9172922998f },
    { 189.6323430207f,  242.2177466485f,  351.3634120428f },
    { 189.0376897491f,  243.3741396001f,  351.8136535568f },
    { 188.4395547079f,  244.5510176687f,  352.2682329517f },
    { 187.8378598491f,  245.7487090733f,  352.7273853973f },
    { 187.2325233703f,  246.9675474085f,  353.1913672147f },
    { 186.6234594068f,  248.2078715685f,  353.6604582597f },
    { 186.0105776868f,  249.4700256430f,  354.1349646502f },
    { 185.3937831432f,  250.7543587817f,  354.6152218975f },
    { 184.7729754745f,  252.0612250244f,  355.1015985183f },
    { 184.1480486458f,  253.3909830938f,  355.5945002161f },
    { 183.5188903197f,  254.7439961504f,  356.0943747460f },
    { 182.8853812025f,  256.1206315088f,  356.6017176014f },
    { 182.2473942905f,  257.5212603166f,  357.1170786946f },
    { 181.6047939946f,  258.9462572030f,  357.6410702510f },
    { 180.9574351178f,  260.3959999072f,  358.1743761904f },
    { 180.3051616515f,  261.8708689063f,  358.7177633472f },
    { 179.6478053503f,  263.3712470758f,  359.2720949843f },
    { 178.9851840276f,  264.8975194349f,  359.8383471885f }
};

// cGamutReachTable removed as it duplicates gamutCuspTableReach

__CONSTANT__ float gamutTopGamma[360] = 
{
    0.887390136718750f,
    0.886383056640625f,
    0.885406494140625f,
    0.884460449218750f,
    0.883544921875000f,
    0.882653808593750f,
    0.881805419921875f,
    0.880987548828125f,
    0.880206298828125f,
    0.879467773437500f,
    0.878765869140625f,
    0.878106689453125f,
    0.877490234375000f,
    0.876916503906250f,
    0.876379394531250f,
    0.875891113281250f,
    0.875445556640625f,
    0.875042724609375f,
    0.874676513671875f,
    0.874359130859375f,
    0.874072265625000f,
    0.873822021484375f,
    0.873626708984375f,
    0.873455810546875f,
    0.873291015625000f,
    0.873181152343750f,
    0.873120117187500f,
    0.873114013671875f,
    0.874237060546875f,
    0.876873779296875f,
    0.879266357421875f,
    0.881597900390625f,
    0.883874511718750f,
    0.885949707031250f,
    0.888000488281250f,
    0.889996337890625f,
    0.891845703125000f,
    0.893688964843750f,
    0.895458984375000f,
    0.897149658203125f,
    0.898834228515625f,
    0.900427246093750f,
    0.901989746093750f,
    0.903540039062500f,
    0.905004882812500f,
    0.906469726562500f,
    0.907885742187500f,
    0.909271240234375f,
    0.910662841796875f,
    0.911975097656250f,
    0.913293457031250f,
    0.914587402343750f,
    0.915850830078125f,
    0.917120361328125f,
    0.918334960937500f,
    0.919555664062500f,
    0.920770263671875f,
    0.921942138671875f,
    0.923126220703125f,
    0.924285888671875f,
    0.925433349609375f,
    0.926593017578125f,
    0.927716064453125f,
    0.928839111328125f,
    0.929980468750000f,
    0.931079101562500f,
    0.932183837890625f,
    0.933312988281250f,
    0.934399414062500f,
    0.935498046875000f,
    0.936608886718750f,
    0.937701416015625f,
    0.938793945312500f,
    0.939898681640625f,
    0.941021728515625f,
    0.942108154296875f,
    0.943212890625000f,
    0.944329833984375f,
    0.945465087890625f,
    0.946594238281250f,
    0.947717285156250f,
    0.948858642578125f,
    0.950006103515625f,
    0.951171875000000f,
    0.952355957031250f,
    0.953546142578125f,
    0.954754638671875f,
    0.955975341796875f,
    0.957214355468750f,
    0.958471679687500f,
    0.959747314453125f,
    0.961047363281250f,
    0.962377929687500f,
    0.963739013671875f,
    0.955554199218750f,
    0.939605712890625f,
    0.923492431640625f,
    0.907135009765625f,
    0.890386962890625f,
    0.873168945312500f,
    0.855303955078125f,
    0.836645507812500f,
    0.825952148437500f,
    0.829992675781250f,
    0.833801269531250f,
    0.837384033203125f,
    0.840771484375000f,
    0.843981933593750f,
    0.847021484375000f,
    0.849914550781250f,
    0.852661132812500f,
    0.855285644531250f,
    0.857788085937500f,
    0.860180664062500f,
    0.862469482421875f,
    0.864660644531250f,
    0.866760253906250f,
    0.868774414062500f,
    0.870715332031250f,
    0.872576904296875f,
    0.874365234375000f,
    0.876092529296875f,
    0.877752685546875f,
    0.879357910156250f,
    0.880902099609375f,
    0.882391357421875f,
    0.883831787109375f,
    0.885217285156250f,
    0.886560058593750f,
    0.887860107421875f,
    0.889111328125000f,
    0.890319824218750f,
    0.891491699218750f,
    0.892626953125000f,
    0.893713378906250f,
    0.894769287109375f,
    0.895788574218750f,
    0.896771240234375f,
    0.897717285156250f,
    0.898626708984375f,
    0.902020263671875f,
    0.905261230468750f,
    0.908306884765625f,
    0.911175537109375f,
    0.913867187500000f,
    0.916406250000000f,
    0.918804931640625f,
    0.921063232421875f,
    0.923193359375000f,
    0.925213623046875f,
    0.927130126953125f,
    0.928936767578125f,
    0.930657958984375f,
    0.932287597656250f,
    0.933831787109375f,
    0.935296630859375f,
    0.936694335937500f,
    0.938018798828125f,
    0.939276123046875f,
    0.940466308593750f,
    0.941601562500000f,
    0.942675781250000f,
    0.943688964843750f,
    0.944653320312500f,
    0.945568847656250f,
    0.946429443359375f,
    0.947241210937500f,
    0.948004150390625f,
    0.948718261718750f,
    0.949389648437500f,
    0.950018310546875f,
    0.950592041015625f,
    0.951123046875000f,
    0.951611328125000f,
    0.952050781250000f,
    0.952447509765625f,
    0.952801513671875f,
    0.953112792968750f,
    0.953375244140625f,
    0.953594970703125f,
    0.953759765625000f,
    0.953875732421875f,
    0.953936767578125f,
    0.953955078125000f,
    0.953912353515625f,
    0.953820800781250f,
    0.953662109375000f,
    0.953442382812500f,
    0.953161621093750f,
    0.952813720703125f,
    0.952386474609375f,
    0.951885986328125f,
    0.951306152343750f,
    0.950634765625000f,
    0.949877929687500f,
    0.966937255859375f,
    0.968695068359375f,
    0.969641113281250f,
    0.970446777343750f,
    0.971166992187500f,
    0.971807861328125f,
    0.972363281250000f,
    0.972851562500000f,
    0.973284912109375f,
    0.973675537109375f,
    0.974023437500000f,
    0.974340820312500f,
    0.974621582031250f,
    0.974865722656250f,
    0.975091552734375f,
    0.975286865234375f,
    0.975463867187500f,
    0.975616455078125f,
    0.975756835937500f,
    0.975872802734375f,
    0.975976562500000f,
    0.976068115234375f,
    0.976147460937500f,
    0.976214599609375f,
    0.976269531250000f,
    0.976318359375000f,
    0.976354980468750f,
    0.976385498046875f,
    0.976403808593750f,
    0.976409912109375f,
    0.976409912109375f,
    0.976403808593750f,
    0.976391601562500f,
    0.976373291015625f,
    0.976348876953125f,
    0.976312255859375f,
    0.976269531250000f,
    0.976220703125000f,
    0.976171875000000f,
    0.976110839843750f,
    0.976049804687500f,
    0.975976562500000f,
    0.975897216796875f,
    0.975811767578125f,
    0.975720214843750f,
    0.975628662109375f,
    0.975524902343750f,
    0.975408935546875f,
    0.975286865234375f,
    0.975164794921875f,
    0.975036621093750f,
    0.974896240234375f,
    0.974743652343750f,
    0.974584960937500f,
    0.974420166015625f,
    0.974243164062500f,
    0.974060058593750f,
    0.973864746093750f,
    0.973657226562500f,
    0.973425292968750f,
    0.973187255859375f,
    0.972937011718750f,
    0.972668457031250f,
    0.972503662109375f,
    0.972515869140625f,
    0.972546386718750f,
    0.972546386718750f,
    0.972583007812500f,
    0.972576904296875f,
    0.972619628906250f,
    0.972601318359375f,
    0.972656250000000f,
    0.972631835937500f,
    0.972668457031250f,
    0.972656250000000f,
    0.972686767578125f,
    0.972680664062500f,
    0.972705078125000f,
    0.972698974609375f,
    0.972717285156250f,
    0.972723388671875f,
    0.972735595703125f,
    0.972735595703125f,
    0.972747802734375f,
    0.972753906250000f,
    0.972760009765625f,
    0.972766113281250f,
    0.972772216796875f,
    0.972772216796875f,
    0.972784423828125f,
    0.972778320312500f,
    0.972796630859375f,
    0.972784423828125f,
    0.972808837890625f,
    0.972790527343750f,
    0.972814941406250f,
    0.972790527343750f,
    0.972802734375000f,
    0.972796630859375f,
    0.972796630859375f,
    0.972808837890625f,
    0.972790527343750f,
    0.972802734375000f,
    0.972790527343750f,
    0.972784423828125f,
    0.972796630859375f,
    0.972778320312500f,
    0.972766113281250f,
    0.972778320312500f,
    0.972766113281250f,
    0.972747802734375f,
    0.972741699218750f,
    0.972747802734375f,
    0.972723388671875f,
    0.972705078125000f,
    0.972692871093750f,
    0.972680664062500f,
    0.972668457031250f,
    0.972656250000000f,
    0.972637939453125f,
    0.972613525390625f,
    0.972589111328125f,
    0.972564697265625f,
    0.972540283203125f,
    0.972509765625000f,
    0.972473144531250f,
    0.972430419921875f,
    0.972387695312500f,
    0.972351074218750f,
    0.972314453125000f,
    0.972253417968750f,
    0.972198486328125f,
    0.972137451171875f,
    0.972070312500000f,
    0.967578125000000f,
    0.956915283203125f,
    0.946356201171875f,
    0.935888671875000f,
    0.925494384765625f,
    0.917663574218750f,
    0.916424560546875f,
    0.915197753906250f,
    0.913970947265625f,
    0.912744140625000f,
    0.911529541015625f,
    0.910314941406250f,
    0.909106445312500f,
    0.907897949218750f,
    0.906695556640625f,
    0.905493164062500f,
    0.904302978515625f,
    0.903112792968750f,
    0.901922607421875f,
    0.900744628906250f,
    0.899572753906250f,
    0.898406982421875f,
    0.897247314453125f,
    0.896093750000000f,
    0.894958496093750f,
    0.893829345703125f,
    0.892712402343750f,
    0.891613769531250f,
    0.890527343750000f,
    0.889459228515625f,
    0.888415527343750f
};

#include "hellwig_lib_v055.h"

__DEVICE__ float3 transform(int p_Width, int p_Height, int p_X, int p_Y, float p_R, float p_G, float p_B)
{
    float3 in = make_float3(p_R, p_G, p_B);
    float3 out = in;

    float3 XYZ;

    if (!invert)
    {
        XYZ = vector_dot(AP0_ACES_to_XYZ_matrix, in);
        if (ap1Clip)
        {
            float3 AP1 = vector_dot(XYZ_to_AP1_ACES_matrix, XYZ);
            AP1.x = _fmaxf(AP1.x, 0.0f);
            AP1.y = _fmaxf(AP1.y, 0.0f);
            AP1.z = _fmaxf(AP1.z, 0.0f);
            XYZ = vector_dot(AP1_ACES_to_XYZ_matrix, AP1);
        }
    }
    else
    {
        in.x = ST2084_to_linear(in.x) / referenceLuminance;
        in.y = ST2084_to_linear(in.y) / referenceLuminance;
        in.z = ST2084_to_linear(in.z) / referenceLuminance;
        XYZ = vector_dot(RGB_to_XYZ_output, in);
    }
    XYZ *= referenceLuminance;
    float3 JMh;
    if (!invert)
    {
        JMh = XYZ_to_Hellwig2022_JMh(XYZ, inWhite);
        if (toneCurve)
        {
            JMh = forwardTonescale(JMh, compressChroma);
        }
        if (gamutCompress)
        {
            JMh = compressGamut(JMh, 0);
        }
    }
    else
    {
        JMh = XYZ_to_Hellwig2022_JMh(XYZ, d65White);
        if (gamutCompress)
        {
            JMh = compressGamut(JMh, 1);
        }
        if (toneCurve)
        {
            JMh = inverseTonescale(JMh, compressChroma);
        }
    }
    if (JMhOut)
    {
        out.x = JMh.x / referenceLuminance;
        out.y = JMh.y / referenceLuminance;
        out.z = JMh.z / 360.0f;
    }
    else
    {
        if (!invert)
        {
            if (!d60Sim)
            {
                XYZ = Hellwig2022_JMh_to_XYZ(JMh , d65White) / referenceLuminance;
            }
            else
            {
                XYZ = Hellwig2022_JMh_to_XYZ(JMh , inWhite) / referenceLuminance;
                float3 creativeWhiteXYZ = vector_dot(RGB_to_XYZ_P3D60, make_float3(1.0f, 1.0f, 1.0f));
                float3 creativeWhiteRGB = vector_dot(XYZ_to_RGB_limit, creativeWhiteXYZ);
                XYZ *= 1.0f / max(creativeWhiteRGB.x, max(creativeWhiteRGB.y, creativeWhiteRGB.z));
            }
            out = vector_dot(XYZ_to_RGB_limit, XYZ);
    
            // Soft clamp by compressing negative display linear values
            if (softClip)
            {
                float3 compr = make_float3(clamp_thr, clamp_dist, 1.2f);
                out = compress_aces(out, compr, compr, compr, 0);
            }

            // hard clip 0-peak
            if (hardClip)
            {
                out = clamp3(referenceLuminance * out, 0.0f, daniele_n);
            }
            else
            {
                out *= referenceLuminance;
            }
        
            if (asPQ)
            {
                out = vector_dot(P3D65_to_BT2020, out);
                out.x = linear_to_ST2084(out.x);
                out.y = linear_to_ST2084(out.y);
                out.z = linear_to_ST2084(out.z);
            }
            else
            {
                out = float3spow(out / referenceLuminance, 1.0f / 2.4f);
            }
        }
        else
        {
            XYZ = Hellwig2022_JMh_to_XYZ(JMh , inWhite) / referenceLuminance;
            out = vector_dot(XYZ_to_AP0_ACES_matrix, XYZ);
        }
    }

    return out;
}