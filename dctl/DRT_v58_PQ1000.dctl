DEFINE_UI_PARAMS(toneCurve, Tone Curve, DCTLUI_CHECK_BOX, 1)
DEFINE_UI_PARAMS(compressChroma, Compress Chroma, DCTLUI_CHECK_BOX, 1)
DEFINE_UI_PARAMS(gamutCompress, Gamut Compress, DCTLUI_CHECK_BOX, 1)
DEFINE_UI_PARAMS(d60Sim, D60 Sim, DCTLUI_CHECK_BOX, 0)
DEFINE_UI_PARAMS(asPQ, Encode as BT.2100 PQ, DCTLUI_CHECK_BOX, 1)
DEFINE_UI_PARAMS(ap1Clip, AP1 Clamp, DCTLUI_CHECK_BOX, 1)
DEFINE_UI_PARAMS(softClip, Soft Clip, DCTLUI_CHECK_BOX, 0)
DEFINE_UI_PARAMS(hardClip, Clamp, DCTLUI_CHECK_BOX, 1)
DEFINE_UI_PARAMS(invert, Invert, DCTLUI_CHECK_BOX, 0)
DEFINE_UI_PARAMS(JMhOut, Diagnostic JMh Output, DCTLUI_CHECK_BOX, 0)


typedef struct
{
    float3 x;
    float3 y;
    float3 z;
} float3x3;

// Constant values generated in Python
// https://github.com/nick-shaw/aces-ot-vwg-experiments/blob/master/python/v57_init_plot.py

__CONSTANT__ float3x3 XYZ_to_RGB_limit =
{
// XYZ to P3-D65 matrix
    { 2.4934969119f, -0.9313836179f, -0.4027107845f },
    {-0.8294889696f,  1.7626640603f,  0.0236246858f },
    { 0.0358458302f, -0.0761723893f,  0.9568845240f }
};

__CONSTANT__ float3x3 RGB_to_XYZ_output =
{
// Rec.2020 to XYZ matrix
    { 0.6369580483f,  0.1446169036f,  0.1688809752f },
    { 0.2627002120f,  0.6779980715f,  0.0593017165f },
    { 0.0000000000f,  0.0280726930f,  1.0609850577f }
};

__CONSTANT__ float3x3 RGB_to_XYZ_P3D60 =
{
    { 0.5049495342f,  0.2646814889f,  0.1830150515f },
    { 0.2376233102f,  0.6891706692f,  0.0732060206f },
    {-0.0000000000f,  0.0449459132f,  0.9638792711f }
};

__CONSTANT__ float3x3 P3D65_to_BT2020 =
{
    { 0.7538330344f,  0.1985973691f,  0.0475695966f },
    { 0.0457438490f,  0.9417772198f,  0.0124789312f },
    {-0.0012103404f,  0.0176017173f,  0.9836086231f }
};

__CONSTANT__ float limitJmax = 283.249899f;
__CONSTANT__ float midJ = 40.8168834391f; // ~15 nits in Hellwig J
__CONSTANT__ float focusDist = 3.7125f;

__CONSTANT__ float daniele_n = 1000.0f; // peak white
__CONSTANT__ float daniele_m_2 = 10.1729113787f;
__CONSTANT__ float daniele_s_2 = 5.8959268851f;
__CONSTANT__ float daniele_u_2 = 0.9869191713f;

// Chroma compression scaling for HDR/SDR appearance match
__CONSTANT__ float sat = 0.403f;
__CONSTANT__ float sat_thr = 0.0005f;
__CONSTANT__ float compr = 10.32f;

__CONSTANT__ float3 gamutCuspTable[360] = 
{
    { 163.9628719030f,  205.0692976684f,  0.6897637722f },
    { 163.1386701083f,  205.8388195962f,  1.5805236740f },
    { 162.3063864604f,  206.6389049391f,  2.5075674356f },
    { 161.4655882392f,  207.4715487465f,  3.4752695483f },
    { 160.6157765267f,  208.3391585860f,  4.4889055645f },
    { 159.7563679986f,  209.2447043371f,  5.5549203793f },
    { 158.8866694019f,  210.1919398090f,  6.6813061892f },
    { 158.0058407468f,  211.1857398816f,  7.8781498062f },
    { 157.1128404125f,  212.2326305016f,  9.1584513969f },
    { 156.2063399331f,  213.3416552991f,  10.5393980380f },
    { 155.2845850908f,  214.5258626255f,  12.0444418655f },
    { 154.3451552084f,  215.8050166124f,  13.7069012916f },
    { 153.3845117252f,  217.2109447521f,  15.5767078943f },
    { 152.3970560837f,  218.7992777606f,  17.7344576139f },
    { 151.3728351567f,  220.6795579709f,  20.3255208421f },
    { 150.2903691378f,  223.1146361754f,  23.6661485261f },
    { 149.0790224515f,  227.0772080771f,  28.7959761284f },
    { 151.9100254016f,  218.0355012686f,  30.3898476637f },
    { 154.6557031837f,  209.8189548246f,  32.0174460620f },
    { 157.3241866351f,  202.3356878068f,  33.6765303273f },
    { 159.9222873237f,  195.5097307085f,  35.3648585584f },
    { 162.4557886255f,  189.2774405805f,  37.0800827088f },
    { 164.9296579952f,  183.5848560295f,  38.8196924074f },
    { 167.3482052307f,  178.3857100233f,  40.5809887320f },
    { 169.7152027475f,  173.6399132788f,  42.3610778426f },
    { 172.0339785282f,  169.3123811161f,  44.1568787853f },
    { 174.3074890253f,  165.3721156699f,  45.9651419635f },
    { 176.5383771018f,  161.7914812013f,  47.7824758603f },
    { 178.7290186308f,  158.5456277102f,  49.6053801085f },
    { 180.8815603777f,  155.6120300428f,  51.4302832312f },
    { 182.9979510972f,  152.9701180393f,  53.2535834647f },
    { 185.0799672892f,  150.6009791779f,  55.0716911241f },
    { 187.1292347049f,  148.4871193956f,  56.8810710171f },
    { 189.1472464400f,  146.6122708434f,  58.6782835030f },
    { 191.1353782620f,  144.9612375977f,  60.4600229211f },
    { 193.0949016777f,  143.5197720584f,  62.2231522938f },
    { 195.0269951410f,  142.2744760767f,  63.9647334296f },
    { 196.9327537185f,  141.2127218885f,  65.6820517946f },
    { 198.8131974685f,  140.3225887701f,  67.3726357808f },
    { 200.6692787395f,  139.5928120235f,  69.0342702467f },
    { 202.5018885568f,  139.0127414876f,  70.6650044408f },
    { 204.3118622340f,  138.5723072753f,  72.2631546140f },
    { 206.0999843242f,  138.2619908695f,  73.8273017880f },
    { 207.8669930040f,  138.0728000893f,  75.3562852630f },
    { 209.6135839701f,  137.9962467604f,  76.8491925190f },
    { 211.3404139129f,  138.0243261998f,  78.3053461978f },
    { 213.0481036243f,  138.1494978553f,  79.7242888476f },
    { 214.7372407856f,  138.3646666343f,  81.1057660831f },
    { 216.4083824755f,  138.6631646067f,  82.4497087560f },
    { 218.0620574330f,  139.0387328933f,  83.7562146665f },
    { 219.6987681042f,  139.4855036402f,  85.0255302688f },
    { 221.3189924973f,  139.9979820507f,  86.2580327447f },
    { 222.9231858695f,  140.5710284930f,  87.4542127429f },
    { 224.5117822619f,  141.1998407361f,  88.6146580112f },
    { 226.0851959021f,  141.8799363809f,  89.7400380801f },
    { 227.6438224853f,  142.6071355658f,  90.8310901030f },
    { 229.1880403492f,  143.3775440247f,  91.8886059094f },
    { 230.7182115525f,  144.1875365708f,  92.9134202856f },
    { 232.2346828663f,  145.0337410740f,  93.9064004692f },
    { 233.7377866875f,  145.9130229868f,  94.8684368175f },
    { 235.2278418819f,  146.8224704658f,  95.8004345931f },
    { 236.7051545631f,  147.7593801218f,  96.7033067968f },
    { 238.1700188131f,  148.7212434250f,  97.5779679723f },
    { 239.6227173511f,  149.7057337767f,  98.4253289010f },
    { 241.0635221531f,  150.7106942562f,  99.2462921058f },
    { 242.4926950288f,  151.7341260379f,  100.0417480834f },
    { 243.9104881576f,  152.7741774720f,  100.8125721880f },
    { 245.3171445890f,  153.8291338143f,  101.5596220920f },
    { 246.7128987082f,  154.8974075862f,  102.2837357569f },
    { 248.0979766721f,  155.9775295435f,  102.9857298484f },
    { 249.4725968165f,  157.0681402305f,  103.6663985404f },
    { 250.8369700367f,  158.1679820916f,  104.3265126534f },
    { 252.1913001456f,  159.2758921155f,  104.9668190803f },
    { 253.5357842077f,  160.3907949821f,  105.5880404580f },
    { 254.8706128545f,  161.5116966859f,  106.1908750465f },
    { 256.1959705792f,  162.6376786070f,  106.7759967818f },
    { 257.5120360158f,  163.7678920037f,  107.3440554747f },
    { 256.9262401566f,  163.8804407243f,  107.9034560184f },
    { 256.3384417108f,  164.0101965447f,  108.4653364318f },
    { 255.7486215042f,  164.1574230306f,  109.0296053837f },
    { 255.1567600504f,  164.3223838588f,  109.5961689605f },
    { 254.5628375444f,  164.5053427111f,  110.1649307385f },
    { 253.9668338548f,  164.7065631711f,  110.7357918629f },
    { 253.3687285159f,  164.9263086235f,  111.3086511338f },
    { 252.7685007206f,  165.1648421562f,  111.8834050975f },
    { 252.1661293114f,  165.4224264666f,  112.4599481453f },
    { 251.5615927729f,  165.6993237712f,  113.0381726176f },
    { 250.9548692225f,  165.9957957201f,  113.6179689140f },
    { 250.3459364021f,  166.3121033163f,  114.1992256094f },
    { 249.7347716685f,  166.6485068409f,  114.7818295752f },
    { 249.1213519844f,  167.0052657833f,  115.3656661053f },
    { 248.5056539081f,  167.3826387784f,  115.9506190476f },
    { 247.8876535840f,  167.7808835507f,  116.5365709394f },
    { 247.2673267320f,  168.2002568652f,  117.1234031465f },
    { 246.6446486367f,  168.6410144861f,  117.7109960073f },
    { 246.0195941367f,  169.1034111439f,  118.2992289782f },
    { 245.3921376126f,  169.5877005108f,  118.8879807835f },
    { 244.7622529758f,  170.0941351845f,  119.4771295670f },
    { 244.1299136558f,  170.6229666826f,  120.0665530448f },
    { 243.4950925880f,  171.1744454448f,  120.6561286611f },
    { 242.8577622005f,  171.7488208467f,  121.2457337434f },
    { 242.2178944005f,  172.3463412228f,  121.8352456590f },
    { 241.5754605607f,  172.9672539006f,  122.4245419710f },
    { 240.9304315044f,  173.6118052451f,  123.0135005944f },
    { 240.2827774910f,  174.2802407149f,  123.6019999505f },
    { 239.6324682004f,  174.9728049289f,  124.1899191200f },
    { 238.9794727168f,  175.6897417453f,  124.7771379945f },
    { 238.3237595125f,  176.4312943516f,  125.3635374251f },
    { 237.6652964304f,  177.1977053670f,  125.9489993683f },
    { 237.0040506664f,  177.9892169559f,  126.5334070287f },
    { 236.3399887508f,  178.8060709551f,  127.1166449980f },
    { 235.6730765292f,  179.6485090115f,  127.6985993895f },
    { 235.0032791428f,  180.5167727331f,  128.2791579687f },
    { 234.3305610076f,  181.4111038523f,  128.8582102788f },
    { 233.6548857934f,  182.3317444012f,  129.4356477612f },
    { 232.9762164009f,  183.2789369002f,  130.0113638704f },
    { 232.2945149394f,  184.2529245584f,  130.5852541834f },
    { 231.6097427024f,  185.2539514870f,  131.1572165032f },
    { 230.9218601431f,  186.2822629250f,  131.7271509565f },
    { 230.2308268481f,  187.3381054784f,  132.2949600844f },
    { 229.5366015108f,  188.4217273710f,  132.8605489273f },
    { 228.8391419032f,  189.5333787085f,  133.4238251036f },
    { 228.1384048472f,  190.6733117561f,  133.9846988810f },
    { 227.4343461838f,  191.8417812276f,  134.5430832416f },
    { 226.7269207420f,  193.0390445884f,  135.0988939409f },
    { 226.0160823054f,  194.2653623717f,  135.6520495591f },
    { 225.3017835786f,  195.5209985072f,  136.2024715470f },
    { 224.5839761507f,  196.8062206638f,  136.7500842641f },
    { 223.8626104589f,  198.1213006055f,  137.2948150121f },
    { 223.1376357489f,  199.4665145611f,  137.8365940599f },
    { 222.4090000349f,  200.8421436078f,  138.3753546643f },
    { 221.6766500568f,  202.2484740697f,  138.9110330838f },
    { 220.9405312363f,  203.6857979300f,  139.4435685866f },
    { 220.2005876306f,  205.1544132587f,  139.9729034533f },
    { 219.4567618838f,  206.6546246563f,  140.4989829738f },
    { 218.7089951768f,  208.1867437121f,  141.0217554394f },
    { 217.9572271740f,  209.7510894806f,  141.5411721296f },
    { 218.5974699952f,  202.5636762556f,  142.6758180264f },
    { 219.2209800960f,  196.2299590424f,  143.7555197450f },
    { 219.8313299177f,  190.5535299623f,  144.7947937743f },
    { 220.4309123998f,  185.4030252093f,  145.8033300347f },
    { 221.0214215975f,  180.6856191219f,  146.7879509697f },
    { 221.6041081418f,  176.3329357684f,  147.7536547971f },
    { 222.1799262237f,  172.2929426787f,  148.7042165965f },
    { 222.7496234928f,  168.5249926019f,  149.6425563135f },
    { 223.3137987833f,  164.9966394753f,  150.5709752202f },
    { 223.8729406829f,  161.6815108230f,  151.4913139700f },
    { 224.4274541690f,  158.5578382169f,  152.4050617761f },
    { 224.9776795269f,  155.6074134192f,  153.3134339614f },
    { 225.5239061121f,  152.8148288597f,  154.2174283782f },
    { 226.0663825731f,  150.1669133512f,  155.1178673255f },
    { 226.6053245853f,  147.6523051254f,  156.0154292712f },
    { 227.1409207960f,  145.2611235126f,  156.9106732609f },
    { 227.6733374613f,  142.9847128208f,  157.8040579829f },
    { 228.2027221095f,  140.8154399484f,  158.6959568676f },
    { 228.7292064683f,  138.7465325904f,  159.5866701989f },
    { 229.2529088295f,  136.7719485310f,  160.4764349501f },
    { 229.7739359768f,  134.8862690363f,  161.3654328635f },
    { 230.2923847719f,  133.0846111410f,  162.2537971629f },
    { 230.8083434696f,  131.3625549034f,  163.1416181922f },
    { 231.3218928162f,  129.7160826293f,  164.0289482033f },
    { 231.8331069735f,  128.1415277513f,  164.9158054659f },
    { 232.3420543010f,  126.6355315624f,  165.8021778310f },
    { 232.8487980216f,  125.1950063853f,  166.6880258561f },
    { 233.3533967921f,  123.8171040533f,  167.5732855709f },
    { 233.8559051933f,  122.4991888046f,  168.4578709518f },
    { 234.3563741546f,  121.2388138662f,  169.3416761553f },
    { 234.8548513227f,  120.0337011401f,  170.2245775530f },
    { 235.3513813824f,  118.8817235125f,  171.1064356002f },
    { 235.8460063389f,  117.7808893934f,  171.9870965662f },
    { 236.3387657648f,  116.7293291602f,  172.8663941455f },
    { 236.8296970187f,  115.7252832357f,  173.7441509688f },
    { 237.3188354388f,  114.7670915751f,  174.6201800257f },
    { 237.8062145142f,  113.8531843715f,  175.4942860100f },
    { 238.2918660381f,  112.9820738208f,  176.3662665961f },
    { 238.7758202448f,  112.1523468103f,  177.2359136526f },
    { 239.2581059316f,  111.3626584151f,  178.1030143973f },
    { 239.7387505696f,  110.6117261034f,  178.9673524985f },
    { 240.2177804020f,  109.8983245670f,  179.8287091230f },
    { 240.6952205343f,  109.2212811020f,  180.6868639345f },
    { 241.1710950151f,  108.5794714775f,  181.5415960425f },
    { 241.6454269091f,  107.9718162361f,  182.3926849020f },
    { 242.1182383646f,  107.3972773792f,  183.2399111652f },
    { 242.5895506736f,  106.8548553938f,  184.0830574846f },
    { 243.0593843280f,  106.3435865835f,  184.9219092675f },
    { 243.5277590697f,  105.8625406724f,  185.7562553821f },
    { 243.9946939375f,  105.4108186507f,  186.5858888141f },
    { 244.4602073094f,  104.9875508384f,  187.4106072749f },
    { 244.9243169421f,  104.5918951423f,  188.2302137609f },
    { 245.3870400072f,  104.2230354870f,  189.0445170637f },
    { 245.8483931239f,  103.8801804013f,  189.8533322317f },
    { 246.3083923904f,  103.5625617432f,  190.6564809839f },
    { 246.7670534118f,  103.2694335500f,  191.4537920759f },
    { 247.2243913268f,  103.0000709976f,  192.2451016199f },
    { 247.6804208320f,  102.7537694610f,  193.0302533587f },
    { 248.1351562046f,  102.5298436615f,  193.8090988951f },
    { 248.5886113233f,  102.3276268935f,  194.5814978790f },
    { 247.2005627392f,  101.5294526059f,  195.3609749905f },
    { 245.8019397094f,  100.7421021633f,  196.1602023490f },
    { 244.3925272599f,  99.9663873183f,  196.9797011520f },
    { 242.9721031408f,  99.2031644196f,  197.8199931243f },
    { 241.5404374789f,  98.4533363854f,  198.6815983971f },
    { 240.0972924082f,  97.7178546905f,  199.5650331124f },
    { 238.6424216774f,  96.9977213526f,  200.4708067336f },
    { 237.1755702320f,  96.2939909027f,  201.3994190460f },
    { 235.6964737701f,  95.6077723240f,  202.3513568308f },
    { 234.2048582678f,  94.9402309391f,  203.3270902006f },
    { 232.7004394743f,  94.2925902236f,  204.3270685871f },
    { 231.1829223714f,  93.6661335245f,  205.3517163758f },
    { 229.6520005971f,  93.0622056561f,  206.4014281897f },
    { 228.1073558283f,  92.4822143473f,  207.4765638291f },
    { 226.5486571196f,  91.9276315114f,  208.5774428838f },
    { 224.9755601950f,  91.3999943083f,  209.7043390446f },
    { 223.3877066878f,  90.9009059702f,  210.8574741497f },
    { 221.7847233230f,  90.4320363601f,  212.0370120163f },
    { 220.1662210391f,  89.9951222358f,  213.2430521208f },
    { 218.5317940416f,  89.5919671937f,  214.4756232042f },
    { 216.8810187828f,  89.2244412703f,  215.7346768965f },
    { 215.2134528602f,  88.8944801864f,  217.0200814700f },
    { 213.5286338255f,  88.6040842239f,  218.3316158432f },
    { 211.8260778958f,  88.3553167368f,  219.6689639765f },
    { 210.1052785562f,  88.1503023072f,  221.0317098092f },
    { 208.3657050423f,  87.9912245710f,  222.4193329007f },
    { 206.6068006913f,  87.8803237544f,  223.8312049425f },
    { 204.8279811453f,  87.8198939768f,  225.2665873131f },
    { 203.0286323918f,  87.8122803980f,  226.7246298410f },
    { 201.2081086234f,  87.8598763065f,  228.2043709356f },
    { 199.3657298936f,  87.9651202664f,  229.7047392276f },
    { 197.5007795474f,  88.1304934655f,  231.2245568382f },
    { 195.6125013980f,  88.3585174286f,  232.7625443696f },
    { 193.7000966178f,  88.6517522820f,  234.3173276702f },
    { 191.7627203098f,  89.0127957795f,  235.8874463916f },
    { 189.7994777153f,  89.4442833203f,  237.4713643067f },
    { 187.8094200130f,  89.9488892106f,  239.0674813160f },
    { 185.7915396512f,  90.5293294397f,  240.6741470201f },
    { 183.7447651508f,  91.1883662634f,  242.2896756980f },
    { 181.6679553016f,  91.9288149063f,  243.9123624885f },
    { 179.5598926654f,  92.7535527184f,  245.5405005494f },
    { 177.4192762803f,  93.6655311488f,  247.1723989432f },
    { 175.2447134431f,  94.6677909335f,  248.8064009953f },
    { 173.0347104243f,  95.7634809388f,  250.4409028755f },
    { 170.7876619406f,  96.9558811621f,  252.0743721732f },
    { 168.5018391752f,  98.2484304723f,  253.7053662721f },
    { 166.1753760941f,  99.6447597805f,  255.3325503795f },
    { 163.8062537525f,  101.1487314769f,  256.9547151281f },
    { 161.3922822181f,  102.7644861665f,  258.5707937477f },
    { 158.9310796529f,  104.4964979946f,  260.1798788933f },
    { 156.4200479895f,  106.3496402009f,  261.7812393271f },
    { 153.8563444970f,  108.3292630056f,  263.3743367735f },
    { 151.2368483553f,  110.4412865527f,  264.9588434179f },
    { 148.5581211216f,  112.6923124704f,  266.5346606945f },
    { 145.8163596675f,  115.0897587548f,  268.1019402336f },
    { 143.0073397545f,  117.6420242440f,  269.6611081185f },
    { 140.1263478626f,  120.3586911287f,  271.2128939804f },
    { 137.1680981363f,  123.2507770179f,  272.7583669697f },
    { 134.1266302648f,  126.3310524716f,  274.2989813585f },
    { 130.9951826493f,  129.6144463176f,  275.8366355651f },
    { 132.4438993729f,  128.9682821570f,  277.9013743846f },
    { 133.8698086186f,  128.4881700868f,  279.9275022835f },
    { 135.2739312535f,  128.1630041275f,  281.9125337949f },
    { 136.6572131541f,  127.9821926343f,  283.8543602985f },
    { 138.0205327307f,  127.9356495300f,  285.7512491171f },
    { 139.3647075073f,  128.0137874251f,  287.6018346844f },
    { 140.6904998986f,  128.2075112242f,  289.4051031042f },
    { 141.9986223002f,  128.5082112172f,  291.1603714833f },
    { 143.2897415893f,  128.9077549963f,  292.8672633949f },
    { 144.5644831175f,  129.3984778192f,  294.5256817487f },
    { 145.8234342632f,  129.9731712591f,  296.1357802097f },
    { 147.0671476026f,  130.6250701510f,  297.6979341505f },
    { 148.2961437473f,  131.3478379622f,  299.2127119497f },
    { 149.5109138909f,  132.1355507947f,  300.6808472825f },
    { 150.7119220998f,  132.9826802727f,  302.1032128828f },
    { 151.8996073796f,  133.8840755904f,  303.4807961178f },
    { 153.0743855423f,  134.8349449921f,  304.8146765861f },
    { 154.2366508988f,  135.8308369471f,  306.1060058488f },
    { 155.3867777950f,  136.8676212560f,  307.3559893165f },
    { 156.5251220088f,  137.9414702969f,  308.5658702536f },
    { 157.6520220246f,  139.0488405926f,  309.7369158097f },
    { 158.7678001964f,  140.1864548429f,  310.8704049575f },
    { 159.8727638119f,  141.3512845431f,  311.9676181930f },
    { 160.9672060682f,  142.5405332754f,  313.0298288452f },
    { 162.0514069671f,  143.7516207414f,  314.0582958357f },
    { 163.1256341384f,  144.9821675770f,  315.0542577313f },
    { 164.1901435982f,  146.2299809768f,  316.0189279405f },
    { 165.2451804480f,  147.4930411351f,  316.9534909095f },
    { 166.2909795207f,  148.7694885031f,  317.8590991881f },
    { 167.3277659781f,  150.0576118471f,  318.7368712434f },
    { 168.3557558637f,  151.3558370869f,  319.5878899131f },
    { 169.3751566161f,  152.6627168881f,  320.4132014011f },
    { 170.3861675452f,  153.9769209751f,  321.2138147285f },
    { 171.3889802751f,  155.2972271333f,  321.9907015643f },
    { 172.3837791560f,  156.6225128605f,  322.7447963693f },
    { 173.3707416489f,  157.9517476342f,  323.4769967954f },
    { 174.3500386829f,  159.2839857555f,  324.1881642909f },
    { 175.3218349908f,  160.6183597327f,  324.8791248688f },
    { 176.2862894207f,  161.9540741707f,  325.5506700013f },
    { 177.2435552298f,  163.2904001297f,  326.2035576110f },
    { 178.1937803575f,  164.6266699206f,  326.8385131312f },
    { 179.1371076828f,  165.9622723059f,  327.4562306145f },
    { 180.0736752657f,  167.2966480762f,  328.0573738712f },
    { 181.0036165733f,  168.6292859733f,  328.6425776227f },
    { 181.9270606926f,  169.9597189346f,  329.2124486577f },
    { 182.8441325315f,  171.2875206331f,  329.7675669804f },
    { 183.7549530068f,  172.6123022909f,  330.3084869440f },
    { 184.6596392223f,  173.9337097439f,  330.8357383623f },
    { 185.5583046363f,  175.2514207387f,  331.3498275944f },
    { 186.4510592201f,  176.5651424426f,  331.8512385995f },
    { 187.3380096073f,  177.8746091499f,  332.3404339582f },
    { 188.2192592352f,  179.1795801689f,  332.8178558589f },
    { 189.0949084784f,  180.4798378754f,  333.2839270474f },
    { 189.9650547753f,  181.7751859185f,  333.7390517405f },
    { 190.8297927483f,  183.0654475670f,  334.1836165011f },
    { 191.6892143167f,  184.3504641858f,  334.6179910769f },
    { 192.5434088053f,  185.6300938297f,  335.0425292023f },
    { 193.3924630459f,  186.9042099482f,  335.4575693639f },
    { 194.2364614749f,  188.1727001892f,  335.8634355309f },
    { 195.0754862254f,  189.4354652963f,  336.2604378514f },
    { 194.4490197137f,  189.5317954665f,  336.6528400563f },
    { 193.8196545935f,  189.6361686366f,  337.0499332947f },
    { 193.1873493717f,  189.7487884978f,  337.4518171207f },
    { 192.5520614155f,  189.8698643100f,  337.8585953743f },
    { 191.9137469023f,  189.9996110856f,  338.2703764881f },
    { 191.2723607653f,  190.1382497808f,  338.6872738227f },
    { 190.6278566367f,  190.2860074970f,  339.1094060343f },
    { 189.9801867863f,  190.4431176919f,  339.5368974761f },
    { 189.3293020560f,  190.6098204010f,  339.9698786396f },
    { 188.6751517902f,  190.7863624716f,  340.4084866391f },
    { 188.0176837599f,  190.9729978089f,  340.8528657445f },
    { 187.3568440831f,  191.1699876374f,  341.3031679687f },
    { 186.6925771372f,  191.3776007766f,  341.7595537155f },
    { 186.0248254660f,  191.5961139355f,  342.2221924968f },
    { 185.3535296784f,  191.8258120252f,  342.6912637259f },
    { 184.6786283396f,  192.0669884945f,  343.1669575986f },
    { 184.0000578524f,  192.3199456888f,  343.6494760720f },
    { 183.3177523285f,  192.5849952380f,  344.1390339564f },
    { 182.6316434487f,  192.8624584743f,  344.6358601321f },
    { 181.9416603098f,  193.1526668879f,  345.1401989133f },
    { 181.2477292570f,  193.4559626235f,  345.6523115760f },
    { 180.5497737007f,  193.7726990247f,  346.1724780768f },
    { 179.8477139142f,  194.1032412356f,  346.7009989899f },
    { 179.1414668102f,  194.4479668674f,  347.2381976967f },
    { 178.4309456943f,  194.8072667437f,  347.7844228676f },
    { 177.7160599903f,  195.1815457376f,  348.3400512841f },
    { 176.9967149341f,  195.5712237192f,  348.9054910573f },
    { 176.2728112310f,  195.9767366360f,  349.4811853120f },
    { 175.5442446711f,  196.3985377539f,  350.0676164181f },
    { 174.8109056945f,  196.8370990935f,  350.6653108692f },
    { 174.0726788988f,  197.2929131063f,  351.2748449316f },
    { 173.3294424779f,  197.7664946466f,  351.8968512114f },
    { 172.5810675795f,  198.2583833115f,  352.5320263271f },
    { 171.8274175643f,  198.7691462411f,  353.1811399155f },
    { 171.0683471495f,  199.2993814996f,  353.8450452605f },
    { 170.3037014083f,  199.8497221947f,  354.5246919091f },
    { 169.5333145971f,  200.4208415431f,  355.2211407363f },
    { 168.7570087670f,  201.0134591585f,  355.9355820564f },
    { 167.9745921103f,  201.6283489357f,  356.6693575520f },
    { 167.1858569708f,  202.2663490343f,  357.4239870333f },
    { 166.3905774296f,  202.9283746591f,  358.2012013727f },
    { 165.5885063450f,  203.6154346033f,  359.0029834160f },
    { 164.7793716817f,  204.3286529191f,  359.8316193291f }
};

__CONSTANT__ float gamutCuspTableReach[360] = 
{
    398.645f,
    402.710f,
    406.677f,
    410.547f,
    414.301f,
    417.932f,
    421.429f,
    424.792f,
    428.009f,
    431.085f,
    434.015f,
    436.798f,
    439.441f,
    441.943f,
    444.312f,
    446.552f,
    448.676f,
    450.690f,
    452.600f,
    454.419f,
    456.158f,
    457.831f,
    459.442f,
    461.005f,
    462.537f,
    464.038f,
    464.020f,
    447.296f,
    431.873f,
    417.609f,
    404.382f,
    392.090f,
    380.640f,
    369.946f,
    359.949f,
    350.586f,
    341.803f,
    333.545f,
    325.781f,
    318.463f,
    311.560f,
    305.042f,
    298.877f,
    293.048f,
    287.531f,
    282.300f,
    277.338f,
    272.632f,
    268.164f,
    263.916f,
    259.882f,
    256.049f,
    252.399f,
    248.926f,
    245.624f,
    242.480f,
    239.490f,
    236.639f,
    233.929f,
    231.354f,
    228.900f,
    226.569f,
    224.347f,
    222.241f,
    220.233f,
    218.335f,
    216.534f,
    214.825f,
    213.208f,
    211.676f,
    210.236f,
    208.875f,
    207.593f,
    206.390f,
    205.267f,
    204.211f,
    203.235f,
    202.325f,
    201.483f,
    200.714f,
    200.006f,
    199.371f,
    198.798f,
    198.285f,
    197.833f,
    197.449f,
    197.125f,
    196.857f,
    196.655f,
    196.509f,
    196.429f,
    196.405f,
    196.442f,
    196.539f,
    196.692f,
    196.912f,
    197.186f,
    197.528f,
    197.925f,
    198.389f,
    198.914f,
    199.506f,
    200.159f,
    200.879f,
    201.666f,
    202.521f,
    203.442f,
    204.437f,
    205.505f,
    206.647f,
    207.867f,
    209.161f,
    210.541f,
    212.006f,
    213.550f,
    215.186f,
    216.913f,
    218.738f,
    220.660f,
    222.687f,
    224.817f,
    227.057f,
    229.419f,
    231.897f,
    234.503f,
    237.238f,
    240.118f,
    243.140f,
    246.313f,
    249.652f,
    253.156f,
    256.842f,
    260.718f,
    264.795f,
    269.086f,
    273.602f,
    278.357f,
    283.368f,
    288.654f,
    294.226f,
    300.116f,
    306.342f,
    312.933f,
    319.910f,
    327.307f,
    335.156f,
    343.500f,
    343.713f,
    334.778f,
    326.343f,
    318.372f,
    310.828f,
    303.687f,
    296.912f,
    290.491f,
    284.387f,
    278.595f,
    273.083f,
    267.841f,
    262.848f,
    258.093f,
    253.564f,
    249.243f,
    245.117f,
    241.187f,
    237.427f,
    233.844f,
    230.420f,
    227.142f,
    224.017f,
    221.027f,
    218.170f,
    215.436f,
    212.830f,
    210.333f,
    207.947f,
    205.664f,
    203.485f,
    201.404f,
    199.414f,
    197.516f,
    195.703f,
    193.976f,
    192.334f,
    190.759f,
    189.270f,
    187.848f,
    186.499f,
    185.217f,
    184.003f,
    182.849f,
    181.763f,
    180.737f,
    179.773f,
    178.870f,
    178.021f,
    177.228f,
    176.489f,
    175.806f,
    175.177f,
    174.597f,
    174.072f,
    173.596f,
    173.169f,
    172.791f,
    172.461f,
    172.186f,
    171.954f,
    171.771f,
    171.631f,
    171.545f,
    171.503f,
    171.509f,
    171.564f,
    171.661f,
    171.808f,
    172.003f,
    172.247f,
    172.534f,
    172.876f,
    173.260f,
    173.700f,
    174.182f,
    174.719f,
    175.305f,
    175.946f,
    176.636f,
    177.380f,
    178.180f,
    179.034f,
    179.944f,
    180.914f,
    181.940f,
    183.032f,
    184.180f,
    185.394f,
    186.670f,
    188.019f,
    189.429f,
    190.918f,
    192.474f,
    194.104f,
    195.819f,
    197.607f,
    199.481f,
    201.440f,
    203.485f,
    205.627f,
    207.861f,
    210.199f,
    212.634f,
    215.179f,
    217.841f,
    220.612f,
    223.505f,
    226.520f,
    229.675f,
    232.959f,
    236.389f,
    239.972f,
    243.707f,
    247.607f,
    251.678f,
    255.927f,
    260.364f,
    264.996f,
    269.836f,
    274.133f,
    271.960f,
    269.885f,
    267.914f,
    266.046f,
    264.270f,
    262.585f,
    260.992f,
    259.485f,
    258.069f,
    256.732f,
    255.481f,
    254.303f,
    253.210f,
    252.191f,
    251.245f,
    250.378f,
    249.579f,
    248.853f,
    248.193f,
    247.607f,
    247.089f,
    246.637f,
    246.252f,
    245.935f,
    245.685f,
    245.496f,
    245.374f,
    245.319f,
    245.325f,
    245.398f,
    245.532f,
    245.734f,
    245.996f,
    246.326f,
    246.716f,
    247.174f,
    247.699f,
    248.285f,
    248.938f,
    249.664f,
    250.452f,
    251.306f,
    252.228f,
    253.223f,
    254.285f,
    255.414f,
    256.622f,
    257.898f,
    259.247f,
    260.669f,
    262.170f,
    263.751f,
    265.405f,
    267.139f,
    268.958f,
    270.856f,
    272.833f,
    274.902f,
    277.051f,
    279.291f,
    281.616f,
    284.033f,
    286.536f,
    289.136f,
    291.827f,
    294.617f,
    297.491f,
    300.470f,
    303.540f,
    306.708f,
    309.967f,
    313.324f,
    316.772f,
    320.319f,
    323.950f,
    327.673f,
    331.482f,
    335.376f,
    339.343f,
    343.384f,
    347.491f,
    351.660f,
    355.878f,
    360.138f,
    364.435f,
    368.756f,
    373.090f,
    377.423f,
    381.744f,
    386.041f,
    390.302f,
    394.507f
};

__CONSTANT__ float3 cGamutCuspTable[360] = 
{
    { 177.8321904515f,  270.6004661774f,  0.2865183627f },
    { 177.1858317192f,  271.5854959307f,  0.8832866927f },
    { 176.5341733159f,  272.5881157676f,  1.4984497422f },
    { 175.8769759624f,  273.6086068282f,  2.1338239923f },
    { 175.2139715371f,  274.6472756469f,  2.7915194499f },
    { 174.5448570344f,  275.7044659204f,  3.4740068477f },
    { 173.8692867124f,  276.7805758835f,  4.1842055278f },
    { 173.1868617157f,  277.8760841867f,  4.9256002637f },
    { 172.4971160946f,  278.9915888896f,  5.7023994530f },
    { 171.7994975569f,  280.1278671237f,  6.5197539133f },
    { 171.0933402964f,  281.2859681710f,  7.3840669929f },
    { 170.3778255009f,  282.4673622227f,  8.3034468571f },
    { 169.6519219452f,  283.6741853856f,  9.2883888744f },
    { 168.9142928488f,  284.9096586639f,  10.3528480985f },
    { 168.1631422361f,  286.1788393597f,  11.5160117288f },
    { 167.3959447641f,  287.4900539556f,  12.8054203497f },
    { 166.6089292818f,  288.8578629663f,  14.2629396006f },
    { 165.7959722143f,  290.3099325927f,  15.9575607935f },
    { 164.9457925068f,  291.9058938012f,  18.0178406063f },
    { 164.0325387460f,  293.8061983321f,  20.7406503293f },
    { 162.9555298932f,  296.7620013758f,  25.2856115744f },
    { 165.4412148880f,  285.7881374362f,  26.6509505979f },
    { 167.8542700663f,  275.6666874556f,  28.0409575220f },
    { 170.2016726442f,  266.3093517210f,  29.4560489203f },
    { 172.4892829982f,  257.6427358771f,  30.8963646734f },
    { 174.7220830651f,  249.6051107280f,  32.3617832585f },
    { 176.9043529740f,  242.1440043792f,  33.8519322891f },
    { 179.0398043949f,  235.2143788195f,  35.3661962362f },
    { 181.1316828905f,  228.7772258288f,  36.9037228195f },
    { 183.1828476441f,  222.7984696441f,  38.4634292353f },
    { 185.1958343888f,  217.2480980432f,  40.0440091415f },
    { 187.1729056717f,  212.0994663295f,  41.6439411234f },
    { 189.1160914386f,  207.3287342323f,  43.2614991895f },
    { 191.0272221241f,  202.9144064986f,  44.8947656838f },
    { 192.9079558757f,  198.8369555320f,  46.5416468480f },
    { 194.7598011375f,  195.0785098349f,  48.1998911115f },
    { 196.5841355252f,  191.6225959142f,  49.8671100369f },
    { 198.3822217144f,  188.4539241455f,  51.5408017042f },
    { 200.1552209016f,  185.5582111721f,  53.2183761844f },
    { 201.9042042771f,  182.9220329483f,  54.8971826370f },
    { 203.6301628597f,  180.5327036667f,  56.5745374715f },
    { 205.3340159716f,  178.3781766567f,  58.2477529484f },
    { 207.0166185769f,  176.4469639682f,  59.9141655609f },
    { 208.6787676662f,  174.7280718342f,  61.5711635371f },
    { 210.3212078354f,  173.2109495753f,  63.2162128333f },
    { 211.9446361807f,  171.8854498013f,  64.8468810506f },
    { 213.5497066093f,  170.7417980086f,  66.4608587911f },
    { 215.1370336513f,  169.7705698775f,  68.0559780755f },
    { 216.7071958397f,  168.9626747637f,  69.6302275583f },
    { 218.2607387200f,  168.3093440474f,  71.1817643965f },
    { 219.7981775360f,  167.8021231717f,  72.7089227442f },
    { 221.3199996352f,  167.4328663556f,  74.2102189512f },
    { 222.8266666292f,  167.1937331200f,  75.6843536403f },
    { 224.3186163377f,  167.0771859064f,  77.1302109100f },
    { 225.7962645440f,  167.0759882035f,  78.5468549700f },
    { 227.2600065840f,  167.1832027201f,  79.9335245524f },
    { 228.7102187860f,  167.3921892541f,  81.2896254639f },
    { 230.1472597809f,  167.6966020076f,  82.6147216461f },
    { 231.5714716951f,  168.0903861824f,  83.9085251004f },
    { 232.9831812391f,  168.5677737638f,  85.1708850163f },
    { 234.3827007040f,  169.1232784573f,  86.4017764067f },
    { 235.7703288737f,  169.7516897934f,  87.6012885259f },
    { 237.1463518631f,  170.4480664459f,  88.7696133030f },
    { 238.5110438884f,  171.2077288407f,  89.9070339876f },
    { 239.8646679767f,  172.0262511436f,  91.0139141688f },
    { 241.2074766210f,  172.8994527294f,  92.0906872890f },
    { 242.5397123851f,  173.8233892365f,  93.1378467467f },
    { 243.8616084633f,  174.7943433112f,  94.1559366515f },
    { 245.1733891998f,  175.8088151421f,  95.1455432679f },
    { 246.4752705697f,  176.8635128780f,  96.1072871694f },
    { 247.7674606269f,  177.9553430147f,  97.0418161000f },
    { 249.0501599203f,  179.0814008273f,  97.9497985329f },
    { 250.3235618819f,  180.2389609138f,  98.8319179007f },
    { 251.5878531881f,  181.4254679087f,  99.6888674671f },
    { 252.8432140984f,  182.6385274121f,  100.5213458018f },
    { 254.0898187707f,  183.8758971757f,  101.3300528193f },
    { 255.3278355572f,  185.1354785740f,  102.1156863371f },
    { 256.5574272814f,  186.4153083870f,  102.8789391129f },
    { 257.7787514980f,  187.7135509091f,  103.6204963155f },
    { 258.9919607366f,  189.0284903966f,  104.3410333889f },
    { 260.1972027310f,  190.3585238596f,  105.0412142707f },
    { 259.4827091988f,  190.5058284715f,  105.7305047947f },
    { 258.7651515127f,  190.6830726592f,  106.4234347677f },
    { 258.0444926573f,  190.8907999716f,  107.1198340445f },
    { 257.3206948596f,  191.1295534490f,  107.8195268768f },
    { 256.5937195669f,  191.3998752875f,  108.5223321303f },
    { 255.8635274244f,  191.7023065127f,  109.2280635223f },
    { 255.1300782512f,  192.0373866668f,  109.9365298810f },
    { 254.3933310161f,  192.4056535100f,  110.6475354260f },
    { 253.6532438119f,  192.8076427402f,  111.3608800673f },
    { 252.9097738291f,  193.2438877306f,  112.0763597241f },
    { 252.1628773283f,  193.7149192898f,  112.7937666607f },
    { 251.4125096118f,  194.2212654454f,  113.5128898392f },
    { 250.6586249939f,  194.7634512530f,  114.2335152872f },
    { 249.9011767696f,  195.3419986338f,  114.9554264787f },
    { 249.1401171831f,  195.9574262415f,  115.6784047275f },
    { 248.3753973939f,  196.6102493613f,  116.4022295908f },
    { 247.6069674421f,  197.3009798428f,  117.1266792808f },
    { 246.8347762122f,  198.0301260676f,  117.8515310835f },
    { 246.0587713951f,  198.7981929549f,  118.5765617817f },
    { 245.2788994487f,  199.6056820050f,  119.3015480811f },
    { 244.4951055570f,  200.4530913829f,  120.0262670370f },
    { 243.7073335873f,  201.3409160436f,  120.7504964795f },
    { 242.9155260449f,  202.2696478987f,  121.4740154355f },
    { 242.1196240272f,  203.2397760280f,  122.1966045463f },
    { 241.3195671741f,  204.2517869339f,  122.9180464768f },
    { 240.5152936175f,  205.3061648418f,  123.6381263167f },
    { 239.7067399282f,  206.4033920460f,  124.3566319708f },
    { 238.8938410596f,  207.5439493015f,  125.0733545369f },
    { 238.0765302897f,  208.7283162631f,  125.7880886693f },
    { 237.2547391601f,  209.9569719714f,  126.5006329279f },
    { 236.4283974121f,  211.2303953856f,  127.2107901098f },
    { 235.5974329196f,  212.5490659647f,  127.9183675633f },
    { 234.7617716190f,  213.9134642957f,  128.6231774830f },
    { 233.9213374355f,  215.3240727704f,  129.3250371851f },
    { 233.0760522060f,  216.7813763092f,  130.0237693621f },
    { 232.2258355980f,  218.2858631339f,  130.7192023162f },
    { 231.3706050242f,  219.8380255885f,  131.4111701716f },
    { 230.5102755531f,  221.4383610084f,  132.0995130646f },
    { 229.6447598152f,  223.0873726382f,  132.7840773117f },
    { 228.7739679036f,  224.7855705998f,  133.4647155558f },
    { 227.8978072698f,  226.5334729084f,  134.1412868911f },
    { 227.0161826140f,  228.3316065410f,  134.8136569651f },
    { 226.1289957695f,  230.1805085544f,  135.4816980611f },
    { 225.2361455804f,  232.0807272564f,  136.1452891591f },
    { 224.3375277731f,  234.0328234309f,  136.8043159766f },
    { 223.4330348203f,  236.0373716172f,  137.4586709910f },
    { 222.5225557969f,  238.0949614475f,  138.1082534423f },
    { 221.6059762288f,  240.2061990425f,  138.7529693194f },
    { 220.6831779318f,  242.3717084697f,  139.3927313288f },
    { 219.7540388412f,  244.5921332659f,  140.0274588480f },
    { 218.8184328322f,  246.8681380276f,  140.6570778643f },
    { 217.8762295278f,  249.2004100742f,  141.2815209001f },
    { 216.9272940968f,  251.5896611865f,  141.9007269249f },
    { 215.9714870378f,  254.0366294271f,  142.5146412574f },
    { 215.0086639503f,  256.5420810472f,  143.1232154561f },
    { 214.0386752912f,  259.1068124870f,  143.7264072008f },
    { 213.0613661156f,  261.7316524758f,  144.3241801672f },
    { 212.0765758001f,  264.4174642399f,  144.9165038931f },
    { 211.0841377484f,  267.1651478278f,  145.5033536397f },
    { 210.0838790765f,  269.9756425609f,  146.0847102482f },
    { 210.7219112775f,  260.0570942366f,  147.5582436743f },
    { 211.3229267175f,  252.0254871498f,  148.8578403213f },
    { 211.8996442323f,  245.2146728053f,  150.0451114152f },
    { 212.4587652523f,  239.2739280178f,  151.1526094959f },
    { 213.0043212008f,  233.9924275316f,  152.1999316429f },
    { 213.5389552072f,  229.2320642273f,  153.1999134609f },
    { 214.0645087956f,  224.8967082175f,  154.1614746660f },
    { 214.5823245836f,  220.9163501519f,  155.0910917303f },
    { 215.0934165975f,  217.2381809841f,  155.9936286494f },
    { 215.5985726402f,  213.8212313038f,  156.8728374153f },
    { 216.0984191062f,  210.6329774966f,  157.7316755489f },
    { 216.5934637915f,  207.6471004004f,  158.5725162099f },
    { 217.0841251729f,  204.8419524037f,  159.3972921514f },
    { 217.5707530334f,  202.1994777209f,  160.2075972847f },
    { 218.0536433603f,  199.7044324906f,  161.0047601573f },
    { 218.5330493434f,  197.3438090519f,  161.7898982786f },
    { 219.0091896506f,  195.1064027945f,  162.5639590557f },
    { 219.4822547584f,  192.9824807743f,  163.3277511598f },
    { 219.9524118689f,  190.9635243919f,  164.0819689225f },
    { 220.4198087782f,  189.0420269077f,  164.8272115662f },
    { 220.8845769584f,  187.2113321958f,  165.5639985449f },
    { 221.3468340375f,  185.4655049419f,  166.2927819179f },
    { 221.8066858168f,  183.7992251254f,  167.0139564285f },
    { 222.2642279251f,  182.2077014712f,  167.7278677902f },
    { 222.7195471875f,  180.6865998760f,  168.4348195546f },
    { 223.1727227660f,  179.2319837713f,  169.1350788484f },
    { 223.6238271165f,  177.8402640867f,  169.8288812000f },
    { 224.0729267978f,  176.5081569950f,  170.5164346267f },
    { 224.5200831585f,  175.2326480188f,  171.1979231164f },
    { 224.9653529247f,  174.0109613680f,  171.8735096114f },
    { 225.4087887043f,  172.8405336129f,  172.5433385774f },
    { 225.8504394227f,  171.7189909682f,  173.2075382277f },
    { 226.2903507006f,  170.6441296052f,  173.8662224558f },
    { 226.7285651829f,  169.6138985155f,  174.5194925235f },
    { 227.1651228269f,  168.6263845351f,  175.1674385394f },
    { 227.6000611547f,  167.6797992090f,  175.8101407593f },
    { 228.0334154761f,  166.7724672269f,  176.4476707338f },
    { 228.4652190851f,  165.9028162096f,  177.0800923232f },
    { 228.8955034352f,  165.0693676592f,  177.7074625988f },
    { 229.3242982942f,  164.2707289156f,  178.3298326433f },
    { 229.7516318832f,  163.5055859880f,  178.9472482654f },
    { 230.1775310006f,  162.7726971477f,  179.5597506373f },
    { 230.6020211339f,  162.0708871874f,  180.1673768650f },
    { 231.0251265592f,  161.3990422640f,  180.7701604994f },
    { 231.4468704324f,  160.7561052558f,  181.3681319943f },
    { 231.8672748703f,  160.1410715716f,  181.9613191179f },
    { 232.2863610248f,  159.5529853612f,  182.5497473224f },
    { 232.7041491503f,  158.9909360805f,  183.1334400756f },
    { 233.1206586645f,  158.4540553720f,  183.7124191596f },
    { 233.5359082046f,  157.9415142268f,  184.2867049392f },
    { 233.9499156775f,  157.4525203969f,  184.8563166024f },
    { 234.3626983073f,  156.9863160322f,  185.4212723773f },
    { 234.7742726773f,  156.5421755185f,  185.9815897258f },
    { 235.1846547694f,  156.1194034964f,  186.5372855179f },
    { 235.5938600002f,  155.7173330421f,  187.0883761869f },
    { 236.0019032542f,  155.3353239955f,  187.6348778687f },
    { 236.4087989146f,  154.9727614200f,  188.1768065250f },
    { 236.8145608911f,  154.6290541824f,  188.7141780541f },
    { 237.2192026467f,  154.3036336405f,  189.2470083874f },
    { 237.6227372217f,  153.9959524301f,  189.7753135754f },
    { 236.2608576583f,  152.7717184796f,  190.3083184428f },
    { 234.8883755998f,  151.5482111317f,  190.8549355703f },
    { 233.5050701110f,  150.3258326485f,  191.4156508185f },
    { 232.1107125869f,  149.1050153138f,  191.9909696803f },
    { 230.7050663757f,  147.8862236015f,  192.5814179467f },
    { 229.2878863791f,  146.6699565029f,  193.1875423610f },
    { 227.8589186257f,  145.4567500252f,  193.8099112538f },
    { 226.4178998176f,  144.2471798718f,  194.4491151496f },
    { 224.9645568451f,  143.0418643181f,  195.1057673357f },
    { 223.4986062705f,  141.8414672939f,  195.7805043805f },
    { 222.0197537748f,  140.6467016881f,  196.4739865875f },
    { 220.5276935671f,  139.4583328875f,  197.1868983696f },
    { 219.0221077510f,  138.2771825652f,  197.9199485247f },
    { 217.5026656468f,  137.1041327326f,  198.6738703917f },
    { 215.9690230629f,  135.9401300700f,  199.4494218638f },
    { 214.4208215136f,  134.7861905499f,  200.2473852306f },
    { 212.8576873784f,  133.6434043683f,  201.0685668202f },
    { 211.2792309955f,  132.5129411973f,  201.9137964067f },
    { 209.6850456856f,  131.3960557719f,  202.7839263456f },
    { 208.0747066974f,  130.2940938249f,  203.6798303950f },
    { 206.4477700682f,  129.2084983781f,  204.6024021782f },
    { 204.8037713902f,  128.1408164017f,  205.5525532378f },
    { 203.1422244737f,  127.0927058460f,  206.5312106284f },
    { 201.4626198958f,  126.0659430518f,  207.5393139925f },
    { 199.7644234223f,  125.0624305384f,  208.5778120614f },
    { 198.0470742899f,  124.0842051683f,  209.6476585215f },
    { 196.3099833324f,  123.1334466806f,  210.7498071856f },
    { 194.5525309333f,  122.2124865835f,  211.8852064147f },
    { 192.7740647854f,  121.3238173905f,  213.0547927337f },
    { 190.9738974343f,  120.4701021809f,  214.2594835998f },
    { 189.1513035791f,  119.6541844630f,  215.5001692862f },
    { 187.3055171024f,  118.8790983148f,  216.7777038666f },
    { 185.4357277926f,  118.1480787778f,  218.0928953007f },
    { 183.5410777218f,  117.4645724812f,  219.4464946536f },
    { 181.6206572314f,  116.8322484807f,  220.8391845121f },
    { 179.6735004746f,  116.2550093085f,  222.2715667030f },
    { 177.6985804523f,  115.7370022499f,  223.7441494683f },
    { 175.6948034719f,  115.2826308908f,  225.2573343040f },
    { 173.6610029441f,  114.8965670237f,  226.8114027367f },
    { 171.5959324180f,  114.5837630527f,  228.4065033753f },
    { 169.4982577390f,  114.3494651176f,  230.0426396508f },
    { 167.3665481874f,  114.1992272534f,  231.7196587261f },
    { 165.1992664341f,  114.1389270294f,  233.4372421345f },
    { 162.9947571122f,  114.1747832741f,  235.1948987667f },
    { 160.7512337655f,  114.3133766939f,  236.9919608855f },
    { 158.4667638819f,  114.5616744463f,  238.8275838917f },
    { 156.1392516571f,  114.9270600422f,  240.7007505910f },
    { 153.7664180524f,  115.4173703438f,  242.6102807239f },
    { 151.3457776094f,  116.0409419108f,  244.5548465148f },
    { 148.8746113501f,  116.8066695624f,  246.5329949765f },
    { 146.3499349253f,  117.7240808099f,  248.5431776902f },
    { 143.7684609462f,  118.8034308272f,  250.5837887679f },
    { 141.1265541487f,  120.0558239710f,  252.6532117356f },
    { 138.4201776415f,  121.4933696664f,  254.7498761690f },
    { 135.6448279708f,  123.1293829573f,  256.8723251233f },
    { 132.7954560086f,  124.9786434951f,  259.0192947850f },
    { 129.8663696788f,  127.0577317202f,  261.1898084285f },
    { 126.8511131325f,  129.3854682535f,  263.3832878092f },
    { 123.7423149786f,  131.9834933429f,  265.5996867766f },
    { 120.5314952476f,  134.8770396992f,  267.8396544471f },
    { 122.5512948021f,  133.1542090579f,  271.1465572741f },
    { 124.5209244397f,  131.9025740672f,  274.3936394458f },
    { 126.4438917789f,  131.0819995467f,  277.5668360681f },
    { 128.3233108693f,  130.6540389206f,  280.6539888262f },
    { 130.1619613692f,  130.5820066148f,  283.6450789804f },
    { 131.9623367710f,  130.8310987667f,  286.5323186246f },
    { 133.7266840485f,  131.3685217836f,  289.3101168204f },
    { 135.4570365197f,  132.1636009446f,  291.9749460462f },
    { 137.1552412887f,  133.1878526330f,  294.5251381007f },
    { 138.8229823203f,  134.4150131357f,  296.9606379470f },
    { 140.4617999667f,  135.8210238974f,  299.2827403099f },
    { 142.0731075902f,  137.3839776976f,  301.4938285694f },
    { 143.6582057926f,  139.0840327507f,  303.5971298402f },
    { 145.2182946580f,  140.9033026764f,  305.5964949164f },
    { 146.7544843388f,  142.8257301306f,  307.4962074547f },
    { 148.2678042498f,  144.8369510641f,  309.3008235199f },
    { 149.7592110876f,  146.9241554238f,  311.0150403801f },
    { 151.2295958541f,  149.0759488646f,  312.6435920590f },
    { 152.6797900307f,  151.2822188609f,  314.1911684408f },
    { 154.1105710249f,  153.5340075658f,  315.6623544806f },
    { 155.5226669925f,  155.8233929087f,  317.0615861498f },
    { 156.9167611198f,  158.1433787398f,  318.3931200103f },
    { 158.2934954379f,  160.4877943183f,  319.6610136626f },
    { 159.6534742309f,  162.8512030671f,  320.8691147108f },
    { 160.9972670885f,  165.2288202616f,  322.0210562640f },
    { 162.3254116480f,  167.6164391532f,  323.1202573511f },
    { 163.6384160637f,  170.0103649325f,  324.1699269376f },
    { 164.9367612352f,  172.4073558902f,  325.1730705014f },
    { 166.2209028239f,  174.8045711256f,  326.1324983487f },
    { 167.4912730806f,  177.1995241638f,  327.0508350393f },
    { 168.7482825063f,  179.5900418781f,  327.9305294367f },
    { 169.9923213644f,  181.9742281483f,  328.7738650223f },
    { 171.2237610597f,  184.3504317362f,  329.5829702076f },
    { 172.4429553986f,  186.7172179014f,  330.3598284498f },
    { 173.6502417427f,  189.0733433300f,  331.1062880398f },
    { 174.8459420671f,  191.4177339906f,  331.8240714704f },
    { 176.0303639317f,  193.7494655752f,  332.5147843300f },
    { 177.2038013756f,  196.0677462189f,  333.1799236903f },
    { 178.3665357408f,  198.3719012300f,  333.8208859771f },
    { 179.5188364320f,  200.6613595891f,  334.4389743250f },
    { 180.6609616194f,  202.9356420095f,  335.0354054270f },
    { 181.7931588883f,  205.1943503709f,  335.6113158987f },
    { 182.9156658414f,  207.4371583650f,  336.1677681773f },
    { 184.0287106578f,  209.6638032088f,  336.7057559816f },
    { 185.1325126115f,  211.8740782992f,  337.2262093589f },
    { 186.2272825544f,  214.0678266990f,  337.7299993462f },
    { 187.3132233655f,  216.2449353560f,  338.2179422711f },
    { 188.3905303702f,  218.4053299710f,  338.6908037188f },
    { 189.4593917308f,  220.5489704374f,  339.1493021902f },
    { 190.5199888117f,  222.6758467890f,  339.5941124744f },
    { 191.5724965212f,  224.7859755953f,  340.0258687575f },
    { 192.6170836310f,  226.8793967549f,  340.4451674890f },
    { 193.6539130757f,  228.9561706411f,  340.8525700248f },
    { 194.6831422337f,  231.0163755600f,  341.2486050651f },
    { 195.7049231906f,  233.0601054861f,  341.6337709037f },
    { 196.7194029875f,  235.0874680451f,  342.0085375039f },
    { 197.7267238536f,  237.0985827154f,  342.3733484154f },
    { 198.7270234253f,  239.0935792248f,  342.7286225453f },
    { 199.7204349528f,  241.0725961215f,  343.0747557949f },
    { 200.7070874952f,  243.0357794991f,  343.4121225729f },
    { 200.1883199996f,  243.4956058537f,  343.7448759280f },
    { 199.6673856829f,  243.9649516679f,  344.0804781772f },
    { 199.1442536994f,  244.4439695454f,  344.4189964936f },
    { 198.6188923164f,  244.9328146410f,  344.7605016087f },
    { 198.0912688723f,  245.4316446899f,  345.1050680703f },
    { 197.5613497317f,  245.9406200359f,  345.4527745232f },
    { 197.0291002377f,  246.4599036564f,  345.8037040150f },
    { 196.4944846609f,  246.9896611859f,  346.1579443302f },
    { 195.9574661440f,  247.5300609367f,  346.5155883549f },
    { 195.4180066426f,  248.0812739165f,  346.8767344769f },
    { 194.8760668621f,  248.6434738424f,  347.2414870237f },
    { 194.3316061883f,  249.2168371509f,  347.6099567447f },
    { 193.7845826138f,  249.8015430043f,  347.9822613405f },
    { 193.2349526571f,  250.3977732910f,  348.3585260480f },
    { 192.6826712757f,  251.0057126214f,  348.7388842850f },
    { 192.1276917711f,  251.6255483172f,  349.1234783649f },
    { 191.5699656856f,  252.2574703939f,  349.5124602890f },
    { 191.0094426898f,  252.9016715371f,  349.9059926267f },
    { 190.4460704586f,  253.5583470693f,  350.3042494959f },
    { 189.8797945359f,  254.2276949092f,  350.7074176585f },
    { 189.3105581857f,  254.9099155221f,  351.1156977456f },
    { 188.7383022273f,  255.6052118593f,  351.5293056329f },
    { 188.1629648535f,  256.3137892893f,  351.9484739884f },
    { 187.5844814281f,  257.0358555168f,  352.3734540186f },
    { 187.0027842609f,  257.7716204937f,  352.8045174454f },
    { 186.4178023563f,  258.5212963184f,  353.2419587503f },
    { 185.8294611309f,  259.2850971283f,  353.6860977318f },
    { 185.2376820955f,  260.0632389853f,  354.1372824286f },
    { 184.6423824960f,  260.8559397580f,  354.5958924751f },
    { 184.0434749052f,  261.6634190065f,  355.0623429662f },
    { 183.4408667571f,  262.4858978755f,  355.5370889308f },
    { 182.8344598134f,  263.3235990089f,  356.0206305296f },
    { 182.2241495485f,  264.1767464984f,  356.5135191259f },
    { 181.6098244361f,  265.0455658902f,  357.0163644113f },
    { 180.9913651190f,  265.9302842796f,  357.5298428165f },
    { 180.3686434336f,  266.8311305374f,  358.0547074954f },
    { 179.7415212586f,  267.7483357291f,  358.5918002555f },
    { 179.1098491444f,  268.6821338145f,  359.1420659083f },
    { 178.4734646694f,  269.6327627511f,  359.7065696607f }
};

__CONSTANT__ float gamutTopGamma[360] = 
{
    0.893347167968750f,
    0.892340087890625f,
    0.891351318359375f,
    0.890380859375000f,
    0.889428710937500f,
    0.888500976562500f,
    0.887597656250000f,
    0.886712646484375f,
    0.885852050781250f,
    0.885015869140625f,
    0.884204101562500f,
    0.883416748046875f,
    0.882659912109375f,
    0.881921386718750f,
    0.881213378906250f,
    0.880529785156250f,
    0.879870605468750f,
    0.879235839843750f,
    0.878631591796875f,
    0.878033447265625f,
    0.877490234375000f,
    0.876940917968750f,
    0.876409912109375f,
    0.875933837890625f,
    0.875469970703125f,
    0.874957275390625f,
    0.874499511718750f,
    0.874096679687500f,
    0.873748779296875f,
    0.873962402343750f,
    0.876245117187500f,
    0.878417968750000f,
    0.880554199218750f,
    0.882464599609375f,
    0.884375000000000f,
    0.886175537109375f,
    0.887890625000000f,
    0.889599609375000f,
    0.891149902343750f,
    0.892724609375000f,
    0.894189453125000f,
    0.895635986328125f,
    0.897033691406250f,
    0.898370361328125f,
    0.899707031250000f,
    0.900952148437500f,
    0.902227783203125f,
    0.903393554687500f,
    0.904589843750000f,
    0.905718994140625f,
    0.906848144531250f,
    0.907940673828125f,
    0.909002685546875f,
    0.910064697265625f,
    0.911071777343750f,
    0.912103271484375f,
    0.913067626953125f,
    0.914056396484375f,
    0.914990234375000f,
    0.915936279296875f,
    0.916845703125000f,
    0.917749023437500f,
    0.918652343750000f,
    0.919512939453125f,
    0.920404052734375f,
    0.921234130859375f,
    0.922082519531250f,
    0.922912597656250f,
    0.923724365234375f,
    0.924554443359375f,
    0.925329589843750f,
    0.926123046875000f,
    0.926904296875000f,
    0.927661132812500f,
    0.928436279296875f,
    0.929174804687500f,
    0.929907226562500f,
    0.930651855468750f,
    0.931365966796875f,
    0.932067871093750f,
    0.932775878906250f,
    0.933471679687500f,
    0.934130859375000f,
    0.934796142578125f,
    0.935455322265625f,
    0.936108398437500f,
    0.936712646484375f,
    0.937310791015625f,
    0.937890625000000f,
    0.938458251953125f,
    0.939001464843750f,
    0.939520263671875f,
    0.940002441406250f,
    0.940454101562500f,
    0.940856933593750f,
    0.941210937500000f,
    0.941503906250000f,
    0.941735839843750f,
    0.941888427734375f,
    0.941961669921875f,
    0.941931152343750f,
    0.941741943359375f,
    0.941394042968750f,
    0.940881347656250f,
    0.933648681640625f,
    0.915191650390625f,
    0.896179199218750f,
    0.876507568359375f,
    0.871606445312500f,
    0.874548339843750f,
    0.877319335937500f,
    0.879931640625000f,
    0.882403564453125f,
    0.884741210937500f,
    0.886956787109375f,
    0.889056396484375f,
    0.891052246093750f,
    0.892944335937500f,
    0.894750976562500f,
    0.896472167968750f,
    0.898107910156250f,
    0.899670410156250f,
    0.901159667968750f,
    0.902581787109375f,
    0.903942871093750f,
    0.905236816406250f,
    0.906481933593750f,
    0.907666015625000f,
    0.908795166015625f,
    0.909881591796875f,
    0.910913085937500f,
    0.911901855468750f,
    0.912841796875000f,
    0.913739013671875f,
    0.914593505859375f,
    0.915405273437500f,
    0.916180419921875f,
    0.916912841796875f,
    0.917602539062500f,
    0.918261718750000f,
    0.918878173828125f,
    0.919451904296875f,
    0.921197509765625f,
    0.924389648437500f,
    0.927386474609375f,
    0.930206298828125f,
    0.932867431640625f,
    0.935375976562500f,
    0.937750244140625f,
    0.939996337890625f,
    0.942126464843750f,
    0.944146728515625f,
    0.946069335937500f,
    0.947888183593750f,
    0.949621582031250f,
    0.951275634765625f,
    0.952844238281250f,
    0.954327392578125f,
    0.955737304687500f,
    0.957080078125000f,
    0.958367919921875f,
    0.959588623046875f,
    0.960754394531250f,
    0.961865234375000f,
    0.962927246093750f,
    0.963928222656250f,
    0.964880371093750f,
    0.965783691406250f,
    0.966644287109375f,
    0.967468261718750f,
    0.968243408203125f,
    0.968981933593750f,
    0.969683837890625f,
    0.970330810546875f,
    0.970947265625000f,
    0.971527099609375f,
    0.972070312500000f,
    0.972583007812500f,
    0.973052978515625f,
    0.973492431640625f,
    0.973889160156250f,
    0.974249267578125f,
    0.974578857421875f,
    0.974877929687500f,
    0.975134277343750f,
    0.975360107421875f,
    0.975537109375000f,
    0.975683593750000f,
    0.975799560546875f,
    0.975872802734375f,
    0.975903320312500f,
    0.975885009765625f,
    0.975836181640625f,
    0.975738525390625f,
    0.975592041015625f,
    0.981994628906250f,
    0.991821289062500f,
    0.991662597656250f,
    0.991473388671875f,
    0.991296386718750f,
    0.991125488281250f,
    0.990954589843750f,
    0.990789794921875f,
    0.990625000000000f,
    0.990460205078125f,
    0.990295410156250f,
    0.990130615234375f,
    0.989971923828125f,
    0.989807128906250f,
    0.989654541015625f,
    0.989495849609375f,
    0.989349365234375f,
    0.989202880859375f,
    0.989038085937500f,
    0.988879394531250f,
    0.988726806640625f,
    0.988580322265625f,
    0.988439941406250f,
    0.988275146484375f,
    0.988122558593750f,
    0.987982177734375f,
    0.987841796875000f,
    0.987683105468750f,
    0.987530517578125f,
    0.987396240234375f,
    0.987243652343750f,
    0.987091064453125f,
    0.986950683593750f,
    0.986804199218750f,
    0.986645507812500f,
    0.986505126953125f,
    0.986358642578125f,
    0.986199951171875f,
    0.986059570312500f,
    0.985906982421875f,
    0.985754394531250f,
    0.985614013671875f,
    0.985455322265625f,
    0.985296630859375f,
    0.985156250000000f,
    0.984991455078125f,
    0.984838867187500f,
    0.984680175781250f,
    0.984515380859375f,
    0.984368896484375f,
    0.984197998046875f,
    0.984033203125000f,
    0.983874511718750f,
    0.983697509765625f,
    0.983538818359375f,
    0.983355712890625f,
    0.983178710937500f,
    0.983020019531250f,
    0.982824707031250f,
    0.982647705078125f,
    0.982458496093750f,
    0.982269287109375f,
    0.982092285156250f,
    0.981878662109375f,
    0.981683349609375f,
    0.981488037109375f,
    0.981268310546875f,
    0.981066894531250f,
    0.980847167968750f,
    0.980621337890625f,
    0.980413818359375f,
    0.980163574218750f,
    0.979925537109375f,
    0.979699707031250f,
    0.979431152343750f,
    0.979180908203125f,
    0.978924560546875f,
    0.978637695312500f,
    0.978375244140625f,
    0.978082275390625f,
    0.977777099609375f,
    0.977551269531250f,
    0.977569580078125f,
    0.977642822265625f,
    0.977661132812500f,
    0.977734375000000f,
    0.977746582031250f,
    0.977819824218750f,
    0.977838134765625f,
    0.977899169921875f,
    0.977923583984375f,
    0.977984619140625f,
    0.978015136718750f,
    0.978063964843750f,
    0.978106689453125f,
    0.978149414062500f,
    0.978204345703125f,
    0.978234863281250f,
    0.978295898437500f,
    0.978326416015625f,
    0.978375244140625f,
    0.978430175781250f,
    0.978460693359375f,
    0.978515625000000f,
    0.978564453125000f,
    0.978601074218750f,
    0.978656005859375f,
    0.978710937500000f,
    0.978747558593750f,
    0.978796386718750f,
    0.978851318359375f,
    0.978906250000000f,
    0.978948974609375f,
    0.978997802734375f,
    0.979046630859375f,
    0.979107666015625f,
    0.979162597656250f,
    0.979223632812500f,
    0.979278564453125f,
    0.979333496093750f,
    0.979394531250000f,
    0.979455566406250f,
    0.979510498046875f,
    0.979565429687500f,
    0.979626464843750f,
    0.979687500000000f,
    0.979754638671875f,
    0.979827880859375f,
    0.979888916015625f,
    0.979956054687500f,
    0.980029296875000f,
    0.980096435546875f,
    0.980175781250000f,
    0.980255126953125f,
    0.980328369140625f,
    0.980407714843750f,
    0.980487060546875f,
    0.970312500000000f,
    0.958020019531250f,
    0.945916748046875f,
    0.933978271484375f,
    0.922149658203125f,
    0.918322753906250f,
    0.917266845703125f,
    0.916204833984375f,
    0.915130615234375f,
    0.914044189453125f,
    0.912951660156250f,
    0.911853027343750f,
    0.910748291015625f,
    0.909637451171875f,
    0.908526611328125f,
    0.907409667968750f,
    0.906298828125000f,
    0.905187988281250f,
    0.904077148437500f,
    0.902966308593750f,
    0.901861572265625f,
    0.900762939453125f,
    0.899670410156250f,
    0.898590087890625f,
    0.897515869140625f,
    0.896453857421875f,
    0.895404052734375f,
    0.894372558593750f
};

#include "hellwig_lib_v058.h"

__DEVICE__ float3 transform(int p_Width, int p_Height, int p_X, int p_Y, float p_R, float p_G, float p_B)
{
    float3 in = make_float3(p_R, p_G, p_B);
    float3 out = in;

    float3 XYZ;

    if (!invert)
    {
        XYZ = vector_dot(AP0_ACES_to_XYZ_matrix, in);
        if (ap1Clip)
        {
            float3 AP1 = vector_dot(XYZ_to_AP1_ACES_matrix, XYZ);
            AP1.x = _fmaxf(AP1.x, 0.0f);
            AP1.y = _fmaxf(AP1.y, 0.0f);
            AP1.z = _fmaxf(AP1.z, 0.0f);
            XYZ = vector_dot(AP1_ACES_to_XYZ_matrix, AP1);
        }
    }
    else
    {
        in.x = ST2084_to_linear(in.x) / referenceLuminance;
        in.y = ST2084_to_linear(in.y) / referenceLuminance;
        in.z = ST2084_to_linear(in.z) / referenceLuminance;
        XYZ = vector_dot(RGB_to_XYZ_output, in);
    }
    XYZ *= referenceLuminance;
    float3 JMh;
    if (!invert)
    {
        JMh = XYZ_to_Hellwig2022_JMh(XYZ, inWhite);
        if (toneCurve)
        {
            JMh = forwardTonescale(JMh, compressChroma);
        }
        if (gamutCompress)
        {
            JMh = compressGamut(JMh, 0);
        }
    }
    else
    {
        JMh = XYZ_to_Hellwig2022_JMh(XYZ, d65White);
        if (gamutCompress)
        {
            JMh = compressGamut(JMh, 1);
        }
        if (toneCurve)
        {
            JMh = inverseTonescale(JMh, compressChroma);
        }
    }
    if (JMhOut)
    {
        out.x = JMh.x / referenceLuminance;
        out.y = JMh.y / referenceLuminance;
        out.z = JMh.z / 360.0f;
    }
    else
    {
        if (!invert)
        {
            if (!d60Sim)
            {
                XYZ = Hellwig2022_JMh_to_XYZ(JMh , d65White) / referenceLuminance;
            }
            else
            {
                XYZ = Hellwig2022_JMh_to_XYZ(JMh , inWhite) / referenceLuminance;
                float3 creativeWhiteXYZ = vector_dot(RGB_to_XYZ_P3D60, make_float3(1.0f, 1.0f, 1.0f));
                float3 creativeWhiteRGB = vector_dot(XYZ_to_RGB_limit, creativeWhiteXYZ);
                XYZ *= 1.0f / max(creativeWhiteRGB.x, max(creativeWhiteRGB.y, creativeWhiteRGB.z));
            }
            out = vector_dot(XYZ_to_RGB_limit, XYZ);
    
            // Soft clamp by compressing negative display linear values
            if (softClip)
            {
                float3 compr = make_float3(clamp_thr, clamp_dist, 1.2f);
                out = compress_aces(out, compr, compr, compr, 0);
            }

            // hard clip 0-peak
            if (hardClip)
            {
                out = clamp3(referenceLuminance * out, 0.0f, daniele_n);
            }
            else
            {
                out *= referenceLuminance;
            }
        
            if (asPQ)
            {
                out = vector_dot(P3D65_to_BT2020, out);
                out.x = linear_to_ST2084(out.x);
                out.y = linear_to_ST2084(out.y);
                out.z = linear_to_ST2084(out.z);
            }
            else
            {
                out = float3spow(out / referenceLuminance, 1.0f / 2.4f);
            }
        }
        else
        {
            XYZ = Hellwig2022_JMh_to_XYZ(JMh , inWhite) / referenceLuminance;
            out = vector_dot(XYZ_to_AP0_ACES_matrix, XYZ);
        }
    }

    return out;
}